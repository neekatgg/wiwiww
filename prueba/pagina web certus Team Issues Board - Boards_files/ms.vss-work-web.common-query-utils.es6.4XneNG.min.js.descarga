"use strict";define("Wit/Common/QueryUtils",["require","exports","VSS/Core/Util/String","VSS/Platform/Trace","VSS/Platform/Date","Wit/Common/DateUtils","Wit/Common/Generated/Constants","Tfs/Platform/Page","VSS/Platform/FPS","VSS/Platform/Location","Wit/Common/WiqlOperators","Wit/Common/WiqlValues"],(function(e,r,t,n,i,o,a,u,s,l,c,d){var p,m,f,g;p=r[g="Resources"]={},r[g].AnyOptionText="[Any]",r[g].ErrorDateTimeValueOutOfRange="The DateTime value is out of range.",r[g].ErrorExpectingBooleanValue="Expecting boolean value.",r[g].ErrorExpectingDateTime="Expecting DateTime value.",r[g].ErrorExpectingIntegerValue="Expecting integer value.",r[g].ErrorExpectingNumericValue="Expecting numeric value.",r[g].ErrorExpectingTeam="Expecting team value.",r[g].False="False",r[g].FieldNotFoundError="Field '{0}' not found",r[g].InvalidQuerySyntax="{0} The error is caused by {1}.",r[g].OperationFailed="Operation failed: {0}",r[g].QueryFilterErrorEmptyValue="The value for row {0} is not filled correctly.",r[g].QueryFilterErrorMissingOperator="The operator for row {0} is missing.",r[g].QueryFilterInvalidMacro="TF20036: The macro '{0}' is not recognized. Available macros include @Me, @Project, @Today and @CurrentIteration.",r[g].True="True",r[g].WorkItemLinkTypeEndDoesNotExist="Work item link type end '{0}' does not exist.",function(e){m=r[e]={},r[e].FavoritesTab="favorites",r[e].FolderView="folder",r[e].AllQueriesTab="all",r[e].Area="QueriesHub2",r[e].FavoriteTabViewed="FavoriteTabViewed",r[e].AllTabViewed="AllTabViewed",r[e].ChartsTabViewed="ChartsTabViewed",r[e].EditorTabViewed="EditorTabViewed",r[e].ResultsViewed="ResultsViewed",r[e].WorkItemEditViewed="WorkItemEditViewed",r[e].QueriesHubViewed="QueriesHubViewed",r[e].TelemetryArea="New-Queries-Hub",r[e].TelemetryFeature="query-service",r[e].MoreButtonId="more-button-",r[e].FavoriteArtifactScopeType="Project",r[e].FavoriteOwnerScope="Team",r[e].TeamFavoriteLoadingGroupKey="TEAM_FAVORITES_LOADING",r[e].MyFavoritesGroupKey="MY_FAVORITES_GROUP",r[e].MaximumQueriesToShow=50,r[e].KeywordFilterKey="keyword",r[e].QueriesPath="Queries",r[e].SplitterDirectionKey=`${r[e].QueriesPath}/SplitterDirection`,r[e].WorkItemFormSplitterSize=`${r[e].QueriesPath}/WorkItemFormSplitterRatio`,r[e].EditorTableSplitterSize=`${r[e].QueriesPath}/EditorTableSplitterRatio`,r[e].SettingsKey="setting"}("QueriesHubConstants"),function(e){r[e]={},r[e].reportError=function(e,r,i){const o=e.getService("IGlobalMessagesService");(0,n.traceException)(e,m.TelemetryArea,r,i);const a=i.status||0,u=(0,t.format)(p.OperationFailed,`${i instanceof Error?i.message:i}${a?" ("+a+")":""}`);o.addBanner({message:u,dismissable:!0,level:2},!0)}}("ErrorHandlingUtils"),function(e){r[e]={},function(e){e[e.NewQuery=0]="NewQuery",e[e.NewFolder=1]="NewFolder",e[e.RenameQuery=2]="RenameQuery",e[e.RenameFolder=3]="RenameFolder",e[e.SaveAs=4]="SaveAs"}(r[e].QuerySaveDialogMode||(r[e].QuerySaveDialogMode={}))}("Models"),function(e){f=r[e]={},function(e){function r(r){return(r||e.Unknown)>e.WorkItems}function t(r){return(r||e.Unknown)>=e.LinksRecursive}e.Unknown=0,e.WorkItems=1,e.LinksMustContain=2,e.LinksMayContain=3,e.LinksDoesNotContain=4,e.LinksRecursive=5,e.LinksRecursiveReturnMatchingChildren=6,e.isLinkQuery=r,e.isTreeQuery=t,e.getQueryType=function(e){return t(e)?2:r(e)?3:1}}(r[e].LinkQueryMode||(r[e].LinkQueryMode={}))}("QueryTypeConstants"),function(e){r[e]={};r[e].checkFlag=(e,r)=>(e&r)!==a.FieldFlags.None,r[e].convertValueToDisplayString=function(e,r){const t={year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric"},n=new Intl.DateTimeFormat(void 0,t);return null!=e?"string"==typeof e?e:e instanceof Date?(0,i.localeDateFormat)((0,o.getDateInUserTimeZone)(e),r,n):"number"==typeof e?r?(0,i.localeDateFormat)((0,o.getDateInUserTimeZone)(new Date(e)),r,n):e.toLocaleString(r,t):"boolean"==typeof e?e?p.True:p.False:"object"==typeof e&&e.distinctDisplayName?e.distinctDisplayName:e.toString():""}}("QueryUtils"),function(e){function n(n,i,o,a,s,c){var d,p;const m=null===(p=null===(d=(0,u.getTFSPageData)(n))||void 0===d?void 0:d.project)||void 0===p?void 0:p.name,f={};return f.project=m||"",f.view=i,s?f.tempQueryId=s:c?f.wiql=c:o&&o.length>0?f.id=o:(f.newQuery=(!0).toString(),f.parentId=null!=a?a:(0,t.newGuid)()),{url:(0,l.routeUrl)(n,r[e].queriesRoute,f),routeValues:f}}r[e]={},r[e].queriesRoute="ms.vss-work-web.new-queries-hub-route",r[e].workItemFormRoute="ms.vss-work-web.work-items-form-route",r[e].getDeletedUrl=function(t){var n,i;const o={project:(null===(i=null===(n=(0,u.getTFSPageData)(t))||void 0===n?void 0:n.project)||void 0===i?void 0:i.name)||"",view:"deleted"};return(0,l.routeUrl)(t,r[e].queriesRoute,o)},r[e].getEditorUrl=function(e,r,t,i,o){return n(e,"query-edit",r,t,i,o).url},r[e].getChartsUrl=function(e,r,t,i,o){return n(e,"query-charts",r,t,i,o).url},r[e].getImportWorkItemsUrl=function(t){var n,i;const o={project:(null===(i=null===(n=(0,u.getTFSPageData)(t))||void 0===n?void 0:n.project)||void 0===i?void 0:i.name)||"",view:"query",importData:"csv"};return(0,l.routeUrl)(t,r[e].queriesRoute,o)},r[e].getQueryUrl=function(e,r,t,i,o){return n(e,"query",r,t,i,o).url},r[e].getQueryFolderUrl=function(t,n){var i,o;const a=null===(o=null===(i=(0,u.getTFSPageData)(t))||void 0===i?void 0:i.project)||void 0===o?void 0:o.name,s={};return s.project=a||"",n?(s.view="folder",s.path=n):s.view="all",(0,l.routeUrl)(t,r[e].queriesRoute,s)},r[e].getWorkItemEditUrl=function(t,n,i){var o,a;const s={project:(null!=i?i:null===(a=null===(o=(0,u.getTFSPageData)(t))||void 0===o?void 0:o.project)||void 0===a?void 0:a.name)||"",view:"edit",id:String(n)};return{url:(0,l.routeUrl)(t,r[e].workItemFormRoute,s),routeValues:s}},r[e].getContributedTabUrl=function(e,r,t,i,o,a){return n(e,r,t,i,o,a).url},r[e].getViewUrl=n,r[e].onClickQuerySaveFPS=function(e,r,t,n,i={}){const o=Object.assign(i,{isQuerySaveFPS:!0});return(0,s.onClickFPS)(e,r,t,n,o)}}("RoutingUtils"),function(e){var n;function i(e,r){const t=new Error(r);return t.name=e,t}function o(e,r){return i(n.InvalidQuerySyntaxException,(0,t.format)(p.InvalidQuerySyntax,e,r))}function u(e,r){return i(n.InvalidQueryFilterRowException,(0,t.format)(e,r))}r[e]={},function(e){e.LinkTypeEndDoesNotExistException="VSS.WorkItemTracking.LinkTypeEndDoesNotExistException",e.InvalidQuerySyntaxException="VSS.WorkItemTracking.InvalidQuerySyntaxException",e.InvalidQueryFilterRowException="VSS.WorkItemTracking.InvalidQueryFilterRowException",e.FieldDoesNotExistException="VSS.WorkItemTracking.FieldDoesNotExistException"}(n||(n={})),function(e){let r;const s=[],l=/^-?[0-9]+?$/,m=/^true$/i,g=/^false$/i,y=/^[0-9]+?$/,v=/[\s'"()]+$/,E=/^[\s'"()]+/,T=/\"([^\"]*)\"/i;let h;function S(e){return e.length>0?"SELECT "+e.map((e=>"["+e+"]")).join(","):"SELECT [System.Id]"}function k(e,n,i){const o=[],s=[];let l,d=e.groups,m=!1;if(e.clauses&&(d=d&&[...d],l=0,e.clauses.forEach((e=>{const r=e.fieldName.trim();if(r){const n=e.operator.trim();if(!n)throw u(p.QueryFilterErrorMissingOperator,e.index+1);if(!e.value.trim()&&((0,c.isFieldComparisonOperator)(n)||(0,t.equals)(c.WiqlOperators.OperatorIn,(0,c.getInvariantOperator)(n),!0)||(0,t.equals)(c.WiqlOperators.OperatorNotIn,(0,c.getInvariantOperator)(n),!0)||F(r)===a.FieldType.Boolean))throw u(p.QueryFilterErrorEmptyValue,e.index+1);o.push(Object.assign(Object.assign({},e),{index:l,originalIndex:e.index})),l++}else d&&d.length&&(d=function(e,r,t){let n,i;if(e&&e.length){if(!t)return n=[],i={},e.forEach((e=>{let t;e.end>=r&&(e.start>r&&(e.start=Math.max(1,e.start-1)),e.end=Math.max(1,e.end-1)),e.start!==e.end&&(t=e.start+"_"+e.end,t in i||(i[t]=!0,n.push(e)))})),n;e.forEach((e=>{e.end>=r&&(e.start>=r&&e.start++,e.end++)}))}return e}(d,l+1,!1))}))),i&&!function(e,r){if(!e||!e.clauses)return!1;let n=!1;return e.clauses.forEach((i=>{const o=(0,c.getInvariantOperator)(i.logicalOperator);if((0,c.isOrOperator)(o,!1)&&O(i,e.groups))return n=!1,!1;(0,c.isOrOperator)(o,!1)||!O(i,e.groups)||(0,c.getInvariantOperator)(i.operator)!==c.WiqlOperators.OperatorEqualTo||w(i.fieldName,!1)!==a.CoreFieldRefNames.TeamProject||!(0,c.isProjectMacro)(i.value,!0)&&0!==(0,t.localeIgnoreCaseComparer)(i.value,r)||(n=!0)})),n}(e,i)){let r,t="";r=(0,c.isProjectMacro)(i,!1)?i:(0,c.quoteString)(i),n&&(t="["+n+"]."),t+="["+a.CoreFieldRefNames.TeamProject+"] = "+r,o.length>0&&(t+=" AND",function(e){if(!e||!e.clauses)return!0;for(const r of e.clauses){const t=(0,c.getInvariantOperator)(r.logicalOperator);if((0,c.isOrOperator)(t,!1)&&O(r,e.groups))return!1}return!0}(e)||(m=!0,t+=" (")),s.push(t)}o.forEach(((e,i)=>{const o=[];let a,u="";i>0&&o.push((0,c.getInvariantOperator)(e.logicalOperator)),d&&d.length&&(d.forEach((r=>{r.start===e.index+1&&(u+="(")})),u&&o.push(u));const l=(e=function(e){if(function(e){const t=r.find((r=>r.name===e));return void 0!==t&&(0,c.isNonNullableField)(t.referenceName)}(e.fieldName))return function(e){let r;if(e.value&&(r=e.value.replace(v,"").replace(E,""),0===(0,t.localeIgnoreCaseComparer)(r,p.AnyOptionText)&&(0,c.getInvariantOperator)(e.operator)===c.WiqlOperators.OperatorEqualTo))return Object.assign(Object.assign({},e),{operator:(0,c.getLocalizedOperator)(c.WiqlOperators.OperatorNotEqualTo),value:""});return e}(e);return e}(e)).fieldName,m=e.operator,f=e.value,g=w(l,!0),y=(0,c.getInvariantOperator)(m);if((0,c.isFieldComparisonOperator)(m)){const e=w(f,!0);a=n?"["+n+"].["+e+"]":"["+e+"]"}else a=y===c.WiqlOperators.OperatorIsEmpty||y===c.WiqlOperators.OperatorIsNotEmpty?"":x(g,y,f);n?o.push("["+n+"].["+g+"]"):o.push("["+g+"]"),o.push(y),o.push(a),d&&d.length&&(u="",d.forEach((r=>{r.end===e.index+1&&(u+=")")})),u&&o.push(u)),s.push(o.join(" "))}));let f=s.join(" ");return m&&(f+=")"),f}function F(e){var t,n;return null!==(n=null===(t=r.find((r=>r.referenceName===e)))||void 0===t?void 0:t.type)&&void 0!==n?n:a.FieldType.String}function w(e,o){const a=r.find((r=>r.name===e));if(a)return a.referenceName;if(h&&e===h.name)return h.referenceName;if(o)throw function(e){return i(n.FieldDoesNotExistException,(0,t.format)(p.FieldNotFoundError,e))}(e);return e}function O(e,r){const t=e.index+1;for(const e of r)if(t>e.start&&t<=e.end)return!1;return!0}function I(e){const r=(""+e).toUpperCase();for(const t of s){if(t.id===e)return t;if(t.name.toUpperCase()===r)return t;if(t.immutableName.toUpperCase()===r)return t}throw o=e,i(n.LinkTypeEndDoesNotExistException,(0,t.format)(p.WorkItemLinkTypeEndDoesNotExist,o));var o}function x(e,n,i){let u,s,f,v,E,T,h,S,k,w,O,N,C="";if(null!=i)if(u=!(i=i.trim()),n===c.WiqlOperators.OperatorIn||n===c.WiqlOperators.OperatorNotIn)s=[],s=(D=e,null!==(b=r.find((e=>e.referenceName!==a.CoreFieldRefNames.Parent&&e.referenceName===D)))&&void 0!==b?b:{}).isIdentity?Q(i):i.split(",").filter((e=>!!e)),s=s.map((r=>x(e,"",r))),C="("+s.join(",")+")";else if((0,t.equals)(e,"System.LinkType",!0)){try{k=I(i)}catch(e){throw o(e.message,i)}C=(0,c.quoteString)(k.immutableName)}else if(u)C="''";else if(f=F(e),v=(0,t.startsWith)(i,c.WiqlOperators.MacroStart),v){const e=(0,d.parseCurrentIteration)(i);if(e){if(e.team){const{offset:r,team:t}=e,n=r>0?` + ${r}`:r<0?" - "+-r:"",i=t?`('${t}')`:"";return`${c.WiqlOperators.MacroCurrentIteration}${i}${n}`}throw o(p.ErrorExpectingTeam,i)}const r=(0,d.parseTeamAreas)(i);if(r){if(r.team){const{team:e}=r,t=e?`('${e}')`:"";return`${c.WiqlOperators.MacroTeamAreas}${t}`}throw o(p.ErrorExpectingTeam,i)}const n=(0,d.parseDateMacro)(i);if(n){if(n.invariantMacro){const{invariantMacro:e,modifier:r,offset:t}=n;let i=`${e}`;return r&&(i+=`('${r}')`),t&&(i+=`${t}`),i}throw o(p.ErrorExpectingTeam,i)}if(!(0,c.isValidMacro)(i,!0))throw o((0,t.format)(p.QueryFilterInvalidMacro,i),i);C=(0,c.getInvariantOperator)(i)}else if(E=f===a.FieldType.DateTime,T=f===a.FieldType.Integer,h=f===a.FieldType.Double,S=f===a.FieldType.Boolean,E){if(O=new Date(Date.parse(i)),void 0===O||Number.isNaN(O))throw o(p.ErrorExpectingDateTime,i);if(N=O.getFullYear(),N<1753||N>9999)throw o(p.ErrorDateTimeValueOutOfRange,i);C=(0,c.quoteString)((0,c.toInvariantDateString)(O))}else if(T){if(!l.test(i))throw o(p.ErrorExpectingIntegerValue,i);C=i}else if(h){if(w=Number(i),Number.isNaN(w))throw o(p.ErrorExpectingNumericValue,i);C=i.toString()}else if(S)if(m.test(i))C="true";else if(g.test(i))C="false";else{if(!y.test(i))throw o(p.ErrorExpectingBooleanValue,i);C=parseInt(i,10)?"true":"false"}else C=(0,c.quoteString)(i);var D,b;return C}function Q(e){if(""===e)return[];const r=e.match(T);return null===r?e.split(","):r&&r.index?Q(e.substr(0,r.index-1)).concat([r[1]]).concat(Q(e.substr(r.index+r[0].length+1))):[]}function N(e,r){let n=e;return r||e&&e.length&&(n=[],e.forEach((e=>{e.name&&!(0,t.equals)(e.name,"System.Links.LinkType",!0)&&n.push(e)}))),n&&n.length?"ORDER BY "+n.map((e=>"["+e.name+"]"+(e.descending?" DESC":""))).join(","):""}e.generateWiql=function(e,n,i,a,u,l){const d=[];let m,g,y;return h=l,r=e,u.forEach((e=>{s.find((r=>r.id===e.forwardEnd.id))||s.push(e.forwardEnd),s.find((r=>r.id===e.reverseEnd.id))||s.push(e.reverseEnd)})),d.push(S(i)),n.mode<=f.LinkQueryMode.WorkItems?d.push("FROM WorkItems"):d.push("FROM WorkItemLinks"),m=function(e){if(f.LinkQueryMode.isLinkQuery(e.mode)){const r=f.LinkQueryMode.isTreeQuery(e.mode),n=r?e.treeTargetFilter:e.linkTargetFilter,i=r?e.treeLinkTypes:e.linkTypes,a=[];let u;return u=k(e.sourceFilter,"Source",e.teamProject).trim(),u&&a.push("("+u+")"),u=function(e){let r=[];if(e)for(let n of e.split(",")){let e;if(n=n.trim(),0===(0,t.localeIgnoreCaseComparer)(n,p.AnyOptionText)){r=["[System.Links.LinkType] <> ''"];break}try{e=I(n),r.push("[System.Links.LinkType] = "+(0,c.quoteString)(e.immutableName))}catch(e){throw o(e.message,n)}}return r.join(" OR ")}(i).trim(),u&&a.push("("+u+")"),u=k(n,"Target",e.teamProject).trim(),u&&a.push("("+u+")"),a.join(" AND ")}return k(e.sourceFilter,"",e.teamProject).trim()}(n).trim(),m&&d.push("WHERE "+m),g=N(a,f.LinkQueryMode.isLinkQuery(n.mode)),g&&d.push(g),y=function(e){switch(e){case f.LinkQueryMode.LinksMustContain:return"mode(MustContain)";case f.LinkQueryMode.LinksMayContain:return"mode(MayContain)";case f.LinkQueryMode.LinksDoesNotContain:return"mode(DoesNotContain)";case f.LinkQueryMode.LinksRecursive:return"mode(Recursive)";case f.LinkQueryMode.LinksRecursiveReturnMatchingChildren:return"mode(Recursive, ReturnMatchingChildren)"}return""}(n.mode),y&&d.push(y),d.join(" ")},e.generateSelectClause=S,e.generateOrderByClause=N}(r[e].WiqlGenerator||(r[e].WiqlGenerator={}))}("WiqlGenerator")}),["Resources","QueriesHubConstants","ErrorHandlingUtils","Models","QueryTypeConstants","QueryUtils","RoutingUtils","WiqlGenerator"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.common-query-utils"}}));