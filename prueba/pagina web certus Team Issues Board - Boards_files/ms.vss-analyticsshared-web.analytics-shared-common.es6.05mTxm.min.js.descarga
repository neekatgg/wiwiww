"use strict";define("Analytics/Shared/Common",["require","exports","VSS/Core/Util/String","Analytics/Shared/Utils/URLHelper","VSS/Core/Observable","VSS/Platform/Context","VSS/Platform/FPS","Analytics/Common/Utilities/QueryUtilities","Analytics/Shared/Utils/DateSKParser","Analytics/Shared/Utils/DateUtils","Analytics/Shared/Utils/Number","Analytics/Common/Utilities/AnalyticsExceptionUtilities","Analytics/Shared/Visuals/Common/Components/AnalyticsUnavailableMessage","react","VSS/Platform/Layout","VSSUI/Spinner","VSS/Platform/Location","VSSUI/Header","VSSUI/HeaderCommandBar","VSSUI/Page","VSSUI/Surface"],(function(e,t,i,a,n,s,r,l,o,u,c,d,p,y,m,P,h,D,S,g,R){var T,b,f,A,C;T=t[C="Resources"]={},t[C].NoOfDaysFormatString="{0} Days",t[C].SevenNumberText="7",t[C].FourteenNumberText="14",t[C].ThirtyDays="30",t[C].OneEightyDays="180",t[C].AnalyticsNotEnabledMessage="Analytics needs to be enabled to use this feature.",t[C].AnalyticsNotEnabledSuggestion="Analytics can be enabled in project collection settings.",t[C].AnalyticsSettings="View Analytics Settings",t[C].AnalyticsNotEnabledAriaDescription="Analytics is not enabled. Analytics needs to be enabled to use this feature. Enable Analytics here.",t[C].AnalyticsText="Analytics",t[C].AnalyticsDataNotReadyMessage="Preparing your data",t[C].AnalyticsDataNotReadySuggestion="This typically takes few minutes, but can take longer depending on the amount of data in your organization.<br>Please check after some time.",t[C].AnalyticsErrorMessage="Yikes! We hit an error while trying to load this page...",function(e){t[e]={},t[e].emsServiceInstanceId="00000028-0000-8888-8000-000000000000",t[e].gridLineColor="rgba(0,0,0,0.1)"}("Constants"),function(e){b=t[e]={},function(e){e[e.Build=1]="Build",e[e.Release=2]="Release"}(t[e].ContextType||(t[e].ContextType={})),function(e){e[e.NoTestDataView=0]="NoTestDataView",e[e.ReportView=1]="ReportView",e[e.TestInsightsReportView=2]="TestInsightsReportView",e[e.ErrorView=3]="ErrorView",e[e.DataNotReadyView=4]="DataNotReadyView"}(t[e].ViewType||(t[e].ViewType={})),function(e){e[e.Hours=0]="Hours",e[e.Days=1]="Days",e[e.Weeks=2]="Weeks"}(t[e].TrendBy||(t[e].TrendBy={})),function(e){e[e.Days_1=0]="Days_1",e[e.Days_7=1]="Days_7",e[e.Days_14=2]="Days_14",e[e.Days_30=3]="Days_30",e[e.Days_180=4]="Days_180"}(t[e].Period||(t[e].Period={})),function(e){e[e.Increased=0]="Increased",e[e.Decreased=1]="Decreased"}(t[e].TrendType||(t[e].TrendType={}))}("Types"),function(e){t[e]={};class a{constructor(e){this._options=[],this._initializeOptions(e)}get options(){return this._options}}t[e].ConfigurationProps=a;t[e].PeriodConfigurationProps=class extends a{constructor(e){super(e)}_initializeOptions(e){e=e||b.Period.Days_30,this._options[b.Period.Days_7]=(0,i.format)(T.NoOfDaysFormatString,T.SevenNumberText),e>b.Period.Days_7&&(this._options[b.Period.Days_14]=(0,i.format)(T.NoOfDaysFormatString,T.FourteenNumberText)),e>b.Period.Days_14&&(this._options[b.Period.Days_30]=(0,i.format)(T.NoOfDaysFormatString,T.ThirtyDays)),e>b.Period.Days_30&&(this._options[b.Period.Days_180]=(0,i.format)(T.NoOfDaysFormatString,T.OneEightyDays))}}}("Definitions"),function(e){t[e]={},t[e].Pipelines="BuildPipelines",t[e].Pipeline="BuildPipeline",t[e].PipelineSK="BuildPipelineSK",t[e].PipelineId="BuildPipelineId",t[e].PipelineName="BuildPipelineName",t[e].PipelineVersion="BuildPipelineVersion",t[e].PipelineProcessType="BuildPipelineProcessType",t[e].PipelineRuns="Builds",t[e].PipelineRun="Build",t[e].PipelineRunSK="BuildSK",t[e].PipelineRunId="BuildId",t[e].PipelineRunNumber="BuildNumber",t[e].PipelineRunNumberRevision="BuildNumberRevision",t[e].PipelineRunOutcome="BuildOutcome",t[e].PipelineRunReason="BuildReason",t[e].PipelineRunDurationSeconds="BuildDurationSeconds",t[e].PipelineRunActivityResults="BuildTaskResults",t[e].PipelineRunActivityResult="BuildTaskResult",t[e].PipelineRunTaskResultSK="BuildTaskResultSK",t[e].PipelineRunQueuedDateSK="BuildQueuedDateSK",t[e].PipelineRunQueuedOn="BuildQueuedOn",t[e].PipelineRunStartedDateSK="BuildStartedDateSK",t[e].PipelineRunStartedOn="BuildStartedOn",t[e].PipelineRunCompletedDateSK="BuildCompletedDateSK",t[e].PipelineRunCompletedOn="BuildCompletedOn",t[e].PipelineRunTaskOutcome="BuildTaskOutcome",t[e].PipelineTask="BuildPipelineTask",t[e].PipelineTaskSK="BuildPipelineTaskSK",t[e].switchEntityAndAttributeNames=function(){t[e].Pipelines="Pipelines",t[e].Pipeline="Pipeline",t[e].PipelineSK="PipelineSK",t[e].PipelineId="PipelineId",t[e].PipelineName="PipelineName",t[e].PipelineVersion="PipelineVersion",t[e].PipelineProcessType="PipelineProcessType",t[e].PipelineRuns="PipelineRuns",t[e].PipelineRun="PipelineRun",t[e].PipelineRunSK="PipelineRunSK",t[e].PipelineRunId="PipelineRunId",t[e].PipelineRunNumber="PipelineRunNumber",t[e].PipelineRunNumberRevision="PipelineRunNumberRevision",t[e].PipelineRunOutcome="PipelineRunOutcome",t[e].PipelineRunReason="PipelineRunReason",t[e].PipelineRunDurationSeconds="PipelineRunDurationSeconds",t[e].PipelineRunActivityResults="PipelineRunActivityResults",t[e].PipelineRunActivityResult="PipelineRunActivityResult",t[e].PipelineRunTaskResultSK="PipelineRunTaskResultSK",t[e].PipelineRunQueuedDateSK="PipelineRunQueuedDateSK",t[e].PipelineRunQueuedOn="PipelineRunQueuedOn",t[e].PipelineRunStartedDateSK="PipelineRunStartedDateSK",t[e].PipelineRunStartedOn="PipelineRunStartedOn",t[e].PipelineRunCompletedDateSK="PipelineRunCompletedDateSK",t[e].PipelineRunCompletedOn="PipelineRunCompletedOn",t[e].PipelineRunTaskOutcome="PipelineRunTaskOutcome",t[e].PipelineTask="PipelineTask",t[e].PipelineTaskSK="PipelineTaskSK"},t[e].switchEntityAndAttributesBackToBuild=function(){t[e].Pipelines="BuildPipelines",t[e].Pipeline="BuildPipeline",t[e].PipelineSK="BuildPipelineSK",t[e].PipelineId="BuildPipelineId",t[e].PipelineName="BuildPipelineName",t[e].PipelineVersion="BuildPipelineVersion",t[e].PipelineProcessType="BuildPipelineProcessType",t[e].PipelineRuns="Builds",t[e].PipelineRun="Build",t[e].PipelineRunSK="BuildSK",t[e].PipelineRunId="BuildId",t[e].PipelineRunNumber="BuildNumber",t[e].PipelineRunNumberRevision="BuildNumberRevision",t[e].PipelineRunOutcome="BuildOutcome",t[e].PipelineRunReason="BuildReason",t[e].PipelineRunDurationSeconds="BuildDurationSeconds",t[e].PipelineRunActivityResults="BuildTaskResults",t[e].PipelineRunActivityResult="BuildTaskResult",t[e].PipelineRunTaskResultSK="BuildTaskResultSK",t[e].PipelineRunQueuedDateSK="BuildQueuedDateSK",t[e].PipelineRunQueuedOn="BuildQueuedOn",t[e].PipelineRunStartedDateSK="BuildStartedDateSK",t[e].PipelineRunStartedOn="BuildStartedOn",t[e].PipelineRunCompletedDateSK="BuildCompletedDateSK",t[e].PipelineRunCompletedOn="BuildCompletedOn",t[e].PipelineRunTaskOutcome="BuildTaskOutcome",t[e].PipelineTask="BuildPipelineTask",t[e].PipelineTaskSK="BuildPipelineTaskSK"},t[e].RenameBuildEntitiesFeatureFlag="WebAccess.Pipeline.Analytics.RenameBuildEntities"}("PipelineEntities"),function(e){t[e]={};class i extends s.VssService{constructor(){super(...arguments),this.items=new n.ObservableArray}getBreadcrumbItems(e){return this.items}async addDefinition(e){(await this._getBreadcrumbItems(e)).forEach((e=>this.items.push(e)))}async _serviceStart(e){super._serviceStart(e);const t=(0,a.getContextTypeFromUrl)(this.pageContext),i=this.pageContext.getService("IVssContributionService");"build"==t?(await i.getContributionAsync("ms.vss-analyticsshared-web.analytics-build-service"),this._analyticsDataService=e.getService("IBuildAnalyticsDataService")):(await i.getContributionAsync("ms.vss-test-analytics-web.release-helper"),this._analyticsDataService=e.getService("IReleaseAnalyticsDataService"))}async _getBreadcrumbItems(e){const t=await this._analyticsDataService.fetchDefinitionName(e),i=this._analyticsDataService.getDefinitionUrl(e),a=this._analyticsDataService.getAnalyticsCardMetricsUrl(e);return[{key:"definition-breadcrumb",href:i,text:t,onClick:e=>{(0,r.onClickFPS)(this.pageContext,i,!0,e)},ariaLabel:t},{key:"definition-analytics-breadcrumb",text:T.AnalyticsText,href:a,onClick:e=>{(0,r.onClickFPS)(this.pageContext,a,!0,e)},ariaLabel:T.AnalyticsText}]}}t[e].AnalyticsHubBreadCrumbService=i,s.Services.add("analytics-hub-breadcrumb-service",{serviceFactory:i})}("ServiceAnalyticsHubBreadCrumbService"),function(e){t[e]={};class i{constructor(e,t,i){this._command=e,this._oDataQueryOptions=t,this.pageContext=i}runQuery(){return this.pageContext.getRestClient("IAnalyticsODataClient").query(this._command,this._oDataQueryOptions)}getKey(){const e=Object.assign({},this._oDataQueryOptions);return e.pageContext=void 0,JSON.stringify(e)}}class a{constructor(e,t,i,a){this._command=e,this._odataQueryUrl=t,this._oDataQueryOptions=i,this.pageContext=a}runQuery(){return this.pageContext.getRestClient("IAnalyticsODataClient").runNextLink(this._command,this._odataQueryUrl,this._oDataQueryOptions)}getKey(){return this._odataQueryUrl}}t[e].AnalyticsODataClientBase=class{constructor(e,t){this._command=e,this.pageContext=t,this._cacheableQueryService=this.pageContext.getService("ICacheableQueryService")}queryOData(e,t){e.oDataVersion=l.latestODataVersion,e.followNextLink=!t,e.batchRequestMode=2,e.pageContext=this.pageContext;const a=new i(this._command,e,this.pageContext);return this._getQueryResult(a)}queryODataByUrl(e){const t={oDataVersion:l.latestODataVersion,batchRequestMode:2,pageContext:this.pageContext},i=new a(this._command,e,t,this.pageContext);return this._getQueryResult(i)}_getProjectId(){const e=this.pageContext.getService("ITfsPageService").getData();if(e&&e.project)return e.project.id;throw new Error("Unable to fetch project details.")}async _getQueryResult(e){const t=this._cacheableQueryService.hasCachedEntry(e),i=await this._cacheableQueryService.getCacheableQueryResult(e);return i.isCachedData=t,i}}}("SourcesAnalyticsODataClientBase"),function(e){function i(e){if(null!=e){let t=2;return t=Math.pow(10,t),Math.floor(e*t)/t}return e}t[e]={},t[e].formatData=function(e){return e.map((e=>i(e)))},t[e].toTwoDecimalPoint=i}("UtilsChartDataConverter"),function(e){t[e]={},t[e].parseReturnDateIntoDisplayForm=function(e,t){switch(e){case b.TrendBy.Days:return o.DateSKParser.parseDateSKAsDateString(t.CompletedDateSK);case b.TrendBy.Weeks:return o.DateSKParser.convertDateToDateString(new Date(t.Date.WeekStartingDate));default:return""}};function i(e,t){const i=(0,u.shiftToUTC)((0,u.getDate)());let n=i;switch(e){case b.TrendBy.Days:n=(0,u.addDays)(i,1-a(t));break;case b.TrendBy.Weeks:n=(0,u.addDays)(i,-7*a(t)+1);break;case b.TrendBy.Hours:n=(0,u.addDays)((0,u.getDate)(),-a(t))}return n}function a(e){switch(e){case b.Period.Days_1:return 1;case b.Period.Days_7:return 7;case b.Period.Days_14:return 14;case b.Period.Days_30:return 30;case b.Period.Days_180:return 180;default:return 30}}t[e].getDateFilter=function(e,t,a){let n=i(e,t);return`${a=a||"CompletedDateSK"} ge ${o.DateSKParser.dateStringToDateSK(o.DateSKParser.convertDateToDateString(n))}`},t[e].getLookBackDate=i,t[e].adjustDataForAllPeriod=function(e,t,i,n){if(!e||e.length<=0&&null==n)return e;const s={},r={};e.forEach((e=>{s[e.date]||(s[e.date]=e.data,r[e.date]=e.customData)}));let l=0,o=(0,u.getDate)();const c=a(i||b.Period.Days_14);switch(t){case b.TrendBy.Days:l=1,o=(0,u.addDays)((0,u.shiftToUTC)((0,u.getDate)()),l*(1-c),!0);break;case b.TrendBy.Weeks:l=7;const e=(0,u.addDays)((0,u.shiftToUTC)((0,u.getDate)()),l*(1-c),!0);o=(0,u.addDays)(e,-e.getDay(),!0)}const d=[];for(let e=1;e<=c;e++){const e=(0,u.convertDateToDateString)(o);s.hasOwnProperty(e)?d.push({date:(0,u.convertDateToDateString)(o),data:s[e],customData:r[e]}):d.push({date:(0,u.convertDateToDateString)(o),data:n}),o=(0,u.addDays)(o,l)}return d},t[e].getPeriodValueFromPeriod=a,t[e].getPeriodStartDate=function(e,t){const i=(0,u.shiftToUTC)((0,u.getDate)());let n=i;switch(e){case b.TrendBy.Days:n=(0,u.addDays)(i,1-a(t));break;case b.TrendBy.Weeks:n=(0,u.addDays)(i,-7*a(t)+1)}return n},t[e].dateDiffInDays=function(e,t){const i=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),a=Date.UTC(t.getFullYear(),t.getMonth(),t.getDate());return Math.floor((a-i)/864e5)}}("UtilsDateAdjuster"),function(e){t[e]={},t[e].publishEvent=function(e,t,a,n,s){try{const i=e.getService("IVssTelemetryService");s[b.ContextType[n.contextType]]=n.definitionId,i.publishEvent(t,a,s)}catch(e){console.error(i.format("[TelemetryService.logProperties]: Error in logging Customer Intelligence data. Error: {0}",e.message))}}}("UtilsTelemetry"),function(e){t[e]={},t[e].getTrendFromData=function(e,t,i){let a;if(e!=t){let n=b.TrendType.Increased;e>t&&(n=b.TrendType.Decreased);let s=i?Math.abs((0,c.getPercentageVariation)(e,t)):Math.abs(Math.round(100*(t-e))/100);s=Math.round(10*s)/10,a={startValue:e,endValue:t,percentageVariation:s,trendType:n}}return a}}("UtilsTrendCalculator"),function(e){f=t[e]={};class i extends m.VssComponent{constructor(e,t){super(e,t),this.state={}}render(){let e=y.createElement(P.Spinner,{className:"analytics-card-spinner flex-grow flex-column",size:"large"}),t=this.props.getSuggestion?this.props.getSuggestion(this.state.viewType,this.state.errorText):void 0,i=this.props.getMessage?this.props.getMessage(this.state.viewType,this.state.errorText):void 0;return this.state&&(this.state.viewType===b.ViewType.ReportView?e=y.createElement(y.Fragment,null,this.props.children):this.state.viewType===b.ViewType.DataNotReadyView?(i=null==i?T.AnalyticsDataNotReadyMessage:i,t=null==t?T.AnalyticsDataNotReadySuggestion:t,e=y.createElement(p.AnalyticsUnavailableMessage,{imageName:this.props.compactView?"":"data-not-ready.svg",iconName:this.props.compactView?"ExploreData":"",message:i,suggestion:t,ariaDescription:i||t,messageClassName:this.props.compactView?"ax-unavailable-error-message":""})):this.state.viewType===b.ViewType.ErrorView&&(i=null==i?T.AnalyticsErrorMessage:i,t=null==t?this.state.errorText:t,e=y.createElement(p.AnalyticsUnavailableMessage,{imageName:this.props.compactView?"":"ServiceError.svg",message:i,suggestion:t,ariaDescription:i||t}))),e}async componentDidMount(){super.componentDidMount(),await this._validateData()}async _validateData(){if(!this.props.dataValidationPromises||0==this.props.dataValidationPromises.length)return this.setState({viewType:b.ViewType.ReportView}),Promise.resolve();Promise.race(this.props.dataValidationPromises).then((()=>{this.setState({viewType:b.ViewType.ReportView})})).catch((e=>{(0,d.recognizeAnalyticsException)(e)===d.AnalyticsExceptionType.DataNotReady?this.setState({viewType:b.ViewType.DataNotReadyView}):this.setState({viewType:b.ViewType.ErrorView,errorText:(0,d.extractODataError)(e)})}))}}t[e].AnalyticsDataValidator=i}("AnalyticsDataValidator"),function(e){A=t[e]={};class i extends m.VssComponent{constructor(e,t){super(e,t),this._analyticsExtensionStateService=t.pageContext.getService("IAnalyticsExtensionStateService"),this.state={isAnalyticsEnabled:null}}render(){let e=y.createElement(P.Spinner,{className:"analytics-card-spinner flex-grow flex-column",size:"large"});if(this.state&&null!=this.state.isAnalyticsEnabled)if(this.state.isAnalyticsEnabled)e=y.createElement(y.Fragment,null,this.props.children);else{const t="axextension-not-installed.svg",i=(0,h.routeUrl)(this.context.pageContext,"ms.vss-analytics.analytics-management-route");e=y.createElement(p.AnalyticsUnavailableMessage,{imageName:t,message:T.AnalyticsNotEnabledMessage,suggestion:T.AnalyticsNotEnabledSuggestion,buttonText:T.AnalyticsSettings,buttonUrl:i,ariaDescription:T.AnalyticsNotEnabledAriaDescription})}return e}async componentDidMount(){if(super.componentDidMount(),null==this.state.isAnalyticsEnabled){const e=await this._analyticsExtensionStateService.isAnalyticsEnabled();this.props.onAnalyticsEnabled&&e&&this.props.onAnalyticsEnabled(),this.setState({isAnalyticsEnabled:e})}}}t[e].AnalyticsExtensionValidator=i}("AnalyticsExtensionValidator"),function(e){t[e]={};t[e].AnalyticsHeaderComponent=e=>y.createElement(D.CustomHeader,{className:"bolt-header-with-commandbar flex-wrap"},y.createElement(D.HeaderTitleArea,null,y.createElement(D.HeaderTitleRow,null,y.createElement(D.HeaderTitle,{className:"text-ellipsis",titleSize:1},e.title)),e.children),e.showCommandBar&&y.createElement(S.HeaderCommandBar,{className:"analytics-command-bar",items:e.commandBarItems}))}("AnalyticsHeaderComponent"),function(e){t[e]={};class i extends m.VssComponent{constructor(e,t){super(e,t),this._handleAnalyticsEnabled=()=>{this.state.dataValidationPromises&&0!==this.state.dataValidationPromises.length||this.setState({dataValidationPromises:this.props.getDataValidationPromises()})},this.state={dataValidationPromises:[]}}render(){return y.createElement(R.Surface,{background:1},y.createElement(g.Page,{className:"analytics-page flex-grow absolute-fill"},this.props.renderHeader(),y.createElement(A.AnalyticsExtensionValidator,{onAnalyticsEnabled:this._handleAnalyticsEnabled},y.createElement(f.AnalyticsDataValidator,{dataValidationPromises:this.state.dataValidationPromises},y.createElement("div",{className:"page-content page-content-top flex flex-grow"},this.props.children)))))}}t[e].AnalyticsPage=i}("AnalyticsPage")}),["Resources","Constants","Types","Definitions","PipelineEntities","Service/AnalyticsHubBreadCrumbService","Sources/AnalyticsODataClientBase","Utils/ChartDataConverter","Utils/DateAdjuster","Utils/Telemetry","Utils/TrendCalculator","AnalyticsDataValidator","AnalyticsExtensionValidator","AnalyticsHeaderComponent","AnalyticsPage"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-analyticsshared-web.analytics-shared-common"}}));