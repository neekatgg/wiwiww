"use strict";define("Comments/Viewer",["require","exports","VSS/Core/Observable","VSS/Core/Util/String","VSS/Platform/Layout","VSSUI/Observer","VSSUI/Resources.Core","VSSUI/TooltipEx","VSSUI/Util","VSSUI/Utilities/Date","VSSUI/Utilities/Image","react","xss","xss/PresetOptions"],(function(e,t,o,n,r,i,a,s,m,c,d,l,p,h){var u,C,f;u=t[f="ResourcesViewer"]={},t[f].CommentedFormat="commented {0}",t[f].CommentedJustNow="just now",t[f].CommentEditedTag="(edited)",t[f].CommentEditedTooltip="Edited {0}",function(e){C=t[e]={};const f=["ms.vss-comments.viewer-toolbar"],T=["ms.vss-comments.reactions"],g=Object.assign(Object.assign({},h.superAllowList),{onIgnoreTagAttr:function(e,t,o){if(t.startsWith("class")||t.startsWith("data-vss-mention"))return t+'="'+(0,p.escapeAttrValue)(o)+'"'},stripIgnoreTagBody:["head"],onIgnoreTag:function(e){if(["html","body"].includes(e))return""},onTagAttr:(e,t,o)=>{if("href"===t&&o.startsWith("x-mvwit:workitem/"))return t+'="'+(0,p.escapeAttrValue)(o)+'"'}});class v extends r.VssComponent{constructor(e,t){super(e,t),this._additionalContentProps={},this._commentContentRef=l.createRef(),this._showDarkThemeFormat=new o.ObservableValue(!1),this._getPermaLink=e=>{const{getPermalink:t,getAnchorId:o=this._getAnchorId}=this.props;return t(o(e))},this._additionalContentProps={[v.CommentIdAttribute]:e.comment.id},this._themeService=this.context.pageContext.getService("IVssThemeService")}render(){const{comment:e,className:t,contentClassName:o,getAnchorId:r=this._getAnchorId,onRenderPersona:p,isReactionsEnabled:h,onRenderCommentBody:C,tooltipTimeFormat:f,currentDate:T,doNotHighlight:g}=this.props,v=e.createdOnBehalfDate||e.createdDate,S=e.modifiedDate,w=e.createdOnBehalfOf||e.createdBy,R=e.createdDate.getTime()!==e.modifiedDate.getTime(),b=c.ago(v,void 0,T)===a.JustNow?u.CommentedJustNow:c.ago(v,void 0,T),_=this._getSanitizedText(e),I=!g&&location.hash==="#"+e.id&&"highlighted";return l.createElement("div",Object.assign({id:r&&r(e.id),className:(0,m.css)("comment-viewer",t,I)},this._additionalContentProps),l.createElement("div",{className:"comment-header"},l.createElement("div",{className:"comment-header-main"},p&&p(w),l.createElement("span",{className:"user-display-name"},w.displayName),l.createElement(s.Tooltip,{text:c.tooltipString(v)},l.createElement("a",{className:"comment-timestamp",href:"#"+e.id,target:"_blank"},n.format(u.CommentedFormat,b))),R&&l.createElement(s.Tooltip,{text:n.format(u.CommentEditedTooltip,c.tooltipString(S,void 0,f))},l.createElement("span",{className:"comment-timestamp"},"Â ",u.CommentEditedTag))),this._renderToolbar()),l.createElement(i.Observer,{showDarkThemeFormat:this._showDarkThemeFormat,themeService:this._themeService},(t=>{const n=!t.showDarkThemeFormat&&this._themeService.getCurrentTheme().isDark;return C?l.createElement("div",{ref:this._commentContentRef},C(e.text)):l.createElement("div",{className:(0,m.css)("comment-content",n&&"comment-content-dark-theme-override",o),ref:this._commentContentRef,dangerouslySetInnerHTML:{__html:_},onDoubleClick:d.openImageInNewTab})})),h&&this._hasReactions()&&this._renderReactionStatusBar())}componentDidMount(){this._updateContent(),location.hash==="#"+this.props.comment.id&&window.setTimeout((()=>{var e,t;return null===(t=null===(e=this._commentContentRef)||void 0===e?void 0:e.current)||void 0===t?void 0:t.scrollIntoView({behavior:"smooth"})}),250)}componentDidUpdate(){this._updateContent()}_renderToolbar(){const{comment:{id:e},baseUrl:t,readonly:o,canEdit:n,editDisabled:i,formatDisabled:a,onStartEdit:s,onConfirmDelete:c,onMoreClick:d,getPermalink:p,isReactionsEnabled:h,reactionTypeToInfoMap:u={},editButtonRef:C,onAddReactionButtonClick:T,onAddReaction:g=m.noop,onDeleteReaction:v=m.noop}=this.props;return l.createElement(r.WrappedComponent,{dependencies:f,wrappedType:"comment-viewer-toolbar",wrappedProps:{commentId:e,baseUrl:t,readonly:o,canEdit:n,editDisabled:i,formatDisabled:a,editButtonRef:C,onStartEdit:s,onConfirmDelete:c,onMoreClick:d,getPermalink:p?this._getPermaLink:void 0,showDarkThemeFormat:this._showDarkThemeFormat,reactionSelectorProps:h?{readonly:o,commentId:e,reactionTypeToInfoMap:u,onAddReactionButtonClick:T,onAddReaction:g,onDeleteReaction:v}:void 0}})}_renderReactionStatusBar(){const{comment:{id:e},readonly:t,reactionTypeToInfoMap:o={},onAddReactionButtonClick:n,onAddReaction:i=m.noop,onDeleteReaction:a=m.noop,onGetRecentlyReactedUsers:s=m.noop}=this.props;return l.createElement("div",{className:"reaction-statusbar-placeholder"},l.createElement(r.WrappedComponent,{dependencies:T,wrappedType:"comment-reaction-statusbar",wrappedProps:{commentId:e,readonly:t,onAddReactionButtonClick:n,onAddReaction:i,onDeleteReaction:a,reactionTypeToInfoMap:o,onGetRecentlyReactedUsers:s}}))}_hasReactions(){const{reactionTypeToInfoMap:e}=this.props;if(!e)return!1;for(const t in e)if(e[t].totalCount>0)return!0;return!1}_getAnchorId(e){return`comment-${e}`}_updateContent(){const e=this._commentContentRef.current;if(e&&e.innerHTML){const{onPostRenderContent:t}=this.props;t&&t(e.innerHTML,e)}}_getSanitizedText(e){return e.renderedText?(0,p.filterXSS)(e.renderedText,g):(0,p.filterXSS)(e.text,g)}}t[e].CommentViewer=v,v.CommentIdAttribute="data-comment-id",r.VssComponent.register("comment-viewer",v)}("ComponentsCommentViewer"),function(e){t[e]={},Object.defineProperty(t[e],"CommentViewer",{enumerable:!0,get:function(){return C.CommentViewer}})}("CommentViewer")}),["Resources.Viewer","Components/CommentViewer","CommentViewer"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-comments.viewer"}}));