"use strict";define("Repos/RepoDropdown",["require","exports","VSS/Platform/Context","VSS/Platform/RestClientBase","VSS/Core/Observable","Favorites/Dropdown/ArtifactDropdownProvider","VSS/Core/Util/String","Favorites/Dropdown/ArtifactDropdown","react","VSS/Platform/Layout","VSSUI/Dropdown","VSSUI/Observer","VSSUI/Utilities/DropdownSelection","VSS/Features/PlatformUI/ContributedMenu","VSS/Platform/FPS","VSS/Platform/Location","VSSUI/Util"],(function(e,t,o,i,r,s,n,a,p,c,d,l,h,m,u,v,f){var g,y,S,I,R;g=t[R="Resources"]={},t[R].ManageRepositories="Manage repositories",t[R].ImportRepository="Import repository",t[R].NewRepository="New repository",t[R].RepositoryDropdownAriaLabel="{0} Repository",t[R].SearchRepositoriesWatermark="Filter repositories",t[R].SelectRepositoryShortcut="Select repository",function(e){y=t[e]={};class r extends i.RestClientBase{constructor(e){super(e)}async getRepositories(e,t,o,i){const r={includeLinks:t,includeAllUrls:o,includeHidden:i};return this.beginRequest({apiVersion:"5.0-preview.1",routeTemplate:"{project}/_apis/git/Repositories/{repositoryId}",routeValues:{project:e},queryParams:r})}}t[e].GitClientName="Repos.RepoDropdown.Git.IGitRestClient",t[e].getGitClient=function(o,i){return o.getRestClient(t[e].GitClientName,i)},o.RestClients.add(t[e].GitClientName,{factory:r,options:{resourceAreaId:"4e080c62-fa21-4fbc-8fef-2a10a2b38049",serviceInstanceType:"00025394-6065-48ca-87d9-7f5672854ef7"}})}("RestClientGit"),function(e){t.GitRepositoryService={};class i extends o.VssService{constructor(){super(...arguments),this.repositoriesByProject={}}getAllRepositories(e){let t=this.repositoriesByProject[e||""];if(!t){t=new r.ReadyableObservableArray;(0,y.getGitClient)(this.pageContext).getRepositories(e).then((e=>{t.value=e,t.ready.value=!0})),this.repositoriesByProject[e||""]=t}return t}}o.Services.add("IGitRepositoryService",{serviceFactory:i})}(),function(e){S=t[e]={};const o="Microsoft.TeamFoundation.Git.Repository";class i extends s.ArtifactDropdownProviderBase{constructor(e,t){super(),this.getDropdownItems=()=>{if(!this.items){const e=this.pageContext.getService("IVssPerformanceService");let t;if(e.startScenario("repo-dropdown-get-all-repositories",!1),this.items=new r.ReadyableObservableArray,this.repositories)t=new r.ReadyableObservableArray(this.repositories,!0);else{const e=this.pageContext.getService("IGitRepositoryService");t=e.getAllRepositories(this.projectId)}const o=t=>{var o;const i=t.map(a);i.sort(((e,t)=>(0,n.localeIgnoreCaseComparer)(e.name,t.name))),this.supportsTfvc&&i.unshift({name:"$/"+this.projectName,isTfvc:!0,id:"tfvc",isFork:!1}),e.endScenario("Repos","repo-dropdown-get-all-repositories",!1),null===(o=this.onRepositoriesLoaded)||void 0===o||o.call(this,t),this.items.value=i,this.items.ready.value=!0};if(t.ready.value)o(t.value);else{const e=e=>{e&&o(t.value)};this.addObserver(t.ready,e)}}return this.items};const{getArtifactHref:i,onFavoritesLoaded:s,onRepositoriesLoaded:p,supportsTfvc:c,projectName:d,projectId:l,repositories:h,defaultGroupHeader:m,favoriteGroupHeader:u,showFavoritesEarly:v=!0}=t;let f;this.pageContext=e,this.projectId=l,this.projectName=d,this.repositories=h,this.supportsTfvc=c,this.onRepositoriesLoaded=p,f=d&&l?{artifactType:o,artifactScope:{id:l,name:d,type:"Project"}}:{artifactType:o,artifactScope:{id:"",name:"",type:"Collection"}},this.artifactPickerOptions={pageContext:e,favoritesContext:f,onFavoritesLoaded:s,defaultGroupHeader:m,favoriteGroupHeader:u,getArtifacts:this.getDropdownItems,getArtifactHref:i,getArtifactId:e=>e.id,getArtifactName:e=>e.name,getArtifactIcon:e=>({iconName:e.isTfvc?"TFVCLogo":e.isFork?"GitFork":"GitLogo",className:e.isTfvc?"repos-tfvc-icon":"repos-git-icon"}),getArtifactFromFavorite:v?e=>({name:e.artifactName,id:e.artifactId,isTfvc:!1,isFork:!1}):void 0,getFavoriteFromArtifact:e=>e.repository?{artifactId:e.repository.id,artifactName:e.repository.name,artifactScope:{id:e.repository.project.id,name:e.repository.project.name,type:"Project"},artifactType:o}:void 0},this.initialize(this.artifactPickerOptions)}async loadFavorites(){const e=this.pageContext.getService("IVssPerformanceService");e.startScenario("repo-dropdown-load-favorites",!1);const t=await super.loadFavorites();return t&&e.endScenario("Repos","repo-dropdown-load-favorites",!1),t}}function a(e){return{name:e.name,id:e.id,repository:e,isFork:e.isFork,isTfvc:!1}}t[e].RepositoryDropdownProvider=i}("RepositoryDropdownProvider"),function(e){I=t[e]={};class o extends c.VssComponent{constructor(e,t){var o;super(e,t),this.dropdown=p.createRef(),this.hasMadeInitialSelection=!1,this.getCalloutWidth=e=>e||null==e?480:void 0,this.onItemsUpdated=()=>(this.hasMadeInitialSelection||(this.props.selectedRepositoryItem?this.makeInitialSelection():this.props.selectedRepositoryItems&&this.makeInitialSelections()),!1),this.makeInitialSelection=()=>{if(this.itemProvider.value.length>0&&this.props.selectedRepositoryItem)for(let e=0;e<this.itemProvider.value.length;e++)if(this.itemProvider.value[e].data&&this.itemProvider.value[e].data.id===this.props.selectedRepositoryItem.id)return this.dropdownSelection.select(e),void(this.hasMadeInitialSelection=!0)},this.makeInitialSelections=()=>{if(this.itemProvider.value.length>0&&this.props.selectedRepositoryItems){for(let e=0;e<this.itemProvider.value.length;e++)this.itemProvider.value[e].data&&this.props.selectedRepositoryItems.some((t=>t.id===this.itemProvider.value[e].data.id))&&this.dropdownSelection.select(e,void 0,!0,!0);this.hasMadeInitialSelection=!0}},this.itemProvider=new S.RepositoryDropdownProvider(t.pageContext,Object.assign(Object.assign({},e.providerOptions),{onRepositoriesLoaded:e.onRepositoriesLoaded})),this.dropdownSelection=null!==(o=e.dropdownSelection)&&void 0!==o?o:new h.DropdownSelection}render(){const{actions:e,className:t,onSelect:o,useDefaultCalloutWidth:i,onCollapse:r}=this.props,{getArtifactHref:s}=this.props.providerOptions;return p.createElement(l.Observer,{itemProvider:{observableValue:this.itemProvider,filter:this.onItemsUpdated},selection:this.dropdownSelection},(()=>{const h=(0,n.format)(g.RepositoryDropdownAriaLabel,this.dropdownSelection.value.length?this.itemProvider.value[this.dropdownSelection.value[0].beginIndex].text:this.props.selectedRepositoryItem?this.props.selectedRepositoryItem.name:"");this.props.getItemProvider&&this.props.getItemProvider(this.itemProvider.value);const m=this.props.selectedRepositoryItem?1:this.props.selectedRepositoryItems?this.props.selectedRepositoryItems.length:void 0;return p.createElement(a.ArtifactDropdown,{ariaLabel:h,ref:this.dropdown,onSelect:o,onCollapse:r,otherActions:e,items:this.itemProvider,getArtifactHref:s,selection:this.dropdownSelection,calloutContentClassName:"repository-selector-callout",className:(0,c.css)(t,"repository-selector scroll-hidden"),width:this.getCalloutWidth(i),filterPlaceholderText:g.SearchRepositoriesWatermark,renderExpandable:e=>p.createElement(d.DropdownExpandableButton,Object.assign({},e,{subtle:!0,style:{width:"100%"}}),p.createElement(l.Observer,{selection:this.dropdownSelection},(()=>{var e;return 0===this.dropdownSelection.selectedCount&&(this.props.selectedRepositoryItem||this.props.selectedRepositoryItems)?(0,a.renderSelectedItem)(this.itemProvider.getListItem(null!==(e=this.props.selectedRepositoryItem)&&void 0!==e?e:this.props.selectedRepositoryItems[0]),m):null})))})}))}componentWillUnmount(){this.itemProvider.dispose()}expand(){this.dropdown.current&&this.dropdown.current.expand()}focus(){this.dropdown.current&&this.dropdown.current.focus()}}t[e].RepositoryDropdown=o}("ComponentsRepositoryDropdown"),function(e){t.ComponentsRepositoryDropdownWithActions={};class o extends c.VssComponent{constructor(e,t){super(e,t),this.repositoryDropdown=p.createRef(),this.getDefaultActions=e=>{const t=[],o=e.findIndex((e=>"contributionId"in e&&"ms-1es.startright.startright-newrepo"===e.contributionId));let i;if(o>-1&&(i=e[o],e.splice(o,1)),this.canCreateRepositories){const e=g.NewRepository,o={iconName:"Add"};if(i){const r=this.menuItemToAction(i);r.text=e,r.iconProps=o,t.push(r)}else t.push({text:e,iconProps:o,onClick:this.onCreate,className:"repo-dropdown-action"});t.push({text:g.ImportRepository,iconProps:{iconName:"Upload"},onClick:this.onImport,className:"repo-dropdown-action"})}if(this.canManageRepositories){const e=(0,v.routeUrl)(this.context.pageContext,"ms.vss-code-web.admin-version-control-route",{project:this.projectName});t.push({text:g.ManageRepositories,iconProps:{iconName:"Settings"},href:e,className:"repo-dropdown-action"})}return t},this.getContributedActions=e=>this.menuItemsToActions(e),this.getItemHref=e=>this.context.pageContext.getService("IReposRoutingService").getSwitchRepositoryURL(e.isTfvc?null:e.name,this.projectName),this.getSelectedRepositoryItem=()=>{if(this.vcData)return{id:this.vcData.defaultRepoId||"tfvc",name:this.vcData.defaultRepoIsGit?this.vcData.defaultGitRepoName:"$/"+this.projectName,isTfvc:!this.vcData.defaultRepoIsGit,isFork:this.vcData.defaultRepoIsFork}},this.menuItemToAction=e=>({text:e.text||"",iconProps:e.iconProps,onClick:t=>{e.onActivate&&e.onActivate(e,t)},href:e.href,className:"repo-dropdown-action"}),this.menuItemsToActions=e=>{const t=[];return e.forEach((e=>{t.push(this.menuItemToAction(e))})),t},this.onCreate=()=>{if(this.context.pageContext.getService("IStartRightExtensionService").navigateToCreateRepository(this.context.pageContext))return;this.context.pageContext.getService("IVssLayoutManager").renderCallout((e=>p.createElement(c.WrappedComponent,{dependencies:["ms.vss-code-web.import-dependencies"],wrappedProps:{onCreate:e=>{e.then((e=>{(0,u.FastPageSwitch)(this.context.pageContext,e.repository.webUrl,!0)}),f.noop)},onDismiss:e,projectId:this.projectId,projectName:this.projectName},wrappedType:"ms.vss-code-web.panel-create"})))},this.onImport=()=>{this.context.pageContext.getService("IVssLayoutManager").renderCallout((e=>p.createElement(c.WrappedComponent,{dependencies:["ms.vss-code-web.import-dependencies"],wrappedProps:{onDismiss:e,onImport:e=>{e.then((e=>{(0,u.FastPageSwitch)(this.context.pageContext,e.repository.webUrl,!0)}),f.noop)},projectId:this.projectId,projectName:this.projectName},wrappedType:"ms.vss-code-web.panel-import"})))};const o=t.pageContext.getService("IProjectRepositoryInformationService");this.vcData=o.getData();const i=t.pageContext.getService("ITfsPageService").getData();if(i&&i.project){this.projectName=i.project.name,this.projectId=i.project.id;const e=t.pageContext.getService("IReposPermissionsService");this.canCreateRepositories=e.hasPermission(256,void 0,void 0,this.projectId),this.canManageRepositories=e.hasPermission(1024,void 0,void 0,this.projectId)||e.hasPermission(512,void 0,void 0,this.projectId)||e.hasPermission(8192,void 0,void 0,this.projectId)}else this.projectName=void 0,this.projectId=void 0;this.repositoryContributedActions=(0,m.getMenuItems)(this.context.pageContext,"ms.vss-code-web.command-bar-repository-picker-actions")}render(){return this.vcData&&this.projectName?p.createElement(l.Observer,{contributedActions:this.repositoryContributedActions},(e=>p.createElement(I.RepositoryDropdown,{ref:this.repositoryDropdown,actions:this.getActions(e.contributedActions),selectedRepositoryItem:this.getSelectedRepositoryItem(),providerOptions:{getArtifactHref:this.getItemHref,projectName:this.projectName,projectId:this.projectId,supportsTfvc:this.vcData&&this.vcData.supportsTfvc}}))):null}componentDidMount(){if(super.componentDidMount(),this.props.registerKeyboardShortcuts){this.context.pageContext.getService("IVssKeyboardShortcutService").registerShortcut("Repos",{action:()=>{const e=this.repositoryDropdown.current;e&&(e.focus(),e.expand())},combos:["r"],description:g.SelectRepositoryShortcut})}}componentWillUnmount(){super.componentWillUnmount();this.context.pageContext.getService("IVssKeyboardShortcutService").unRegisterShortcut("Repos","r")}getActions(e){return[...this.getDefaultActions(e),...this.getContributedActions(e)]}}c.Components.add("ms.vss-code-web.repository-dropdown-actions",o),c.Components.add("ms.vss-code-web.repository-dropdown-menuitem",(function(){return p.createElement("tr",null,p.createElement("td",null),p.createElement("td",{colSpan:5},p.createElement("div",{className:"repository-dropdown-menuitem flex-row"},p.createElement(o,null))),p.createElement("td",null))}))}()}),["Resources","RestClient/Git","GitRepositoryService","RepositoryDropdownProvider","Components/RepositoryDropdown","Components/RepositoryDropdownWithActions"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-code-web.repo-dropdown"}}));