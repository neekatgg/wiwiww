"use strict";define("Wit/WorkItemSignalR",["require","exports","VSS/Features/SignalR/Hub","VSS/Platform/Context","VSS/Platform/Trace"],(function(t,e,i,s,o){var a;!function(t){a=e[t]={};const s="workItemHub";function o(t){return t.server={unwatchWorkItem:function(e){return t.invoke.apply(t,["UnwatchWorkItem",e])},watchWorkItem:function(e){return t.invoke.apply(t,["WatchWorkItem",e])}},t}class r extends i.SignalRHub{constructor(t){super({name:s,hostInformation:t.hostInformation,userInactivityTimeoutMs:36e5,pageContext:t.pageContext,removeApiPath:!0,useSignalRAppPoolDefaultValue:t.useSignalRAppPoolDefaultValue}),this._callbacks={},this._disposed=!1,this._initializeClient=t=>{t.client.onWorkItemUpdated=t=>{t&&t.forEach((t=>{const e=this._callbacks[t.id];e&&e(t)}))}},this._onTimeout=()=>{this._disposed||0!==Object.keys(this._callbacks).length||this.stop(!0)},this.initializeProxy(o,this._initializeClient)}async watch(t,e){if(this._clearTimeout(),!this._disposed){this._callbacks[t]=e;try{await this.start()}catch(e){return delete this._callbacks[t],void this._tryStartTimeout()}try{const e=this.getHub(s);if(!e)throw new Error("WorkItemHub not initialized");await e.server.watchWorkItem(t)}catch(e){throw delete this._callbacks[t],this._tryStartTimeout(),e}}}async endWatch(t){if(this._clearTimeout(),delete this._callbacks[t],!this._disposed){const e=this.getHub(s);e&&await e.server.unwatchWorkItem(t),this._tryStartTimeout()}}dispose(){super.dispose(),this._callbacks={},this._clearTimeout(),this._disposed=!0}_tryStartTimeout(){this._clearTimeout(),this._disposed||0!==Object.keys(this._callbacks).length||(this._timeoutHandle=setTimeout(this._onTimeout,12e4))}_clearTimeout(){this._timeoutHandle&&(clearTimeout(this._timeoutHandle),this._timeoutHandle=null)}}e[t].WorkItemHub=r}("WorkItemSignalRHub"),function(t){e.WorkItemSignalRService={};class i extends s.VssService{_serviceEnd(t){super._serviceEnd(t),this._workItemHub&&this._workItemHub.dispose(),this._workItemHub=null}async watch(t,e,i){if(this._ensureHubInitialized(i),this._workItemHub&&t)try{await this._workItemHub.watch(t,e)}catch(t){(0,o.traceException)(this.pageContext,"WIT","WorkItem",t,{method:"SignalR.Watch"})}}async endWatch(t){if(this._workItemHub)try{await this._workItemHub.endWatch(t)}catch(t){(0,o.traceException)(this.pageContext,"WIT","WorkItem",t,{method:"SignalR.EndWatch"})}}_ensureHubInitialized(t){if(!this._workItemHub){const e=this.pageContext.getService("IVssPageService").getData(),i=this.pageContext.getService("IVssHistoryService");if(e){const s={hostInformation:{hostId:e.hostId,hostPath:e.hostPath,isHosted:e.isHosted},historyService:i,pageContext:this.pageContext,useSignalRAppPoolDefaultValue:t};this._workItemHub=new a.WorkItemHub(s)}}}}s.Services.add("ms.vss-work-web.work-item-signalr-service",{serviceFactory:i})}()}),["WorkItemSignalRHub","WorkItemSignalRService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-signalr-contribution"}}));