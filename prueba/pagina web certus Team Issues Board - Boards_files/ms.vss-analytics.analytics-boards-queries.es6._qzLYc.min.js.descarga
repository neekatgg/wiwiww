"use strict";define("Analytics/Boards/BoardsQueries",["require","exports","Analytics/Common/AnalyticsCacheableQueryBase","Analytics/Common/Utilities/QueryUtilities","Analytics/Common/Utilities/PublicProjectsQueryHelper","VSS/Platform/Feature"],(function(e,t,r,o,a,n){var i,s;t[s="Resources"]={},t[s].Error_FailedToFindAVisibleBoard="Failed to find any visible boards. Please visit/configure boards and try again.",function(e){t[e]={};class a extends r.AnalyticsCacheableQueryBase{static generateQueryOptions(e){return{entityType:"WorkItemTypeFields",oDataVersion:o.latestODataVersion,project:e,$filter:"(FieldType eq 'Integer' or FieldType eq 'Double') and (not startswith(FieldReferenceName,'System.'))"}}constructor(e){super(r.CommonFeatureCommandName,a.generateQueryOptions(e))}getQueryName(){return"AggregationWorkItemTypeFieldsQuery"}}function n(e){return["Microsoft.VSTS.Common.StackRank","Microsoft.VSTS.Common.Priority","Microsoft.VSTS.Common.BacklogPriority","Microsoft.VSTS.Common.TimeCriticality"].findIndex((t=>t===e))>=0}t[e].AggregationFieldsQuery=a,t[e].getDistinctFieldsOfTypes=function(e,t){const r=t.filter((t=>e.some((e=>t.WorkItemType===e&&!n(t.FieldReferenceName)))));let o={},a=[];for(let e of r)void 0===o[e.FieldReferenceName]&&a.push({FieldName:e.FieldName,FieldReferenceName:e.FieldReferenceName,FieldType:e.FieldType}),o[e.FieldReferenceName]=0;return a},t[e].isRecognizedNonAggregationField=n}("AggregationFieldsQuery"),function(e){t[e]={};class a extends r.AnalyticsCacheableQueryBase{static generateQueryOptions(e,t){if(!t||0==t.length)throw new Error("No team Id's were supplied to Backlogs query.");let r="";for(let e=0;e<t.length;e++)e>0&&(r+=" or "),r+=`TeamSK eq ${t[e]}`;return{project:e,entityType:"BoardLocations",oDataVersion:o.latestODataVersion,$apply:`filter(${r})/groupby((BoardName,BoardLevel,BoardCategoryReferenceName,IsBoardVisible))`,$orderby:"BoardLevel desc"}}constructor(e,t){super(r.CommonFeatureCommandName,a.generateQueryOptions(e,t))}getQueryName(){return"BacklogQuery"}}t[e].BacklogsQuery=a}("BacklogsQuery"),function(e){i=t[e]={},function(e){e[e.Count=0]="Count",e[e.Sum=1]="Sum"}(t[e].AggregationMode||(t[e].AggregationMode={})),function(e){e[e.Internal=0]="Internal",e[e.String=1]="String",e[e.Integer=2]="Integer",e[e.DateTime=3]="DateTime",e[e.PlainText=5]="PlainText",e[e.Html=7]="Html",e[e.TreePath=8]="TreePath",e[e.History=9]="History",e[e.Double=10]="Double",e[e.Guid=11]="Guid",e[e.Boolean=12]="Boolean",e[e.PicklistInteger=14]="PicklistInteger",e[e.PicklistString=15]="PicklistString"}(t[e].WitFieldType||(t[e].WitFieldType={})),function(e){e.NotSpace="NOT",e.OperatorAnd="AND",e.OperatorOr="OR",e.OperatorContains="CONTAINS",e.OperatorNotContains="NOT CONTAINS",e.OperatorContainsWords="CONTAINS WORDS",e.OperatorNotContainsWords="NOT CONTAINS WORDS",e.OperatorIn="IN",e.OperatorNotIn="NOT IN",e.OperatorEver="EVER",e.OperatorNotEver="NOT EVER",e.OperatorUnder="UNDER",e.OperatorNotUnder="NOT UNDER",e.OperatorInGroup="IN GROUP",e.OperatorNotInGroup="NOT IN GROUP",e.OperatorEqualTo="=",e.OperatorNotEqualTo="<>",e.OperatorIsEmpty="IS EMPTY",e.OperatorIsNotEmpty="IS NOT EMPTY",e.OperatorGreaterThan=">",e.OperatorLessThan="<",e.OperatorGreaterThanOrEqualTo=">=",e.OperatorLessThanOrEqualTo="<=",e.MacroStart="@",e.MacroToday="@today",e.MacroMe="@me",e.MacroProject="@project",e.MacroCurrentIteration="@currentIteration",e.MacroTeamAreas="@teamAreas",e.MacroFollows="@follows",e.MacroRecentMentions="@recentMentions",e.MacroMyRecentActivity="@myRecentActivity",e.MacroRecentProjectActivity="@recentProjectActivity",e.MacroStartOfYear="@startOfYear",e.MacroStartOfMonth="@startOfMonth",e.MacroStartOfWeek="@startOfWeek",e.MacroStartOfDay="@startOfDay"}(t[e].WiqlOperators||(t[e].WiqlOperators={}))}("DataContracts"),function(e){t[e]={};class a extends r.AnalyticsCacheableQueryBase{constructor(e,t,o,n,i,s){super(r.CommonFeatureCommandName,a.generateQueryOptions(e,t,o,n,i)),this.queryName=s}static generateQueryOptions(e,t,r,a,n){let i,s;let c;a&&(c=null!=r?"StartDate lt now()":"StartDate ne null");s=t?`Teams/any(t:t/TeamSK eq ${t})`+" and "+c:c;const u="IsEnded,StartDate desc,EndDate desc,IterationName";r&&(i=`${r}`);const l=n;return s||e?{entityType:"Iterations",oDataVersion:o.latestODataVersion,project:e,$filter:s,$orderby:u,$top:i,$select:l}:{entityType:"Iterations",oDataVersion:o.latestODataVersion,$orderby:u,$select:l}}static onTeam(e,t,r){const o=a.defaultColumns;return new a(e,t,r,!0,o)}static onProject(e){const t=a.defaultColumns;return new a(e,void 0,void 0,!0,t)}static allIterationsOnProject(e){const t=a.unrestrictedColumns;return new a(e,void 0,void 0,!1,t)}getQueryName(){return this.queryName||"IterationsQuery"}interpretQueryResults(e){return i(e)}}t[e].IterationsQuery=a,a.defaultColumns="IterationSK, IterationName, StartDate, EndDate, IsEnded, IterationPath",a.unrestrictedColumns="IterationSK,IterationName,StartDate,EndDate,IterationPath,Depth,ProjectSK,Number,Depth";class n extends r.AnalyticsCacheableQueryBase{static onIterationPath(e,t){const r=`IterationPath eq '${o.QueryUtilities.escapeString(t)}'`,i=a.defaultColumns,s={entityType:"Iterations",oDataVersion:o.latestODataVersion,project:e,$filter:r,$select:i};return new n(s)}constructor(e){super(r.CommonFeatureCommandName,e)}getQueryName(){return"IterationQuery"}interpretQueryResults(e){return i(e)}}function i(e){return e.value.map((e=>({IterationSK:e.IterationSK,IterationName:e.IterationName,IterationPath:e.IterationPath,StartDateTimeOffset:e.StartDate,EndDateTimeOffset:e.EndDate,IsEnded:e.IsEnded,ProjectSK:e.ProjectSK,Number:e.Number,Depth:e.Depth}))).reverse()}t[e].IterationQuery=n}("IterationsQuery"),function(e){t[e]={};class i extends r.AnalyticsCacheableQueryBase{constructor(e,t){super(r.CommonFeatureCommandName,e),this.queryName=t}static generateQueryOptions(e,t,r){const i=`filter(${null!=r?`TeamSK eq ${r} and `:""} ProjectSK eq ${t})`,s=(0,n.isFeatureFlagEnabled)(e,"WebAccess.Process.WorkItemTypeIsDeletedOnProcess",!1)?", IsDeleted":"";return(0,a.forceProjectScoping)(e,[t],{entityType:"Processes",oDataVersion:o.latestODataVersion,$apply:`${i}/groupby((BacklogCategoryReferenceName, WorkItemType, IsBugType, BacklogName${s}))`})}static onProject(e,t){return new i(i.generateQueryOptions(e,t))}static onTeam(e,t,r){if(null==r||0===r.trim().length)throw new Error("Team ID must be provided to use this method. Use onProject instead if querying for processes at the project level.");return new i(i.generateQueryOptions(e,t,r))}getQueryName(){return this.queryName||"ProcessesQuery"}}t[e].ProcessesQuery=i}("ProcessesQuery"),function(e){t[e]={};class a extends r.AnalyticsCacheableQueryBase{static generateQueryOptions(e){return{entityType:"Teams",oDataVersion:o.latestODataVersion,project:e,$orderby:"TeamName",$select:"TeamId,TeamName,ProjectSK"}}static onProject(e,t){return new a(a.generateQueryOptions(t))}constructor(e){super(r.CommonFeatureCommandName,e)}getQueryName(){return"TeamsQuery"}}t[e].TeamsQuery=a}("TeamsQuery"),function(e){t[e]={};class r{static replaceUnsupportedCharacters(e){const t=[];for(let r=0;r<e.length;++r){const o=e[r];if("."===o)t.push("_");else if(/[^\w\s\.]/.test(o)){let e=o.charCodeAt(0).toString(16).toUpperCase();e="0000"+e,e=e.slice(-4),t.push(`__${e}`)}else t.push(o)}return t.join("")}static tagOperatorToODataClause(e){switch(e.toLowerCase().trim()){case"Contains".toLowerCase():return"eq";case"Does not contain".toLowerCase():case"Not contains".toLowerCase():return"ne"}return""}static getTagsClause(e){const t=[],o=[];for(const a of e)a.fieldName===r.tagsReferenceName&&("eq"===r.tagOperatorToODataClause(a.queryOperation)?t.push(`Tags/any(t:t/TagName eq '${r.escapeString(a.queryValue)}')`):o.push(`t/TagName ne '${r.escapeString(a.queryValue)}'`));let a=t.join(" and ");return o.length>0&&(""!=a&&(a+=" and "),a+=`Tags/all(t:${o.join(" and ")})`),a}static operatorToODataOperator(e){switch(e.trim()){case">":return"gt";case">=":return"ge";case"<":return"lt";case"<=":return"le";case"=":return"eq";case"<>":return"ne"}return""}static getFieldODataPropertyName(e){const t=r.workItemPrimitiveCommonPropertiesMapping[e];return null!=t&&(e=t),/^(\d+)/.test(e)&&(e=`_${e}`),r.replaceUnsupportedCharacters(e)}static escapeString(e){return e.split("'").join("''")}static getFiltersClause(e,t){const o=e.filter((e=>e.fieldName!==r.tagsReferenceName)).map((e=>{const o=t.filter((t=>t.FieldReferenceName==e.fieldName));if(o.length>0){const t=o[0];if("Identity"==t.FieldType)return null;const a=t.AnalyticsFilterName,n=t.GetAnalyticsQueryValueFunc(e),s=r.escapeString(n);if(t.FieldType===i.WitFieldType[i.WitFieldType.TreePath]&&e.queryOperation===i.WiqlOperators.OperatorUnder)return`(${a} eq '${s}' or startswith(${a},'${s}\\'))`;if(t.FieldType===i.WitFieldType[i.WitFieldType.TreePath]&&e.queryOperation===i.WiqlOperators.OperatorNotUnder)return`((${a} ne '${s}' and not startswith(${a},'${s}\\')) or ${a} eq null)`;{const o=t.UseQuotes?"'":"",n=r.operatorToODataOperator(e.queryOperation),i=`${a} ${n} ${o}${s}${o}`;return s?"ne"===n?`(${i} or ${a} eq null)`:i:`${a} ${n} null`}}return console.warn("Query did not recognize field: "+e.fieldName),null})).filter((e=>!!e)).join(" and "),a=r.getTagsClause(e);return o&&a?[o,a].join(" and "):o||(a||"")}}t[e].WitFieldUtilities=r,r.workItemPrimitiveCommonPropertiesMapping={"System.Id":"WorkItemId","System.Rev":"Revision","System.Watermark":"Watermark","System.Title":"Title","System.WorkItemType":"WorkItemType","System.ChangedDate":"ChangedDate","System.CreatedDate":"CreatedDate","System.State":"State","System.Reason":"Reason","System.IsDeleted":"IsDeleted","System.Tags":"TagNames","Microsoft.VSTS.Common.StateChangeDate":"StateChangeDate","System.StateChangeDate":"StateChangeDate","Microsoft.VSTS.Build.FoundIn":"FoundIn","Microsoft.VSTS.Build.IntegrationBuild":"IntegrationBuild","Microsoft.VSTS.Common.Activity":"Activity","Microsoft.VSTS.Common.ActivatedDate":"ActivatedDate","Microsoft.VSTS.Common.BacklogPriority":"BacklogPriority","Microsoft.VSTS.Common.BusinessValue":"BusinessValue","Microsoft.VSTS.Common.ClosedDate":"ClosedDate","Microsoft.VSTS.Common.Discipline":"Discipline","Microsoft.VSTS.Common.Issue":"Issue","Microsoft.VSTS.Common.Priority":"Priority","Microsoft.VSTS.Common.Rating":"Rating","Microsoft.VSTS.Common.ResolvedDate":"ResolvedDate","Microsoft.VSTS.Common.ResolvedReason":"ResolvedReason","Microsoft.VSTS.Common.Risk":"Risk","Microsoft.VSTS.Common.Severity":"Severity","Microsoft.VSTS.Common.StackRank":"StackRank","Microsoft.VSTS.Common.TimeCriticality":"TimeCriticality","Microsoft.VSTS.Common.Triage":"Triage","Microsoft.VSTS.Common.ValueArea":"ValueArea","Microsoft.VSTS.Scheduling.CompletedWork":"CompletedWork","Microsoft.VSTS.Scheduling.DueDate":"DueDate","Microsoft.VSTS.Scheduling.Effort":"Effort","Microsoft.VSTS.Scheduling.FinishDate":"FinishDate","Microsoft.VSTS.Scheduling.OriginalEstimate":"OriginalEstimate","Microsoft.VSTS.Scheduling.RemainingWork":"RemainingWork","Microsoft.VSTS.Scheduling.Size":"Size","Microsoft.VSTS.Scheduling.StartDate":"StartDate","Microsoft.VSTS.Scheduling.StoryPoints":"StoryPoints","Microsoft.VSTS.Scheduling.TargetDate":"TargetDate","Microsoft.VSTS.CMMI.Blocked":"Blocked","Microsoft.VSTS.CMMI.Committed":"Committed","Microsoft.VSTS.CMMI.Escalate":"Escalate","Microsoft.VSTS.CMMI.FoundInEnvironment":"FoundInEnvironment","Microsoft.VSTS.CMMI.HowFound":"HowFound","Microsoft.VSTS.CMMI.Probability":"Probability","Microsoft.VSTS.CMMI.RequirementType":"RequirementType","Microsoft.VSTS.CMMI.RequiresReview":"RequiresReview","Microsoft.VSTS.CMMI.RequiresTest":"RequiresTest","Microsoft.VSTS.CMMI.RootCause":"RootCause","Microsoft.VSTS.CMMI.SubjectMatterExpert1":"SubjectMatterExpert1","Microsoft.VSTS.CMMI.SubjectMatterExpert2":"SubjectMatterExpert2","Microsoft.VSTS.CMMI.SubjectMatterExpert3":"SubjectMatterExpert3","Microsoft.VSTS.CMMI.TargetResolveDate":"TargetResolveDate","Microsoft.VSTS.CMMI.TaskType":"TaskType","Microsoft.VSTS.CMMI.UserAcceptanceTest":"UserAcceptanceTest","Microsoft.VSTS.TCM.AutomatedTestId":"AutomatedTestId","Microsoft.VSTS.TCM.AutomatedTestName":"AutomatedTestName","Microsoft.VSTS.TCM.AutomatedTestStorage":"AutomatedTestStorage","Microsoft.VSTS.TCM.AutomatedTestType":"AutomatedTestType","Microsoft.VSTS.TCM.AutomationStatus":"AutomationStatus"},r.tagsReferenceName="System.Tags"}("WitFieldUtilities")}),["Resources","AggregationFieldsQuery","BacklogsQuery","DataContracts","IterationsQuery","ProcessesQuery","TeamsQuery","WitFieldUtilities"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-analytics.analytics-boards-queries"}}));