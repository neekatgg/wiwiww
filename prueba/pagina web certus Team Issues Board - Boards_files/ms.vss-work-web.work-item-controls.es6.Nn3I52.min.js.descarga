"use strict";define("Wit/Common/WorkItemControls",["require","exports","VSS/Core/Observable","react","VSSUI/Components/Dropdown/Dropdown","VSSUI/Dropdown","VSSUI/EditableDropdown","VSSUI/ListBox","VSSUI/Table","VSSUI/TooltipEx","VSSUI/TreeEx","VSSUI/Util","VSSUI/Utilities/DropdownSelection","Tfs/Platform/Page","VSS/Platform/Layout","VSSUI/DatePicker","VSSUI/Dialog","Wit/Common/DateUtils","VSS/Platform/Util/Storage","VSSUI/Button","VSSUI/Callout","VSSUI/Spinner","VSSUI/SplitButton","VSSUI/TextField","Wit/UI/WorkItemTypeIcon","VSS/Features/Identities/IdentityPickerProvider","VSS/Platform/Feature","VSSUI/IdentityPicker","Wit/Common/Constants/FeatureFlags","Wit/Common/Generated/Constants","Wit/Common/Utilities/FormatUtils","Wit/Common/Utilities/Identity","Wit/Common/WITMeMacroPeoplePickerProvider","Wit/Common/WiqlOperators","Wit/Common/WorkItemFieldService/IWorkItemFieldService","Wit/Identity/Utilities/WorkItemIdentityHelper"],(function(e,t,n,o,a,l,r,i,s,c,d,u,m,v,p,f,g,I,b,y,S,w,C,h,x,T,N,D,k,E,P,O,F,V,A,W){var U,j,L,B,R,M,z,_;U=t[_="Resources"]={},t[_].AddAtSelection="Add at selection",t[_].AddToBottom="Add to bottom",t[_].AddToTop="Add to top",t[_].Cancel="Cancel",t[_].ChangeDestination="Change destination",t[_].NewWorkItemDropdownAriaLabel="Select new work item type.",t[_].Ok="OK",t[_].SelectDate="Select Date",t[_].SuggestionsHeader="Suggestions",function(e){j=t[e]={},t[e].FutureDate=new Date(2533707648e5)}("Constants"),function(e){L=t[e]={};t[e].NodeTreeItemProvider=class{constructor(e,t){this.itemCollection=new n.ObservableCollection,this.itemCollection.push(e),this.itemCollection.push(t)}get length(){return this.itemCollection.length}get value(){return this.itemCollection.value}subscribe(e,t){return this.itemCollection.subscribe(e,t)}unsubscribe(e,t){return this.itemCollection.unsubscribe(e,t)}}}("NodeTreeItemProvider"),function(e){B=t[e]={},t[e].convertNodesToListBoxItems=function a(l,r){const i={id:l.identifier,data:l,parent:r,text:o(l.path)},s=[i];if(l.hasChildren){const o=0===l.structureType?n:t[e].compareIterations,r=[...l.children].sort(o);for(const e of r)s.push(...a(e,i))}return s};const n=(e,t)=>e.name.localeCompare(t.name);function o(e,t="\\"){if(!e)return"";e.startsWith(t)&&(e=e.substring(1));const n=e.split("\\");return n.splice(1,1),n.join(t)}t[e].compareIterations=(e,t)=>{const n=e.attributes&&e.attributes.startDate||j.FutureDate,o=t.attributes&&t.attributes.startDate||j.FutureDate;return n!==o?n.getTime()-o.getTime():e.name.localeCompare(t.name)},t[e].normalizePath=o,t[e].isEmpty=function(e){return!e||Object.getPrototypeOf(e)===Object.prototype&&0===Object.keys(e).length}}("NodeUtils"),function(e){R=t[e]={},t[e].NodeTreeDropdown=o.forwardRef(((e,t)=>{const{additionalColumns:s,items:c,mruNodes:d,onSetPath:u,onValueChange:p,selectedText:f}=e,g=__rest(e,["additionalColumns","items","mruNodes","onSetPath","onValueChange","selectedText"]),y=e.additionalColumns?[...v,...e.additionalColumns]:v,[S]=(0,n.useObservableArray)(I(c.value,null==d?void 0:d.value)),w=o.useRef(new L.NodeTreeItemProvider(S,c)),C=o.useRef(new Map),h=o.useRef(new m.DropdownSelection),x=e=>{const t=w.current.value.filter((e=>(0,i.isListBoxItemVisible)(e))).findIndex((t=>!b(t)&&t.text===e));t>-1&&h.current.select(t)},T=()=>{if(!f)return;const e=n.ObservableLike.getValue(f),t=c.value.find((t=>t.text===e));let o=null==t?void 0:t.parent;for(;o;)o.expanded=!0,C.current.set(o.id,!0),o=o.parent;x(e)},N=()=>{S.value=I(c.value,null==d?void 0:d.value);for(const e of c.value){const t=C.current.get(e.id);void 0!==t&&(e.expanded=t)}T()};return o.useEffect((()=>{const e=c.subscribe(N),t=null==d?void 0:d.subscribe(N),o=n.ObservableLike.isObservable(f)&&f.subscribe(T);return()=>{c.unsubscribe(e),d&&t&&d.unsubscribe(t),o&&n.ObservableLike.isObservable(f)&&f.unsubscribe(o)}}),[c,d,f]),o.useEffect(T,[f]),o.createElement(r.EditableDropdown,Object.assign({allowClear:!1,allowTextSelection:!0,className:"node-tree-dropdown",columns:y,filterMatchedItem:e=>(0,a.filterMatchedItemByListboxType)(e)&&!b(e),items:w.current,onToggle:(e,t)=>{if(t.expanded=!t.expanded,C.current.set(t.id,t.expanded),!f)return;const o=n.ObservableLike.getValue(f);x(o)},onValueChange:e=>{if(u)if((0,B.isEmpty)(null==e?void 0:e.data))(null==e?void 0:e.text)?u(null==e?void 0:e.text):u("");else{const t=e.data.path;u((0,B.normalizePath)(t))}p&&p(e)},ref:t,renderCallout:e=>o.createElement(l.DropdownCallout,Object.assign({},e,{containerClassName:"node-tree-dropdown-callout"})),renderExpandable:e=>{const t=Object.assign({autoSelect:!0},e);return o.createElement(l.DropdownExpandableTextField,Object.assign({},t))},selectedText:f,selection:h.current,showTree:!0,minCalloutWidth:400},g))}));const v=[{id:"title",width:new n.ObservableValue(-100),renderCell:function(e,t,n,a){if(3===a.underlyingItem.data.type)return o.createElement(s.SimpleTableCell,{className:(0,u.css)(a.className,n.className),contentClassName:"divider-cell",columnIndex:t,colspan:2,key:a.underlyingItem.id,tableColumn:n},o.createElement("div",{className:"bolt-list-box-divider flex-grow"}));const l=a.underlyingItem,r=(0,B.isEmpty)(l.data.data)||b(l.data)?l.text:l.data.data.name;return o.createElement(d.ExpandableTreeCell,{className:(0,u.css)(a.className,n.className),columnIndex:t,key:`title-cell-${e}-${t}`,treeColumn:n,treeItem:a},o.createElement(c.Tooltip,{overflowOnly:!0},o.createElement("span",{className:"text-ellipsis"},r)))}}];const p={id:"suggestions-header",text:U.SuggestionsHeader,type:2},f={id:"suggestions-divider",type:3},g="mru-items";function I(e,t){if(!(null==t?void 0:t.length)||!e.length)return[];const n=[];for(const o of t){const t=e.find((e=>!(0,B.isEmpty)(null==e?void 0:e.data)&&e.data.id===o)),a=null==t?void 0:t.data;a&&n.push({id:`mru-${o}`,data:a,text:(0,B.normalizePath)(a.path),groupId:g})}return[p,...n,f]}function b(e){return e.groupId===g}}("NodeTreeDropdown"),function(e){M=t[e]={},t[e].AreaPathDropdown=o.forwardRef(((e,t)=>{var a;const{items:l,macros:r,onSetPath:s,onValueChange:c,projectId:d,selectDefaultValue:u}=e,m=__rest(e,["items","macros","onSetPath","onValueChange","projectId","selectDefaultValue"]),{pageContext:f}=(0,p.useComponentContext)(),g=(0,v.getTFSPageData)(f),I=o.useRef([]),b=r&&((0,i.wrapListBoxItems)(r)||r),y=n.ObservableLike.isObservable(l)?l:new n.ObservableArray(null!==(a=l)&&void 0!==a?a:b),[S]=(0,n.useObservableArray)([]),w=o.useRef(new n.ObservableArray(y.value.concat(I.current)));return o.useEffect((()=>{w.current.value=y.value.concat(I.current)}),[y.length]),o.useEffect((()=>{l?u&&y.length&&y.value[0].text&&(null==s||s(y.value[0].text)):(async()=>{var e;const t=null!=d?d:null===(e=null==g?void 0:g.project)||void 0===e?void 0:e.id;if(!l&&t){const e=f.getService("IWorkItemNodeService"),n=await e.getAreaPathNodes(t);n&&(I.current=(0,B.convertNodesToListBoxItems)(n),w.current.value=y.value.concat(I.current),u&&(null==s||s((0,B.normalizePath)(n.path))))}})(),(async()=>{var e;const t=null!=d?d:null===(e=null==g?void 0:g.project)||void 0===e?void 0:e.id;if(t){const e=f.getService("IWorkItemNodeService");S.value=await e.getMruAreaPaths(t)}})()}),[d]),o.createElement(R.NodeTreeDropdown,Object.assign({allowFreeform:!!r,items:l?y:w.current,mruNodes:S,onValueChange:async e=>{var t;c&&c(e),null==s||s((null==e?void 0:e.text)||"");const n=null!=d?d:null===(t=null==g?void 0:g.project)||void 0===t?void 0:t.id;if(!n||(0,B.isEmpty)(null==e?void 0:e.data))return;const o=e.data,a=f.getService("IWorkItemNodeService");S.value=await a.updateMruAreaPaths(n,[o.id])},ref:t},m))}))}("AreaPathDropdown"),function(e){t[e]={},t[e].DatePickerDialog=function(e){const[t,n]=(0,o.useState)();return o.createElement(g.Dialog,{titleProps:{text:U.SelectDate},onDismiss:()=>e.onDismiss,footerButtonProps:[{text:U.Cancel,onClick:()=>e.onDismiss()},{text:U.Ok,onClick:()=>e.onDismiss(t),primary:!0}]},o.createElement("div",{className:"scroll-auto flex-grow flex-row"},o.createElement(f.DatePicker,{containerClassName:"full-width",onChange:e=>{n(e)},value:t})))}}("DatePickerDialog"),function(e){z=t[e]={},t[e].IterationDropdown=o.forwardRef(((e,t)=>{var l;const{items:r,macros:s,onValueChange:c,projectId:d}=e,u=__rest(e,["items","macros","onValueChange","projectId"]),{pageContext:m}=(0,p.useComponentContext)(),f=(0,v.getTFSPageData)(m),g=o.useRef([]),I=s&&((0,i.wrapListBoxItems)(s)||s),b=n.ObservableLike.isObservable(r)?r:new n.ObservableArray(null!==(l=r)&&void 0!==l?l:I),[y]=(0,n.useObservableArray)([]),S=o.useRef(new n.ObservableArray(b.value.concat(g.current)));return o.useEffect((()=>{S.current.value=b.value.concat(g.current)}),[b.length]),o.useEffect((()=>{r||(async()=>{var e;const t=null!=d?d:null===(e=null==f?void 0:f.project)||void 0===e?void 0:e.id;if(!r&&t){const e=m.getService("IWorkItemNodeService"),n=await e.getIterationNodes(t);n&&(g.current=(0,B.convertNodesToListBoxItems)(n),S.current.value=b.value.concat(g.current))}})(),(async()=>{var e;const t=null!=d?d:null===(e=null==f?void 0:f.project)||void 0===e?void 0:e.id;if(t){const e=m.getService("IWorkItemNodeService");y.value=await e.getMruIterations(t)}})()}),[d]),o.createElement(R.NodeTreeDropdown,Object.assign({allowFreeform:!!s,additionalColumns:a,items:r?b:S.current,mruNodes:y,onValueChange:async e=>{var t;c&&c(e);const n=null!=d?d:null===(t=null==f?void 0:f.project)||void 0===t?void 0:t.id;if(!n||(0,B.isEmpty)(null==e?void 0:e.data))return;const o=e.data,a=m.getService("IWorkItemNodeService");y.value=await a.updateMruIterations(n,[o.id])},ref:t},u))}));const a=[{id:"iteration-dates",width:new n.ObservableValue(-50),renderCell:function(e,t,n,a){var r;const i=null===(r=a.underlyingItem.data.data)||void 0===r?void 0:r.attributes,d=`iteration-dates-cell-${e}-${t}`;let m=null;if(i){const e=i.startDate,t=i.finishDate;if(e&&t){const n=`${l.format((0,I.getDateInUTC)(e))} - ${l.format((0,I.getDateInUTC)(t))}`;m=o.createElement(c.Tooltip,{overflowOnly:!0},o.createElement("span",{className:"text-ellipsis"},n))}}return o.createElement(s.SimpleTableCell,{className:(0,u.css)(n.className,a.className),columnIndex:t,contentClassName:"justify-end",key:d,tableColumn:n},m)}}],l=new Intl.DateTimeFormat(void 0,{year:"numeric",month:"numeric",day:"numeric"})}("IterationDropdown"),function(e){t[e]={};const a="backlogStackRankDirection";function r(e){const{colorAndIcons:t,selectedType:n}=e,a=__rest(e,["colorAndIcons","selectedType"]),r=t.map((e=>({iconProps:{render:()=>o.createElement(x.WorkItemTypeIcon,{className:"margin-horizontal-8",data:e,suppressTooltip:!0})},id:e.workItemTypeName,text:e.workItemTypeName}))),i=new m.DropdownSelection,s=r.findIndex((e=>e.text===n));return s>-1&&i.select(s),o.createElement(l.Dropdown,Object.assign({ariaLabel:U.NewWorkItemDropdownAriaLabel,items:r,selection:i},a))}t[e].NewItemCallout=function({allowedPositions:e,anchor:t,colorAndIcons:l,getLocalStorageKeyForWorkItemType:i,getBacklogDefaultWorkItemTypeNameFetcher:s,onAddItem:c,onDismiss:d,keepOpenAfterAddingItem:u}){if(0===l.length)return null;const[m]=(0,n.useObservable)("");let v=(0,b.tryGetLocalStorageValue)(a);(null==e?void 0:e.length)&&!e.some((e=>e===v))&&(v=e[0]);const p=e=>{I(e.id),(0,b.trySetLocalStorageValue)(a,e.id)},f=o.useMemo((()=>{const t=[];return e&&!e.some((e=>"top"===e))||t.push({id:"top",text:U.AddToTop,onActivate:p}),e&&!e.some((e=>"bottom"===e))||t.push({id:"bottom",text:U.AddToBottom,onActivate:p}),e&&!e.some((e=>"selection"===e))||t.push({id:"selection",text:U.AddAtSelection,onActivate:p}),t}),[e]),[g,I]=o.useState((()=>v||"top")),T=i?i():"new-item-callout-witType",N=(0,b.tryGetLocalStorageValue)(T),D=l.find((e=>e.workItemTypeName===N)),[k,E]=o.useState();o.useEffect((()=>{var e;if(D)E(D.workItemTypeName);else if(s){const{teamId:t,backlog:n}=null!==(e=s.context)&&void 0!==e?e:{};s.service.getBacklogDefaultWorkItemTypeName(t,n).then((e=>{E(l.find((t=>t.workItemTypeName===e))&&e||l[0].workItemTypeName)})).catch((()=>{E(l[0].workItemTypeName)}))}else E(l[0].workItemTypeName)}),[]);const P=e=>o.createElement(S.Callout,{anchorElement:t,anchorOrigin:{horizontal:"end",vertical:"end"},className:"new-item-callout",contentClassName:"flex-row flex-center padding-8 subtle-border depth-8",escDismiss:!0,focuszoneProps:{circularNavigation:!0,defaultActiveElement:".new-item-name-textbox",direction:1,focusOnMount:!0,handleTabKey:!0},lightDismiss:!0,onDismiss:d},e);if(!k)return P(o.createElement(w.Spinner,{size:"small"}));const O=()=>{null==c||c(m.value,k,g),u||d(),m.value=""},F={text:"top"===g?U.AddToTop:"bottom"===g?U.AddToBottom:U.AddAtSelection,onClick:O};return P(o.createElement(o.Fragment,null,1===l.length?o.createElement(x.WorkItemTypeIcon,{className:"margin-right-8",data:l[0],size:1}):o.createElement(r,{className:"margin-right-8",colorAndIcons:l,onSelect:(e,t)=>{E(t.text),(0,b.trySetLocalStorageValue)(T,t.text)},selectedType:k,width:150}),o.createElement(h.TextField,{autoFocus:!0,className:"new-item-name-textbox margin-right-8",value:m,onChange:(e,t)=>m.value=t,onKeyPress:e=>"Enter"===e.key&&O()}),f.length>1?o.createElement(C.SplitButton,{primary:!0,buttonProps:F,menuButtonProps:{ariaLabel:U.ChangeDestination,contextualMenuProps:{menuProps:{id:"directionMenu",items:f}}}}):o.createElement(y.Button,Object.assign({primary:!0},F))))},t[e].WorkItemDropdown=r}("NewItemCallout"),function(e){t[e]={};t[e].WorkItemFieldControl=e=>{const{className:t,disabled:n,fieldName:r,includeIterationMacros:i,initialValue:c,onChange:d}=e,u=(0,p.usePageContext)(),m=(0,A.getWorkItemFieldService)(u),[v,f]=o.useState(!1),[g,I]=o.useState((()=>{var t,n;let o=null!==(t=e.fieldEntry)&&void 0!==t?t:null===(n=e.field)||void 0===n?void 0:n.fieldDefinition;return!o&&r&&(o=m.getFieldByReferenceName(r)),o}));if(o.useEffect((()=>{if(!g&&r){(async()=>{f(!0),await m.getFieldsAsync();const e=m.getFieldByReferenceName(r);I(e),f(!1)})()}})),o.useEffect((()=>{e.fieldEntry&&I(e.fieldEntry)}),[e.fieldEntry]),v)return o.createElement(w.Spinner,null);const b=Object.assign(Object.assign({},e),{fieldEntry:g});return(null==g?void 0:g.isIdentity)?o.createElement(a,Object.assign({},b)):(null==g?void 0:g.type)===E.FieldType.DateTime?o.createElement(l,Object.assign({},b)):(null==g?void 0:g.referenceName)===E.CoreFieldRefNames.AreaPath?o.createElement(M.AreaPathDropdown,{className:t,disabled:n,onSetPath:e=>{d&&d(e,e!==c)},selectedText:null==c?void 0:c.toString()}):(null==g?void 0:g.referenceName)===E.CoreFieldRefNames.IterationPath?o.createElement(z.IterationDropdown,{className:t,disabled:n,macros:i?V.IterationPathMacros:void 0,onSetPath:e=>{d&&d(e,e!==c)},selectedText:null==c?void 0:c.toString()}):o.createElement(s,Object.assign({},b))};const a=({className:e,disabled:t,field:a,initialValue:l,onChange:r,useMacroMePickerProvider:i,excludeServicePrincipals:s,fieldEntry:c})=>{var d;const u=null===(d=null==a?void 0:a.filterByScope)||void 0===d?void 0:d.excludeGroups,{pageContext:m}=(0,p.useComponentContext)(),v=function(e,t){if(!t)return;"string"==typeof t&&(t=(0,W.convertWorkItemIdentityRefFromFieldValue)(e,t));return(0,W.isWorkItemIdentityRef)(t)?(0,W.convertWorkItemIdentityRefToIIdentity)(e,t):(0,W.isIdentityRef)(t)?(0,W.convertIdentityRefToIIdentity)(e,t):void 0}(m,l),[f]=(0,n.useObservable)(v),[g,I]=o.useState(void 0),b=(0,N.isFeatureFlagEnabled)(m,k.FeatureFlags.NonIdentityValuesDisabled,!1);o.useEffect((()=>{(async()=>{if(b)return;const e=(0,A.getWorkItemFieldService)(m);let t;a?t=await e.getAllowedValues(a.fieldDefinition.referenceName,a.workItem.project.guid,a.fieldDefinition.workItemType.name):c&&(t=await e.getAllowedValues(c.referenceName)),I(t)})()}),[I]);const y=o.useMemo((()=>{const e=new(i?F.WITMeMacroPeoplePickerProvider:T.PeoplePickerProvider)(m,{identityTypes:(0,O.getAllowedIdentityTypes)(m,{excludeServicePrincipals:s,excludeGroups:u})});return!b&&e.setAdditionalEntries&&g&&e.setAdditionalEntries(g),e}),[m,s,u,i,g]);return o.createElement(D.IdentityPickerDropdown,{className:e,disabled:t,onChange:e=>{if(f.value=e,r){const t=e&&(0,W.convertIIdentityToWorkItemIdentityRef)(m,e),n=v&&(0,W.convertIIdentityToWorkItemIdentityRef)(m,v);r(t,(null==t?void 0:t.distinctDisplayName)!==(null==n?void 0:n.distinctDisplayName))}},pickerProvider:y,value:f})};const l=({className:e,datePickerExpandOnMount:t,datePickerOnCollapse:a,disabled:l,initialValue:r,onChange:i})=>{const s=r instanceof Date?(0,I.getDateInUserTimeZone)(r):void 0,[c]=(0,n.useObservable)(s);return o.createElement(f.DatePicker,{className:e,disabled:l,expandOnMount:t,showClear:!0,value:c,onChange:e=>{const t=e?(0,I.getDateInClientTimeZone)(e):void 0;c.value=t,i&&i(t,(null==t?void 0:t.getTime())!==(null==s?void 0:s.getTime()))},onCollapse:a})},s=({allowFreeform:e,allowedValues:t,autoSelect:a,className:l,disabled:s,fieldEntry:c,inputType:d,initialValue:u,onChange:v})=>{var f,g;const[I]=(0,n.useObservableArray)(null!==(f=(0,i.wrapListBoxItems)(null!=t?t:[]))&&void 0!==f?f:[]),b=null==u?void 0:u.toString(),{pageContext:y}=(0,p.useComponentContext)(),S=!(0,N.isFeatureFlagEnabled)(y,k.FeatureFlags.DecimalFieldsCommaFixIsDisabled,!1),w=(null==c?void 0:c.type)===E.FieldType.Double&&S?null===(g=(0,P.getNumberInUserFormat)(u))||void 0===g?void 0:g.toString():b,[C]=(0,n.useObservable)(w),x=new m.DropdownSelection;if(o.useEffect((()=>{var e;if(I.value=null!==(e=(0,i.wrapListBoxItems)(null!=t?t:[]))&&void 0!==e?e:[],t){const e=t.findIndex((e=>e===b));e>=0&&x.selectable(e)&&x.select(e)}})),t&&t.length>0)return o.createElement(r.EditableDropdown,{allowFreeform:null==e||e,allowTextSelection:!0,autoSelect:null!=a&&a,className:l,disabled:s,items:I,onValueChange:e=>{e||x.clear();const t=null==e?void 0:e.text;C.value=t,v&&v(t,t!==b)},selectedText:b,selection:x,minCalloutWidth:180});{const e=(null==c?void 0:c.type)===E.FieldType.Integer||!S&&(null==c?void 0:c.type)===E.FieldType.Double,t=t=>{switch(t){case"text":case"number":case"password":case"button":return t;default:return e?"number":"text"}},n=t(d);return o.createElement(h.TextField,{autoSelect:null!=a&&a,containerClassName:l,className:l,disabled:s,inputType:n,value:C,onChange:(e,t)=>{C.value=t,v&&v(t,t!==b)}})}}}("WorkItemFieldControl")}),["Resources","Constants","NodeTreeItemProvider","NodeUtils","NodeTreeDropdown","AreaPathDropdown","DatePickerDialog","IterationDropdown","NewItemCallout","WorkItemFieldControl"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-controls"}}));