"use strict";define("Wit/WorkItemLinksRegistration",["require","exports","Wit/WorkItemModel/OM/index","VSS/Core/Util/String","VSS/Platform/Context","react","VSS/Platform/Layout","Wit/Common/DateUtils","VSSUI/Ago","VSS/Platform/Components/Format/Format"],(function(e,t,n,i,o,r,s,a,l,c){var d,u,p,k,T,y,m,L,g,v,I;d=t[I="Resources"]={},t[I].LinkTypeRelated="Related",t[I].LinkTypeHyperlink="Hyperlink",t[I].LinkTypeChangeset="Changeset",t[I].LinkTypeVersionedItem="Versioned Item",t[I].LinkTypeCommit="Commit",t[I].LinkTypeBranch="Branch",t[I].LinkTypeTag="Tag",t[I].LinkTypePullRequest="Pull Request",t[I].LinkTypeResultAttachment="Result Attachment",t[I].LinkTypeTestResult="Test Result",t[I].LinkTypeTest="Test",t[I].LinkTypeStoryboard="Storyboard",t[I].LinkTypeBuild="Build",t[I].LinkTypeFoundInBuild="Found in build",t[I].LinkTypeIntegratedInBuild="Integrated in build",t[I].LinkTypeWikiPage="Wiki page",t[I].LinkTypeGitHubPullRequest="GitHub Pull Request",t[I].LinkTypeGitHubCommit="GitHub Commit",t[I].LinkTypeGitHubIssue="GitHub Issue",t[I].LinkTypeReleaseEnvironment="Integrated in release stage",t[I].LinkToolTypeCode="Code",t[I].LinkToolTypeTest="Test",t[I].LinkToolTypeRequirements="Requirements",t[I].LinkToolTypeBuild="Build",t[I].LinkToolTypeWiki="Wiki",t[I].LinkToolTypeGitHub="GitHub",t[I].LinkToolTypeWork="Work",t[I].LinkToolTypeRemoteWork="Remote Work",t[I].LinkUpdatedAtTime="Updated {0}",t[I].ErrorLinkCouldNotBeRead="{0} link could not be read",t.Contracts={},function(e){u=t[e]={},Object.defineProperty(t[e],"RegisteredLinkTypeNames",{enumerable:!0,get:function(){return n.RegisteredLinkTypeNames}}),t[e].ToolIds={VersionControl:"VersionControl",WorkItemTracking:"WorkItemTracking",RemoteWorkItemTracking:"RemoteWorkItemTracking",TeamBuild:"Build",TestManagement:"TestManagement",Requirements:"Requirements",Hyperlink:"Hyperlink",Legacy:"Legacy",CodeSense:"CodeSense",Git:"Git",CodeReview:"CodeReview",ProjectDownload:"ProjectDownload",Wiki:"Wiki",GitHub:"GitHub",ReleaseManagement:"ReleaseManagement"},t[e].ArtifactTypeNames={TcmResult:"TcmResult",TcmResultAttachment:"TcmResultAttachment",TcmTest:"TcmTest",Build:"Build",VersionedItem:"VersionedItem",LatestItemVersion:"LatestItemVersion",Changeset:"Changeset",Shelveset:"Shelveset",WorkItem:"WorkItem",Storyboard:"Storyboard",Commit:"Commit",CodeReviewId:"CodeReviewId",CodeReviewSdkId:"ReviewId",PullRequestId:"PullRequestId",ProjectDownloadProject:"Project",Ref:"Ref",WikiPage:"WikiPage",PullRequest:"PullRequest",Issue:"Issue"},t[e].LinkTypeFieldIds={Attachment:50,Hyperlink:51,ExternalLink:58,WorkItem:37}}("Constants"),function(e){function n(e){switch(e){case u.RegisteredLinkTypeNames.Related:return d.LinkTypeRelated;case u.RegisteredLinkTypeNames.Hyperlink:return d.LinkTypeHyperlink;case u.RegisteredLinkTypeNames.Changeset:return d.LinkTypeChangeset;case u.RegisteredLinkTypeNames.VersionedItem:return d.LinkTypeVersionedItem;case u.RegisteredLinkTypeNames.Commit:return d.LinkTypeCommit;case u.RegisteredLinkTypeNames.Branch:return d.LinkTypeBranch;case u.RegisteredLinkTypeNames.Tag:return d.LinkTypeTag;case u.RegisteredLinkTypeNames.PullRequest:return d.LinkTypePullRequest;case u.RegisteredLinkTypeNames.ResultAttachment:return d.LinkTypeResultAttachment;case u.RegisteredLinkTypeNames.TestResult:return d.LinkTypeTestResult;case u.RegisteredLinkTypeNames.Test:return d.LinkTypeTest;case u.RegisteredLinkTypeNames.Storyboard:return d.LinkTypeStoryboard;case u.RegisteredLinkTypeNames.Build:return d.LinkTypeBuild;case u.RegisteredLinkTypeNames.FoundInBuild:return d.LinkTypeFoundInBuild;case u.RegisteredLinkTypeNames.IntegratedInBuild:return d.LinkTypeIntegratedInBuild;case u.RegisteredLinkTypeNames.WikiPage:return d.LinkTypeWikiPage;case u.RegisteredLinkTypeNames.GitHubPullRequestLinkType:return d.LinkTypeGitHubPullRequest;case u.RegisteredLinkTypeNames.GitHubCommitLinkType:return d.LinkTypeGitHubCommit;case u.RegisteredLinkTypeNames.GitHubIssueLinkType:return d.LinkTypeGitHubIssue;case u.RegisteredLinkTypeNames.ReleaseEnvironment:return d.LinkTypeReleaseEnvironment;default:return e}}p=t[e]={},t[e].getLinkTypeDisplayName=n,t[e].getToolDisplayName=function(e,t){switch(e){case u.ToolIds.VersionControl:case u.ToolIds.Git:return d.LinkToolTypeCode;case u.ToolIds.TestManagement:return d.LinkToolTypeTest;case u.ToolIds.Requirements:return d.LinkToolTypeRequirements;case u.ToolIds.TeamBuild:return d.LinkToolTypeBuild;case u.ToolIds.Wiki:return d.LinkToolTypeWiki;case u.ToolIds.GitHub:return d.LinkToolTypeGitHub;default:return t?d.LinkToolTypeRemoteWork:d.LinkToolTypeWork}},t[e].isSameLinkIdentifier=function(e,t){return e.FldID===t.FldID&&e.ExtID===t.ExtID&&e.FilePath===t.FilePath&&e.ID===t.ID&&e.OriginalName===t.OriginalName},t[e].makePlaceholderForUnresolvedLinkIdentifier=function(e,t,o){var r;const s=e.FldID===u.LinkTypeFieldIds.ExternalLink?e.OriginalName:e.FldID===u.LinkTypeFieldIds.WorkItem?u.RegisteredLinkTypeNames.Related:e.FldID===u.LinkTypeFieldIds.Hyperlink?u.RegisteredLinkTypeNames.Hyperlink:void 0;if(s)return{linkIdentifier:e,icons:[{iconName:"AlertSolid",className:"error-text icon-margin"}],id:e.ID?e.ID.toString():null!==(r=e.FilePath)&&void 0!==r?r:"ID",displayId:e.ID?e.ID.toString():"",title:(0,i.format)(d.ErrorLinkCouldNotBeRead,t||n(s)),tool:e.tool,linkTypeDisplayName:t||n(s),registeredLinkType:s,uri:"#",additionalData:{isPlaceholderForUnresolvedLinkIdentifier:!0},witLinkTypeEnd:o}},t[e].isPlaceholderForUnresolvedLinkIdentifier=function(e){var t;return null===(t=e.additionalData)||void 0===t?void 0:t.isPlaceholderForUnresolvedLinkIdentifier}}("LinkUtils"),function(e){let n;k=t[e]={};class i{constructor(){this.displayDataByKey=new Map}static getInstance(){return n||(n=new i),n}get(e){const t=this.constructCacheKey(e);return this.displayDataByKey.get(t)}set(e,t){if((0,p.isPlaceholderForUnresolvedLinkIdentifier)(t))return;const n=this.constructCacheKey(e);this.displayDataByKey.set(n,t)}clear(e){const t=this.constructCacheKey(e);this.displayDataByKey.delete(t)}constructCacheKey(e){var t,n,i,o,r,s;return`tool:${e.tool}, ID:${null!==(t=e.ID)&&void 0!==t?t:"None"}, ExtID:${e.ExtID}, field:${e.FldID}, linkType:${null!==(n=e.LinkType)&&void 0!==n?n:"None"}, originalName:${null!==(i=e.OriginalName)&&void 0!==i?i:"None"}, filePath:${null!==(o=e.FilePath)&&void 0!==o?o:"None"}, updateDate:${null!==(r=e.LastWriteDate)&&void 0!==r?r:"None"}, comment:${null!==(s=e.Comment)&&void 0!==s?s:"None"}`}}t[e].ArtifactCache=i}("ArtifactCache"),t.IRegisteredLinkTypeService={},function(e){T=t[e]={};const n=new Map,i=new Map([[u.ToolIds.WorkItemTracking,"work-item-link-type-service"],[u.ToolIds.RemoteWorkItemTracking,"remote-work-item-link-type-service"],[u.ToolIds.GitHub,"github-link-type-service"],[u.ToolIds.TeamBuild,"build-link-type-service"],[u.ToolIds.Git,"git-link-type-service"],[u.ToolIds.TestManagement,"tcm-link-type-service"],[u.ToolIds.VersionControl,"tfvc-link-type-service"],[u.ToolIds.Wiki,"wiki-link-type-service"],[u.ToolIds.Requirements,"requirements-link-type-service"],[u.ToolIds.ReleaseManagement,"release-link-type-service"]]),r=new Map([[u.ToolIds.TeamBuild,"ms.vss-work-web.build-link-type-service"],[u.ToolIds.Git,"ms.vss-work-web.git-link-type-service"],[u.ToolIds.TestManagement,"ms.vss-work-web.tcm-link-type-service"],[u.ToolIds.VersionControl,"ms.vss-work-web.tfvc-link-type-service"],[u.ToolIds.Wiki,"ms.vss-work-web.wiki-link-type-service"],[u.ToolIds.Requirements,"ms.vss-work-web.requirements-link-type-service"],[u.ToolIds.ReleaseManagement,"ms.vss-releaseManagement-web.release-link-type-service"]]),s=new Map([[u.ToolIds.TestManagement,[u.RegisteredLinkTypeNames.Test]]]);t[e].registerLinkTypeService=function(e){n.set(e.getToolId(),e)};class a extends o.VssService{static registerLinkTypeService(e){n.set(e.getToolId(),e)}hasLinkTypeForm(e,t){var n;return i.has(e)&&!(null===(n=s.get(e))||void 0===n?void 0:n.includes(t))}async getRegisteredLinkTypeService(e){const t=n.get(e);if(t)return t;const o=i.get(e);if(!o)return;try{return this.pageContext.getService(o)}catch(e){}const s=r.get(e);if(!s)return;const a=this.pageContext.getService("IVssContributionService");try{return await a.getService(s)}catch(e){return}}}t[e].ILinkTypeRegistryId="link-type-registry",o.Services.add(t[e].ILinkTypeRegistryId,{serviceFactory:a})}("registerLinkTypeService"),function(e){y=t[e]={},t[e].useLinkTypeService=function(e){const t=(0,s.usePageContext)(),n=(0,r.useMemo)((()=>t.getService(T.ILinkTypeRegistryId)),[t]),[i,o]=(0,r.useState)(),a=function(){const e=(0,r.useRef)(!1);return(0,r.useEffect)((()=>(e.current=!1,()=>{e.current=!0})),[]),e}();if((0,r.useEffect)((()=>{(async()=>{o(void 0);const t=await n.getRegisteredLinkTypeService(e);a.current||o(t)})()}),[e]),(null==i?void 0:i.getToolId())===e)return i}}("ComponentsuseLinkTypeService"),function(e){function n({link:e}){return null}m=t[e]={},t[e].LinkTypeAction=function({link:e}){const t=(0,y.useLinkTypeService)(e.tool);return t?t.renderAction(e):r.createElement(n,{link:e})},t[e].DefaultLinkTypeAction=n}("ComponentsLinkTypeAction"),function(e){L=t[e]={},t[e].LinkTypeForm=function({tool:e,onArtifactsUpdated:t,linkType:n,workItemLinkTypeEnd:i,isNew:o,onNewArtifactsUpdated:r,originWorkItems:s,linkableWorkItemTypeFilter:a}){const l=(0,y.useLinkTypeService)(e);return l?o&&l.renderNewLinkTypeForm?l.renderNewLinkTypeForm(e,r,n,s,i,a):l.renderLinkTypeForm(e,t,n,s,i,a):null}}("ComponentsLinkTypeForm"),function(e){function n({link:e}){return r.createElement(r.Fragment,null,e.state)}g=t[e]={},t[e].LinkTypeState=function({link:e}){const t=(0,y.useLinkTypeService)(e.tool);return t?t.renderState(e):r.createElement(n,{link:e})},t[e].DefaultLinkTypeState=n}("ComponentsLinkTypeState"),function(e){function n({link:e}){return e.updateDate?r.createElement(c.FormatComponent,{format:d.LinkUpdatedAtTime},r.createElement(l.Ago,{date:(0,a.getDateInUserTimeZone)(e.updateDate),currentDate:(0,a.getDateInUserTimeZone)(),tooltipTimeFormat:a.tooltipTimeFormat})):null}v=t[e]={},t[e].LinkTypeUpdateDate=function({link:e}){const t=(0,y.useLinkTypeService)(e.tool);return t?t.renderUpdateDate(e):r.createElement(n,{link:e})},t[e].DefaultLinkTypeUpdateDate=n}("ComponentsLinkTypeUpdateDate"),function(e){t[e]={},__exportStar(m,t[e]),__exportStar(L,t[e]),__exportStar(g,t[e]),__exportStar(v,t[e])}("Componentsindex"),function(e){async function n(e,t,n){const i=o(e,t,n),r=await Promise.all(Object.values(i)),s=[];for(const e of r)for(const t of e)s.push(t);const a=await Promise.all(s);let l=[];for(const e of a)l=l.concat(e);const c=e.filter((e=>!l.find((t=>(0,p.isSameLinkIdentifier)(e,t.linkIdentifier))))).map((e=>(0,p.makePlaceholderForUnresolvedLinkIdentifier)(e))).filter((e=>!!e));return l.concat(c)}t[e]={},t[e].resolveArtifact=async function(e,t,i){const[o]=await n([e],t,i);return o},t[e].resolveAllArtifacts=n;const i=new Set;function o(e,t,n){const i=new Map;for(const t of e)i.has(t.tool)?i.get(t.tool).push(t):i.set(t.tool,[t]);const o={};for(const[e,s]of i.entries())o[e]=r(e,s,t,n);return o}async function r(e,t,n,i){const o=k.ArtifactCache.getInstance(),r=[],s=[];for(const e of t){const t=o.get(e);t?s.push(t):r.push(e)}if(0===r.length)return[Promise.resolve(s)];try{const t=await async function(e,t){const n=e.getService(T.ILinkTypeRegistryId),i=await n.getRegisteredLinkTypeService(t).catch((()=>{}));if(!i)return Promise.reject(new Error(`No link type service avaiable for tool ${t}`));return i}(i,e),a=t.resolveArtifacts(r,n);for(const e of a)e.then((e=>{for(const t of e)o.set(t.linkIdentifier,t)}));return[Promise.resolve(s),...a]}catch(e){return console.error("Unable to resolve artifacts: ",t,e),[Promise.resolve(s)]}}t[e].observeArtifactResolution=function(e,t,n,r,s,a,l){if(i.has(r))return;i.add(r);const c=new Array(e.length).fill(void 0);r.value=c;const d=k.ArtifactCache.getInstance();for(const t of e)!0!==s||!t.ID&&t.tool!==u.ToolIds.ReleaseManagement&&t.tool!==u.ToolIds.Git||d.clear(t);const T=o(e,t,n),y={totalTopLevel:Object.keys(T).length,completedTopLevel:0,totalDisplayData:0,completedDisplayData:0},m=()=>{r.removeAll((e=>!e));const t=e.filter((e=>!r.value.find((t=>(0,p.isSameLinkIdentifier)(e,t.linkIdentifier))))).map((e=>{const t=e.LinkType?null==l?void 0:l.get(e.LinkType):void 0;return(0,p.makePlaceholderForUnresolvedLinkIdentifier)(e,null==t?void 0:t.name,null==t?void 0:t.immutableName)})).filter((e=>!!e));t.length>0&&r.push(...t),i.delete(r),a&&(r.value=r.value.sort(a))};if(0!==Object.values(T).length)for(const e of Object.values(T))e.then((e=>{y.completedTopLevel+=1,y.totalDisplayData+=e.length;for(const t of e)t.then((e=>{y.completedDisplayData+=1;for(const t of e){const e=r.value.findIndex((e=>!e));e>-1&&r.splice(e,1,t)}y.totalTopLevel===y.completedTopLevel&&y.totalDisplayData===y.completedDisplayData&&m()})).catch((()=>{y.completedDisplayData+=1,y.totalTopLevel===y.completedTopLevel&&y.totalDisplayData===y.completedDisplayData&&m()}))})).catch((()=>{y.completedTopLevel+=1,y.totalTopLevel===y.completedTopLevel&&m()}));else m()}}("resolveArtifacts"),function(e){t[e]={};class n extends o.VssService{_serviceStart(e){super._serviceStart(e),(0,T.registerLinkTypeService)(this)}renderAction(e){return r.createElement(m.DefaultLinkTypeAction,{link:e})}renderState(e){return r.createElement(g.DefaultLinkTypeState,{link:e})}renderUpdateDate(e){return r.createElement(v.DefaultLinkTypeUpdateDate,{link:e})}}t[e].BaseRegisteredLinkTypeService=n}("BaseRegisteredLinkTypeService")}),["Resources","Contracts","Constants","LinkUtils","ArtifactCache","IRegisteredLinkTypeService","registerLinkTypeService","Components/useLinkTypeService","Components/LinkTypeAction","Components/LinkTypeForm","Components/LinkTypeState","Components/LinkTypeUpdateDate","Components/index","resolveArtifacts","BaseRegisteredLinkTypeService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-links-registration-content"}}));