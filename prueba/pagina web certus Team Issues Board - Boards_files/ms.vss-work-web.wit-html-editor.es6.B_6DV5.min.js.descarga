"use strict";define("Wit/HtmlEditor",["require","exports","roosterjs-react","VSS/Core/Util/String","Mention/AutocompleteResolver/AutocompleteContributionResolverService","VSS/Features/Markdown/Utils/UrlHelper","Mention/Autocomplete/Components/AutocompleteComponent","react","VSS/Core/Observable","VSS/Core/TimerManagement","VSS/Core/Util/Accessibility","VSS/Platform/Layout","VSSUI/Util"],(function(e,t,o,n,r,i,s,l,a,u,d,h,c){var m,_,g,p,C,v,k,b,y,f,E,P,w,R;m=t[R="Resources"]={},t[R].CommandClickToOpen="&#8984;+Click to follow link",t[R].CtrlClickToOpen="CTRL+Click to follow link",t[R].NoSuggestionsFound="No suggestions found",t[R].OK="OK",t[R].Cancel="Cancel",t[R].SearchForEmoji="Search for emoji",t[R].FontColorPicker_AriaLabel="Font color picker",t[R].HeaderMenu_AriaLabel="Header menu",t[R].HighlightColorPicker_AriaLabel="Highlight color picker",t[R].Toolbar_More="More commands",t[R].InsertLink_FieldLabel="Address",t[R].MentionSomeone="Mention someone",t[R].MentionWorkItem="Mention work item",t[R].MentionPullRequest="Mention PR",t[R].Color_Black="Black",t[R].Color_Blue="Blue",t[R].Color_Cyan="Cyan",t[R].Color_DarkBlue="Dark Blue",t[R].Color_DarkerBlue="Darker Blue",t[R].Color_DarkerGray="Darker Gray",t[R].Color_DarkerGreen="Darker Green",t[R].Color_DarkerOrange="Darker Orange",t[R].Color_DarkerPurple="Darker Purple",t[R].Color_DarkerRed="Darker Red",t[R].Color_DarkerYellow="Darker Yellow",t[R].Color_DarkGray="Dark Gray",t[R].Color_DarkGreen="Dark Green",t[R].Color_DarkOrange="Dark Orange",t[R].Color_DarkPurple="Dark Purple",t[R].Color_DarkRed="Dark Red",t[R].Color_DarkYellow="Dark Yellow",t[R].Color_Gray="Gray",t[R].Color_Green="Green",t[R].Color_LightBlue="Light Blue",t[R].Color_LightCyan="Light Cyan",t[R].Color_LightGray="Light Gray",t[R].Color_LightGreen="Light Green",t[R].Color_LightMagenta="Light Magenta",t[R].Color_LightOrange="Light Orange",t[R].Color_LightPurple="Light Purple",t[R].Color_LightRed="Light Red",t[R].Color_LightYellow="Light Yellow",t[R].Color_Magenta="Magenta",t[R].Color_Orange="Orange",t[R].Color_Purple="Purple",t[R].Color_Red="Red",t[R].Color_White="White",t[R].Color_Yellow="Yellow",t[R].OperationFailed="Operation failed: {0}",t[R].Toolbar_Bold="Bold",t[R].Toolbar_BulletedList="Bulleted list",t[R].Toolbar_ClearFormat="Clear format",t[R].Toolbar_Emoji="Insert emoji",t[R].Toolbar_FontColor="Font color",t[R].Toolbar_Header="Header",t[R].Toolbar_HeaderN="Header {0}",t[R].Toolbar_Highlight="Highlight",t[R].Toolbar_Indent="Increase indent",t[R].Toolbar_InsertImage="Insert image",t[R].Toolbar_Italic="Italic",t[R].Toolbar_Link="Create link",t[R].Toolbar_NumberedList="Numbered list",t[R].Toolbar_Outdent="Decrease indent",t[R].Toolbar_Strikethrough="Strikethrough",t[R].Toolbar_Underline="Underline",t[R].Toolbar_Unlink="Remove link",t[R].Toolbar_Code="Code",function(e){_=t[e]={},t[e].CustomButtonKeys={AtMention:"atMention",HashMention:"hashMention",PRMention:"prMention"},t[e].SearchForEmoji=m.SearchForEmoji,t[e].CommandBarLocaleStrings={[o.RoosterCommmandBarButtonKeys.Header]:m.Toolbar_Header,[o.RoosterCommmandBarButtonKeys.Bold]:m.Toolbar_Bold,[o.RoosterCommmandBarButtonKeys.Italic]:m.Toolbar_Italic,[o.RoosterCommmandBarButtonKeys.Underline]:m.Toolbar_Underline,[o.RoosterCommmandBarButtonKeys.BulletedList]:m.Toolbar_BulletedList,[o.RoosterCommmandBarButtonKeys.NumberedList]:m.Toolbar_NumberedList,[o.RoosterCommmandBarButtonKeys.Link]:m.Toolbar_Link,[o.RoosterCommmandBarButtonKeys.Highlight]:m.Toolbar_Highlight,[o.RoosterCommmandBarButtonKeys.ClearFormat]:m.Toolbar_ClearFormat,[o.RoosterCommmandBarButtonKeys.Emoji]:m.Toolbar_Emoji,[o.RoosterCommmandBarButtonKeys.InsertImage]:m.Toolbar_InsertImage,[o.RoosterCommmandBarButtonKeys.Indent]:m.Toolbar_Indent,[o.RoosterCommmandBarButtonKeys.Outdent]:m.Toolbar_Outdent,[o.RoosterCommmandBarButtonKeys.Strikethrough]:m.Toolbar_Strikethrough,[o.RoosterCommmandBarButtonKeys.FontColor]:m.Toolbar_FontColor,[o.RoosterCommmandBarButtonKeys.Unlink]:m.Toolbar_Unlink,[o.RoosterCommmandBarButtonKeys.Code]:m.Toolbar_Code,[o.InsertLinkStringKeys.CancelButton]:m.Cancel,[o.InsertLinkStringKeys.InsertButton]:m.OK,[o.InsertLinkStringKeys.LinkFieldLabel]:m.InsertLink_FieldLabel,[o.InsertLinkStringKeys.Title]:m.Toolbar_Link,header1:(0,n.format)(m.Toolbar_HeaderN,1),header2:(0,n.format)(m.Toolbar_HeaderN,2),header3:(0,n.format)(m.Toolbar_HeaderN,3),black:m.Color_Black,blue:m.Color_Blue,cyan:m.Color_Cyan,darkBlue:m.Color_DarkBlue,darkGray:m.Color_DarkGray,darkGreen:m.Color_DarkGreen,darkOrange:m.Color_DarkOrange,darkPurple:m.Color_DarkPurple,darkRed:m.Color_DarkRed,darkYellow:m.Color_DarkYellow,darkerBlue:m.Color_DarkerBlue,darkerGray:m.Color_DarkerGray,darkerGreen:m.Color_DarkerGreen,darkerOrange:m.Color_DarkerOrange,darkerPurple:m.Color_DarkerPurple,darkerRed:m.Color_DarkerRed,darkerYellow:m.Color_DarkerYellow,gray:m.Color_Gray,green:m.Color_Green,lightBlue:m.Color_LightBlue,lightCyan:m.Color_LightCyan,lightGray:m.Color_LightGray,lightGreen:m.Color_LightGreen,lightMagenta:m.Color_LightMagenta,lightOrange:m.Color_LightOrange,lightPurple:m.Color_LightPurple,lightRed:m.Color_LightRed,lightYellow:m.Color_LightYellow,magenta:m.Color_Magenta,orange:m.Color_Orange,purple:m.Color_Purple,red:m.Color_Red,white:m.Color_White,yellow:m.Color_Yellow}}("ComponentsHtmlEditorStrings"),function(e){g=t[e]={},t[e].createHTMLEditorInputProxy=function(e,t){return new o(e,t)};class o{constructor(e,t){this._contentElement=e,this._getEditor=t,this._listeners=[],this.getElementForAnchor=()=>this._contentElement,this.getClientWidth=()=>this._contentElement.clientWidth,this.setInputAttribute=(e,t)=>this._contentElement.setAttribute(e,t),this.getInputAttribute=e=>this._contentElement.getAttribute(e),this.removeInputAttribute=e=>this._contentElement.removeAttribute(e),this.focus=()=>{var e;return null===(e=this._getEditor())||void 0===e?void 0:e.focus()}}addKeyDownListener(e){this._listeners.push({eventName:"keydown",listener:e}),this._contentElement.addEventListener("keydown",e)}addKeyUpListener(e){this._listeners.push({eventName:"keyup",listener:e}),this._contentElement.addEventListener("keyup",e)}addInputListener(e){this._listeners.push({eventName:"input",listener:e}),this._contentElement.addEventListener("input",e)}addBlurListener(e){this._listeners.push({eventName:"blur",listener:e}),this._contentElement.addEventListener("blur",e)}addPasteListener(e){this._listeners.push({eventName:"paste",listener:e}),this._contentElement.addEventListener("paste",e)}removeListeners(){for(const{eventName:e,listener:t}of this._listeners)this._contentElement.removeEventListener(e,t)}isTargetedByEvent(e){return!!e&&e.target===this._contentElement}getSelection(){var e,t,o,n,r;const i=null===(e=this._getEditor())||void 0===e?void 0:e.getSelection();return i?{selectionStart:i.anchorOffset,selectionEnd:i.anchorOffset,value:null!==(r=null===(n=i.focusNode)||void 0===n?void 0:n.textContent)&&void 0!==r?r:""}:{selectionStart:0,selectionEnd:0,value:null!==(o=null===(t=this._getEditor())||void 0===t?void 0:t.getContent())&&void 0!==o?o:""}}insertCalloutAnchor(e){}insertText(e,t){const o=this._getEditor();o&&o.addUndoSnapshot(((n,r,i)=>{const s=Object.assign(Object.assign({},n),{offset:t});o.select(s,n),o.insertContent(e,{replaceSelection:!0,updateCursor:!0,position:3})}))}}}("ComponentsHtmlEditorInputProxy"),function(e){p=t[e]={};t[e].EscapeCodeBlockPlugin=class{getName(){return"EscapeCodeBlockPlugin"}dispose(){this._editor=null}initialize(e){this._editor=e}onPluginEvent(e){0===e.eventType&&this._handleKeyDown(e.rawEvent)}_handleKeyDown(e){"Enter"===e.key&&!e.shiftKey&&this._isCursorOnBlankLastLineInCodeBlock()&&(this._escapeCodeBlock(),e.stopPropagation(),e.preventDefault())}_isCursorOnBlankLastLineInCodeBlock(){const e=this._editor.getElementAtCursor(),t=e.parentElement,n=null==t?void 0:t.parentElement;return"CODE"===(null==t?void 0:t.tagName)&&"PRE"===(null==n?void 0:n.tagName)&&e===(null==t?void 0:t.lastElementChild)&&(0,o.isNodeEmpty)(e)}_escapeCodeBlock(){var e;null===(e=this._editor)||void 0===e||e.addUndoSnapshot((()=>{var e,t;const o=null===(e=this._editor)||void 0===e?void 0:e.getElementAtCursor(),n=null==o?void 0:o.parentElement.parentElement,r=document.createElement("div");r.appendChild(document.createElement("br")),n.after(r),null===(t=this._editor)||void 0===t||t.select(r,0)}))}}}("PluginsEscapeCodeBlockPlugin"),function(e){C=t[e]={};const o="MentionBegin",n="MentionEnd",s=new RegExp(`\x3c!--${o}--\x3e.+?\x3c!--(<a[^>]+>.+?</a>)--\x3e\x3c!--${n}--\x3e`,"gi");async function l(e){return new Promise(((t,o)=>{let n=!1;const i=(0,r.getAutocompleteProviders)(e),s=i.value,l=new Set(s.map((e=>e.shortcutCharacter))),a=()=>{n||l.has("#")&&l.has("@")&&l.has("!")&&(i.unsubscribe(u),t(s),n=!0)},u=e=>{var t;n||null===(t=e.addedItems)||void 0===t||t.forEach((e=>{s.push(e),l.add(e.shortcutCharacter),a()}))};a(),n||(i.subscribe(u),setTimeout((()=>{n||(i.unsubscribe(u),t(s))}),3e3))}))}t[e].loadMentionProviders=l,t[e].convertRawMentionsToRichPreviews=async function(e,t){e.querySelectorAll("a[data-vss-mention]").forEach((e=>{var t,r,i;null===(t=e.parentElement)||void 0===t||t.insertBefore(document.createComment(o),e),null===(r=e.parentElement)||void 0===r||r.insertBefore(document.createComment(n),e.nextSibling),null===(i=e.parentElement)||void 0===i||i.insertBefore(document.createComment(e.outerHTML),e.nextSibling)}));const r=await l(t);await Promise.all(r.map((t=>{var o,n;return null!==(n=null===(o=t.transformHtml)||void 0===o?void 0:o.call(t,e))&&void 0!==n?n:Promise.resolve()})))},t[e].revertMentions=function(e){return e.replace(s,"$1")},t[e].sanitizeExternalLinks=function(e){for(const t of Array.from(e.querySelectorAll("a"))){const e=t.getAttribute("href");e&&(0,i.isExternalUrl)(e)&&(t.setAttribute("target","_blank"),t.setAttribute("rel","noopener noreferrer"))}}}("UtilsMention"),function(e){var o;v=t[e]={};class n{constructor(e,t){this._pageContext=e,this._autocompleteIsSuggesting=t}getName(){return"MentionPlugin"}initialize(e){this._editor=e,this._hasFocus=!1}onPluginEvent(e){if(8===e.eventType&&this._autocompleteIsSuggesting.value&&(e.clipboardData.rawHtml="",e.clipboardData.text="",e.pasteOption=1),9===e.eventType||6===e.eventType)this._showRichMentionPreviews();else if(7===e.eventType){const t=e;t.content=(0,C.revertMentions)(t.content)}}dispose(){this._editor=null}onBlur(){this._hasFocus=!1}onFocus(){this._hasFocus=!0,this._showRawMentions()}async _showRichMentionPreviews(){const e=this._getEditorContentWithRawMentions(),t=this._latestRenderTime=Date.now();if(!e||-1===e.indexOf("data-vss-mention"))return;const o=document.createElement("div");o.innerHTML=e,(0,C.sanitizeExternalLinks)(o),await(0,C.convertRawMentionsToRichPreviews)(o,this._pageContext),t!==this._latestRenderTime||this._hasFocus||this._setEditorContentWithoutChangeEvent(o.innerHTML)}_showRawMentions(){this._setEditorContentWithoutChangeEvent(this._getEditorContentWithRawMentions())}_getEditorContentWithRawMentions(){return this._editor?(0,C.revertMentions)(this._editor.getContent(!1)):""}_setEditorContentWithoutChangeEvent(e){this._editor&&this._editor.setContent(e,!1)}static _closest(e,t){if(e&&e.closest)return e.closest(t);for(;e&&e.parentElement&&!(e.matches||e.msMatchesSelector).call(e,t);)e=e.parentElement;return e}}t[e].MentionPlugin=n,o=n,n.SanitizeHtmlOptions={attributeCallbacks:{class:(e,t)=>o._closest(t,"[data-rendered-mention]")?e:void 0,style:e=>e.replace(/(height|line-height)\s*:.+?(;[\s]?|$)/g,"").replace("background-color: rgb(255, 255, 255);","").replace("color: rgb(0, 0, 0);",""),color:e=>{},"data-vss-mention":(e,t)=>e,"data-rendered-mention":(e,t)=>e}}}("PluginsMentionPlugin"),function(e){k=t[e]={};t[e].KeyDownPlugin=class{constructor(e){this._keyDownEventHandler=e}getName(){return"KeyDownPlugin"}dispose(){this._keyDownEventHandler=null}initialize(e){}onPluginEvent(e){this._keyDownEventHandler&&0===e.eventType&&this._keyDownEventHandler(e.rawEvent)}}}("PluginsKeyDownPlugin"),function(e){b=t[e]={};t[e].EditorProviderPlugin=class{getName(){return"EditorProviderPlugin"}dispose(){}initialize(e){this._editor=e}onPluginEvent(e){}getEditor(){return this._editor}}}("PluginsEditorProviderPlugin"),function(e){y=t[e]={};const o=new Set([6,11,4]);function n(e,t){return!!(e.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_FOLLOWING)}t[e].TabToNextFocusableElementPlugin=class{getName(){return"TabToNextFocusableElementPlugin"}dispose(){this._removeNavigationShortcutHelp(),this._editor=null}initialize(e){this._editor=e,this._focusedElement=null,this._addNavigationShortcutHelp()}onPluginEvent(e){0===e.eventType?this._handleKeyDown(e.rawEvent):o.has(e.eventType)&&(this._focusedElement=null)}_handleKeyDown(e){return"Enter"===e.key?this._activateFocusedElement(e):(e.ctrlKey||e.metaKey)&&"ArrowDown"===e.key?this._selectNextFocusableElement(e):(e.ctrlKey||e.metaKey)&&"ArrowUp"===e.key?this._selectPreviousFocusableElement(e):void(this._focusedElement=null)}_selectPreviousFocusableElement(e){return this._selectNextFocusableElement(e,!0)}_selectNextFocusableElement(e,t){var o;const n=this._getNextFocusableElement(e,!!t);if(!n)return this._focusedElement=null,void this._removeLinkActivationShortcutHelp();this._focusedElement=n,this._addLinkActivationShortcutHelp(),null===(o=this._editor)||void 0===o||o.select(n),e.preventDefault(),e.stopPropagation()}_getNextFocusableElement(e,t){var o,r,i;if(!(e.target&&e.target instanceof HTMLElement))return null;const s=e.target.querySelectorAll("a");if(0===s.length)return null;const l=null!==(o=this._focusedElement)&&void 0!==o?o:null===(i=null===(r=this._editor)||void 0===r?void 0:r.getFocusedPosition())||void 0===i?void 0:i.node;if(!l)return t?null:s[0];if(t){for(const e of Array.from(s).reverse())if(n(e,l))return e}else for(const e of Array.from(s))if(n(l,e))return e;return null}_activateFocusedElement(e){var t;const o=null===(t=this._focusedElement)||void 0===t?void 0:t.getAttribute("href");o&&(window.open(o,"_blank"),e.preventDefault(),e.stopPropagation())}_addNavigationShortcutHelp(){var e;null===(e=this._editor)||void 0===e||e.setEditorDomAttribute("aria-keyshortcuts","Control+ArrowDown Control+ArrowUp")}_removeNavigationShortcutHelp(){var e;null===(e=this._editor)||void 0===e||e.setEditorDomAttribute("aria-keyshortcuts","")}_addLinkActivationShortcutHelp(){var e;null===(e=this._editor)||void 0===e||e.setEditorDomAttribute("aria-keyshortcuts","Control+ArrowDown Control+ArrowUp Enter")}_removeLinkActivationShortcutHelp(){var e;null===(e=this._editor)||void 0===e||e.setEditorDomAttribute("aria-keyshortcuts","Control+ArrowDown Control+ArrowUp")}}}("PluginsTabToNextFocusableElementPlugin"),function(e){f=t[e]={};const o="data-html-editor-org-href",n=/(<a\s+([^>]*\s+)?)(data\-html\-editor\-org\-href="([^"]*)")(\s?)([^>]*>)/gm,r=/^x-mvwit:workitem\/([0-9]+)$/;function i(e,t){const n=t.getService("IVssLocationService"),i=e.href,s=r.exec(i);if(!s)return;const l=s[1],a=n.routeUrl("ms.vss-work-web.new-work-item-form-route-collection",{id:l});e.href=a,e.setAttribute(o,i)}t[e].makeAllWorkItemHyperlinksClickable=function(e,t){e.querySelectorAll("a[href]").forEach((e=>{i(e,t)}))},t[e].makeWorkItemHyperlinkClickable=i,t[e].revertWorkItemHyperlinks=function(e){return e?e.replace(n,((...e)=>{let t=!!e[5]?e[1]:e[1].slice(0,-1);t=t.replace(/href="[^"]*"/,`href="${e[4]}"`);return`${t}${e[6]}`})):e}}("UtilsWorkItemLinks"),function(e){E=t[e]={};t[e].WorkItemLinkPlugin=class{constructor(e){this._pageContext=e,this._editor=null}getName(){return"WorkItemLinkPlugin"}initialize(e){this._editor=e}dispose(){this._editor=null}onPluginEvent(e){var t;const o=9===e.eventType;6===e.eventType||o?null===(t=this._editor)||void 0===t||t.queryElements("a[href]",(e=>{(0,f.makeWorkItemHyperlinkClickable)(e,this._pageContext)})):7===e.eventType&&(e.content=(0,f.revertWorkItemHyperlinks)(e.content))}}}("PluginsWorkItemLinkPlugin"),function(e){P=t[e]={},__exportStar(p,t[e]),__exportStar(v,t[e]),__exportStar(k,t[e]),__exportStar(b,t[e]),__exportStar(y,t[e]),__exportStar(E,t[e])}("Pluginsindex"),function(e){w=t[e]={};const r=o.Browser.isMac?m.CommandClickToOpen:m.CtrlClickToOpen,i="html-editor-img-placeholder",p=`:not(.${i})`,C=e=>{const{dataTransfer:t}=e.nativeEvent;if(!t||!t.types)return;const o="Files",n=t.types;if(n.indexOf&&n.indexOf(o)>=0||n.contains&&n.contains(o)){e.preventDefault();try{t.dropEffect="none"}catch(e){}return!1}};class v extends h.VssComponent{constructor(e,t){super(e,t),this._leanRoosterRef=l.createRef(),this._commandBarRef=l.createRef(),this._timerManagement=new u.TimerManagement,this._autocompleteIsSuggesting=new a.ObservableValue(!1),this.refreshCommandBar=this._timerManagement.debounce((()=>this._commandBarRef.current&&this._commandBarRef.current.forceUpdate()),100,{trailing:!0}),this._createMentionButttonHandler=e=>t=>{var n,r,i,s,l,a,u,d;const h=t.getSelection(),c=/\s/.test(null!==(i=null===(r=null===(n=null==h?void 0:h.focusNode)||void 0===n?void 0:n.textContent)||void 0===r?void 0:r.substr(-1))&&void 0!==i?i:"");t.insertContent(c?e:` ${e}`),t.triggerContentChangedEvent("Mentions"),t.focus();let m=t.getSelection().focusNode,_=null!==(l=null===(s=m.textContent)||void 0===s?void 0:s.lastIndexOf(e))&&void 0!==l?l:-1;for(;-1===_&&m.previousSibling;)m=m.previousSibling,_=null!==(u=null===(a=m.textContent)||void 0===a?void 0:a.lastIndexOf(e))&&void 0!==u?u:-1;-1!=_&&(t.select(new o.Position(m,_+1)),null===(d=this._leanRoosterContentDiv)||void 0===d||d.dispatchEvent(new InputEvent("input")))},this._publishEmojiFromKeyboardTelemetry=()=>{this._publishShortcutCommandTelemetry("Emoji")},this._publishToolbarTelemetry=e=>{(this.props.telemetryContext||{}).controlName},this._publishShortcutCommandTelemetry=e=>{(this.props.telemetryContext||{}).controlName},this._handleContentChanged=(e,t=!1)=>{this._tryUpdateState(e,t)&&this.props.onChange&&this.props.onChange(this.isEmpty()?"":e)},this._updateViewState=(e,t,o)=>{this._throttledOnContentChanged(t,o)},this._focusOutShellAllowMouseDown=e=>!(!this._leanRoosterContentDiv||!this._leanRoosterContentDiv.contains(e)),this._focusOutShellOnFocus=e=>{this._commandBarRef.current&&this._commandBarPlugin.registerRoosterCommandBar(this._commandBarRef.current),!this.props.editOnlyMode&&this._leanRoosterRef&&(this.mode=1)},this._leanRoosterOnFocus=e=>{var t,o,n;null===(o=(t=this.props).onFocus)||void 0===o||o.call(t,e);const{helpText:r}=this.props;r&&this._leanRoosterRef.current&&this._leanRoosterRef.current.hasPlaceholder()&&(0,d.announce)(r,!0),null===(n=this._mentionPlugin)||void 0===n||n.onFocus()},this._focusOutShellOnBlur=e=>{var t;this.props.onBlur&&this.props.onBlur(e),!this.props.editOnlyMode&&this._leanRoosterRef&&(this.mode=0,this._imageResizePlugin.hideResizeHandle()),null===(t=this._mentionPlugin)||void 0===t||t.onBlur()},this._leanRoosterContentDivOnRef=e=>{this._leanRoosterContentDiv=e,this._loadEmojiStrings()},this._hyperlinkToolTipCallback=e=>"#"===e.replace(location.href,"")?"":this.hasFocus()?`${e}\n${r}`:"",this._onHyperlinkClick=(e,t)=>{const o=e.getAttribute("href");if(0!==this.mode||!o)return!1;try{window.open(o,"_blank")}catch(e){this.reportError(e)}return!0},this._throttledOnContentChanged=this._timerManagement.throttle(this._handleContentChanged,100,{trailing:!0});const{htmlContent:n,readonly:i,hidden:s,fullScreen:h}=e;this._viewState={content:n,isDirty:!1},this._createAdditionalEditorPlugins(),this._initializeButtonOverrides(),this._creationStartTime=Date.now();const c=this._viewState,m=o.HtmlSanitizer.sanitizeHtml(c.content,P.MentionPlugin.SanitizeHtmlOptions);c.content=m,this.state={readonly:!!i,hidden:!!s,fullScreen:!!h}}getValue(){return this._viewState.content}isEmpty(){return""===this.getValue()}render(){const{className:e,height:t}=this.props;return l.createElement("div",{className:(0,c.css)("html-editor",e,this.state.hidden&&"is-hidden",this.state.fullScreen&&"full-screen",null==t&&"auto-grow"),style:{height:t}},this._renderRoosterEditor())}setContent(e){const t=o.HtmlSanitizer.sanitizeHtml(e,P.MentionPlugin.SanitizeHtmlOptions);if(this._tryUpdateState(t)&&this._leanRoosterRef.current){this._leanRoosterRef.current.reloadContent(!0,!1);const e=this._leanRoosterRef.current.getContent();this._undoPlugin.reset(e)}}get isDirty(){return this._viewState.isDirty}get htmlContent(){return this._viewState.content}focus(){this._leanRoosterRef.current&&this._leanRoosterRef.current.focus()}selectAll(){this._leanRoosterRef.current&&this._leanRoosterRef.current.selectAll()}flushChanges(){if(this._leanRoosterRef.current){const e=this._leanRoosterRef.current.getContent();this._handleContentChanged(e)}}hasFocus(){return null!=this._leanRoosterRef.current&&1===this.mode}setEnabled(e){this.setState({readonly:!e})}setVisible(e){this.setState({hidden:!e})}setFullScreen(e){this.setState({fullScreen:e})}get mode(){return this._leanRoosterRef.current?this._leanRoosterRef.current.mode:void 0}set mode(e){this._leanRoosterRef.current&&void 0!==e&&(this._leanRoosterRef.current.mode=e)}componentDidMount(){this._leanRoosterRef.current&&this.props.editOnlyMode&&(this.mode=1),this.props.autoFocus&&this.focus(),this._endCreateScenario()}componentWillUnmount(){this._leanRoosterContentDiv&&(this._leanRoosterContentDiv=null,this._emojiPlugin=null),this._timerManagement&&(this._timerManagement.dispose(),this._timerManagement=null),this._commandBarPlugin&&this._commandBarRef.current&&this._commandBarPlugin.unregisterRoosterCommandBar(this._commandBarRef.current)}componentDidUpdate(e,t,o){super.componentDidUpdate(e,t,o),this.props.htmlContent!==e.htmlContent&&this.props.htmlContent!==this.htmlContent&&this.setContent(this.props.htmlContent),this.props.readonly!==e.readonly&&this.props.readonly!==this.state.readonly&&this.setState({readonly:!!this.props.readonly})}_renderRoosterEditor(){const{showChromeBorder:e,placeholder:t,ariaLabel:n}=this.props;return l.createElement(l.Fragment,null,l.createElement(o.FocusOutShell,{className:(0,c.css)("rooster-wrapper",!!e&&"with-chrome"),allowMouseDown:this._focusOutShellAllowMouseDown,onBlur:this._focusOutShellOnBlur,onFocus:this._focusOutShellOnFocus},((e,r)=>(this._createPluginsWithCallout(e,r),[l.createElement(o.LeanRooster,{key:"rooster",className:(0,c.css)("rooster-editor","propagate-keydown-event","text-element"),viewState:this._viewState,plugins:this._editorPlugins,undo:this._undoPlugin,ref:this._leanRoosterRef,updateViewState:this._updateViewState,contentDivRef:this._leanRoosterContentDivOnRef,readonly:this.state.readonly,placeholder:t,sanitizeAttributeCallbacks:P.MentionPlugin.SanitizeHtmlOptions.attributeCallbacks,hyperlinkToolTipCallback:this._hyperlinkToolTipCallback,onFocus:this._leanRoosterOnFocus,onDragEnter:C,onDragOver:C,"aria-label":n,activateRoosterOnMount:!this.props.disableMentions,activateInViewMode:!this.props.disableMentions,onHyperlinkClick:this._onHyperlinkClick,clickOpenHyperlinkViewMode:!0}),l.createElement(o.RoosterCommandBar,{key:"cmd",className:"rooster-command-bar",commandBarClassName:"html-command-bar-base",buttonOverrides:this._buttonOverrides,roosterCommandBarPlugin:this._commandBarPlugin,emojiPlugin:this._emojiPlugin,imageManager:this._imageManager,calloutClassName:(0,c.css)("rooster-callout",e),calloutOnDismiss:r,strings:_.CommandBarLocaleStrings,ref:this._commandBarRef,onButtonClicked:this._publishToolbarTelemetry,disableListWorkaround:true,overflowMenuProps:{className:"rooster-command-bar-overflow"},ellipsisAriaLabel:m.Toolbar_More})]))),l.createElement(s.AutocompleteComponent,{insertAsHtml:!0,isSuggesting:this._autocompleteIsSuggesting,ref:e=>{this._leanRoosterContentDiv&&(null==e||e.bind((0,g.createHTMLEditorInputProxy)(this._leanRoosterContentDiv,(()=>{var e;return null===(e=this._editorProvider)||void 0===e?void 0:e.getEditor()}))))}}))}_createPluginsWithCallout(e,t){this._emojiPlugin||(this._emojiPlugin=new o.EmojiPlugin({calloutClassName:(0,c.css)(e,"rooster-emoji-callout"),calloutOnDismiss:t,emojiPaneProps:{quickPickerClassName:"rooster-emoji-quick-pick",navBarProps:{className:"rooster-emoji-navbar",buttonClassName:"rooster-emoji-navbar-button",iconClassName:"rooster-emoji-navbar-icon",selectedButtonClassName:"rooster-emoji-navbar-selected"},statusBarProps:{className:"rooster-emoji-status-bar"},emojiIconProps:{className:"rooster-emoji-icon",selectedClassName:"rooster-emoji-selected"},searchPlaceholder:_.SearchForEmoji,searchInputAriaLabel:_.SearchForEmoji},onKeyboardTriggered:this._publishEmojiFromKeyboardTelemetry,strings:{emjDNoSuggetions:m.NoSuggestionsFound}}),this._editorPlugins.push(this._emojiPlugin)),this._commandBarPlugin||(this._commandBarPlugin=new o.RoosterCommandBarPlugin({strings:_.CommandBarLocaleStrings,onShortcutTriggered:this._publishShortcutCommandTelemetry,disableListWorkaround:true,calloutClassName:e,calloutOnDismiss:t}),this._editorPlugins.push(this._commandBarPlugin)),this.props.onKeyDown&&this._editorPlugins.push(new P.KeyDownPlugin(this.props.onKeyDown))}_initializeButtonOverrides(){const e=!!this.props.uploadImageHandler,t=o.RoosterCommmandBarButtonKeys,n="html-command-bar-button";this._buttonOverrides=[{key:t.Bold,order:0},{key:t.Italic,order:1},{key:t.Underline,order:2},{key:t.BulletedList,order:3},{key:t.NumberedList,order:4},{key:t.Highlight,order:5,subMenuPropsOverride:{ariaLabel:m.HighlightColorPicker_AriaLabel}},{key:t.FontColor,order:6,subMenuPropsOverride:{ariaLabel:m.FontColorPicker_AriaLabel}},{key:t.Emoji,order:7,buttonClassName:(0,c.css)("rooster-emoji-button",n)},{key:t.Outdent,order:8},{key:t.Indent,order:9},{key:t.Strikethrough,order:10},{key:t.Header,order:11,subMenuPropsOverride:{ariaLabel:m.HeaderMenu_AriaLabel}},{key:t.Code,order:12},{key:t.ClearFormat,order:16},{key:t.InsertImage,order:17,exclude:!e},{key:t.Link,order:18},{key:t.Unlink,order:19}],this.props.disableMentions||(this._buttonOverrides.push({key:"atMention",name:m.MentionSomeone,iconProps:{iconName:"Accounts"},onRender:(0,o.getIconOnRenderDelegate)(),handleChange:this._createMentionButttonHandler("@"),order:13}),this._buttonOverrides.push({key:"hashMention",name:m.MentionWorkItem,iconProps:{iconName:"NumberSymbol"},onRender:(0,o.getIconOnRenderDelegate)(),handleChange:this._createMentionButttonHandler("#"),order:14}),this._buttonOverrides.push({key:"prMention",name:m.MentionPullRequest,iconProps:{iconName:"BranchPullRequest"},onRender:(0,o.getIconOnRenderDelegate)(),handleChange:this._createMentionButttonHandler("!"),order:15})),this._buttonOverrides.forEach((e=>{e.className=e.className||"html-command-button-root",e.buttonClassName=e.buttonClassName||n}))}_createAdditionalEditorPlugins(){const{uploadImageHandler:e,handleXmvwitAnchor:t}=this.props;this._imageManager=new o.ImageManager({uploadImage:e,placeholderImageClassName:i}),this._undoPlugin=new o.UndoWithImagePlugin(this._imageManager),this._imageResizePlugin=new o.ImageResize(void 0,void 0,void 0,void 0,p);const n=!!e;if(this._editorPlugins=[new o.ContentChangedPlugin(this._throttledOnContentChanged),this._imageResizePlugin,new o.TableResize,n?new o.PasteImagePlugin(this._imageManager):o.IgnorePasteImagePlugin.Instance,new o.DoubleClickImagePlugin(p),new P.EscapeCodeBlockPlugin,new P.TabToNextFocusableElementPlugin,new P.WorkItemLinkPlugin(this.context.pageContext)],!this.props.disableMentions){const e=new P.EditorProviderPlugin;this._editorProvider=e,this._editorPlugins.push(e),this._mentionPlugin=new P.MentionPlugin(this.context.pageContext,this._autocompleteIsSuggesting),this._editorPlugins.push(this._mentionPlugin)}}_tryUpdateState(e,t=!1){e=this._isEmpty(e)?"":e;const o=this._viewState;return e!==o.content&&(o.content=e,o.isDirty=!0,!t)}_isEmpty(e){if(null==e||0===e.length)return!0;if(e.length>=500)return!1;const t=(0,o.fromHtml)(`<div>${e}</div>`,document)[0];return(0,o.isNodeEmpty)(t)}_endCreateScenario(){this._creationStartTime&&(this._creationStartTime=null)}reportError(e){const t=this.context.pageContext.getService("IGlobalMessagesService"),o=e.status||0,r=(0,n.format)(m.OperationFailed,`${e instanceof Error?e.message:e}${o?" ("+o+")":""}`);t.addBanner({message:r,dismissable:!0,level:2})}_loadEmojiStrings(){}}t[e].HtmlEditor=v,h.Components.add("wit-html-editor-component",v)}("ComponentsHtmlEditor"),function(e){t[e]={},Object.defineProperty(t[e],"HtmlEditor",{enumerable:!0,get:function(){return w.HtmlEditor}})}("index"),function(e){t[e]={},t[e].HtmlPreview=function({rawHtml:e}){const t=(0,h.usePageContext)(),o=(0,l.useMemo)((()=>{const t=document.createElement("div");return t.innerHTML=e,(0,C.sanitizeExternalLinks)(t),t}),[e]),n=o.innerHTML,[r,i]=(0,l.useState)(n);return(0,l.useEffect)((()=>{i(o.innerHTML),(0,f.makeAllWorkItemHyperlinksClickable)(o,t),(0,C.convertRawMentionsToRichPreviews)(o,t).then((()=>{i(o.innerHTML)}))}),[o]),l.createElement("div",{dangerouslySetInnerHTML:{__html:r}})}}("ComponentsHtmlPreview")}),["Resources","Components/HtmlEditor.Strings","Components/HtmlEditorInputProxy","Plugins/EscapeCodeBlockPlugin","Utils/Mention","Plugins/MentionPlugin","Plugins/KeyDownPlugin","Plugins/EditorProviderPlugin","Plugins/TabToNextFocusableElementPlugin","Utils/WorkItemLinks","Plugins/WorkItemLinkPlugin","Plugins/index","Components/HtmlEditor","index","Components/HtmlPreview"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.wit-html-editor"}}));