"use strict";define("TFS/NetPromoterSurvey",["require","exports","VSS/Platform/Context","VSS/Platform/RestClientBase","VSS/Platform/Util/Cookie","VSS/Core/Util/String","VSS/Platform/Trace","OfficeFabric/Label","react","OfficeFabric/Dropdown","VSSUI/Button","VSSUI/Checkbox","VSSUI/Link","VSSUI/TextField","VSS/Platform/Layout","VSSUI/Icon","VSS/Platform/Feature","VSS/Platform/UserClaims"],(function(e,t,o,a,n,s,r,i,c,l,m,u,d,p,h,g,y,S){var b,v,D,I,C,P,N,f,R;b=t[R="Resources"]={},t[R].AzureDevOpsBrandName="Azure DevOps",t[R].BrandNameTemplate="Azure {0}",t[R].CloseButtonTitle="Close",t[R].ContactMeLabel="It's okay to contact me for more details on my comments.",t[R].PrivacyLabel="Your privacy is important to us.",t[R].PrivacyUrl="https://go.microsoft.com/fwlink/?LinkId=264782",t[R].ReasonLabel="Please explain why you gave this score.",t[R].RoleLabel="What is your primary role?",t[R].RoleList="Analyst,Architect,Designer,DevOps,Developer,ITPro,Management,Product Owner,Project Manager,Student,Tester/QA,Other",t[R].RolePlaceholder="i.e. Project Manager, Engineer, etc.",t[R].Score0Label="Not likely",t[R].Score10Label="Extremely likely",t[R].ScoreLabel="How likely are you to recommend {0} to a colleague?",t[R].Step0Title="",t[R].Step1Title="Thanks for your feedback. Why did you give {0} a {1}?",t[R].Step2Title="Thanks for your feedback!",t[R].SubmitLabel="Submit",t[R].SuiteName="DevOps",t[R].ThankYouBody="Our goal is to create the best possible product for you and your team. Your thoughts, ideas, and suggestions play a major role in helping us identify opportunities to improve.",t[R].VSTSBrandName="Azure DevOps Services",function(e){t[e]={};class n extends a.RestClientBase{constructor(e){super(e)}async add(e){return this.beginRequest({apiVersion:"3.2-preview.1",method:"POST",routeTemplate:"_apis/Interaction/Interaction",body:e})}async get(e){const t={interactionId:e};return this.beginRequest({apiVersion:"3.2-preview.1",routeTemplate:"_apis/Interaction/Interaction",queryParams:t})}}t[e].InteractionClientName="IInteractionRestClient",t[e].getInteractionClient=function(o,a){return o.getRestClient(t[e].InteractionClientName,a)},o.RestClients.add(t[e].InteractionClientName,{factory:n,options:{serviceInstanceType:"00000041-0000-8888-8000-000000000000"}})}("clientRestClientInteraction"),function(e){t[e]={};class n extends a.RestClientBase{constructor(e){super(e)}async read(e){const t={engagementId:e};return this.beginRequest({apiVersion:"3.2-preview.1",routeTemplate:"_apis/Recommendation/EngagementData",queryParams:t})}async readEngagementIds(){return this.beginRequest({apiVersion:"3.2-preview.1",routeTemplate:"_apis/Recommendation/EngagementData"})}async write(e){return this.beginRequest({apiVersion:"3.2-preview.1",method:"POST",routeTemplate:"_apis/Recommendation/EngagementData",body:e})}async logRecommendation(e,t){const o={type:e,engagementId:t};return this.beginRequest({apiVersion:"3.2-preview.1",method:"POST",routeTemplate:"_apis/Recommendation/RecommendationHistory",queryParams:o})}async getEngagementRecommendation(e){return this.beginRequest({apiVersion:"3.2-preview.1",method:"POST",routeTemplate:"_apis/Recommendation/Recommendations",body:e})}async getRecommendations(e,t){const o={type:e,input:t};return this.beginRequest({apiVersion:"3.2-preview.1",routeTemplate:"_apis/Recommendation/Recommendations",queryParams:o})}}t[e].RecommendationClientName="IRecommendationRestClient",t[e].getRecommendationClient=function(o,a){return o.getRestClient(t[e].RecommendationClientName,a)},o.RestClients.add(t[e].RecommendationClientName,{factory:n,options:{serviceInstanceType:"00000041-0000-8888-8000-000000000000"}})}("clientRestClientRecommendation"),function(e){v=t[e]={},function(e){e.AnonymousAccess="AnonymousAccess",e.ContactMe="OkToContactMe",e.DeferredTimes="DeferredTimes",e.ExitMethod="ExitMethod",e.FeatureAvailability="FeatureAvailability",e.HubGroupId="HubGroupId",e.HubId="HubId",e.Interaction="Interaction",e.InteractionType="InteractionType",e.MaxAllowableDeferTimes="MaxAllowableDeferTimes",e.Navigation="Navigation",e.NPSDebugCookieEnabled="NPSDebugCookieEnabled",e.OperationDate="OperationDate",e.ProductName="ProductName",e.PromptId="PromptId",e.Reason="Reason",e.Response="Response",e.Score="Score",e.SurveyId="SurveyId",e.Url="Url",e.UserRole="UserRole",e.VerticalNavigationEnabled="VerticalNavigationEnabled"}(t[e].DataKeys||(t[e].DataKeys={}))}("Common"),function(e){var o;D=t[e]={},function(e){e.EngagementId="EngagementId",e.InteractionIds="InteractionIds",e.AccountId="AccountId",e.CollectionId="CollectionId",e.ProjectId="ProjectId",e.PageId="PageId",e.ProductName="ProductName"}(o=t[e].DataConstants||(t[e].DataConstants={}));class a{constructor(e,t){this._context=e,this._productName=t}recommmend(){const e=this._context.getRestClient("IRecommendationRestClient"),t={},s="00000000-0000-0000-0000-000000000000";t[o.EngagementId]=a.NetPromoterSurveyId,t[o.AccountId]=s,t[o.CollectionId]=s,t[o.ProjectId]=s,t[o.ProductName]=this._productName;const r={recommendationInputData:t,recommendationType:1};if("TRUE"===(0,n.getCookie)("TFS-NPS-DEBUG")){const e={};return e[v.DataKeys.DeferredTimes]="0",e[v.DataKeys.MaxAllowableDeferTimes]="3",e[v.DataKeys.NPSDebugCookieEnabled]="TRUE",e[v.DataKeys.PromptId]="DEBUG",Promise.resolve({isPositive:!0,data:e})}return new Promise((t=>{e.getEngagementRecommendation(r).then((e=>{const n=e.recommendationData[o.EngagementId];n&&n.toLowerCase()===a.NetPromoterSurveyId.toLowerCase()&&t({isPositive:!0,data:e.recommendationData}),t({isPositive:!1})})).catch((()=>t({isPositive:!1})))}))}logRecommendation(){return this._context.getRestClient("IRecommendationRestClient").logRecommendation(5,a.NetPromoterSurveyId)}logInteraction(e){const t=this._context.getRestClient("IInteractionRestClient"),o={id:a.NetPromoterSurveyId,accountId:"00000000-0000-0000-0000-000000000000",projectId:"00000000-0000-0000-0000-000000000000",timestamp:new Date,interactionInputData:e};return t.add(o)}}t[e].Recommender=a,a.NetPromoterSurveyId="NetPromoterSurvey"}("RecommendersRecommender"),function(e){I=t[e]={};class o{constructor(e){this._getNPSData=e=>{const t=e.getService("IVssContributionService"),o="ms.vss-tfs-web.net-promoter-survey-context";return t.getDataAsync(o).then((e=>{if(e){const t={samplingRate:e.samplingRate,delayInDaysForSubmit:e.delayInDaysForSubmit,delayInDaysForPostpone:e.delayInDaysForPostpone,maxAllowableDeferTimes:e.maxAllowableDeferTimes,minDelayInHoursBetweenPrompts:e.minDelayInHoursBetweenPrompts};return Promise.resolve(t)}return Promise.reject(void 0)})).catch((e=>((0,r.traceError)(this._context,"Engagement","NetPromoterSurvey",(0,s.format)("Data provider {0} failed: {1}",o,e)),Promise.reject(void 0))))},this._context=e}recommmend(){return new Promise((e=>{this._getNPSData(this._context).then((t=>{this.settings=t;const a=localStorage.getItem(o.LocalStorageRecommendationKey);null==a&&this.logRecommendation();const n=new Date(Number(a)),s=JSON.parse(localStorage.getItem(o.LocalStorageInteractionKey)||"{}",((e,t)=>"timestamp"===e?new Date(t):t));let r;this.shouldPrompt(n,s).then((t=>{t&&(r=s&&s.interactionInputData?s.interactionInputData:{},r[v.DataKeys.AnonymousAccess]="true",r[D.DataConstants.EngagementId]="NetPromoterSurvey",r[v.DataKeys.MaxAllowableDeferTimes]=this.settings.maxAllowableDeferTimes.toString()),e({isPositive:t,data:r})}))}))}))}logRecommendation(){return new Promise((e=>{localStorage.setItem(o.LocalStorageRecommendationKey,(new Date).getTime().toString()),e()}))}logInteraction(e){return new Promise((()=>{const t={id:"NetPromoterSurvey",accountId:"00000000-0000-0000-0000-000000000000",projectId:"00000000-0000-0000-0000-000000000000",timestamp:new Date,interactionInputData:e};localStorage.setItem(o.LocalStorageInteractionKey,JSON.stringify(t))}))}shouldPrompt(e,t){return new Promise((o=>{this.evaluateLastRecommendationDate(e)||o(!1),this.evaluateNextPromptDate(t)||o(!1),this.isUserInRandomSample()||o(!1),o(!0)}))}evaluateLastRecommendationDate(e){if(e.getTime()!==new Date(Number(null)).getTime()){const t=this.settings.minDelayInHoursBetweenPrompts;if(null!=e)return((new Date).getTime()-e.getTime())/36e5>t}return!1}evaluateNextPromptDate(e){if(e&&e.interactionInputData&&e.interactionInputData[v.DataKeys.InteractionType]){const t=this.getNextPromptDate(e.timestamp,e.interactionInputData[v.DataKeys.InteractionType]);if((new Date).getTime()<t.getTime())return!1}return!0}isUserInRandomSample(){const e=this.settings.samplingRate;return this._random((new Date).getTime())<e}getNextPromptDate(e,t){const o=new Date(e.getTime());let a=this.settings.delayInDaysForSubmit;return"postpone"===t.toLowerCase()&&(a=this.settings.delayInDaysForPostpone),o.setDate(e.getDate()+a),o}_random(e){const t=1e4*Math.sin(e++);return t-Math.floor(t)}}t[e].AnonymousRecommender=o,o.LocalStorageRecommendationKey="NetPromoterSurvey_Recommendation",o.LocalStorageInteractionKey="NetPromoterSurvey_Interaction"}("RecommendersAnonymousRecommender"),function(e){C=t[e]={};t[e].ScoreChoiceGroup=e=>{const t=[];for(let o=0;o<=e.scoreCount;o++){const a=e.selected===o,n="nps-score-choice"+o.toString();t.push(c.createElement("li",{key:o.toString(),className:"nps-score-choice"},c.createElement("input",{type:"radio",id:n,name:n,checked:a,onChange:()=>e.onChange({score:o}),onClick:()=>{e.onClick&&e.onClick()}}),c.createElement("label",{className:"fontSizeM fontWeightSemiBold"+(a?" selected":""),htmlFor:n},o)))}return c.createElement("div",{className:"nps-score"},c.createElement(i.Label,{className:"fontSizeM fontWeightSemiBold nps-score-label"},e.label),c.createElement("ul",null,t),c.createElement("div",{className:"fontSizeS fontWeightSemiBold flex-row"},c.createElement("span",{className:"flex-grow"},b.Score0Label),c.createElement("span",null,b.Score10Label)))}}("ComponentsScoreChoiceGroup"),function(e){P=t[e]={};t[e].SubmissionDetail=e=>{const t=e.roleList.split(",").map((e=>({key:e,text:e})));return c.createElement("div",null,c.createElement(i.Label,{className:"fontSizeM fontWeightSemiBold"},e.reasonLabel),c.createElement(p.TextField,{className:"nps-dialog-reason",multiline:!0,rows:3,resizable:!1,value:e.reason,onChange:(t,o)=>{e.onChange({reason:o})}}),c.createElement(l.Dropdown,{calloutProps:{directionalHintFixed:!1},label:e.roleLabel,placeholder:e.rolePlaceholder,options:t,selectedKey:e.role,onChanged:t=>{e.onChange({role:t.key.toString()})}}),!e.hideContactConsented&&c.createElement(u.Checkbox,{className:"nps-contact-consented-checkbox",label:e.contactConsentedLabel,checked:!!e.contactConsented,onChange:(t,o)=>{e.onChange({contactConsented:o})}}),c.createElement("div",{className:"flex-row nps-dialog-footer"},c.createElement(d.Link,{className:"flex-grow flex-self-center",target:"_blank",href:e.privacyUrl},e.privacyText),c.createElement(m.Button,{primary:!0,onClick:e.onSubmit,text:b.SubmitLabel,disabled:e.submitDisabled})))}}("ComponentsSubmissionDetail"),function(e){N=t[e]={};class o extends h.VssComponent{constructor(e){super(e),this.next=()=>{if(this.state.step+1===2&&void 0===this.props.response.score)return document.removeEventListener("mousedown",this._handleClick),void this.props.close();this.setState({step:this.state.step+1})},this.step0=()=>c.createElement(C.ScoreChoiceGroup,{selected:this.props.response.score,scoreCount:10,label:(0,s.format)(b.ScoreLabel,this.props.productName),labelMinimum:b.Score0Label,labelMaximum:b.Score10Label,onChange:e=>{this.props.change(e),this.props.submit(Object.assign(Object.assign({},this.props.response),e),"score-click")},onClick:()=>{this.next()}}),this.step1=()=>c.createElement("div",null,c.createElement(d.Link,{onClick:()=>{this.setState({step:0})},target:"_blank"},c.createElement(g.Icon,{iconName:"Back"})," Back"),c.createElement(P.SubmissionDetail,{reason:this.props.response.reason,reasonLabel:(0,s.format)(b.Step1Title,this.props.productName,this.props.response.score),role:this.props.response.role,roleLabel:b.RoleLabel,roleList:b.RoleList,rolePlaceholder:b.RolePlaceholder,hideContactConsented:!this.props.isAuthenticated,contactConsentedLabel:b.ContactMeLabel,contactConsented:this.props.response.contactConsented,privacyText:b.PrivacyLabel,privacyUrl:b.PrivacyUrl,onChange:this.props.change,onSubmit:()=>{this.next(),this.props.submit(this.props.response,"submit")}})),this.step2=()=>c.createElement("div",null,c.createElement(i.Label,{className:"fontSizeM fontWeightSemiBold"},b.Step2Title),c.createElement("p",null,b.ThankYouBody)),this._handleClick=()=>{2===this.state.step&&(document.removeEventListener("mousedown",this._handleClick),this.props.close())},this.state={step:0},document.addEventListener("mousedown",this._handleClick)}render(){switch(this.state.step){case 0:return this.step0();case 1:return this.step1();case 2:return this.step2();default:return c.createElement("div",null)}}}t[e].StepByStepSurveyDialog=o}("ComponentsStepByStepSurveyDialog"),function(e){var o;f=t[e]={},function(e){e.AreaName="Survey",e.SubmitFeature="User.Submit",e.PostponeFeature="User.Postpone",e.AppearFeature="Dialog.Appear",e.CloseFeature="Dialog.Close"}(o||(o={}));class a extends h.VssComponent{constructor(e,t){super(e,t),this._handleChange=e=>{this.setState({response:Object.assign(Object.assign({},this.state.response),e)})},this._appear=()=>{this.publishTelemetry(o.AppearFeature,{})},this._close=()=>{this.setState({showSurvey:!1},(()=>{this.publishTelemetry(o.CloseFeature,{}),this.props.onDismiss()}))},this._submit=(e,t)=>{const a="submit",n=this._buildTelemetryData(e,a,0,t,!0);this.props.recommender.logInteraction(this._buildInteractionData(a,0)),this.publishTelemetry(o.SubmitFeature,n),this.setState({hasScoreBeenSubmitted:!0})},this._postpone=(e,t)=>{if(this._close(),!this.state.hasScoreBeenSubmitted){let a="postpone",n=(Number(this.props.data[v.DataKeys.DeferredTimes])||0)+1;n>=Number(this.props.data[v.DataKeys.MaxAllowableDeferTimes])&&(a="submit",n=0),this.props.recommender.logInteraction(this._buildInteractionData(a,n));const s=this._buildTelemetryData(e,a,n,t,!1);this.publishTelemetry(o.PostponeFeature,s)}},this._buildCoreData=(e,t,o)=>{const a={};return a[v.DataKeys.UserRole]=o,a[v.DataKeys.InteractionType]=e,a[v.DataKeys.DeferredTimes]=t,a},this._buildInteractionData=(e,t)=>this._buildCoreData(e,t,this.state.response.role),this._buildTelemetryData=(e,t,o,a,n)=>{const s={};return s[v.DataKeys.Interaction]=this._buildCoreData(t,o,e.role),s[v.DataKeys.ExitMethod]=a,s[v.DataKeys.Response]=n?e:void 0,s},this._buildCoreTelemetryData=()=>{const e={};return e[v.DataKeys.SurveyId]="NetPromoterSurvey",e[v.DataKeys.Url]=window.location.href,e[v.DataKeys.OperationDate]=(new Date).toISOString(),e[v.DataKeys.FeatureAvailability]={},e[v.DataKeys.FeatureAvailability].StepByStepSurveyEnabled=!0,e[v.DataKeys.FeatureAvailability].UseNewBranding=Boolean(this.props.useNewBranding),e[v.DataKeys.FeatureAvailability].VerticalNavigationEnabled=Boolean(this.props.verticalNavigationEnabled),e[v.DataKeys.FeatureAvailability].VerticalBranding=Boolean(this.props.verticalBrandingEnabled),e[v.DataKeys.AnonymousAccess]=!this.props.isAuthenticated,e[v.DataKeys.HubGroupId]=this.props.selectedHubGroupId,e[v.DataKeys.HubId]=this.props.selectedHubId,e[v.DataKeys.ProductName]=this.props.productName,e[v.DataKeys.PromptId]=this.props.data[v.DataKeys.PromptId],e},this.publishTelemetry=(e,t)=>{const a=this._buildCoreTelemetryData();a[v.DataKeys.NPSDebugCookieEnabled]=this.props.data[v.DataKeys.NPSDebugCookieEnabled],this._telemetryService.publishEvent(o.AreaName,e,Object.assign(Object.assign({},a),t))},this._setWrapperRef=e=>{this.dialogWrapper=e},this._setServices=()=>{this._telemetryService=this.context.pageContext.getService("IVssTelemetryService")},this.state={showSurvey:!1,response:{role:this.props.data[v.DataKeys.UserRole]},hasScoreBeenSubmitted:!1},this._setServices()}componentDidMount(){this._selectedHubIsValid()&&this.setState({showSurvey:!0},(()=>{this._appear()}))}render(){return this.state.showSurvey?c.createElement("div",{id:"nps-dialog",className:(0,s.format)("nps-dialog nps-dialog-{0}","step-by-step"),ref:this._setWrapperRef},c.createElement(m.Button,{subtle:!0,iconProps:{iconName:"Cancel"},className:"nps-dialog-close",ariaLabel:b.CloseButtonTitle,onClick:()=>{this._postpone(this.state.response,"close")}}),c.createElement(N.StepByStepSurveyDialog,{productName:this.props.productName,response:this.state.response,isAuthenticated:this.props.isAuthenticated,change:this._handleChange,submit:this._submit,postpone:this._postpone,close:this._close})):c.createElement("div",null)}_selectedHubIsValid(){const e=this.context.pageContext.getService("IVssNavigationService").getDisplayedNavigation(),t=e.length>2&&e[2]||"N/A",o=e.length>3&&e[3]||"N/A";return t===this.props.selectedHubGroupId&&o===this.props.selectedHubId}}t[e].SurveyComponent=a}("SurveyComponent"),function(e){t.NetPromoterService={};class a extends o.VssService{constructor(){super(...arguments),this._buildDisplayedProductName=(e,t,o)=>{if(!t)return b.VSTSBrandName;const a=o?this._hubGroupToProductName(e):b.SuiteName;return(0,s.format)(b.BrandNameTemplate,a)}}async initialize(){const e=this._isAuthenticated(),t=this._getSelectedHub();let o;try{o=await this._recommend(e,this._hubGroupToProductName(t[0]))}catch(e){(0,r.traceError)(this.pageContext,"Engagement","NetPromoterSurvey",(0,s.format)("Recommend Failed: {0}",e)),o={isPositive:!1}}if(o.isPositive){this._recommender.logRecommendation();const a=(0,y.isFeatureFlagEnabled)(this.pageContext,"VisualStudio.Services.WebPlatform.UseNewBranding",!1),n=(0,y.isFeatureFlagEnabled)(this.pageContext,"WebAccess.Survey.NetPromoter.VerticalBranding",!1),s=n,r=this.pageContext.getService("IVssLayoutManager");document.getElementById("nps-dialog")||r.renderCallout((r=>c.createElement(f.SurveyComponent,{recommender:this._recommender,isAuthenticated:e,verticalNavigationEnabled:!0,verticalBrandingEnabled:n,useNewBranding:a,productName:this._buildDisplayedProductName(t[0],a,s),selectedHubGroupId:t[0],selectedHubId:t[1],data:o.data||{},onDismiss:r})||{}))}}async _recommend(e,t){return this._recommender=e?new D.Recommender(this.pageContext,t):new I.AnonymousRecommender(this.pageContext),this._recommender.recommmend()}_isAuthenticated(){return!(0,S.userHasClaim)(this.pageContext,"anonymous")}_getSelectedHub(){const e=this.pageContext.getService("IVssNavigationService").getDisplayedNavigation();return[e.length>2&&e[2]||"N/A",e.length>3&&e[3]||"N/A"]}_hubGroupToProductName(e){switch(e){case"ms.vss-work-web.work-hub-group":return"Boards";case"ms.vss-code-web.code-hub-group":return"Repos";case"ms.vss-build-web.build-release-hub-group":return"Pipelines";case"ms.feed.package-hub-group":return"Artifacts";case"ms.vss-test-web.test-hub-group":return"Test Plans";default:return b.SuiteName}}}o.Services.add("INetPromoterService",{serviceFactory:a})}()}),["Resources","client/RestClient/Interaction","client/RestClient/Recommendation","Common","Recommenders/Recommender","Recommenders/AnonymousRecommender","Components/ScoreChoiceGroup","Components/SubmissionDetail","Components/StepByStepSurveyDialog","SurveyComponent","NetPromoterService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-tfs-web.net-promoter-survey-content"}}));