"use strict";define("Reporting/WorkItemsCategoriesPicker",["require","exports","Analytics/Boards/BoardsQueries/ProcessesQuery","VSS/Core/Util/String","VSS/Platform/Feature","Wit/Common/WorkItemTypeColorAndIcons","Wit/UI/DataProviders/WorkItemTrackingDataProvider","react","VSS/Platform/Layout","VSSUI/Dropdown","VSSUI/Utilities/DropdownSelection"],(function(e,o,t,r,s,n,i,a,c,l,m){var k,p;k=o[p="Resources"]={},o[p].BacklogsName="Backlogs",o[p].WorkItemsName="Work Items",o[p].BacklogOptionFormat="{0} backlog",function(e){o[e]={},o[e].convertBacklogInfoToFilter=function(e){return"BacklogCategory"===e.type?{identifier:"BacklogCategory",settings:e.backlogReferenceName}:{identifier:"WorkItemType",settings:e.workItemTypeName}}}("IWorkItemBacklogInfo"),function(e){async function a(e,o,r,a,c){const m=new i.WorkItemTrackingDataProvider(e,o),k=e.getService("IDashboardsCacheableQueryService"),p=(await k.getCacheableQueryResult(t.ProcessesQuery.onTeam(e,o,r).setAutomationMode(c))).filter((e=>a.some((o=>e.BacklogCategoryReferenceName===o)))),g=(0,s.isFeatureFlagEnabled)(e,"WebAccess.Process.WorkItemTypeIsDeletedOnProcess",!1)?p.filter((e=>!1===e.IsDeleted)):p;return await Promise.all(g.map((async e=>{const t=await m.getWorkItemTypeColorAndIcon(o,e.WorkItemType),r=n.WorkItemTypeColorAndIcons.createColorAndIcon(t.color,t.icon);return{pickerId:l("WorkItemType",e.WorkItemType),type:"WorkItemType",workItemTypeName:e.WorkItemType,iconColor:r.color,iconName:r.icon}})))}async function c(e,o,t){const s=await async function(e,o){const t=e.getService("IVssContributionService"),r=await t.getDataAsync("ms.vss-dashboards-web.backlog-configuration-for-team-data-provider",{teamId:o});let s;return s=[r.taskBacklog,r.requirementBacklog],s=s.concat(r.portfolioBacklogs),s}(e,t);return await Promise.all(s.map((async e=>({pickerId:l("BacklogCategory",e.id),type:"BacklogCategory",backlogName:(0,r.format)(k.BacklogOptionFormat,e.name),backlogReferenceName:e.id,iconColor:e.color,iconName:"BacklogBoard",rank:e.rank}))))}function l(e,o){return`${e}_${o}`}function m(e){let o,t;"BacklogCategory"===e.type?(o=!0,t=e.backlogName):(o=!1,t=e.workItemTypeName);const r=o?"":"bowtie-icon ",s=o?"#":"",n=8===e.iconColor.length?e.iconColor.substring(2):e.iconColor;return{id:e.pickerId,data:e,text:t,iconProps:{className:r+e.iconName,style:{color:s+n},iconName:e.iconName}}}o[e]={},o[e].getWorkItemTypes=a,o[e].getBacklogs=c,o[e].getPickerId=l,o[e].getDefaultWorkItemCategoriesOption=function(){return[]},function(e){e[e.WorkItems=1]="WorkItems",e[e.BacklogAndWorkItems=3]="BacklogAndWorkItems"}(o[e].AllowedItems||(o[e].AllowedItems={})),o[e].getWorkItemAndCategoriesOptions=async function(e,o,t,r,s,n){const i=function(e,o){return e.filter((e=>o(e))).sort(((e,o)=>o.rank-e.rank))}(await c(e,0,t),r),l=i.map((e=>e.backlogReferenceName)),p=await a(e,o,t,l,n),g=[];return 2==(2&s)&&(g.push({id:"backlogs_header",disabled:!0,type:2,text:k.BacklogsName}),g.push(...i.map((e=>m(e)))),g.push({id:"separator",disabled:!0,type:3}),g.push({id:"workitems_header",disabled:!0,type:2,text:k.WorkItemsName})),g.push(...p.map((e=>m(e)))),g},o[e].packItem=m}("WorkItemsCategoriesHelper"),function(e){o[e]={};class t extends c.VssComponent{constructor(e){super(e),this.onSelectionChange=()=>{const e=this.selection.value,o=new Set;for(let t=0;t<e.length;t++)for(let r=e[t].beginIndex;r<=e[t].endIndex;r++)o.add(this.props.items[r]);this.props.onSelect(Array.from(o))},this.selection=e.suppressMultiSelect?new m.DropdownSelection:new m.DropdownMultiSelection}componentDidMount(){this.applySelection(this.props),this.selection.subscribe(this.onSelectionChange)}componentWillReceiveProps(e){JSON.stringify(e)!=JSON.stringify(this.props)&&(this.selection.unsubscribe(this.onSelectionChange),this.applySelection(e),this.selection.subscribe(this.onSelectionChange))}componentWillUnmount(){this.selection.unsubscribe(this.onSelectionChange)}render(){return a.createElement("div",{className:"flex-row"},a.createElement(l.Dropdown,{className:"workitems-categories-picker",items:this.props.items,selection:this.selection}))}applySelection(e){void 0!==e.selectedIds&&(this.selection.clear(),e.selectedIds.forEach((o=>{const t=e.items.findIndex((e=>e.id===o));t>=0&&this.selection.select(t,1,true)})))}}o[e].MultiSelectPicker=t;o[e].WorkItemsCategoriesPicker=class extends t{},c.VssComponent.register("WorkItemsCategoriesPicker",t)}("WorkItemsCategoriesPicker")}),["Resources","IWorkItemBacklogInfo","WorkItemsCategoriesHelper","WorkItemsCategoriesPicker"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-reporting-web.workitems-categories-picker"}}));