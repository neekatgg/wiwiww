"use strict";define("Reporting/VelocityReport",["require","exports","Analytics/Boards/BoardsQueries/BacklogsQuery","VSS/Core/Util/String","react","Reporting/BoardsCommon/BoardsReport","Reporting/BoardsCommon/BoardsRoutingHelper","Reporting/BoardsCommon/Pickers/AggregationPicker","Reporting/BoardsCommon/ReportGuidedTourUtility","Reporting/BoardsCommon/ReportQueryHelper","Reporting/BoardsCommon/ReportTelemetry","Reporting/BoardsCommon/ResetElement","Reporting/BoardsCommon/Resources","Reporting/BoardsCommon/UnmaterializedBoardMessage","VSS/Core/Observable","VSS/Platform/Components/Layout","VSS/Platform/FPS","VSS/Platform/Layout","VSSUI/FormItem","VSSUI/TextField","Widgets/Configs/Common/GenericSelectionDropdown","Widgets/VelocityWidget/VelocityWidgetComponents/VelocitySettingsManager","VSS/Platform/Feature","VSSUI/Checkbox","Reporting/BoardsCommon/ReportPageState"],(function(e,t,o,i,s,a,r,n,l,c,g,m,u,d,p,h,b,C,S,y,I,R,f,B,v){var V,w,x,T,k,O,N;V=t[N="Resources"]={},t[N].ReportTitle="Velocity",t[N].MissingBacklogDetail="The active backlog level could not be found on the Analytics service.",t[N].CustomIterations="Custom iterations",t[N].TourBubbleTitle="The Velocity Report",t[N].TourBubbleText="Get insights into your team's average speed in completing work across several sprints. Use this information to plan future requirements. Customize this report by changing the metrics and number of iterations. Click next to take a quick tour.",t[N].FilterBubbleTitle="Velocity Report Configuration",t[N].FilterBubbleText="Customize the aggregation metric and number of iterations of your Velocity report. Your selection will be saved next time you visit the report.",t[N].ChartBubbleTitle="Velocity Chart",t[N].ChartBubbleText="Use the chart to compare planned velocity versus actual (completed) velocity and work completed later than planned. Learn more on how to control the calculation of planned work and work completed late.",t[N].LegendBubbleTitle="Velocity Chart Legend",t[N].LegendBubbleText="​Click the chart's legend to hide or show parts of the chart.",t[N].AggregateByLabel="Velocity by",t[N].NumberOfIterationsLabel="Number of Iterations",t[N].CustomNumberOfIterationsLabel="Custom Number of Iterations",t[N].VelocityWidgetTitleFormat="{0} Velocity",t[N].IterationCountPickerOption="Last {0} iterations",t[N].ShowResolvedItemsAsCompletedLabel="Show Resolved work items as Completed",t[N].ShowResolvedItemsAsCompletedLabelToolTipText="Consider work items with State or StateCategory 'Resolved' as Completed work items",t[N].AdvancedLabel="Advanced",function(e){w=t[e]={};class o{static async reset(e,t,i){const s=e.getService("ISettingsService");await s.removeEntries("VelocityReport",0,o.teamScopeName,t)}static async save(e,t,i,s){const a=e.getService("ISettingsService"),r=`VelocityReport/${s}`,n={};n[r+"/"+o.aggregationKey]=t.aggregation,n[r+"/"+o.iterationKey]=t.numberOfIterations,n[r+"/"+o.showResolvedItemsAsCompletedKey]=t.showResolvedItemsAsCompleted,await a.setEntries(n,0,o.teamScopeName,i)}static async load(e,t,i){const s=e.getService("ISettingsService"),a=await s.getEntriesAsync("VelocityReport/"+i,0,o.teamScopeName,t);return{aggregationSettings:a[o.aggregationKey],numberOfIterations:a[o.iterationKey],showResolvedItemsAsCompleted:a[o.showResolvedItemsAsCompletedKey]}}}function i(){return"VelocityReport"}t[e].VelocityReportUserSettings=o,o.aggregationKey="AggregationSettings",o.iterationKey="NumberOfIterations",o.teamScopeName="team",o.showResolvedItemsAsCompletedKey="ShowResolvedItemsAsCompleted",t[e].getVelocityReportSettingsStorageKey=i}("VelocityReportUserSettings"),function(e){x=t[e]={},t[e].getTeachingBubblesData=function(){return{reportKey:(0,w.getVelocityReportSettingsStorageKey)(),tourBubble:{title:V.TourBubbleTitle,text:V.TourBubbleText},filterBubble:{title:V.FilterBubbleTitle,text:V.FilterBubbleText},chartBubble:{title:V.ChartBubbleTitle,text:V.ChartBubbleText},legendBubble:{title:V.LegendBubbleTitle,text:V.LegendBubbleText},reportDocumentationUrl:"https://go.microsoft.com/fwlink/?linkid=2095910"}}}("VelocityReportTeachingBubbleHelper"),function(e){T=t[e]={},t[e].getBacklog=async function(e,t,i,s){const a=e.getService("IDashboardsCacheableQueryService"),r=new o.BacklogsQuery(t,[i]),n=await a.getCacheableQueryResult(r),l=n.findIndex((e=>e.BoardCategoryReferenceName===s));return l>=0?n[l]:void 0}}("PickersBacklogsQuery"),function(e){function o(e){return{id:e.toString(),text:(0,i.format)(V.IterationCountPickerOption,e),data:e}}k=t[e]={},t[e].customIterationsId="customiterations",t[e].getIterationOptions=function(){return[o(2),o(3),o(6),o(10),o(15),{id:"separator",type:3},{id:t[e].customIterationsId,text:V.CustomIterations}]}}("PickersIterationsPickerOptions"),function(e){O=t[e]={};class o extends a.BoardsReport{constructor(e,t){super(e,t),this.textFieldValue=new p.ObservableValue(""),this.resetSettings=async()=>{await w.VelocityReportUserSettings.reset(this.context.pageContext,this.props.teamId,this.props.categoryReferenceName),this.initializeReportState()},this.onAggregationSelect=e=>{const t=Object.assign({},this.state.widgetSettings);t.aggregation=e,this.setUserSelection(t)},this.onIterationSelect=e=>{const t=e.id===k.customIterationsId;if(t)this.textFieldValue.value=this.state.widgetSettings.numberOfIterations.toString(),this.setState({customIterationValidationMessage:null});else{const t=Object.assign({},this.state.widgetSettings);t.numberOfIterations=e.data,this.setUserSelection(t)}this.setState({isCustomIteration:t})},this.onCustomIterationChanged=(e,t)=>{const o=t.replace(/\D/g,"");this.textFieldValue.value=o,this.validateAndSaveCustomIterationsInput(o)},this.toggleTeachingBubble=()=>{this.setState({showTeachingBubble:!this.state.showTeachingBubble})},this.onBubbleDismiss=()=>{this.setState({showTeachingBubble:!1})},this.renderCheckboxLabelWithInfoIcon=e=>s.createElement("div",null,s.createElement("span",null,e)," ⓘ"),this.onToggleShowResolvedItemsAsCompleted=(e,t)=>{const o=Object.assign({},this.state.widgetSettings);o.showResolvedItemsAsCompleted=t,this.setUserSelection(o)},this.state=this.getDefaultState()}getReportTitle(){return V.ReportTitle}getReportTelemetryName(){return"VelocityReport"}getWidgetName(){const e=this.props.teamName;return(0,i.format)(V.VelocityWidgetTitleFormat,e)}getWidgetContributionId(){return"ms.vss-dashboards-web.Microsoft.VisualStudioOnline.Dashboards.VelocityWidget"}initializeOnRender(){this.reportGuidedTourUtility=new l.ReportGuidedTourUtility(this.context.pageContext,(0,x.getTeachingBubblesData)(),this.onBubbleDismiss)}renderTeachingBubble(){return s.createElement(s.Fragment,null," ",this.reportGuidedTourUtility.render(this.state.showTeachingBubble)," ")}getTitleBlock(){const e=this.isReady()&&!this.isInAbnormalState()&&this.isConfigurationValid();return s.createElement(s.Fragment,null,super.getTitleBlock((0,l.getInfoIcon)(this.reportGuidedTourUtility.titleBubbleCallback,this.toggleTeachingBubble,e,this.getReportTitle())))}decorateWidgetContent(e){return s.createElement("div",{ref:this.reportGuidedTourUtility.chartBubbleCallback},e)}getFilterItems(){var e,t;return s.createElement(s.Fragment,null,s.createElement("div",{ref:this.reportGuidedTourUtility.filterBubbleCallback},s.createElement(S.FormItem,{label:V.AggregateByLabel},s.createElement(n.AggregationPicker,{value:this.state.widgetSettings.aggregation,items:this.state.aggregationOptions,onSelect:this.onAggregationSelect}))),s.createElement(S.FormItem,{label:V.NumberOfIterationsLabel},s.createElement(I.GenericSelectionDropdown,{selectedId:this.state.isCustomIteration?k.customIterationsId:this.state.widgetSettings.numberOfIterations.toString(),items:this.state.iterationOptions,onSelect:this.onIterationSelect})),this.state.isCustomIteration&&s.createElement(S.FormItem,{className:"custom-iterations-form-item",label:V.CustomNumberOfIterationsLabel,message:this.state.customIterationValidationMessage,error:null!==this.state.customIterationValidationMessage},s.createElement(y.TextField,{ariaLabel:V.CustomIterations,value:this.textFieldValue,onChange:this.onCustomIterationChanged,width:"auto",className:"custom-iterations-text-field",inputClassName:"custom-iterations-text-field-input"})),(0,f.isFeatureFlagEnabled)(this.context.pageContext,"WebAccess.Widgets.ShowResolvedItemsAsCompleted",!1)&&s.createElement(S.FormItem,{label:V.AdvancedLabel},s.createElement(B.Checkbox,{label:this.renderCheckboxLabelWithInfoIcon(V.ShowResolvedItemsAsCompletedLabel),onChange:this.onToggleShowResolvedItemsAsCompleted,checked:null!==(t=null===(e=this.state.widgetSettings)||void 0===e?void 0:e.showResolvedItemsAsCompleted)&&void 0!==t&&t,tooltipProps:{text:V.ShowResolvedItemsAsCompletedLabelToolTipText}})),s.createElement(m.ResetElement,{onClick:this.resetSettings,isEnabled:this.state.hasCustomUserSettings}))}getKnownWarningComponent(){return this.state.knownWarning===V.MissingBacklogDetail?s.createElement(d.UnmaterializedBoardMessage,null):null}componentDidMount(){(0,c.resetQueryCache)(this.context.pageContext),this.initializeReportState()}componentDidUpdate(e){JSON.stringify(this.props)!==JSON.stringify(e)&&(this.props.lastRefresh!==e.lastRefresh&&(0,c.resetQueryCache)(this.context.pageContext),this.setState(this.getDefaultState()),this.initializeReportState())}async initializeReportState(){var e;this.cancelDataPromises();try{const t=await w.VelocityReportUserSettings.load(this.context.pageContext,this.props.teamId,this.props.categoryReferenceName),o=await(0,l.hasUserSeenBubble)(this.context.pageContext,(0,w.getVelocityReportSettingsStorageKey)());this.backlogCanceleablePromise=this.trackPromise((0,T.getBacklog)(this.context.pageContext,this.props.projectId,this.props.teamId,this.props.categoryReferenceName));const i=await this.backlogCanceleablePromise.promise;if(null==i){const e=V.MissingBacklogDetail;return this.setState({knownWarning:e}),void(0,g.publishEmptyReportTelemetry)(this.context.pageContext,this.getReportTelemetryName(),e)}const s=(0,k.getIterationOptions)();this.aggregationCanceleablePromise=this.trackPromise((0,n.getAggregationOptionsForBacklogCategories)(this.context.pageContext,this.props.projectId,this.props.teamId,[this.props.categoryReferenceName]));const a=await this.aggregationCanceleablePromise.promise,r=t.numberOfIterations||6,c=(0,R.packSettings)(this.props,i.BoardCategoryReferenceName,t.aggregationSettings,r,null!==(e=t.showResolvedItemsAsCompleted)&&void 0!==e&&e),m=this.isCustomIteration(s,r);this.setState({aggregationOptions:a,iterationOptions:s,widgetSettings:c,isCustomIteration:m,showTeachingBubble:!o,hasCustomUserSettings:"{}"!==JSON.stringify(t)}),m&&(this.textFieldValue.value=this.state.widgetSettings.numberOfIterations.toString()),(0,g.publishReportTelemetry)(this.context.pageContext,this.getReportTelemetryName(),{aggregationMode:c.aggregation.identifier,numberOfIterations:c.numberOfIterations,showResolvedItemsAsCompleted:c.showResolvedItemsAsCompleted})}catch(e){if(e.isCanceled)return;this.handleCommonInitError(e)}finally{this.props.onLoadCompleted&&this.props.onLoadCompleted()}}getDefaultState(){return Object.assign({aggregationOptions:[],iterationOptions:[],customIterationValidationMessage:null},super.getDefaultState())}isConfigurationValid(){return null===this.state.customIterationValidationMessage}getBackButtonProps(){return{onClick:()=>{const e=(0,r.getBoardsReportUrl)(this.context.pageContext,this.props.categoryName);(0,b.FastPageSwitch)(this.context.pageContext,e,!0)}}}cancelDataPromises(){this.backlogCanceleablePromise&&this.backlogCanceleablePromise.cancel(),this.aggregationCanceleablePromise&&this.aggregationCanceleablePromise.cancel()}validateAndSaveCustomIterationsInput(e){const t=Number(e);if(""!==e&&t>=1&&t<=15){this.setState({customIterationValidationMessage:null});const e=Object.assign({},this.state.widgetSettings);e.numberOfIterations=t,this.setUserSelection(e)}else this.setState({customIterationValidationMessage:(0,i.format)(u.ValueMustBeWithinRange,1,15)})}isCustomIteration(e,t){return!e.some((e=>null!=e.data&&e.data===t))}setUserSelection(e){w.VelocityReportUserSettings.save(this.context.pageContext,e,this.props.teamId,this.props.categoryReferenceName),this.setState({widgetSettings:e,hasCustomUserSettings:!0})}}t[e].VelocityReport=o,C.VssComponent.register("VelocityReport",o),C.VssComponent.register("VelocityReportPreloader",h.NoOpComponent)}("VelocityReport"),function(e){t[e]={};class o extends C.VssComponent{async componentDidMount(){this.setState(await(0,v.getReportPageState)(this.context.pageContext))}render(){return null==this.state?null:s.createElement(O.VelocityReport,{categoryReferenceName:this.state.categoryReferenceName,categoryName:this.state.categoryName,teamId:this.state.teamId,teamName:this.state.teamName,projectId:this.state.projectId})}}t[e].VelocityReportPage=o,C.VssComponent.register("VelocityReportPage",o)}("VelocityReportPage")}),["Resources","VelocityReportUserSettings","VelocityReportTeachingBubbleHelper","Pickers/BacklogsQuery","Pickers/IterationsPickerOptions","VelocityReport","VelocityReportPage"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-reporting-web.velocity-report-content"}}));