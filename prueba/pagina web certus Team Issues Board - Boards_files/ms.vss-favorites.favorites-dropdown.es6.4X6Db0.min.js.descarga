"use strict";define("Favorites/Dropdown",["require","exports","Favorites/Common/Resources","react","VSS/Core/Observable","VSS/Core/Util/String","VSS/Platform/UserClaims","VSSUI/Button","VSSUI/List","VSSUI/Observer","VSSUI/Table","VSSUI/Util","VSSUI/Utilities/AggregateItemProvider","VSSUI/Utilities/GroupedItemProvider","VSSUI/Clipboard","VSSUI/Resources.Clipboard","VSSUI/Dropdown","VSSUI/Icon","VSSUI/TooltipEx"],(function(t,e,i,s,o,r,a,n,d,l,c,h,v,f,p,u,g,m,I){!function(t){e[t]={};class g{constructor(t){this.observers=[],this.resolvedArtifactsByPivot={},this.pivotArtifactsById={},this.disposed=!1,this.builtInGroups=[],this.favoritesByArtifactId={},this.initialFavoriteItems={},this.extendedFavoritesLoaded=!1,this.groupedProvider=new f.GroupedItemProvider([],[],!1),this.getItems=()=>{const t=(0,a.userHasClaim)(this.options.pageContext,"member");if(!this.artifacts){this.artifacts=this.options.getArtifacts();const e=e=>{this.resolvedArtifacts=this.processResolvedArtifacts(e),this.artifactsLoaded=!0,t||(this.favoritesLoaded=!0),this.favoritesLoaded&&this.addResolvedItems(this.resolvedArtifacts)};if(this.artifacts.ready.value)e(this.artifacts.value);else{const t=t=>{t&&this.artifacts&&e(this.artifacts.value)};this.addObserver(this.artifacts.ready,t)}}if(!this.options.favoritesContext||!t)return;if(this.loadFavorites(),!this.favoritesCollection)return;const e=this.favoritesCollection.value.filter((t=>!t.artifactIsDeleted));this.initialFavoriteItems={};for(const t of e)this.favoritesByArtifactId[t.artifactId]?this.favoritesByArtifactId[t.artifactId].value=t:this.favoritesByArtifactId[t.artifactId]=new o.ObservableValue(t)},this.getListItem=t=>{const{getArtifactHref:e,getArtifactName:r,getArtifactId:a,getArtifactListGroupId:v,getArtifactIcon:f,getFavoriteFromArtifact:g,getArtifactTextNode:m}=this.options;let I=!0;const b={data:t,text:r(t),id:a(t)};return this.getFavoriteItem(a(t))?b.groupId="favorites":v&&(b.groupId=v(t)),b.groupId||(b.groupId="default"),f&&(b.iconProps=f(t)),this.favoritesByArtifactId[b.id]||(this.favoritesByArtifactId[b.id]=new o.ObservableValue(void 0)),b.render=(o,r,a,v)=>{let f=!this.options.hideFavoriteSelectedItemIndicator;if(b.id){this.getFavoriteItem(b.id)||g&&g(t)||(f=!1)}else f=!1;v.tooltipProps||(v.tooltipProps={disabled:!0},I=!1);const A="Microsoft.TeamFoundation.Git.GitRefFavorite"===this.options.favoritesContext.artifactType.toString();return s.createElement(c.SimpleTableCell,{className:(0,h.css)(a.className,v.className,2===v.type&&"bolt-list-box-header","artifact-list-item"),columnIndex:r,key:r,tableColumn:a},v&&(0,d.renderListCell)(Object.assign(Object.assign({},v),{textNode:m?m(b):void 0,href:e&&b.data?e(b.data):void 0,textClassName:"flex-grow artifact-link"}),!I),A&&s.createElement(p.ClipboardButton,{className:"artifact-dropdown-branch-copy-button",getContent:()=>{var t,e;return null!==(e=null===(t=v.text)||void 0===t?void 0:t.toString())&&void 0!==e?e:""},key:"clipboard",showCopiedTooltip:!0,tooltipProps:{text:u.CopyToClipboard}}),f&&s.createElement(l.Observer,{favorite:this.favoritesByArtifactId[b.id]},(t=>{const e=t.favorite?i.FavoriteStarFavoritedTitle:i.FavoriteStarUnfavoritedTitle;return s.createElement(n.Button,{ariaLabel:e,className:"artifact-item-favorite-button",iconProps:{iconName:t.favorite?"FavoriteStarFill":"FavoriteStar",className:(0,h.css)("artifact-item-favorite-icon ms-font-l",(!!t.favorite||this.initialFavoriteItems[b.id])&&"show-favorite")},subtle:!0,tooltipProps:{text:e},onClick:t=>this.onFavoriteClick(t,v)})})))},b},this.addObserver=(t,e)=>{t.subscribe(e),this.observers.push({observable:t,observer:e})},this.forgetCachedArtifacts=t=>{t?this.pivotArtifactsById[t]={}:(this.artifacts=void 0,this.pivotArtifactsById={},this.resolvedArtifacts=void 0)},this.onGroupLoadRequest=(t,e=0)=>{if("favorites"===t||"default"===t){const t=new o.ReadyableObservableArray;return t.ready.value=!0,t}const i=this.options.getArtifacts(t),s=this.options.groupToPivotMap&&this.options.groupToPivotMap[t]||"",r=new o.ReadyableObservableArray;this.resolvedArtifactsByPivot[s]=r;const a=i=>{const o=this.resolvedArtifactsByPivot[s]&&this.resolvedArtifactsByPivot[s].length;return r.push(...this.processResolvedArtifacts(i,s)),r.ready.value=!0,i.length>e&&this.resolvedArtifactsByPivot[s].length===o&&this.options.groups&&this.options.groups.some((e=>e.name===t&&Boolean(e.loading)))?this.onGroupLoadRequest(t,i.length):this.resolvedArtifactsByPivot[s]};if(i.ready.value)a(i.value);else{const t=t=>{t&&a(i.value)};this.addObserver(i.ready,t)}return r},this.addResolvedItems=t=>{this.favoritesLoaded&&this.artifactsLoaded&&this.defaultGroup&&this.groupedProvider.setGroupLoading(this.defaultGroup.id,!1),t&&this.groupedProvider.push(...t)},this.onFavoriteClick=(t,e)=>{let i=!1,s=this.getFavoriteItem(e.id);if(s)i=!0;else if(s=this.options.getFavoriteFromArtifact(e.data),!s)return;i?this.favoritesService.removeFavorite(s):this.favoritesService.addFavorite(s),t.preventDefault()},this.favoritesErrorDelegate=t=>{this.options.onFavoriteLoadError&&this.options.onFavoriteLoadError(t),this.favoritesLoaded=!0,this.addResolvedItems(this.resolvedArtifacts)},this.onFavoritesLoaded=t=>{if(this.disposed)return void t.dispose();this.favoritesCollection&&this.favoritesCollection!==this.options.favoritesContext.favorites&&this.favoritesCollection.dispose();const e=[...t.value].sort(((t,e)=>(0,r.localeIgnoreCaseComparer)(t.artifactName,e.artifactName)));if(this.favoritesCollection=t,t.subscribe(this.onFavoriteItemChanged),e.forEach((t=>{if(!t.artifactIsDeleted&&(this.initialFavoriteItems[t.artifactId]=!0,this.favoritesByArtifactId[t.artifactId]?this.favoritesByArtifactId[t.artifactId].value=t:this.favoritesByArtifactId[t.artifactId]=new o.ObservableValue(t),this.resolvedArtifacts)){const e=this.resolvedArtifacts.findIndex((e=>e.id===t.artifactId));e>-1&&this.resolvedArtifacts.splice(e,1,Object.assign(Object.assign({},this.resolvedArtifacts[e]),{groupId:this.favoriteGroup.id}))}})),this.options.onFavoritesLoaded&&this.options.onFavoritesLoaded(),this.favoritesLoaded=!0,this.options.getArtifactFromFavorite){const t=[];e.forEach((e=>{e.artifactIsDeleted||t.push(this.options.getArtifactFromFavorite(e))}));const i=this.processResolvedArtifacts(t);this.addResolvedItems(i)}return this.resolvedArtifacts&&this.addResolvedItems(this.resolvedArtifacts),t},this.onFavoriteItemChanged=(t,e)=>{if(t.addedItems)for(const e of t.addedItems)this.favoritesByArtifactId[e.artifactId].value=e;if(t.removedItems)for(const e of t.removedItems)this.favoritesByArtifactId[e.artifactId].value=void 0},t&&this.initialize(t)}get length(){return this.aggregateProvider.length}get value(){return this.aggregateProvider.value}subscribe(t,e){return this.aggregateProvider.subscribe(t,e)}unsubscribe(t,e){return this.aggregateProvider.unsubscribe(t,e)}dispose(){this.favoritesCollection&&(this.options.favoritesContext.favorites===this.favoritesCollection&&this.favoritesCollection.dispose(),this.favoritesCollection=void 0),this.observers.forEach((t=>{t.observable.unsubscribe(t.observer)})),this.disposed=!0}initialize(t){if(this.options=t,this.aggregateProvider=new v.AggregateItemProvider,this.options.pivots)this.options.pivots.forEach((t=>{this.aggregateProvider.push(t.items)})),this.favoritesService=t.favoritesService||t.pageContext.getService("IFavoritesService");else{this.aggregateProvider.push(this.groupedProvider),this.initializeDefaultGroup();const e=t.favoritesContext;this.favoritesService=t.favoritesService||t.pageContext.getService("IFavoritesService"),e&&this.favoritesService.canUseFavorites()&&(this.initializeFavoriteGroup(),e.favorites&&this.onFavoritesLoaded(e.favorites))}}loadFavorites(){if(this.extendedFavoritesLoaded)return Promise.resolve(void 0);const t=this.options.favoritesContext,e=this.favoritesService.getFavorites(t.artifactType,t.artifactScope.type,t.artifactScope.id,!0).then(this.onFavoritesLoaded,this.favoritesErrorDelegate);return this.extendedFavoritesLoaded=!0,e}processResolvedArtifacts(t,e){const i=e||"default-pivot",s=[];this.pivotArtifactsById[i]||(this.pivotArtifactsById[i]={});for(const e of t){const t=this.options.getArtifactId(e);this.pivotArtifactsById[i][t]||s.push(e),this.pivotArtifactsById[i][t]=e}return s.map((t=>this.getListItem(t)))}initializeDefaultGroup(){const t={id:"default",name:this.options.defaultGroupHeader,loading:!0};this.artifactsLoaded=!1;const e=this.tryGetGroupSynchronously("default");e?this.defaultGroup=e:(this.defaultGroup=t,this.builtInGroups.push(t),this.groupedProvider.pushGroups(t))}initializeFavoriteGroup(){const t={id:"favorites",name:this.options.favoriteGroupHeader};this.favoritesLoaded=!1;const e=this.tryGetGroupSynchronously("favorites");e?this.favoriteGroup=e:(this.favoriteGroup=t,this.builtInGroups.unshift(t),this.groupedProvider.spliceGroups(0,0,t))}tryGetGroupSynchronously(t){const{groups:e}=this.options;if(e&&"function"!=typeof e.then)return e.filter((e=>e.id===t))[0]}getFavoriteItem(t){const e=this.favoritesByArtifactId[t];return e||!this.favoritesCollection||this.artifacts?e?e.value:e:this.favoritesCollection.value.filter((e=>e.artifactId===t))[0]}}e[t].ArtifactDropdownProviderBase=g;e[t].ArtifactDropdownProvider=class extends g{constructor(t){super(t)}}}("ArtifactDropdownProvider"),function(t){e[t]={};class r extends s.Component{constructor(t){super(t),this.provider=new v.AggregateItemProvider,this.searchResults=new o.ObservableArray,this.dropdown=s.createRef(),this.onExpand=()=>{this.provider.collections.forEach((t=>{const e=t.provider;e.getItems&&e.getItems()}))},this.onSelect=(t,e)=>{e.data&&this.props.getArtifactHref&&(window.location.href=this.props.getArtifactHref(e.data)),this.props.onSelect&&this.props.onSelect(t,e)},this.onCollapse=()=>{this.props.onCollapse&&this.props.onCollapse()},this.renderSelectedItems=(t,e)=>n(e[t.value[0].beginIndex],t.selectedCount),this.selectedPivot=t.selectedPivot||new o.ObservableValue(t.pivots?t.pivots[0].id:""),this.provider.push(t.items),this.provider.push(this.searchResults),t.searchResultsGroupName&&this.searchResults.push({id:"search-results-header",text:t.searchResultsGroupName,type:2})}get actions(){const{browseAllText:t,onBrowseAllClick:e,otherActions:s}=this.props,o=s?[...s]:[];return e&&o.push({onClick:e,text:t||i.FavoriteItemPickerBrowseAllText,iconProps:{iconName:"Home"}}),o}render(){const{ariaLabel:t,calloutContentClassName:e,className:i,showFilterBox:o,filterPlaceholderText:r,filteredNoResultsText:a,filteredResultsLoadingText:n,loading:d,noItemsText:l,onFilterTextChanged:c,placeholder:h,pivots:v,renderExpandable:f,searching:p,selection:u,showItemsWhileSearching:m,userFilteredItems:I,width:b}=this.props,A={horizontal:"start",vertical:"end"},C={horizontal:"start",vertical:"start"},S=s.createElement(g.Dropdown,{ariaLabel:t,calloutContentClassName:e,className:i,filterThrottleWait:100,ref:this.dropdown,actions:this.actions,items:this.provider,loading:d,onExpand:this.onExpand,onSelect:this.onSelect,onCollapse:this.onCollapse,noItemsText:l,placeholder:h,renderCallout:t=>s.createElement(g.DropdownCallout,Object.assign({},t,{anchorOrigin:A,dropdownOrigin:C,filterPlaceholderText:r,filteredNoResultsText:a,filteredResultsLoadingText:n,onFilterTextChanged:(e,i)=>{t.onFilterTextChanged&&t.onFilterTextChanged(e,i),c&&c(e,i)}})),renderExpandable:f?t=>f(Object.assign(Object.assign({},t),{renderSelectedItems:this.renderSelectedItems})):void 0,searching:p,selection:u,showFilterBox:!1!==o,showItemsWhileSearching:m,userFilteredItems:I,width:b});return v?s.createElement(g.WithPivots,{selectedPivot:this.selectedPivot,onPivotClicked:this.onPivotClicked,pivots:v,calloutProps:{anchorOrigin:A,dropdownOrigin:C,onFilterTextChanged:c}},(t=>s.cloneElement(S,t))):S}componentWillUnmount(){this.provider.collections.forEach((t=>{t.provider&&t.provider.dispose&&t.provider.dispose()}))}expand(){this.dropdown.current&&this.dropdown.current.expand()}focus(){this.dropdown.current&&this.dropdown.current.focus()}onPivotClicked(t){this.selectedPivot.value=t.id}}function a(t,e){var i;return e&&1!=e?e>1?t.text+" (+"+(e-1).toString()+")":"":null!==(i=t.text)&&void 0!==i?i:""}function n(t,e,i=a){let o=i(t,e);return s.createElement("div",{className:"flex-row"},t.iconProps&&s.createElement(m.Icon,Object.assign({},t.iconProps,{className:(0,h.css)(t.iconProps.className,"artifact-dropdown-icon")})),s.createElement(I.Tooltip,{overflowOnly:!0},s.createElement("span",{className:"text-ellipsis"},o)))}e[t].ArtifactDropdown=r,e[t].renderSelectedItem=n}("ArtifactDropdown")}),["ArtifactDropdownProvider","ArtifactDropdown"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-favorites.favorites-dropdown"}}));