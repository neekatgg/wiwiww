"use strict";define("VC/ProjectOverview",["require","exports","react","VSS/Core/Util/Object","VSS/Core/Util/String","VSSUI/Spinner","VSSUI/Util","VSS/Core/Util/Promise","VSS/Legacy/Legacy","VSS/Platform/Components/FPSLink","VSS/Platform/Layout","VSS/Platform/Location","VSSUI/VssIcon","Repos/RepoDropdown/Components/RepositoryDropdown","VC/Common/Components/RepositoryDropdown","VSS/Platform/Feature","VC/Common/Utils/Ref","VSS/Platform/Context"],(function(e,t,i,o,s,r,n,a,d,p,c,h,m,l,g,f,S,v){var R,u,_;R=t[_="Resources"]={},t[_].ReadmeChoiceName="Readme file",t[_].SelectRepositoryLabel="Select a repository",t[_].ReadmeNotFoundTitle="We couldn't find Readme.md",t[_].ReadmeNotFoundMessage="Seems like the file has not been created or was deleted.",t[_].PreviewTitle="Preview",t[_].RepositoryPickerDescription="Select a repository with Readme to show in the About section.",function(e){u=t[e]={};class v extends c.VssComponent{constructor(e,t){super(e,t),this._readmeFileName="/README.md",this._readmeString="README.md",this._codeSource="Code",this._ttiMarked=!1,this._tfvcPrefix="$/",this._repoPickerAriaDescribedById=(0,o.getId)("repo-picker-description"),this._abortSplitTimeName="Code.FetchInitialData.Abort",this._endSplitTimeName="Code.FetchInitialData.End",this._logSplitTimeInRender=!0,this.getSelectedRepositoryItem=()=>{var e;const t=this.state.repositoryDropdownItem;return t?{id:t.id,name:t.name?t.name:"$/"+(null===(e=t.repository)||void 0===e?void 0:e.project.name),isTfvc:!!t.isTfvc,isFork:!!t.isFork}:{id:(0,o.getId)(R.SelectRepositoryLabel),name:R.SelectRepositoryLabel}},this.onRepoDropdownSelected=(e,t)=>{const i=t.data,o=this.state.repositoryDropdownItem&&this.state.repositoryDropdownItem.id;!i||i.isTfvc&&i.name===this.props.repoId||!i.isTfvc&&i.id===this.props.repoId||i.id===o||(this.setState({fetchingState:1,repositoryDropdownItem:i}),i.isTfvc?(this.props.onRepositoryChanged(i.name),this._fetchTfvcReadme(i.name)):(this.props.onRepositoryChanged(i.id),this.trackPromise(this.gitClient.getItem(i.id,this._readmeFileName,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0)).promise.then((e=>{this.setState({fetchingState:2,rendererOptions:{content:e.content,repository:i.repository,filePath:this._readmeFileName,branchName:i.repository?i.repository.defaultBranch:"master"}})}),this._onFetchingReadmeFailed)))},this._onContentRendered=()=>{!this._ttiMarked&&this.props.readMode&&(this.props.markTimeToInteractive(this._codeSource),this._ttiMarked=!0)},this._onRepositorySelected=e=>{if(!e||e.isTfvc&&e.name===this.props.repoId||!e.isTfvc&&e.id===this.props.repoId)return;const t=Object.assign(Object.assign({},this.state.pickerOptions),{selectedRepositoryId:e.id,selectedRepositoryIsFork:e.isFork,selectedRepositoryName:e.name,selectedRepositoryIsTfvc:e.isTfvc});this.setState({fetchingState:1,pickerOptions:t}),e.isTfvc?(this.props.onRepositoryChanged(e.name),this._fetchTfvcReadme(e.name)):(this.props.onRepositoryChanged(e.id),this.trackPromise(this.gitClient.getItem(e.id,this._readmeFileName,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0)).promise.then((t=>{this.setState({fetchingState:2,rendererOptions:{content:t.content,repository:e.repository,filePath:this._readmeFileName,branchName:e.repository?e.repository.defaultBranch:"master"}})}),this._onFetchingReadmeFailed))},this._onFetchingReadmeFailed=(e,t)=>{e.isCanceled||(t&&this._addSplitTiming(this._abortSplitTimeName),this.setState({fetchingState:3,rendererOptions:void 0,errorOptions:this._getErrorOptions(e)}))},this._onFetchingInitialDataFailed=(e,t,i)=>{i&&i.isCanceled||this.setState({fetchingState:3,pickerOptions:e,dropdownOptions:t,rendererOptions:void 0,errorOptions:i?this._getErrorOptions(i):{title:R.ReadmeNotFoundTitle,message:R.ReadmeNotFoundMessage}})},this.state={fetchingState:0},this._isRepoDropdownFFon=(0,f.isFeatureFlagEnabled)(this.context.pageContext,"CodeAboutRegion.EnableNewRepositoryDropdown",!1)}componentDidMount(){super.componentDidMount(),this.props.readMode?(this._addSplitTiming("Code.GetReadmeData.Start"),this.trackPromise(this.context.pageContext.getService("IVssContributionService").getDataAsync(v.PROVIDER_ID)).promise.then((e=>{if(this._addSplitTiming("Code.GetReadmeData.End"),e&&this.setState({showReadmeLink:e.hasCodeAccess}),e&&e.codeReadmeData&&(e.codeReadmeData.isTfvc||e.codeReadmeData.repository)&&this.props.repoId){const{content:t,repository:i,isTfvc:o}=e.codeReadmeData,{repoId:s}=this.props;if(s.startsWith(this._tfvcPrefix)&&o||i&&s===i.id){const{projectId:o,projectName:r}=this._getProjectInfo(this.context.pageContext);if(null!=t)this.setState({fetchingState:2,rendererOptions:{repository:i,content:t,branchName:i?i.defaultBranch:void 0,filePath:s.startsWith(this._tfvcPrefix)?s+this._readmeFileName:this._readmeFileName},pickerOptions:{projectName:r},dropdownOptions:{projectName:r},showReadmeLink:e.hasCodeAccess});else{const t=e&&e.supportsTfvc,i=this._getDefaultPickerOptions(o,r,t),s=this.getDefaultDropdownOptions(o,r,t);this._onFetchingInitialDataFailed(i,s)}}else this._fetchInitialData(this.props,this.context)}else this._fetchInitialData(this.props,this.context)}),(e=>{e.isCanceled||(this._addSplitTiming("Code.GetReadmeData.Failed"),this._fetchInitialData(this.props,this.context))}))):this._fetchInitialData(this.props,this.context)}componentDidUpdate(e,t){super.componentDidUpdate(e,t),e.repoId!==this.props.repoId&&this._fetchInitialData(this.props,this.context),!this._ttiMarked&&this.props.readMode&&3===this.state.fetchingState&&(this.props.markTimeToInteractive(this._codeSource),this._ttiMarked=!0)}render(){if(0===this.state.fetchingState)return this._logSplitTimeInRender&&(this._addSplitTiming("Code.FetchLegacyComponent.Start"),this._logSplitTimeInRender=!1),i.createElement(i.Fragment,null,this._loadingComponent(),i.createElement(d.LegacyComponent,{wrappedType:"TFS.ProjectOverview.ReadmeFileRenderer",modules:["ProjectOverview/Scripts/Shared/Components/ReadmeSection/ReadmeFileRenderer"],key:"readme-file-renderer"}));{const e=i.createElement("div",{id:this._repoPickerAriaDescribedById,className:"hidden",hidden:!0},R.RepositoryPickerDescription),t=this._isRepoDropdownFFon?!this.props.readMode&&this.state.dropdownOptions&&i.createElement(i.Fragment,null,i.createElement(l.RepositoryDropdown,{providerOptions:this.state.dropdownOptions,selectedRepositoryItem:this.getSelectedRepositoryItem(),onSelect:this.onRepoDropdownSelected,className:"about-repository-selector repo-dropdown-code-about-region",useDefaultCalloutWidth:!0}),e):!this.props.readMode&&this.state.pickerOptions&&i.createElement(i.Fragment,null,i.createElement(g.RepositoryDropdownComponent,{className:"about-repository-selector",providerOptions:this.state.pickerOptions,ariaDescribedBy:this._repoPickerAriaDescribedById,hideSelectedItemIcon:!0}),e);let o=null;if(this.props.readMode&&this.state.rendererOptions&&this.state.pickerOptions&&this.state.pickerOptions.projectName){const e=this.state.rendererOptions.repository;let t="",r="",a="";this.props.repoId&&this.props.repoId.startsWith(this._tfvcPrefix)?(t="tfvc-repo",r=this.props.repoId,a=(0,h.routeUrl)(this.context.pageContext,"ms.vss-code-web.tfvc-files-route",{project:this.state.pickerOptions.projectName,path:r+this._readmeFileName})):e&&(t=e.isFork?"git-fork":"git",r=e.name,a=(0,h.routeUrl)(this.context.pageContext,"ms.vss-code-web.files-route-git",{project:this.state.pickerOptions.projectName,"vc.GitRepositoryName":e.name,path:this._readmeFileName,version:(0,S.getVersionFromBranchName)((0,S.getFriendlyName)(e.defaultBranch))}));const d=(0,s.format)("{0} / {1}",r,this._readmeString),c="readme-title font-size-mm font-weight-semibold";o=i.createElement(i.Fragment,null,i.createElement(m.VssIcon,{iconName:t,iconType:1,className:"repo-icon"}),this.state.showReadmeLink?i.createElement(p.FPSLinkComponent,{className:(0,n.css)("readme-link link-text",c),href:a,telemetrySource:"project_overview_about_region_code"},d):i.createElement("span",{className:c},d))}let r=null;if(1===this.state.fetchingState)r=this._loadingComponent();else if(3===this.state.fetchingState&&this.state.errorOptions&&this.props.showError){const{message:e,title:t}=this.state.errorOptions;r=i.createElement("div",{className:"about-error-message",role:"alert"},i.createElement("div",{className:"error-title font-weight-semibold"},t),i.createElement("div",{className:"error-message"},e))}else if(2===this.state.fetchingState&&this.state.rendererOptions){const{repository:e,branchName:t,filePath:s,content:n}=this.state.rendererOptions;r=i.createElement(i.Fragment,null,!this.props.readMode&&i.createElement("div",{className:"about-preview-title"},R.PreviewTitle),o,i.createElement(d.LegacyComponent,{wrappedType:"TFS.ProjectOverview.ReadmeFileRenderer",modules:["ProjectOverview/Scripts/Shared/Components/ReadmeSection/ReadmeFileRenderer"],key:"readme-file-renderer",repository:e,branchName:t?(0,S.getFriendlyName)(t):t,filePath:s,content:n,onContentRendered:this._onContentRendered,className:"about-readme-file-renderer",loadingComponent:this._loadingComponent}))}return i.createElement("div",{className:(0,n.css)("code-about-region",this.props.readMode?"readmode":"editmode")},t,r)}}_loadingComponent(){return i.createElement(r.Spinner,{className:"about-loading-spinner"})}_fetchInitialData(e,t){this._addSplitTiming("Code.FetchInitialData.Start"),this.trackPromise(t.pageContext.getService("IVssContributionService").getDataAsync(v.PROVIDER_ID,{scope:"supportsTfvc"})).promise.then((i=>{const o=i&&i.supportsTfvc,{projectId:s,projectName:r}=this._getProjectInfo(t.pageContext);if(e.repoId)if(e.repoId.startsWith(this._tfvcPrefix)){const t={onRepositorySelected:this._onRepositorySelected,projectId:s,projectName:r,selectedRepositoryId:"tfvc",selectedRepositoryIsFork:!1,selectedRepositoryName:e.repoId,selectedRepositoryIsTfvc:!0,supportsTfvc:o},i=this.getDefaultDropdownOptions(s,r,o),n={name:e.repoId,isTfvc:!0,isFork:!1,id:"tfvc"};this.setState({fetchingState:1,pickerOptions:t,dropdownOptions:i,repositoryDropdownItem:n}),this._fetchTfvcReadme(e.repoId,!0)}else{const i=this.props.readMode?this.trackPromise(t.pageContext.getService("IVssContributionService").getDataAsync(v.PROVIDER_ID,{scope:"gitRepositoryInfo"},!0).then((e=>e&&e.codeRepositoryData.repository))).promise:this.trackPromise(this.gitClient.getRepository(e.repoId)).promise,n=this.gitClient.getItem(e.repoId,this._readmeFileName,s,void 0,void 0,void 0,void 0,void 0,void 0,!0);a.allSettled([i,n]).then((e=>{const t="rejected";if(e[0].state===t){this._addSplitTiming(this._abortSplitTimeName);const t=this._getDefaultPickerOptions(s,r,o),i=this.getDefaultDropdownOptions(s,r,o),n=e[0].reason;this._onFetchingInitialDataFailed(t,i,n)}else{const i=e[0].value;if(i){const n={onRepositorySelected:this._onRepositorySelected,projectId:s,projectName:r,selectedRepositoryId:i.id,selectedRepositoryIsFork:i.isFork,selectedRepositoryName:i.name,selectedRepositoryIsTfvc:!1,supportsTfvc:o},a=this.getDefaultDropdownOptions(s,r,o);if(e[1].state===t){this._addSplitTiming(this._abortSplitTimeName);const t=e[1].reason;this._onFetchingInitialDataFailed(n,a,t)}else{this._addSplitTiming(this._endSplitTimeName);const t={content:e[1].value.content,repository:i,filePath:this._readmeFileName,branchName:i.defaultBranch},o={name:i.name,isTfvc:!1,isFork:i.isFork,id:i.id,repository:i};this.setState({fetchingState:2,pickerOptions:n,dropdownOptions:a,rendererOptions:t,repositoryDropdownItem:o})}}else{this._addSplitTiming(this._abortSplitTimeName);const e=this._getDefaultPickerOptions(s,r,o),t=this.getDefaultDropdownOptions(s,r,o);this._onFetchingInitialDataFailed(e,t)}}}))}else{this._addSplitTiming(this._abortSplitTimeName);const e=this._getDefaultPickerOptions(s,r,o),t=this.getDefaultDropdownOptions(s,r,o);this.setState({fetchingState:3,pickerOptions:e,dropdownOptions:t,errorOptions:void 0})}}),(()=>{this._addSplitTiming(this._abortSplitTimeName)}))}_getProjectInfo(e){const t=e.getService("ITfsPageService").getData();if(t&&t.project){const e=t.project;return{projectId:e.id,projectName:e.name}}return{}}_getDefaultPickerOptions(e,t,i){return{onRepositorySelected:this._onRepositorySelected,projectId:e,projectName:t,supportsTfvc:i,selectedRepositoryName:R.SelectRepositoryLabel}}getDefaultDropdownOptions(e,t,i){return{projectId:e,projectName:t,supportsTfvc:i}}_fetchTfvcReadme(e,t){const i=e+this._readmeFileName,o=this.context.pageContext.getRestClient("ITfvcRestClient");this.trackPromise(o.getItem(i,void 0,void 0,void 0,void 0,void 0,void 0,!0)).promise.then((e=>{t&&this._addSplitTiming(this._endSplitTimeName);const o={content:e.content,repository:void 0,filePath:i,branchName:void 0};this.setState({fetchingState:2,rendererOptions:o})}),(e=>{this._onFetchingReadmeFailed(e,t)}))}_getErrorOptions(e){return!e||400!==e.status&&404!==e.status?void 0:{title:R.ReadmeNotFoundTitle,message:R.ReadmeNotFoundMessage}}_addSplitTiming(e){if(this._ttiMarked)return;this.context.pageContext.getService("IVssPerformanceService").addSplitTiming(e)}get gitClient(){return this._gitClient||(this._gitClient=this.context.pageContext.getRestClient("IGitRestClient")),this._gitClient}}t[e].CodeAboutRegion=v,v.PROVIDER_ID="ms.vss-code-web.code-readme-data-provider-verticals"}("CodeAboutRegion"),function(e){t.CodeProjectAboutService={};class o extends v.VssService{getAboutRegion(e,t,o,s,r){return i.createElement(u.CodeAboutRegion,{readMode:e,repoId:t,onRepositoryChanged:o,markTimeToInteractive:s,showError:r})}getChoiceName(){return R.ReadmeChoiceName}}v.Services.add("VC.ProjectAboutService",{serviceFactory:o})}()}),["Resources","CodeAboutRegion","CodeProjectAboutService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-code-web.projectoverview-content"}}));