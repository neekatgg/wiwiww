"use strict";define("Comments/Editor",["require","exports","Comments/Common/Resources","react","VSS/Core/Observable","VSS/Platform/Layout","VSSUI/Button","VSSUI/Dialog","VSSUI/Observer","VSSUI/Util"],(function(e,t,i,s,o,r,a,n,l,c){var m,d,h;m=t[h="Resources"]={},t[h].ConfirmDiscardCommentDraft="Are you sure you want to discard this draft?",t[h].Discard="Discard",t[h].Update="Update",t[h].DefaultCommentEditorAriaLabel="Comment",function(e){d=t[e]={};const h=["ms.vss-markdown.markdown-editor"],p=["image/*"],u={"image/jpg":"jpg","image/jpeg":"jpg","image/png":"png","image/bmp":"bmp","image/gif":"gif","image/tif":"tif","image/tiff":"tif"};class g extends s.PureComponent{constructor(e){super(e),this._showDiscardDialog=new o.ObservableValue(!1),this._blobUrlToFinalUrlMap={},this._onRenderDefaultEditor=e=>{const{onRenderPreview:t,uploadImageHandler:i,ariaLabel:o,ariaLabelledBy:a,placeholder:n}=this.props;return s.createElement(s.Fragment,null,s.createElement(r.WrappedComponent,{dependencies:h,wrappedType:"ms.vss-markdown.markdown-component",wrappedProps:{enableMentions:!0,onTextChanged:e.onChange,isActive:!!t,renderPreview:this._onRenderPreview,autoAdjustHeight:!0,value:this.state.value,autoFocus:!0,showToolbar:!0,className:"comment-markdown-component",addAttachments:i?this._onAddAttachments:void 0,validAttachmentTypes:p,ariaLabel:o||m.DefaultCommentEditorAriaLabel,ariaLabelledBy:a,placeholder:n},wrappedRef:this._editorRef}))},this._onAddAttachments=async(e,t,i)=>{if(!e||e.length<1)return;const s=e[0],{uploadImageSizeLimitByte:o}=this.props;if(s.size>o)return;const r=s.type?u[s.type]:"png";if(!r)return;const{uploadImageHandler:a}=this.props;if(!a)return;const n=this.state.value,l=n.substring(0,t),c=n.substring(i),m=s.name||`image.${r}`,d=new Blob([s],{type:s.type}),h=URL.createObjectURL(d),p=`${l}${`![${m}](${h})`} ${c}`;this.setState({value:p},(()=>this._onChange(p)));const g=await a(s);this._isDisposing?URL.revokeObjectURL(h):this._blobUrlToFinalUrlMap[h]=g},this._onRenderPreview=e=>{const{onRenderPreview:t}=this.props;return new Promise(((i,o)=>{if(t){const e=this._editor.getValue(!0);e instanceof Promise?e.then((e=>{i(t(e))})):i(t(e))}else i(s.createElement(s.Fragment,null,e))}))},this._onChange=e=>{const{comment:t,onChange:i}=this.props;i&&i(t.id,e),this.setState({isDirty:this._getDirtyState(e),value:e})},this._editorRef=e=>{const{onEditorMounted:t,comment:i}=this.props;if(this._editor=e,e){const s=e.getValue();if(s instanceof Promise)return void s.then((e=>{this._originalValue=void 0!==this.props.originalText?this.props.originalText:e,this.setState({isDirty:this._getDirtyState(e)}),t&&t(i.id)}));this._originalValue=void 0!==this.props.originalText?this.props.originalText:s,this.setState({isDirty:this._getDirtyState(s)}),t&&t(i.id)}},this._renderButtons=()=>{const{updateButtonText:e,infoMessage:t}=this.props;return s.createElement("div",{className:"comment-message-area"},s.createElement("div",{className:"custom-message"},t),s.createElement("div",{className:"actions-area"},s.createElement(a.Button,{className:"editor-cancel-button",text:i.Cancel,onClick:this._onCancelClick,ariaLabel:i.Cancel}),s.createElement(a.Button,{text:e||m.Update,ariaLabel:e||m.Update,disabled:!this.state.isDirty,onClick:this._onUpdateClick,primary:!0})))},this._renderDiscardDraftDialog=()=>{const e="cancel-discard-draft";return s.createElement(l.Observer,{isDialogOpen:this._showDiscardDialog},(t=>t.isDialogOpen&&s.createElement(n.Dialog,{titleProps:{text:m.ConfirmDiscardCommentDraft},onDismiss:this._dismissDiscardDraftDialog,lightDismiss:!1,defaultActiveElement:`.${e}`,footerButtonProps:[{text:i.Cancel,onClick:this._dismissDiscardDraftDialog,className:e},{text:m.Discard,danger:!0,onClick:this._onConfirmDiscardClick}]})))},this._dismissDiscardDraftDialog=()=>{const{comment:e,onKeepDraft:t}=this.props;if(this._showDiscardDialog.value=!1,!t)return;const i=this._editor.getValue();i instanceof Promise?i.then((i=>t(e.id,i))):t(e.id,i)},this._onConfirmDiscardClick=()=>{const{comment:e,onCancelEdit:t}=this.props,{isDirty:i}=this.state;this.setState({isDirty:!1}),t&&t(e.id,i)},this._onUpdateClick=()=>{const{isDirty:e}=this.state;if(!e)return;const{comment:t,onUpdate:i}=this.props,{text:s}=t;this.setState({isDirty:!1});const o=this._editor.getValue(!0);o instanceof Promise?o.then((e=>i(t.id,this._resolveBlobUrl(e),s))):i(t.id,this._resolveBlobUrl(o),s)},this._onCancelClick=()=>{const{isDirty:e}=this.state;if(e)this._showDiscardDialog.value=!0;else{const{comment:t,onCancelEdit:i}=this.props;i&&i(t.id,e)}},this._originalValue=null!=e.originalText?e.originalText:e.comment.text,this.state={isDirty:this._getDirtyState(e.comment.text),value:e.comment.text}}render(){const{className:e,onRenderEditor:t=this._onRenderDefaultEditor,comment:i,uploadImageHandler:o,ariaLabel:r,ariaLabelledBy:a,placeholder:n}=this.props;return s.createElement("div",{className:(0,c.css)("comment-editor",e)},t({ref:this._editorRef,onChange:this._onChange,comment:i,uploadImageHandler:o,ariaLabel:r,ariaLabelledBy:a,placeholder:n}),this._renderButtons(),this._renderDiscardDraftDialog())}componentDidUpdate(e,t){const{isDirty:i}=this.state,{comment:s,onDirtyChange:o}=this.props;o&&t.isDirty!==i&&o(s.id,i)}componentWillUnmount(){const{comment:e,onDirtyChange:t}=this.props;this._isDisposing=!0,t&&this.state.isDirty&&t(e.id,!1),this._blobUrlToFinalUrlMap&&(Object.keys(this._blobUrlToFinalUrlMap).forEach((e=>URL.revokeObjectURL(e))),this._blobUrlToFinalUrlMap=null)}_getDirtyState(e){const t=this._editor;return this._originalValue!==e&&!!e&&e.trim().length>0&&(!t||!t.isEmpty())}_resolveBlobUrl(e){if(this.props.onRenderEditor)return e;for(const t in this._blobUrlToFinalUrlMap)e=e.replace(new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),this._blobUrlToFinalUrlMap[t]);return e.replace(/!\[[^\]]+\]\(blob:[^)]+\)/gi,"")}}t[e].CommentEditor=g,g.defaultProps={uploadImageSizeLimitByte:26214400},r.VssComponent.register("comment-editor",g)}("ComponentsCommentEditor"),function(e){t[e]={},Object.defineProperty(t[e],"CommentEditor",{enumerable:!0,get:function(){return d.CommentEditor}})}("CommentEditor")}),["Resources","Components/CommentEditor","CommentEditor"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-comments.editor"}}));