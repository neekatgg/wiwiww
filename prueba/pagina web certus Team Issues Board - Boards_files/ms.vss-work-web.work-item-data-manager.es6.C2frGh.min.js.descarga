"use strict";define("Wit/WorkItemDataManager",["require","exports","VSS/Platform/Telemetry","VSS/Platform/Trace","Wit/Common/Generated/Constants","VSS/Core/Util/String","VSS/Platform/Util/Cookie","TFS/Services/LocalSettingsService","Tfs/Platform/Page","VSS/Platform/Util/Serialization","VSS/Platform/Context"],(function(e,t,a,r,o,s,n,i,c,m,d){var h,u,l,g,p,v,C,I,k,S,w,_;h=t[_="Resources"]={},t[_].MVCActionToDpIdMappingNotFoundError="There is no dataprovider id mapped for the passed action {0}",t[_].WorkItemNotFoundClientException="TF401232: Work item {0} does not exist, or you do not have permissions to read it.",function(e){u=t[e]={},t[e].constructCacheProvider=async function(e){const t=e.getService("ILegacyPlatformService"),a=await t.getLegacyPageContext();return n.isSupported(a)?new n(e):((0,r.traceWarning)(e,o.WITCommonConstants.WorkItemTrackingArea,"constructCacheProvider","Could not find supported WIT cache provider"),new c)};const s="/Service/WorkItemTracking/IndexedDbVersion";class n{constructor(e){this._disposed=!1,this._evictEntries=()=>{const e=Date.now()-5184e5;this._ensureStore((()=>this._store.getAll().then((t=>Object.keys(t).filter((a=>t[a].cachedAt<e)))).then((e=>(e.length>0&&(0,a.publishEvent)(this._pageContext,o.WITCommonConstants.WorkItemTrackingArea,"Caching",{numberOfEvictedItems:e.length}),e.reduce(((e,t)=>e.then((()=>this._store.delete(t)))),Promise.resolve(null)))))))},this._pageContext=e,this._store=new i(e),this._witIndexedDBRegistryVersion=null;const t=window.__vssPageContext.webAccessConfiguration.registryItems;t&&t.hasOwnProperty(s)&&(this._witIndexedDBRegistryVersion=Number(t[s])),this._openPromise=this._store.open("wit","metaDataCache").then((()=>{this._openPromise=null})).then((()=>this._scheduleEviction())).catch((t=>{(0,r.traceError)(e,o.WITCommonConstants.WorkItemTrackingArea,"OpenKeyValueStore",`Could not open IndexedDB: ${(null==t?void 0:t.message)||t}`),this._store=null,this._disposed=!0}))}static isSupported(e){try{const t=e.webAccessConfiguration.registryItems;let a=!1;return t&&t.hasOwnProperty(s)&&(a=!0),null!=window.indexedDB&&a}catch(e){return console.warn("Failed to get indexed db WIT cache: ",e),!1}}dispose(){this._disposed||(this._disposed=!0,this._store&&(this._openPromise=null,this._store.close(),this._store=null),void 0!==this._evictionTimerId&&window.clearTimeout(this._evictionTimerId))}store(e,t,a){return this._ensureStore((()=>this._store.set(this._getKey(e,t),a)))}delete(e,t){return this._ensureStore((()=>this._store.delete(this._getKey(e,t))))}read(e,t){return this._ensureStore((()=>this._store.get(this._getKey(e,t))))}update(e,t,a){return this._ensureStore((()=>this._store.getAndSet(this._getKey(e,t),a)))}_ensureStore(e){return!this._store||this._disposed?Promise.resolve():this._openPromise?this._openPromise.then((()=>{if(this._store)return e()})):e()}_getKey(e,t){return`wit/${this._witIndexedDBRegistryVersion}/${e}/${t}`}_scheduleEviction(){this._evictionTimerId=window.setTimeout(this._evictEntries,3e3)}}class i{constructor(e){this._pageContext=e}open(e,t){this._dbName=e,this._storeName=t;const a=window.indexedDB.open(e,1);return new Promise(((e,r)=>{a.onsuccess=()=>e(a.result),a.onerror=()=>r(a.error),a.onupgradeneeded=e=>{if(console.log(`Upgrading from ${e.oldVersion} to ${e.newVersion}`),e.oldVersion<1)try{a.result.createObjectStore(t)}catch(e){console.error(e)}else console.error("Upgrade not supported yet")}})).then((()=>{this._db=a.result,this._sendQuotaInformation()}))}close(){return new Promise((e=>{this._db&&(this._db.close(),this._db=null)}))}getAll(){return new Promise(((e,t)=>{const a={};this._usingTransaction("readonly",(t=>{t.openCursor().onsuccess=t=>{const r=t.target.result;r?(a[r.key]=r.value,r.continue()):e(a)}})).then(null,t)}))}get(e){return this._usingTransaction("readonly",(t=>t.get(e)))}set(e,t){return this._usingTransaction("readwrite",(a=>a.put(t,e))).then()}getAndSet(e,t){return this._usingTransaction("readwrite",(a=>{const r=a.get(e);r.onsuccess=()=>{const o=r.result,s=t(o);return a.put(s,e)}})).then()}delete(e){return this._usingTransaction("readwrite",(t=>t.delete(e))).then()}_usingTransaction(e,t){return new Promise(((a,r)=>{if(!this._db)return void r(new Error("KeyValueStore: DB not ready"));const o=this._db.transaction(this._storeName,e);let s=null;o.oncomplete=e=>{a(s)};const n=e=>{e&&e.target&&e.target.error?r(e.target.error):r(e)};o.onabort=n,o.onerror=n;const i=o.objectStore(this._storeName);s=t(i)||null,s&&(s.onerror=e=>{r(e)})})).then((e=>{if(e)return e.result}))}_sendQuotaInformation(){try{const e=navigator;e&&e.webkitTemporaryStorage&&e.webkitTemporaryStorage.queryUsageAndQuota&&e.webkitTemporaryStorage.queryUsageAndQuota(((e,t)=>{(0,a.publishEvent)(this._pageContext,o.WITCommonConstants.WorkItemTrackingArea,"IndexedDB",{usedQuota:e,availableQuota:t})}))}catch(e){}}}class c{delete(e,t){return Promise.resolve()}store(e,t,a){return Promise.resolve()}update(e,t,a){return Promise.resolve()}read(e,t){return Promise.resolve(void 0)}}t[e].NullCacheProvider=c}("CacheManagersCacheProviders"),function(e){l=t[e]={};t[e].WorkItemIndexDBCacheManager=class{constructor(e){this._pageContext=e}getDataFromCache(e,t,a,s){return a=this._transformKey(a),s||(0,r.traceWarning)(this._pageContext,o.WITCommonConstants.WorkItemTrackingArea,"IndexDbManager.GetCacheStamp",`Could not get cache stamp for '${t}'`),this._tryGetDataFromCache(e,t,a,s).catch((e=>((0,r.traceWarning)(this._pageContext,o.WITCommonConstants.WorkItemTrackingArea,"IndexDbManager.TryGetDataFromCache",e),null))).then((e=>e||null))}async _tryGetDataFromCache(e,t,a,r){return await this.getCacheProvider(),this._cacheProvider&&r?this._cacheProvider.read(e,t).then((o=>o&&o.data[a]?o.cachestamp!==r?(this._recordTelemetry(e,t,a,r,"ClearedCachedStaleData"),this._cacheProvider.delete(e,t).then()):o.data[a]:(this._recordTelemetry(e,t,a,r,"CacheMiss"),null))):Promise.resolve(null)}async cacheData(e,t,a,r,o){if(await this.getCacheProvider(),!this._cacheProvider||!o)return Promise.resolve(null);let s;return a=this._transformKey(a),this._cacheProvider.update(e,t,(e=>(e=e&&e.cachestamp===o?Object.assign(Object.assign({},e),{data:Object.assign(Object.assign({},e.data),{[a]:r})}):{cachedAt:Date.now(),cachestamp:o,data:{[a]:r}},s=Object.keys(e.data),e))).then((()=>s))}async deleteData(e,t){return await this.getCacheProvider(),this._cacheProvider.delete(e,t)}async getCacheProvider(){return void 0===this._cacheProvider&&(this._cacheProvider=await(0,u.constructCacheProvider)(this._pageContext)),this._cacheProvider}_transformKey(e){return e.toLowerCase()}_recordTelemetry(e,t,r,o,s,n){(0,a.publishEvent)(this._pageContext,"WIT","WITData",{scopeId:e,type:t,key:r,stamp:o,message:s,cachedData:n})}}}("CacheManagersWorkItemIndexDBCacheManager"),function(e){g=t[e]={};const a="WIT-METADATA",r={[o.WITCommonConstants.TeamProjects.toLowerCase()]:!0,[o.WITCommonConstants.LinkTypes.toLowerCase()]:!0,[o.WITCommonConstants.WorkItemTypes.toLowerCase()]:!0};t[e].WorkItemMetadataCacheInformationManager=class{constructor(e){this._pageContext=e}persist(e,t,r,c){if(!this._shouldSetCookieForType(t)||!c)return;const u=(0,s.format)(o.WorkItemTrackingMetadataCacheConstants.CookieFormat,e),l=this._pageContext.getService("ILocalSettingsService");let g=(0,n.getCookie)(u);if(g||(g=l.read(a,void 0,i.LocalSettingsScope.Project)),!g)return;const p=function(e){const t={};return decodeURIComponent(e||"").split(m).forEach((e=>{const a=e.split(d);if(a.length>2){const e=a[0],r=a[1],o=a[2],s=a[3].split(h);t[e]={scopeId:r,stamp:o,keys:s.length>0&&s||"_"}}})),t}(g);p[t]={scopeId:e,stamp:c,keys:r},g=function(e){const t=[];for(const a of Object.keys(e)){const r=e[a];t.push([a,r.scopeId,r.stamp,Array.isArray(r.keys)&&r.keys.join(h)||r.keys].join(d))}return encodeURIComponent(t.join(m))}(p);const v=this._getCookieLocation();v&&((0,n.setCookie)(u,g,v,void 0,432e3),l.write(a,g,i.LocalSettingsScope.Project))}readInformationForNonWITLocation(){return this._pageContext.getService("ILocalSettingsService").read(a,void 0,i.LocalSettingsScope.Project)}_shouldSetCookieForType(e){return r[e.toLowerCase()]}_getCookieLocation(){var e,t,a;const r=null===(t=null===(e=(0,c.getTFSPageData)(this._pageContext))||void 0===e?void 0:e.project)||void 0===t?void 0:t.name,o=null===(a=this._pageContext.getService("IVssPageService").getData())||void 0===a?void 0:a.hostName;if(r&&o)return`/${o}/${r}/_workitems/`}};const m="|",d=":",h=","}("CacheManagersWorkItemMetadataCacheInformationManager"),function(e){p=t[e]={};const r="ms.vss-work-web.work-item-cache-data-provider";t[e].WorkItemMetadataCacheStampManager=class{constructor(e){this._cachedPromises={},this._workItemMetaDataCacheStamps={},this._pageContext=e,this._contributionService=e.getService("IVssContributionService")}makeCacheKey(e){return(null==e?void 0:e.length)>0?e.sort().reduce(((e,t)=>e+t)):"_"}ensureStampsForCurrentProject(e,t=!1){const a=e.toUpperCase();return this._contributionService.getDataAsync(r).then((e=>{e&&e.data&&this._setCacheStamps(e.data,a)}))}getMetadataCacheStamp(e,t){var r;const s=null===(r=(0,c.getTFSProject)(this._pageContext))||void 0===r?void 0:r.id,n=(t||s||"").toUpperCase();if(!n)return Promise.resolve(null);const i=()=>this._workItemMetaDataCacheStamps[n]?this._workItemMetaDataCacheStamps[n][e]:null;return this._workItemMetaDataCacheStamps[n]?Promise.resolve(i()):this._cachedPromises[n]?this._cachedPromises[n].then((()=>i()),(()=>i())):(this._cachedPromises[n]=this._ensureMetadataCacheStamps(n,s,t),this._cachedPromises[n].then((()=>(delete this._cachedPromises[n],i())),(e=>(delete this._cachedPromises[n],(0,a.publishEvent)(this._pageContext,o.WITCommonConstants.WorkItemTrackingArea,"getMetadataCacheStamp",{error:e}),i()))))}_ensureMetadataCacheStamps(e,t,a){const o=!a||(0,s.equals)(a,t||"",!0),n=t=>{this._workItemMetaDataCacheStamps[e]=t?t.workItemMetadataCacheStamp:null,this.workItemTypesEtag=t?t.rawWorkItemTypesEtagForCI:null};let i;return!o&&a&&(i={projectId:a}),this._pageContext.getService("IVssPerformanceService").addSplitTiming("WorkItemTracking.GetMetadataCacheStamp.FromPageData"),this._contributionService.getDataAsync(r,i).then((e=>{e&&e.data&&n(e.data)}))}_setCacheStamps(e,t){this._workItemMetaDataCacheStamps[t]=e?e.workItemMetadataCacheStamp:null,this.workItemTypesEtag=e?e.rawWorkItemTypesEtagForCI:null}async addStampToParams(e,t,a){const r=await this.getMetadataCacheStamp(e,a);return r?(e=>e?t?(t.stamp=e,t):{stamp:e}:t)(r):t}}}("CacheManagersWorkItemMetadataCacheStampManager"),function(e){v=t[e]={},t[e].canDeserializeRules=function(e){var t;const a=null===(t=null==e?void 0:e.rules)||void 0===t?void 0:t.fieldRules;return"string"==typeof a||a instanceof String}}("Utils"),function(e){C=t[e]={},t[e].WorkItemDataProviderId="ms.vss-work-web.work-item-data-provider";function a(e){return e.status===o.CacheStatus.UpToDate||"string"==typeof e.status&&e.status===o.CacheStatus[o.CacheStatus.UpToDate]}t[e].WorkItemDataProviderSource=class{constructor(e,t){this._pageContext=e,this._cacheInformationManager=t}getWorkItemData(e){if(!this._containsWorkItemData(e))return null;const t=this._getDataProviderData();return this._processWorkItemData(e,t)}beginGetWorkItemData(a,r,o,s){if(1!==a.length)return Promise.resolve(null);const n=a[0];if(!s&&this._containsWorkItemData(n))return Promise.resolve([this.getWorkItemData(n)]);const i={id:a[0],"include-history":s,"include-in-recent-activity":o,"is-deleted":r,cookie:this._cacheInformationManager&&this._cacheInformationManager.readInformationForNonWITLocation()};return this._pageContext.getService("IVssContributionService").getDataAsync(t[e].WorkItemDataProviderId,i,!0).then((e=>e?(this._dataProviderData=e,[this._processWorkItemData(n,this._dataProviderData)]):Promise.resolve(null)))}_processWorkItemData(e,t,a=!0){var r;let o=t["work-item-data"];if(!o){const e=t["work-item-data-serialized"];e&&(o=null!==(r=(0,m.deserializeVssJsonObject)(e))&&void 0!==r?r:void 0)}if(!o)throw new Error((0,s.format)(h.WorkItemNotFoundClientException,e));return a&&(delete t["work-item-id"],delete t["work-item-data"],delete t["work-item-data-serialized"]),o}beginGetWorkItemTypeData(e,t){if(t.length>1)return Promise.resolve(null);const r=this._getDataProviderData(),o=r&&r["work-item-type-data"];if(o){if(a(o))return Promise.resolve(null);if(o.data){const a=Object.assign(Object.assign({},o.data),{rules:Object.assign(Object.assign({},o.data.rules),{fieldRules:{}})});if(!(0,s.equals)(a.projectGuid,e,!0))return Promise.resolve(null);if(!(0,s.equals)(t[0],a.referenceName,!0)&&!(0,s.equals)(t[0],a.name,!0))return Promise.resolve(null);if((0,v.canDeserializeRules)(o.data)){const e=(0,m.deserializeVssJsonObject)(o.data.rules.fieldRules);e&&(a.rules.fieldRules=e)}else a.rules.fieldRules=a.rules.fieldRules;return Promise.resolve([a])}}return Promise.resolve(null)}beginGetFields(){return Promise.resolve(null)}beginGetFieldProjectData(e){const t=this._getDataProviderData(),r=t&&t["work-item-project-field-data"];if(r){if(a(r))return Promise.resolve(null);if(r.data&&r.data.projects){if(!r.data.projects.some((t=>(0,s.equals)(e,t.guid,!0)||(0,s.equals)(e,t.name,!0))))return Promise.resolve(null)}return Promise.resolve(r.data)}return Promise.resolve(null)}beginGetLinkTypes(){const e=this._getDataProviderData(),t=e&&e["work-item-link-data"];return t?a(t)?Promise.resolve(null):Promise.resolve(t.data):Promise.resolve(null)}beginGetConstantSets(e){const t=this._getDataProviderData(),r=t&&t["work-item-constant-sets"];if(r){if(a(r))return Promise.resolve({});let t={};return e.forEach((e=>{t[e]=r.data[e]})),Promise.resolve(t)}return Promise.resolve(null)}_containsWorkItemData(e){const t=this._getDataProviderData();return t&&t["work-item-id"]===e&&void 0!==t["work-item-data"]}_getDataProviderData(){if(!this._dataProviderData){const a=this._pageContext.getService("IVssContributionService").getData(t[e].WorkItemDataProviderId);a&&(this._dataProviderData=a)}return this._dataProviderData}}}("SourcesWorkItemDataProviderSource"),function(e){I=t[e]={};t[e].QueryDataProviderSource=class{constructor(e){this.pageContext=e}beginGetWorkItemData(e,t,a,r){return Promise.resolve(null)}beginGetWorkItemTypeData(e,t){return Promise.resolve(null)}beginGetLinkTypes(){return Promise.resolve(null)}beginGetConstantSets(e){return Promise.resolve(null)}beginGetFields(){return Promise.resolve(null)}beginGetFieldProjectData(e){const t=this._getDataProviderData(),a=t&&t.projectFieldData;if(a){if(a.projects.some((t=>0===(0,s.localeIgnoreCaseComparer)(t.guid,e)||0===(0,s.localeIgnoreCaseComparer)(t.name,e))))return Promise.resolve(a)}return Promise.resolve(null)}_getDataProviderData(){return this.pageContext.getService("IVssContributionService").getData("ms.vss-work-web.query-data-provider")}}}("SourcesQueryDataProviderSource"),function(e){k=t[e]={};const a={fields:"ms.vss-work-web.fields-data-provider",allowedValues:"ms.vss-work-web.fields-allowed-values-provider",ResourceLinks:"ms.vss-work-web.resource-links-data-provider",workItemTypeExtensions:"ms.vss-work-web.work-item-type-extensions-data-provider",updateWorkItems:"ms.vss-work-web.update-work-items-data-provider",constantSets:"ms.vss-work-web.constant-sets-data-provider",getMetadataCacheStamps:"ms.vss-work-web.work-item-cache-data-provider",linkTypes:"ms.vss-work-web.work-item-link-types-data-provider",teamProjects:"ms.vss-work-web.work-item-team-projects-data-provider",workItemTypes:"ms.vss-work-web.work-item-types-data-provider",pageWorkItems:"ms.vss-work-web.page-work-items-data-provider",pageWorkItemsByIdRev:"ms.vss-work-web.page-work-items-by-id-rev-data-provider",AdHocQueries:"ms.vss-work-web.ad-hoc-queries-data-provider",query:"ms.vss-work-web.work-item-query-data-provider",updateAdHocQuery:"ms.vss-work-web.update-ad-hoc-query-data-provider",updateColumnOptions:"ms.vss-work-web.update-column-options-data-provider",search:"ms.vss-work-web.search-data-provider",queryFavorites:"ms.vss-work-web.query-favorites-data-provider",teamSettings:"ms.vss-work-web.team-settings-data-provider",workitems:"ms.vss-work-web.work-items-with-history-data-provider",workitemsnohistory:"ms.vss-work-web.work-items-no-history-data-provider",sendMail:"ms.vss-work-web.send-mail-data-provider",workitemcolor:"ms.vss-work-web.work-item-color-data-provider"};t[e].WorkItemStoreLevelWITDataSource=class{constructor(e){this._workItemCacheManager=new l.WorkItemIndexDBCacheManager(e),this._pageContext=e}getDataFromCacheAsync(e,t,a,r,o){return this.getDataProviderDataUsingIndexDB(e,t,a,r,o).then((({resolvedFromCache:e,data:t})=>{if(t&&!e){const e=t;return this.updateIndexDBCache(e,a,r,o).then((()=>e))}return t}))}getDataWithoutCache(e,t){return this.getDataFromDataProviderAsync(e,t,this.getDataProviderId(e))}getDataProviderDataUsingIndexDB(e,t,a,r,s){var n=null!=t?t.stamp:null;const i=this._pageContext.getService("IVssPerformanceService"),c=i.startScenario("WIT-ds-data-provider-with-indexDB",!1);return c.addProperties({routeParams:e,requestProperties:t,scopeId:a,type:r,key:s}),this._workItemCacheManager.getDataFromCache(a,r,s,n).then((a=>{if(!a)return c.addProperties({cacheHit:!1}),this.getDataFromDataProviderAsync(e,t,this.getDataProviderId(e)).then((e=>(i.endScenario(o.WITCommonConstants.WorkItemTrackingArea,c.scenarioName,!1),{resolvedFromCache:!1,data:e})));c.addProperties({cacheHit:!0}),i.endScenario(o.WITCommonConstants.WorkItemTrackingArea,c.scenarioName,!1);return{resolvedFromCache:!0,data:{data:a,versionStamp:n}}}))}updateIndexDBCache(e,t,a,s){return e&&e.versionStamp&&e.versionStamp.length>0?this._workItemCacheManager.cacheData(t,a,s,e.data,e.versionStamp).catch((e=>((0,r.traceWarning)(this._pageContext,o.WITCommonConstants.WorkItemTrackingArea,"updateIndexDBCache",e),null))):Promise.resolve(null)}getDataProviderId(e){if(e&&e.action&&a[e.action])return a[e.action];throw new Error((0,s.format)(h.MVCActionToDpIdMappingNotFoundError,e.action))}async getDataFromDataProviderAsync(e,t,a){const r=this._pageContext.getService("IVssPerformanceService"),s=r.startScenario("WIT-ds-data-provider-async",!1),n=this._pageContext.getService("IVssContributionService"),i=await n.getDataAsync(a,t,!0);if(r.endScenario(o.WITCommonConstants.WorkItemTrackingArea,s.scenarioName,!1),i){if(i.errorMessage&&i.errorMessage.length>0)throw i.errorMessage;return{data:i.data,versionStamp:i.versionStamp}}{const e=n.getDataProviderExceptions()[a];if(e){const t=new Error(e.message);throw t.exceptionType=e.exceptionType,t.serverStackTrace=e.stackTrace,t}throw i}}}}("SourcesWorkItemStoreLevelWITDataSource"),function(e){S=t[e]={};t[e].WorkItemAsyncDataProviderSource=class{constructor(e,t){var a,r;this.workItemStoreSource=new k.WorkItemStoreLevelWITDataSource(e),this._cacheStampManager=t,this._hostId=null!==(r=null===(a=e.getService("IVssPageService").getData())||void 0===a?void 0:a.hostId)&&void 0!==r?r:""}beginGetWorkItemData(e,t,a,r,o){const s={controller:"wit",action:r?"workitems":"workitemsnohistory"};return this.workItemStoreSource.getDataWithoutCache(s,{ids:e,isDeleted:t,includeInRecentActivity:a,includeHistory:r,errorPolicy:o}).then((e=>e.data))}async beginGetWorkItemTypeData(e,t){const a=await this._cacheStampManager.addStampToParams(o.WITCommonConstants.WorkItemTypes,{typeNames:t,projectId:e});return(await this.workItemStoreSource.getDataWithoutCache({controller:"wit",action:"workItemTypes",routeData:{project:e}},a)).data.map((e=>{const t=Object.assign(Object.assign({},e),{rules:Object.assign(Object.assign({},e.rules),{fieldRules:{}})});if((0,v.canDeserializeRules)(e)){const a=(0,m.deserializeVssJsonObject)(e.rules.fieldRules);a&&(t.rules.fieldRules=a)}else t.rules.fieldRules=e.rules.fieldRules;return t}))}async beginGetFields(){const e=await this._cacheStampManager.addStampToParams(o.WITCommonConstants.WorkItemTypes,null);return(await this.workItemStoreSource.getDataFromCacheAsync({controller:"wit",action:"fields"},e,this._hostId,o.WITCommonConstants.Fields,"_")).data}async beginGetFieldProjectData(e){const t=await this._cacheStampManager.addStampToParams(o.WITCommonConstants.TeamProjects,{includeFieldDefinitions:!0,namesOrIds:[e]});return(await this.workItemStoreSource.getDataFromCacheAsync({controller:"wit",action:"teamProjects",routeData:{project:e}},t,this._hostId,o.WITCommonConstants.TeamProjects,"_")).data}async beginGetLinkTypes(){const e=await this._cacheStampManager.addStampToParams(o.WITCommonConstants.LinkTypes,null);return(await this.workItemStoreSource.getDataFromCacheAsync({controller:"wit",action:"linkTypes"},e,this._hostId,o.WITCommonConstants.LinkTypes,"_")).data}async beginGetConstantSets(e){if(0===e.length)return Promise.resolve({});const t=await this._cacheStampManager.addStampToParams(o.WITCommonConstants.ConstantSets,{ids:e}),a=this._cacheStampManager.makeCacheKey(e);return(await this.workItemStoreSource.getDataFromCacheAsync({controller:"wit",action:"constantSets"},t,this._hostId,o.WITCommonConstants.ConstantSets,a)).data}}}("SourcesWorkItemAsyncDataProviderSource"),function(e){w=t[e]={},t[e].getDataSources=function(e,t,a){return[new C.WorkItemDataProviderSource(e,t),new I.QueryDataProviderSource(e),new S.WorkItemAsyncDataProviderSource(e,a)]}}("Sourcesindex"),function(e){t.WorkItemDataManager={};class a extends d.VssService{_serviceStart(e){var t;this.pageContext=e,this._cacheStampManager=new p.WorkItemMetadataCacheStampManager(e),this._workItemIndexDBCacheManager=new l.WorkItemIndexDBCacheManager(e),this._cacheInformationManager=new g.WorkItemMetadataCacheInformationManager(e),this._dataSources=(0,w.getDataSources)(e,this._cacheInformationManager,this._cacheStampManager),this._projectId=(null===(t=(0,c.getTFSProject)(e))||void 0===t?void 0:t.id)||""}async beginGetWorkItemData(e,t,a,r,s){const n=this.pageContext.getService("IVssPerformanceService"),i=n.startScenario("widm-get-work-item-data",!1),c=await this._getDataFromSource((async o=>await o.beginGetWorkItemData(e,t,a,r,s)));return n.endScenario(o.WITCommonConstants.WorkItemTrackingArea,i.scenarioName,!1),c}async beginGetLinkTypes(){const e=this.pageContext.getService("IVssPerformanceService"),t=e.startScenario("widm-get-link-types",!1),a=await this._getDataWithCache(this._projectId,o.WITCommonConstants.LinkTypes,"_",(e=>e.beginGetLinkTypes()));return e.endScenario(o.WITCommonConstants.WorkItemTrackingArea,t.scenarioName,!1),a}async beginGetConstantSets(e){const t=this.pageContext.getService("IVssPerformanceService"),a=t.startScenario("widm-get-constant-sets",!1),r=this._cacheStampManager.makeCacheKey(e),s=await this._getDataWithCache(this._projectId,o.WITCommonConstants.ConstantSets,r,(t=>t.beginGetConstantSets(e)));return t.endScenario(o.WITCommonConstants.WorkItemTrackingArea,a.scenarioName,!1),s}async beginGetFieldProjectData(e){const t=this.pageContext.getService("IVssPerformanceService"),a=t.startScenario("widm-get-field-project-data",!1),r=await this._getDataWithCache(e,o.WITCommonConstants.TeamProjects,e,(t=>t.beginGetFieldProjectData(e)));return t.endScenario(o.WITCommonConstants.WorkItemTrackingArea,a.scenarioName,!1),r}async beginGetFields(){const e=this.pageContext.getService("IVssPerformanceService"),t=e.startScenario("widm-get-fields",!1),a=await this._getDataWithCache(this._projectId,o.WITCommonConstants.Fields,"_",(e=>e.beginGetFields()));return e.endScenario(o.WITCommonConstants.WorkItemTrackingArea,t.scenarioName,!1),a}async beginGetWorkItemTypeData(e,t){const a=this.pageContext.getService("IVssPerformanceService"),s=a.startScenario("widm-get-work-item-type-data",!1);if(1===t.length)return a.endScenario(o.WITCommonConstants.WorkItemTrackingArea,s.scenarioName,!1),this._getDataWithCache(e,o.WITCommonConstants.WorkItemTypes,t[0],(a=>a.beginGetWorkItemTypeData(e,t)));const n=await this._getDataFromSource((a=>a.beginGetWorkItemTypeData(e,t))),i=await this._cacheStampManager.getMetadataCacheStamp(o.WITCommonConstants.WorkItemTypes);return n&&n.map((async t=>{try{const a=await this._workItemIndexDBCacheManager.cacheData(e,o.WITCommonConstants.WorkItemTypes,this._transformKey(t.name),[t],i);a&&this._cacheInformationManager.persist(e,o.WITCommonConstants.WorkItemTypes,a,i)}catch(e){(0,r.traceWarning)(this.pageContext,o.WITCommonConstants.WorkItemTrackingArea,"WorkItemType.CacheResults",e)}})),a.endScenario(o.WITCommonConstants.WorkItemTrackingArea,s.scenarioName,!1),null!=n?n:[]}async _getDataWithCache(e,t,a,r){a=this._transformKey(a);const o=await this._cacheStampManager.getMetadataCacheStamp(t);let s,n;if(o&&(s=await this._workItemIndexDBCacheManager.getDataFromCache(e,t,a,o)),s?n=!0:(s=await this._getDataFromSource(r),n=!1),s&&!n){const r=await this._workItemIndexDBCacheManager.cacheData(e,t,a,s,o);r&&this._cacheInformationManager&&this._cacheInformationManager.persist(e,t,r,o)}return s}async _getDataFromSource(e,t=0){const a=()=>t+1<this._dataSources.length?this._getDataFromSource(e,t+1):null,r=e(this._dataSources[t]);if(r){const e=await r;return e||a()}return a()}_transformKey(e){return e.toLowerCase()}}d.Services.add("IWorkItemDataManager",{serviceFactory:a})}()}),["Resources","CacheManagers/CacheProviders","CacheManagers/WorkItemIndexDBCacheManager","CacheManagers/WorkItemMetadataCacheInformationManager","CacheManagers/WorkItemMetadataCacheStampManager","Utils","Sources/WorkItemDataProviderSource","Sources/QueryDataProviderSource","Sources/WorkItemStoreLevelWITDataSource","Sources/WorkItemAsyncDataProviderSource","Sources/index","WorkItemDataManager"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-data-manager"}}));