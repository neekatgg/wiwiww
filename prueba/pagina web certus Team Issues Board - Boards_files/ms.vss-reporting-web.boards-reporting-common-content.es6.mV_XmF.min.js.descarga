"use strict";define("Reporting/BoardsCommon",["require","exports","VSS/Platform/Feature","VSS/Platform/FPS","VSS/Platform/Location","VSS/Platform/Navigation","VSS/Core/Observable","VSS/Platform/Context","Analytics/Boards/BoardsQueries/BacklogsQuery","VSS/Platform/Util/Url","react","VSS/Platform/Components/Format","VSS/Platform/Layout","VSSUI/ZeroData","VSSUI/MessageCard","VSSUI/Spinner","Analytics/Common/Utilities/AnalyticsExceptionUtilities","Reporting/ReportWidgetHost/ReportWidgetHost","VSS/Platform/Trace","VSSUI/Header","VSSUI/Util","VSS/Core/Util/String","VSSUI/Button","VSSUI/Observer","VSSUI/TeachingBubble","Analytics/Boards/BoardsQueries/AggregationFieldsQuery","Analytics/Boards/BoardsQueries/ProcessesQuery","VSSUI/Dropdown","VSSUI/Utilities/DropdownSelection","WidgetCommon/ModernWidgetTypes/CommonConfigurationTypes"],(function(e,t,r,i,o,n,s,a,l,u,c,g,m,h,d,p,b,y,B,S,f,v,T,P,x,C,k,R,w,A){var I,D,U,E,N,L,V,M;I=t[M="Resources"]={},t[M].AggregationPicker_CountOfWorkItems="Count of Work Items",t[M].AggregationPicker_SumOfNamedProperty="Sum of {0}",t[M].InfoIcon="Info icon for {0}",t[M].DataNotReadyImageDescription="A worker shaking data from a cloud into a machine producing a graphs",t[M].DataNotFoundImageDescription="A picture of a man looking out a telescope",t[M].UnmaterializedBoardHeader="Board information not found",t[M].UnmaterializedBoardDetail="Information about the selected boards category for this team could not be found. Have you visited the corresponding boards page yet?",t[M].GoToBoard="Go to board",t[M].AccessDeniedSummary="Analytics view permission required",t[M].AccessDeniedDetail='Using this service requires "View Analytics" permission. Instructions on how to configure it can be found {0}. Changing the permissions requires administrator rights to the associated project.',t[M].AccessDeniedMoreInfoDocLink="https://go.microsoft.com/fwlink/?LinkId=786441",t[M].AccessDeniedLinkText="here",t[M].NoPermissionImageDescription="A dog sitting outside a closed door on a snowy day",t[M].ValueMustBeWithinRange="Value must be between {0} and {1}",t[M].TeachingBubbleLearnMoreButtonText="Learn more",t[M].TeachingBubbleLearnMoreButtonDescriptiveText="Learn more about {0}",t[M].TeachingBubbleNextButtonText="Next",t[M].TeachingBubblePreviousButtonText="Previous",t[M].TeachingBubbleEndTourButtonText="End tour",t[M].ResetLabel="Reset",t[M].ResetButtonDetail="Reset to report defaults",function(e){function s(){return window.location.href.indexOf("_backlogs")>=0}function a(){return s()?"ms.vss-work-web.backlogs-content-route":"ms.vss-work-web.team-board-content-route"}D=t[e]={},t[e].isBacklogsPage=s,t[e].chooseAnalyticsRootRoute=a,t[e].getBoardsAnalyticsRootUrl=function(e){const t=(0,n.getCurrentRoute)(e),r={project:t.routeValues.project,teamName:t.routeValues.teamName,pivot:"analytics"},i=a();return(0,o.routeUrl)(e,i,r)},t[e].getBoardsReportUrl=function(e,t,i){const a=(0,n.getCurrentRoute)(e),l={project:a.routeValues.project,teamName:a.routeValues.teamName,backlogLevel:t,pivot:"analytics"};null!=i&&(l.report=i);const u=s()?(0,r.isFeatureEnabled)(e,"ms.vss-work-web.new-boards-hub-feature",!1)?"ms.vss-work-web.new-backlogs-content-route":"ms.vss-work-web.backlogs-content-route":"ms.vss-work-web.team-board-content-route";return(0,o.routeUrl)(e,u,l)},t[e].getSprintsReportUrl=function(e){const t=(0,n.getCurrentRoute)(e),i={project:t.routeValues.project,teamName:t.routeValues.teamName,iteration:t.routeValues.iteration,pivot:"analytics"},s=(0,r.isFeatureEnabled)(e,"ms.vss-work-web.new-boards-hub-feature",!1)?"ms.vss-work-web.new-sprints-content-route":"ms.vss-work-web.sprints-content-route";return(0,o.routeUrl)(e,s,i)},t[e].getNavigateToBoardHandler=function(e){return()=>{const t=(0,n.getCurrentRoute)(e),r={project:t.routeValues.project,teamName:t.routeValues.teamName,backlogLevel:t.routeValues.backlogLevel,pivot:"board"},s=(0,o.routeUrl)(e,"ms.vss-work-web.team-board-content-route",r);(0,i.FastPageSwitch)(e,s,!0)}}}("BoardsRoutingHelper"),function(e){t[e]={};class r extends a.VssService{constructor(){super(...arguments),this.items=new s.ObservableArray}getBreadcrumbItems(e){return this.items.push({key:"analytics",text:"Analytics",href:(0,D.getBoardsAnalyticsRootUrl)(this.pageContext)}),this.items}}t[e].BoardsReportingHeaderBreadcrumbService=r,a.Services.add("boards-reporting-header-breadcrumb-service",{serviceFactory:r})}("BoardsReportingHeaderBreadcrumbService"),t.PickersWorkItemBacklogFilter={},function(e){async function r(e){const t=e.getService("IVssContributionService");return(await t.getDataAsync("ms.vss-work-web.agile-backlog-configuration-data-provider")).taskBacklog.id}t[e]={},t[e].getTaskBacklogCategoryReferenceName=r,t[e].ensureWorkItemFilter=async function(e,t){let i;if(null!=t)i=t;else{i={identifier:"BacklogCategory",settings:await r(e)}}return i}}("PickersBacklogCategoryPickerHelpers"),function(e){function r(e,t){const r=(0,n.getCurrentRoute)(e).routeValues;return void 0!==r[t]?r.backlogLevel:new u.Uri(window.location.href).getQueryParam(t)}t[e]={},t[e].getReportPageState=async function(e){const t=e.getService("ITfsPageService"),i=await t.getData().project,o=await t.getHorizontalNavigationTeamData(),n=e.getService("IDashboardsCacheableQueryService"),s=new l.BacklogsQuery(i.id,[o.id]),a=await n.getCacheableQueryResult(s),u=r(e,"backlogLevel"),c=a.findIndex((e=>e.BoardName===u&&e.IsBoardVisible));return{teamId:o.id,teamName:o.name,projectId:i.id,categoryReferenceName:c>=0&&a[c].BoardCategoryReferenceName||"",categoryName:u}},t[e].extractParameter=r}("ReportPageState"),function(e){t[e]={},t[e].resetQueryCache=function(e){e.getService("IDashboardsCacheableQueryService").resetCache()}}("ReportQueryHelper"),function(e){function r(r,i,o){const n=r.getService("IVssTelemetryService"),s=Object.assign({isEmptyState:!1},o);n.publishEvent(t[e].telemetryAreaName,i,s)}U=t[e]={},t[e].telemetryAreaName="Analytics-Reports",t[e].publishEmptyReportTelemetry=function(e,t,i){r(e,t,{isEmptyState:!0,emptyStateReason:i})},t[e].publishReportTelemetry=r,t[e].publishTeachingBubbleTelemetry=function(r,i,o){const n=r.getService("IVssTelemetryService"),s=Object.assign({isEmptyState:!1},o);n.publishEvent(t[e].telemetryAreaName,i,s)}}("ReportTelemetry"),function(e){E=t[e]={};class r extends m.VssComponent{constructor(){super(...arguments),this.linkUrl="https://go.microsoft.com/fwlink/?LinkId=786441"}render(){return c.createElement(h.ZeroData,{primaryText:I.AccessDeniedSummary,secondaryText:c.createElement(g.FormatComponent,{format:I.AccessDeniedDetail},c.createElement("a",{href:this.linkUrl},I.AccessDeniedLinkText)),imageAltText:I.NoPermissionImageDescription,imagePath:(0,o.getAssetLocation)(this.context.pageContext,"ms.vss-reporting-web/boards-reporting-common-content/images/no-permission.svg")})}}t[e].AccessDeniedMessage=r}("AccessDeniedMessage"),function(e){N=t[e]={};class r extends c.Component{render(){return c.createElement(d.MessageCard,{severity:"Error"},this.props.errorMessage)}}t[e].ReportError=r}("ReportError"),function(e){L=t[e]={};class r extends c.Component{render(){return c.createElement(p.Spinner,null)}}t[e].ReportLoading=r}("ReportLoading"),function(e){t[e]={};class r extends m.VssComponent{constructor(){super(...arguments),this.getTeamContext=()=>(null!=this.lastTeamContext&&this.lastTeamContext.id==this.props.teamId&&this.lastTeamContext.name==this.props.teamName||(this.lastTeamContext={id:this.props.teamId,name:this.props.teamName}),this.lastTeamContext)}getWidgetName(){return this.getReportTitle()}render(){if(this.isMinimalReport())return this.renderMinimalReport();this.initializeOnRender();const e=this.isLightbox()?this.renderLightboxReportContents():this.renderReportContents(),t=this.isLightbox()?"":"bolt-page-grey";return c.createElement("div",{className:(0,f.css)("boards-widget-report",t)},this.getTitleBlock(),e,!this.isReady()&&!this.isInAbnormalState()&&c.createElement(L.ReportLoading,null),this.state.error&&c.createElement(N.ReportError,{errorMessage:this.state.error}),this.state.knownWarning&&this.renderConfigurationWarning())}isReady(){return null!=this.state.widgetSettings}getFilterRow(e){return c.createElement("div",{className:"report-filter-area flex-self-center"},c.createElement("div",{className:"report-filter-area-content flex-row"},e))}getWidgetContent(){return this.isConfigurationValid()?c.createElement(y.ReportWidgetHostContainer,{settings:JSON.stringify(this.state.widgetSettings),name:this.getWidgetName(),parentPageName:this.getParentPagePrefix()+this.getReportTelemetryName(),contributionId:this.getWidgetContributionId(),renderSize:this.getSize(),widgetPinningSize:this.getWidgetPinningSize(),allowPinning:this.allowPinning(),teamContext:this.getTeamContext(),lastRefreshDate:this.getLastRefreshDate()}):null}renderMinimalReport(){return this.isReady()||this.isInAbnormalState()?this.isInAbnormalState()?this.renderConfigurationWarning():this.getWidgetContent():null}getTitleBlock(e){return c.createElement(S.Header,{titleSize:1,backButtonProps:this.getBackButtonProps(),title:c.createElement(c.Fragment,null,this.getReportTitle()," ",e),titleClassName:"boards-report-header-title"})}componentDidCatch(e,t){this.setState({error:e.toString()}),(0,B.traceException)(this.context.pageContext,U.telemetryAreaName,this.getReportTelemetryName(),e)}isInAbnormalState(){return null!=this.state.error||null!=this.state.knownWarning}getLastRefreshDate(){}isMinimalReport(){return!1}isLightbox(){return!1}getDefaultState(){return{widgetSettings:void 0,error:void 0,knownWarning:void 0}}renderConfigurationWarning(){let e;return e=this.state.knownWarning!==I.AccessDeniedSummary||this.isMinimalReport()?this.getKnownWarningComponent():c.createElement(E.AccessDeniedMessage,null),null!==e?e:c.createElement(N.ReportError,{errorMessage:this.state.knownWarning})}handleCommonInitError(e){(0,b.recognizeAnalyticsException)(e)===b.AnalyticsExceptionType.MissingAnalyticsPermissions?this.setState({knownWarning:I.AccessDeniedSummary}):(this.setState({error:e.toString()}),(0,B.traceException)(this.context.pageContext,U.telemetryAreaName,this.getReportTelemetryName(),e))}getBackButtonProps(){}allowPinning(){return!0}getWidgetPinningSize(){return{columnSpan:3,rowSpan:2}}renderReportContents(){return this.isReady()?this.isInAbnormalState()?this.renderConfigurationWarning():c.createElement("div",{className:"boards-report-content"},this.getFilterRow(this.getFilterItems()),this.decorateWidgetContent(this.getWidgetContent()),this.renderTeachingBubble()):null}renderLightboxReportContents(){return this.isReady()?this.isInAbnormalState()?this.renderConfigurationWarning():c.createElement("div",{className:"boards-report-lightbox-content"},this.getWidgetContent(),this.renderTeachingBubble()):null}getSize(){return this.isMinimalReport()?{width:140,height:40}:this.isLightbox()?{width:1010,height:483}:{width:1010,height:670}}getParentPagePrefix(){return this.isMinimalReport()?"Header":this.isLightbox()?"Lightbox":""}}t[e].BoardsReport=r}("BoardsReport"),function(e){V=t[e]={};class r{constructor(e,t,r){this.pageContext=e,this.tourUtilityProps=t,this.dismissBubble=r,this.tutorialDismissed=-1,this.teachingBubbleTourProps=[],this.activeTourStep=new s.ObservableValue(this.tutorialDismissed),this.titleBubbleCallback=e=>{this.teachingBubbleTourProps.push({anchorElement:e,anchorOrigin:{horizontal:"center",vertical:"end"},primaryButtonProps:this.getLinkButton(),secondaryButtonProps:this.getNextButton(),title:this.tourUtilityProps.tourBubble.title,text:this.tourUtilityProps.tourBubble.text}),this.activeTourStep.value=0},this.filterBubbleCallback=e=>{this.teachingBubbleTourProps.push({anchorElement:e,anchorOrigin:{horizontal:"end",vertical:"end"},primaryButtonProps:this.getPreviousButton(),secondaryButtonProps:this.getNextButton(),title:this.tourUtilityProps.filterBubble.title,text:this.tourUtilityProps.filterBubble.text})},this.chartBubbleCallback=e=>{this.teachingBubbleTourProps.splice(1,0,{anchorElement:e,anchorOrigin:{horizontal:"start",vertical:"start"},primaryButtonProps:this.getPreviousButton(),secondaryButtonProps:this.getNextButton(),title:this.tourUtilityProps.chartBubble.title,text:this.tourUtilityProps.chartBubble.text}),this.teachingBubbleTourProps.push({anchorElement:e,anchorOrigin:{horizontal:"start",vertical:"end"},primaryButtonProps:this.getPreviousButton(),secondaryButtonProps:this.getDismissButton(),title:this.tourUtilityProps.legendBubble.title,text:this.tourUtilityProps.legendBubble.text})},this.dismissTour=()=>{this.dismissBubble(),(0,U.publishTeachingBubbleTelemetry)(this.pageContext,this.tourUtilityProps.reportKey,this.getTelemetryProps(this.activeTourStep.value,"Dismiss")),this.activeTourStep.value=this.tutorialDismissed,o(this.pageContext,this.tourUtilityProps.reportKey),this.render(!1)},this.nextBubble=()=>{this.activeTourStep.value<this.teachingBubbleTourProps.length-1&&((0,U.publishTeachingBubbleTelemetry)(this.pageContext,this.tourUtilityProps.reportKey,this.getTelemetryProps(this.activeTourStep.value,"Next")),this.activeTourStep.value++,this.render(!0))},this.previousBubble=()=>{this.activeTourStep.value>0&&((0,U.publishTeachingBubbleTelemetry)(this.pageContext,this.tourUtilityProps.reportKey,this.getTelemetryProps(this.activeTourStep.value,"Previous")),this.activeTourStep.value--,this.render(!0))},this.publishLearnMoreClickTelemetry=()=>{(0,U.publishTeachingBubbleTelemetry)(this.pageContext,this.tourUtilityProps.reportKey,this.getTelemetryProps(this.activeTourStep.value,"LearnMore"))}}render(e){return c.createElement(c.Fragment,null,e&&c.createElement(P.Observer,{activeBubble:this.activeTourStep},(e=>e.activeBubble!==this.tutorialDismissed?c.createElement(x.TeachingBubble,Object.assign({},this.teachingBubbleTourProps[e.activeBubble],{onDismiss:this.dismissTour})):null)))}getLinkButton(){return{text:I.TeachingBubbleLearnMoreButtonText,target:"_blank",href:this.tourUtilityProps.reportDocumentationUrl,onClick:this.publishLearnMoreClickTelemetry,role:"link",ariaLabel:(0,v.format)(I.TeachingBubbleLearnMoreButtonDescriptiveText,this.tourUtilityProps.tourBubble.title)}}getDismissButton(){return{text:I.TeachingBubbleEndTourButtonText,primary:!0,onClick:this.dismissTour}}getNextButton(){return{text:I.TeachingBubbleNextButtonText,primary:!0,onClick:this.nextBubble}}getPreviousButton(){return{text:I.TeachingBubblePreviousButtonText,onClick:this.previousBubble}}getTelemetryProps(e,t){return{currentTeachingBubbleName:i[e],buttonAction:t}}}var i;async function o(e,t){const i=e.getService("ISettingsService"),o={};o[t+"/"+r.teachingBubbleSeenKey]=!0,await i.setEntries(o,0)}t[e].ReportGuidedTourUtility=r,r.teachingBubbleSeenKey="ReportTourSeen",function(e){e[e.Dismiss=-1]="Dismiss",e[e.IntroBubble=0]="IntroBubble",e[e.ChartBubble=1]="ChartBubble",e[e.FilterBubble=2]="FilterBubble",e[e.LegendBubble=3]="LegendBubble"}(i||(i={})),t[e].saveUserBubbleSettings=o,t[e].hasUserSeenBubble=async function(e,t){const i=e.getService("ISettingsService");return(await i.getEntriesAsync(t,0))[r.teachingBubbleSeenKey]},t[e].getInfoIcon=function(e,t,r,i){return r?c.createElement("span",{ref:e},c.createElement(T.Button,{className:"boards-report-info-icon subtle",ariaLabel:(0,v.format)(I.InfoIcon,i),iconProps:{iconName:"Unknown"},onClick:t})):null}}("ReportGuidedTourUtility"),function(e){t[e]={};t[e].LightboxReportGuidedTourUtility=class{constructor(e,t,r){this.pageContext=e,this.tourUtilityProps=t,this.dismissBubble=r,this.tutorialDismissed=-1,this.activeTourStep=new s.ObservableValue(this.tutorialDismissed),this.titleBubbleCallback=e=>{this.teachingBubbleTourProps={anchorElement:e,anchorOrigin:{horizontal:"center",vertical:"end"},title:this.tourUtilityProps.tourBubble.title,text:this.tourUtilityProps.tourBubble.text,onDismiss:this.dismissTour},this.activeTourStep.value=0},this.dismissTour=()=>{this.dismissBubble(),this.activeTourStep.value=this.tutorialDismissed,(0,V.saveUserBubbleSettings)(this.pageContext,this.tourUtilityProps.reportKey),this.render(!1)}}render(e){return c.createElement(c.Fragment,null,e&&c.createElement(P.Observer,{activeBubble:this.activeTourStep},(e=>e.activeBubble!==this.tutorialDismissed?c.createElement(x.TeachingBubble,Object.assign({},this.teachingBubbleTourProps)):null)))}},t[e].getInfoIcon=function(e,t,r,i){return r?c.createElement("span",{ref:e},c.createElement(T.Button,{className:"boards-report-info-icon subtle",ariaLabel:(0,v.format)(I.InfoIcon,i),iconProps:{iconName:"Unknown"},onClick:t})):null}}("LightboxReportGuidedTourUtility"),function(e){t[e]={};class r extends m.VssComponent{constructor(){super(...arguments),this.selection=new w.DropdownSelection,this.onSelect=(e,t)=>{this.props.onSelect(t.data)}}componentDidMount(){this.applySelection(this.props)}componentWillReceiveProps(e){JSON.stringify(e)!=JSON.stringify(this.props)&&this.applySelection(e)}render(){return c.createElement(R.Dropdown,{className:"aggregation-picker",items:this.props.items,selection:this.selection,onSelect:this.onSelect,showFilterBox:this.props.items.length>7})}applySelection(e){const t=i(e.value),r=e.items.findIndex((e=>e.id===t));r>=0?this.selection.select(r,1,!1):this.selection.clear()}}function i(e){return e.identifier===A.AggregationMode.Sum?A.AggregationMode[e.identifier]+"_"+e.settings:A.AggregationMode[e.identifier]}async function o(e,t,r,i,o){const s=await async function(e,t,r,i,o){const n=e.getService("IDashboardsCacheableQueryService"),s=await n.getCacheableQueryResult(k.ProcessesQuery.onTeam(e,t,r).setAutomationMode(o)),a=s.filter((e=>i.some((t=>e.BacklogCategoryReferenceName===t)))).map((e=>e.WorkItemType));return a}(e,t,r,i,o);return n(e,t,s,o)}async function n(e,t,r,o){const n=e.getService("IDashboardsCacheableQueryService"),s=new C.AggregationFieldsQuery(t).setAutomationMode(o),a={identifier:A.AggregationMode.Count,settings:""},l={id:i(a),text:I.AggregationPicker_CountOfWorkItems,data:a},u=(0,C.getDistinctFieldsOfTypes)(r,await n.getCacheableQueryResult(s)).map((e=>{const t={identifier:A.AggregationMode.Sum,settings:e.FieldReferenceName};return{id:i(t),text:(0,v.format)(I.AggregationPicker_SumOfNamedProperty,e.FieldName),data:t}}));return[l].concat(u)}t[e].AggregationPicker=r,t[e].getAggregationOptions=async function(e,t,r,i,s){let a;return a="BacklogCategory"===i.identifier?o(e,t,r,[i.settings],s):n(e,t,[i.settings],s),a},t[e].ensureAggregationSettings=function(e,t){const r="Microsoft.VSTS.Scheduling.RemainingWork";let i={identifier:A.AggregationMode.Count,settings:""};return null==t||t.identifier!==A.AggregationMode.Count&&!e.some((e=>t.settings===e.data.settings))?e.some((e=>r===e.data.settings))&&(i={identifier:A.AggregationMode.Sum,settings:r}):i=t,i},t[e].getAggregationOptionsForBacklogCategories=o,t[e].getAggregationOptionsForWorkItemTypes=n}("PickersAggregationPicker"),function(e){t[e]={};class r extends c.Component{render(){return c.createElement(T.Button,{className:"reset-settings-button subtle",ariaLabel:I.ResetButtonDetail,onClick:this.props.onClick,text:I.ResetLabel,disabled:!this.props.isEnabled,tooltipProps:{text:I.ResetButtonDetail}})}}t[e].ResetElement=r}("ResetElement"),function(e){t[e]={};class r extends m.VssComponent{constructor(e,t){super(e,t),this.navigateTo=(0,D.getNavigateToBoardHandler)(t.pageContext)}render(){return c.createElement(h.ZeroData,{primaryText:I.UnmaterializedBoardHeader,secondaryText:c.createElement("span",null,I.UnmaterializedBoardDetail),imageAltText:I.DataNotFoundImageDescription,imagePath:(0,o.getAssetLocation)(this.context.pageContext,"ms.vss-reporting-web/boards-reporting-common-content/images/data-not-found.svg"),actionText:I.GoToBoard,actionType:0,onActionClick:this.navigateTo})}}t[e].UnmaterializedBoardMessage=r}("UnmaterializedBoardMessage")}),["Resources","BoardsRoutingHelper","BoardsReportingHeaderBreadcrumbService","Pickers/WorkItemBacklogFilter","Pickers/BacklogCategoryPickerHelpers","ReportPageState","ReportQueryHelper","ReportTelemetry","AccessDeniedMessage","ReportError","ReportLoading","BoardsReport","ReportGuidedTourUtility","LightboxReportGuidedTourUtility","Pickers/AggregationPicker","ResetElement","UnmaterializedBoardMessage"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-reporting-web.boards-reporting-common-content"}}));