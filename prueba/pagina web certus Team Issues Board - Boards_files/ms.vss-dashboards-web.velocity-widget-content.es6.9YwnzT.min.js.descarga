"use strict";define("Widgets/VelocityWidget",["require","exports","WidgetCommon/ModernWidgetTypes/ActionCreatorBase","Analytics/Boards/BoardsQueries/WitFieldUtilities","VSS/Core/Util/String","WidgetCommon/ModernWidgetTypes/CommonConfigurationTypes","WidgetCommon/WitUtils/Constants","Tfs/Widget/LinkPermissionsHelper","VSS/Features/Charts/Contracts","WidgetCommon/ModernWidgetTypes/ChartOptionFactoryBase","Analytics/Boards/BoardsQueries/IterationsQuery","Reporting/Visuals/LayoutComponents/Widgets/Demands/DemandType","Reporting/Visuals/LayoutComponents/Widgets/LayoutState","Analytics/Boards/VelocityQueries/AggregationWorkItemTypeFieldsQuery","Analytics/Boards/VelocityQueries/CompletedLateMetastateByIterationDetailsQuery","Analytics/Boards/VelocityQueries/CompletedLateMetastateByIterationsQuery","Analytics/Boards/VelocityQueries/MetastateByIterationDetailsQuery","Analytics/Boards/VelocityQueries/MetastateByIterationsQuery","Analytics/Boards/VelocityQueries/PlannedWorkByDayDetailsQuery","Analytics/Boards/VelocityQueries/PlannedWorkByDayQuery","Dashboards/WidgetCommon/WidgetTelemetry","WidgetCommon/ModernWidgetTypes/WidgetDataManagerBase","WidgetCommon/WitUtils/WiqlUrlBuilder","Analytics/Boards/BoardsQueries/ProcessesQuery","Analytics/Common/Utilities/AnalyticsExceptionUtilities","Dashboards/WidgetCommon/DashboardsCacheableQueryService","VSS/Platform/Feature","Tfs/Widget/Context","WidgetCommon/ModernWidgetTypes/SettingsManagerBase","Analytics/Common/Resources","react","Reporting/Lightbox/Lightbox","VSS/Platform/Components/Format","VSS/Platform/Location","WidgetCommon/ModernWidgetTypes/ViewComponentBase","VSS/Platform/Layout"],(function(e,t,o,a,i,r,n,s,l,c,d,g,m,y,p,u,C,h,W,I,k,S,V,D,A,f,v,x,M,T,w,P,L,R,F,_){var b,N,B,Q,E,q,O,U,H,j;b=t[j="Resources"]={},t[j].VelocityChart_CompletedLate_StateName="Completed Late",t[j].VelocityChart_Completed_StateName="Completed",t[j].VelocityChart_Incomplete_StateName="Incomplete",t[j].VelocityChart_Planned_StateName="Planned",t[j].KanbanTime_DefaultSettings_FailedToFindAnyBacklogsError="Please configure backlogs and try again.",t[j].VelocityWidget_IterationsSubtitle="Last {0} iterations",t[j].VelocityWidget_NoIterations="No iterations",t[j].VelocityWidget_SingleIterationSubtitle="Last iteration",t[j].Velocity_DefaultWidgetName="Velocity",t[j].VelocityWidget_AverageVelocity="Average Velocity",t[j].VelocityWidget_CountOfWorkItems="Count of work items",t[j].VelocityWidget_LearnMore="Learn more about the Velocity Widget",t[j].VelocityWidget_Loading="Loading...",t[j].MessageCard_Unconfigured="Configure widget",t[j].VelocityWidget_WidgetErrorFormat="Widget failed to load",t[j].VelocityWidget_ErrorDetails="More details",t[j].VelocityWidget_ErrorDetailsAriaLabel="More information about the widget error.",t[j].VelocityWidget_WidgetError="Widget error",t[j].ModernWidget_TeamSettingsErrorFormat="VS403646: Unable to retrieve team settings. {0}",t[j].VelocityWidget_LearnMoreLink="https://go.microsoft.com/fwlink/?LinkID=760415",t[j].VelocityWidget_SetIterationDatesAriaLabel="Set start and end dates for iterations",t[j].VelocityWidget_SetIterationDatesLink="Set iteration dates",t[j].VelocityWidget_UnexpectedAggregationError="Unexpected aggregation mode: '{0}'",t[j].VelocityWidget_NoPropNameFoundForAggregation="No property name found for aggregation setting: '{0}'",function(e){N=t[e]={};class a extends o.ActionCreatorBase{}t[e].VelocityActionCreator=a}("VelocityWidgetComponentsVelocityActionCreator"),function(e){B=t[e]={};class o{}t[e].VelocityConstants=o,o.featureName="VelocityWidget",o.queryResult="AggregationResult",o.featureFlagName_ShowResolvedItemsAsCompleted="WebAccess.Widgets.ShowResolvedItemsAsCompleted"}("VelocityWidgetComponentsVelocityConstants"),function(e){Q=t[e]={},function(e){e[e.Proposed=1e3]="Proposed",e[e.InProgress=2e3]="InProgress",e[e.Resolved=3e3]="Resolved",e[e.Completed=4e3]="Completed",e[e.Removed=5e3]="Removed"}(t[e].WorkItemStateCategory||(t[e].WorkItemStateCategory={})),function(e){e[e.WorkItemType=0]="WorkItemType",e[e.BacklogCategory=1]="BacklogCategory"}(t[e].WorkItemTypeFilterMode||(t[e].WorkItemTypeFilterMode={}))}("VelocityWidgetComponentsVelocityDataContract"),function(e){E=t[e]={};class o{static getScalarMeasure(e,t){switch(t.identifier){case r.AggregationMode.Sum:return o.getWorkItemTypeFieldName(e,t.settings);case r.AggregationMode.Count:return b.VelocityWidget_CountOfWorkItems}}static getQueryAggregation(e){switch(e.identifier){case r.AggregationMode.Sum:const t=a.WitFieldUtilities.getFieldODataPropertyName(e.settings);if(null==t||0===t.trim().length)throw new Error((0,i.format)(b.VelocityWidget_NoPropNameFoundForAggregation,e.settings));return`aggregate(${t} with sum as ${B.VelocityConstants.queryResult})`;case r.AggregationMode.Count:return`aggregate($count as ${B.VelocityConstants.queryResult})`;default:throw new Error((0,i.format)(b.VelocityWidget_UnexpectedAggregationError,e.identifier))}}static isWorkItemCompleted(e,t,o=!1){return e===n.WorkItemStateCategory[n.WorkItemStateCategory.Completed]||!!o&&(e===n.WorkItemStateCategory[n.WorkItemStateCategory.Resolved]||t===n.WorkItemStateCategory[n.WorkItemStateCategory.Resolved])}static isWorkItemInProgress(e,t,o=!1){return o?e===n.WorkItemStateCategory[n.WorkItemStateCategory.InProgress]&&t!==n.WorkItemStateCategory[n.WorkItemStateCategory.Resolved]:e===n.WorkItemStateCategory[n.WorkItemStateCategory.InProgress]}static getAverageVelocity(e,t,a=!1){let i=0,r=0;return t.map((t=>{t.IsEnded&&(e.map((e=>{o.isWorkItemCompleted(e.StateCategory,e.State,a)&&e.IterationSK===t.IterationSK&&(i+=e.AggregationResult)})),r++)})),r>0?Math.round(i/r):0}static getSubtitle(e){return 1===e?b.VelocityWidget_SingleIterationSubtitle:e>1?(0,i.format)(b.VelocityWidget_IterationsSubtitle,e.toString()):b.VelocityWidget_NoIterations}static getWorkItemTypeFieldName(e,t){let o="";for(const a of e)if(!(0,i.localeIgnoreCaseComparer)(a.FieldReferenceName,t)){o=a.FieldName;break}return o}}t[e].VelocityDataHelper=o}("VelocityWidgetComponentsVelocityDataHelper"),function(e){q=t[e]={};class o extends c.ChartOptionFactoryBase{constructor(e){super(),this.context=e}static handleClick(e,t,o){const a=t.seriesName,i=o[t.seriesDataIndex];e.handleChartClick({stateName:a,iteration:i,valueAtPoint:t.itemY})}static customTooltipMapping(e){return e.map((e=>{const t=(Math.round(10*+e.values[0])/10).toLocaleString();return{styleType:{color:e.color,type:1},text:`${e.seriesName}: ${t}`}}))}createChartOptions(e){return e.isAdvancedChart?this.renderAdvanced(e):this.renderSimple(e)}renderAdvanced(e){const t=[];e.iterations.map(((o,a)=>{t[a]=0,e.plannedWorkByDayResult&&e.plannedWorkByDayResult.map((e=>{o.IterationSK===e.IterationSK&&(t[a]=e.AggregationResult)}))}));const a=this.renderSimple(e);return a.series.forEach((e=>{e.stackGroup=o.endIterationStackGroup})),a.series.unshift({name:b.VelocityChart_Planned_StateName,data:t,stackGroup:o.startIterationStackGroup,color:"#86CCDE"}),a}renderSimple(e){const t=[],a=[],i=[],r=[],n=s.LinkPermissionsHelper.canUserAccessWITQueriesPage(this.context);e.iterations.map(((o,n)=>{o.IterationName&&r.push(o.IterationName),t[n]=0,i[n]=0,a[n]=0,null!=e.completedLateResult&&e.completedLateResult.map((e=>{o.IterationSK===e.IterationSK&&(a[n]+=e.AggregationResult)})),e.metastateResult.map((a=>{o.IterationSK===a.IterationSK&&(E.VelocityDataHelper.isWorkItemCompleted(a.StateCategory,a.State,e.showResolvedItemsAsCompleted)?t[n]+=a.AggregationResult:E.VelocityDataHelper.isWorkItemInProgress(a.StateCategory,a.State,e.showResolvedItemsAsCompleted)&&(i[n]+=a.AggregationResult))})),t[n]-=a[n]}));const c={pageContext:this.context,chartType:l.ChartTypesConstants.StackedColumn,series:[{name:b.VelocityChart_Completed_StateName,data:t,color:"#107c10"},{name:b.VelocityChart_Incomplete_StateName,data:i,color:"#0078d4"}],xAxis:{labelValues:r},tooltip:{customTooltipMapping:o.customTooltipMapping},legendClick:t=>e.velocityClickHandler.handleLegendClick(),suppressAnimation:e.suppressAnimations};return n&&(c.click=t=>o.handleClick(e.velocityClickHandler,t,e.iterations)),null!=e.completedLateResult&&c.series.splice(1,0,{name:b.VelocityChart_CompletedLate_StateName,data:a,color:"#8DC54B"}),c}}t[e].VelocityChartOptionFactory=o,o.startIterationStackGroup="start",o.endIterationStackGroup="end"}("VelocityWidgetComponentsVelocityChartOptionFactory"),t.VelocityWidgetComponentsVelocitySettings={},function(e){O=t[e]={};class o extends S.WidgetDataManagerBase{constructor(e,t,o="Velocity"){super(e,t),this.command=o,this.dataService=this.context.getService(f.IDashboardsCacheableQueryServiceName),this.teamContext=t.widgetTelemetryProps.teamContext}async getData(){const e=new Set;if(this.demandTracker.isDemandPresent(g.DemandType.subtitle)||this.demandTracker.isDemandPresent(g.DemandType.scalar)||this.demandTracker.isDemandPresent(g.DemandType.chart)){const t=JSON.parse(this.settings||""),o=t.teamId,a=t.projectId,i=t.numberOfIterations,r=t.aggregation;r.settings||(r.settings=""),(0,v.isFeatureFlagEnabled)(this.context,B.VelocityConstants.featureFlagName_ShowResolvedItemsAsCompleted,!1)||(t.showResolvedItemsAsCompleted=!1);const n=this.getIterations(a,o,i,e);return this.getWorkItemTypes(t).then((i=>n.then((async n=>{var s;if(n&&n.length>0){const l=[];n.filter((e=>e.IterationSK)).map((e=>{l.push(e.IterationSK)}));const c=this.getMetastate(l,a,o,r,i,e),d=null!=t.lateWorkDelay?this.getCompletedLateMetastate(n,a,o,r,i,t.showResolvedItemsAsCompleted,t.lateWorkDelay,e):Promise.resolve(void 0),g=null!=t.plannedWorkDelay?this.getPlannedWorkByDay(a,o,n,r,i,t.plannedWorkDelay,e):Promise.resolve(void 0),y=this.getAggregationWorkItemTypeFields(a),[p,u,C,h]=await Promise.all([c,d,g,y]);if(0===p.length)return this.packMessageAsState(m.MessageType.NoData);this.queryContext={velocitySettings:t,workItemTypes:i};const W={velocityClickHandler:this,iterations:n,metastateResult:p,plannedWorkByDayResult:C,completedLateResult:u,suppressAnimations:this.suppressAnimations,isAdvancedChart:null!=t.plannedWorkDelay,showResolvedItemsAsCompleted:null!==(s=t.showResolvedItemsAsCompleted)&&void 0!==s&&s},I=await new q.VelocityChartOptionFactory(this.context).createChartOptions(W);return this.currentState={showMessage:!1,title:{text:this.title},subtitle:{text:E.VelocityDataHelper.getSubtitle(n.length)},scalarData:{description:b.VelocityWidget_AverageVelocity,measure:E.VelocityDataHelper.getScalarMeasure(h,r),value:p&&p.length>0?E.VelocityDataHelper.getAverageVelocity(p,n,t.showResolvedItemsAsCompleted):0},chartData:{chartOptions:I},warningsData:Array.from(e)},this.currentState}return this.packMessageAsState(m.MessageType.SetIterationDates)})))).then(null,(e=>{let t=m.MessageType.WidgetError;(0,A.recognizeAnalyticsException)(e)===A.AnalyticsExceptionType.DataNotReady&&(t=m.MessageType.AxFaultIn),(0,A.recognizeAnalyticsException)(e)===A.AnalyticsExceptionType.MissingAnalyticsPermissions&&(t=m.MessageType.MissingPermissions);const o=(0,A.extractODataError)(e);return this.packMessageAsState(t,o)}))}return Promise.resolve(this.currentState)}handleLegendClick(){k.onWidgetClick(this.context,this.widgetPropsForTelemetry,{linkDescription:"LegendClicked"})}handleChartClick(e,t){if(e.valueAtPoint){const o=window.open();let a;switch(e.stateName){case b.VelocityChart_Planned_StateName:a=this.getPlannedWorkByDayDetails(this.queryContext.velocitySettings.projectId,this.queryContext.velocitySettings.teamId,e.iteration,this.queryContext.workItemTypes,this.queryContext.velocitySettings.plannedWorkDelay);break;case b.VelocityChart_CompletedLate_StateName:a=this.getCompletedLateMetastateDetails(this.queryContext.velocitySettings.projectId,this.queryContext.velocitySettings.teamId,e.iteration,this.queryContext.workItemTypes,this.queryContext.velocitySettings.showResolvedItemsAsCompleted,this.queryContext.velocitySettings.lateWorkDelay,t);break;case b.VelocityChart_Completed_StateName:a=this.getCompletedMetastateDetails(this.queryContext.velocitySettings.projectId,this.queryContext.velocitySettings.teamId,e.iteration,this.queryContext.workItemTypes,this.queryContext.velocitySettings.showResolvedItemsAsCompleted,this.queryContext.velocitySettings.lateWorkDelay,t);break;case b.VelocityChart_Incomplete_StateName:a=this.getIncompleteMetastateDetails(this.queryContext.velocitySettings.projectId,this.queryContext.velocitySettings.teamId,e.iteration,this.queryContext.workItemTypes,this.queryContext.velocitySettings.showResolvedItemsAsCompleted,t);break;default:a=null}null!=a&&a.then((t=>{const a=t.map((e=>e.WorkItemId));k.onWidgetClick(this.context,this.widgetPropsForTelemetry,{linkDescription:"ChartClicked"}),null!=o&&this.navigateToWorkItemList(e.stateName||"",e.iteration,a,o)})).then(void 0,(e=>{k.onWidgetFailure(this.context,this.widgetPropsForTelemetry,"Failure handling chart click in Velocity Chart.","handleChartClick",{ErrorDetail:JSON.stringify(e)})}))}}async getWorkItemTypes(e){if(e.workItemTypeFilter.identifier===Q.WorkItemTypeFilterMode[Q.WorkItemTypeFilterMode.BacklogCategory]){const t=this.context.getService(f.IDashboardsCacheableQueryServiceName),o=D.ProcessesQuery.onTeam(this.context,e.projectId,e.teamId),a=await t.getCacheableQueryResult(o),i=e.workItemTypeFilter.settings;return a.map((e=>e.BacklogCategoryReferenceName===i?e.WorkItemType:"")).filter((e=>""!=e))}return Promise.resolve([e.workItemTypeFilter.settings])}getIterations(e,t,o,a){const i=d.IterationsQuery.onTeam(e,t,o);return this.runQuery("getIterations",i,void 0,a)}getMetastate(e,t,o,a,i,r){const n=new h.MetastateByIterationsQuery(this.command,t,o,e,a,i);return this.runQuery("getMetastate",n,void 0,r)}getCompletedLateMetastate(e,t,o,a,i,r=!1,n,s){const l=new u.CompletedLateMetastateByIterationsQuery(this.command,t,o,e,a,i,r,n);return this.runQuery("getCompletedLateMetastate",l,void 0,s)}getPlannedWorkByDay(e,t,o,a,i,r,n){const s=new I.PlannedWorkByDayQuery(this.command,e,t,o,a,i,r);return this.runQuery("getPlannedWorkByDay",s,void 0,n)}getIncompleteMetastateDetails(e,t,o,a,i=!1,r){const n=new C.MetastateByIterationDetailsQuery(this.command,o.IterationSK||"",e,t,a);return this.runQuery("getMetastate",n,(e=>Promise.resolve(e.filter((e=>E.VelocityDataHelper.isWorkItemInProgress(e.StateCategory,e.State,i))))),r)}getCompletedLateMetastateDetails(e,t,o,a,i=!1,r,n){const s=new p.CompletedLateMetastateByIterationDetailsQuery(this.command,o,e,t,a,i,r);return this.runQuery("getCompletedLateMetastate",s,void 0,n)}getPlannedWorkByDayDetails(e,t,o,a,i,r){const n=new W.PlannedWorkByDayDetailsQuery(this.command,e,t,o,a,i);return this.runQuery("getPlannedWorkByDay",n,void 0,r)}getAggregationWorkItemTypeFields(e){const t=new y.AggregationWorkItemTypeFieldsQuery(this.command,e);return this.runQuery("getAggregationWorkItemTypeFields",t)}getCompletedMetastateDetails(e,t,o,a,i=!1,r,n){const s=new C.MetastateByIterationDetailsQuery(this.command,o.IterationSK||"",e,t,a);let l=Promise.resolve([]);return null!=r&&(l=this.getCompletedLateMetastateDetails(e,t,o,a,i,r)),this.runQuery("getMetastate",s,(e=>l.then((t=>{const o=e.filter((e=>E.VelocityDataHelper.isWorkItemCompleted(e.StateCategory,e.State,i)));return this.arraySubtract(o,t)}))),n)}runQuery(e,t,o,a){o||(o=e=>Promise.resolve(e));const i=k.executeAndTimeAsync(this.context,B.VelocityConstants.featureName,e,(()=>this.dataService.getCacheableQueryResult(t).then(o)),A.extractODataError);return this.addDataQualityWarnings(this.dataService.getDataQualityWarnings(t),a),i}navigateToWorkItemList(e,t,o,a){const r=`SELECT [${n.CoreFieldRefNames.Id}],[${n.CoreFieldRefNames.WorkItemType}],[${n.CoreFieldRefNames.Title}] FROM WorkItems WHERE [${n.CoreFieldRefNames.Id}] IN ({0})`,s=(0,i.format)(r,o.join(",")),l=`${this.title} - ${t.IterationName} - ${e}`;this.navigateToQueryPage(s,l,a)}navigateToQueryPage(e,t,o){new V.WiqlURLBuilder(this.context).BuildQueryURL(e,t,this.teamContext.id).then((e=>{o.location.href=e}))}arraySubtract(e,t){return e.filter((e=>t.findIndex((t=>t.WorkItemId===e.WorkItemId))<0))}addDataQualityWarnings(e,t){t&&e.then((e=>{e.forEach((e=>{t.add(e)}))}))}}t[e].VelocityDataManager=o}("VelocityWidgetComponentsVelocityDataManager"),function(e){U=t[e]={};class o extends M.SettingsManagerBase{constructor(e,t){super(),this.pageContext=e,this.teamContext=t}getFeatureName(){return B.VelocityConstants.featureName}generateDefaultSettings(){const e=this.packContext(this.teamContext);return Promise.resolve(a(e))}packContext(e){return{teamId:e.id,projectId:x.getProject(this.pageContext).id}}}function a(e,t,o,a,i=!1){return{lastArtifactName:void 0,teamId:e.teamId,projectId:e.projectId,aggregation:o||{identifier:r.AggregationMode.Count,settings:""},lateWorkDelay:0,plannedWorkDelay:0,numberOfIterations:a||6,workItemTypeFilter:{identifier:Q.WorkItemTypeFilterMode[Q.WorkItemTypeFilterMode.BacklogCategory],settings:t||"Microsoft.RequirementCategory"},showResolvedItemsAsCompleted:i}}t[e].default=o,t[e].packSettings=a}("VelocityWidgetComponentsVelocitySettingsManager"),function(e){H=t[e]={};class o extends F.ViewComponentBase{constructor(e){super(e)}createDataManager(e){return new O.VelocityDataManager(this.props.context,e,this.computeCommandName())}createActionCreator(){return new N.VelocityActionCreator(this.props.context,this.dataManager,this.store,this.actions,B.VelocityConstants.featureName,A.extractODataError)}createSettingsManager(){return new U.default(this.props.context,this.props.teamContext)}getMessageOptions(){let e;switch(this.getStoreState().messageType){case m.MessageType.AxFaultIn:e={actionText:b.VelocityWidget_LearnMore,actionAriaLabel:b.VelocityWidget_LearnMore,actionOnClickDelegate:()=>window.open(b.VelocityWidget_LearnMoreLink,"_blank")};break;case m.MessageType.SetIterationDates:const t=(0,R.routeUrl)(this.context.pageContext,"ms.vss-admin-web.project-admin-hub-route",{project:(0,x.getProject)(this.props.context).name,adminPivot:"work"});e={actionText:b.VelocityWidget_SetIterationDatesLink,actionAriaLabel:b.VelocityWidget_SetIterationDatesAriaLabel,actionOnClickDelegate:()=>window.open(t,"_blank")};break;case m.MessageType.MissingPermissions:e={actionOnClickDelegate:()=>{(0,P.showActionRequiredDialog)(this.context.pageContext,T.PermissionDeniedTitleText,w.createElement(L.FormatComponent,{format:T.PermissionDeniedDetailText},w.createElement("a",{href:T.PermissionDeniedDetailLinkAddress},T.PermissionDeniedDetailLinkText)))}};break;default:e=void 0}return e}packWidgetLoadedTelemetryData(e){return e&&this.props.teamContext?{WorkItemFilterKey:e.workItemTypeFilter.identifier,WorkItemFilterValue:e.workItemTypeFilter.identifier,AggregationKey:r.AggregationMode[e.aggregation.identifier],AggregationValue:e.aggregation.settings,NumberOfIterations:e.numberOfIterations,LateWorkDelayEnabled:void 0!==e.lateWorkDelay,LateWorkDelay:e.lateWorkDelay,PlannedWorkDelayEnabled:void 0!==e.plannedWorkDelay,PlannedWorkDelay:e.plannedWorkDelay,showResolvedItemsAsCompletedEnabled:e.showResolvedItemsAsCompleted}:{}}computeCommandName(){return"embedded-View"===this.props.presentationMode?"VelocityReport":"Velocity"}}t[e].default=o}("VelocityWidgetComponentsVelocityViewComponent"),function(e){t[e]={};class o extends _.VssComponent{constructor(e,t){super(e,t)}render(){return w.createElement(H.default,Object.assign({},this.props,{context:this.context.pageContext,suppressAnimations:!this.props.showLoadAnimations,onRenderCompletion:this.props.onWidgetLoaded}))}}t[e].VelocityWidget=o,o.componentType="velocityWidget",_.VssComponent.register(o.componentType,o)}("VelocityWidget")}),["Resources","VelocityWidgetComponents/VelocityActionCreator","VelocityWidgetComponents/VelocityConstants","VelocityWidgetComponents/VelocityDataContract","VelocityWidgetComponents/VelocityDataHelper","VelocityWidgetComponents/VelocityChartOptionFactory","VelocityWidgetComponents/VelocitySettings","VelocityWidgetComponents/VelocityDataManager","VelocityWidgetComponents/VelocitySettingsManager","VelocityWidgetComponents/VelocityViewComponent","VelocityWidget"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-dashboards-web.velocity-widget-content"}}));