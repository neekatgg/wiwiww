"use strict";define("Wit/WorkItemModel",["require","exports","Wit/Common/WorkItemControls/Constants","xss/PresetOptions","Wit/Common/Generated/Constants","VSS/Core/Observable","VSS/Core/Util/String","Wit/Identity/Utilities/WorkItemIdentityHelper","VSS/Platform/Context","Wit/WorkItemDataManager/Sources/WorkItemStoreLevelWITDataSource","Wit/Clients/Wit/RestClient/WorkItemTracking","Mention/Common/DisplayNameStorageKeyTranslationService","VSS/Platform/Feature","VSS/Platform/Telemetry","VSS/Platform/Util/Array","Wit/Common/Constants/FeatureFlags","Wit/Common/NodeHelpers","xss","react","VSS/Platform/FPS","VSSUI/Dialog","VSSUI/Observer"],(function(e,t,i,s,a,r,n,o,l,d,u,h,c,I,m,f,g,p,k,v,E,y){var F,C,D,T,S,_,R,W,w,L,N,O,V,P,A,b,B,M,U,x,H,j,G,Q,K,q;F=t[q="Resources"]={},t[q].BrowserRefreshRequired="VS402831: Changes have been made to the process that require you to refresh your browser.",t[q].FailedToRetrieveProjectDataForId="Failed to retrieve project data for project id {0}.",t[q].FailedToRetrieveWorkItemDataForIds="Failed to retrieve work item data for the following ids: {0}.",t[q].FieldStatusInvalidCharactersError="The value for field '{0}' has unsupported characters.",t[q].FieldStatusInvalidComputedFieldError="The value for field '{0}' is computed and cannot be changed.",t[q].FieldStatusInvalidDateErrorError="FieldStatusInvalidDateErrorError",t[q].FieldStatusInvalidEmptyError="Field '{0}' cannot be empty.",t[q].FieldStatusInvalidEmptyOrOldValueError="Field '{0}' cannot be empty, and must be different from the original value.",t[q].FieldStatusInvalidFormatError="The value for field '{0}' is not in a recognized format.",t[q].FieldStatusInvalidListValueError="The field '{0}' contains the value '{1}' that is not in the list of supported values.",t[q].FieldStatusInvalidNotEmptyError="The value for field '{0}' must be empty.",t[q].FieldStatusInvalidNotEmptyOrOldValueError="The value for field '{0}' must be empty or the same as the original value.",t[q].FieldStatusInvalidNotOldValueError="The value for field '{0}' must be the same as the original value.",t[q].FieldStatusInvalidOldValueError="The value for field '{0}' must be updated, the current value is no longer supported.",t[q].FieldStatusInvalidPathError="The area or iteration provided for field '{0}' could not be found.",t[q].FieldStatusInvalidTooLongError="The value for field '{0}' is too long.",t[q].FieldStatusInvalidTypeError="The value for field '{0}' is not of the right type.",t[q].FieldStatusInvalidUnknownError="There is an unknown problem with field '{0}'.",t[q].FieldStatusInvalidValueInOtherFieldError="The field '{0}' is unsupported because of a value in another field.",t[q].FieldStatusInvalidValueNotInOtherFieldError="The field '{0}' is unsupported because a value is missing in another field.",t[q].InvalidWorkItemId="Unable to retrieve work item info for work item id {0}.",t[q].WorkItemBulkSaveFailed="One or more work items could not be saved. You might have lost the connection to your server. Refresh your browser, and then try again. If the problem persists, you might not have the area path permissions required to edit work items.",t[q].WorkItemIsReadOnlyError="This action does not apply because the work is read-only.",t[q].WorkItemLinkTypeEndDoesNotExist="Work item link type end '{0}' does not exist.",t[q].UnknownError="Unknown error.",t[q].CreateCopyCopiedFrom="Copied from {0}",t[q].CreateCopyCopiedFromNewWorkItem="Copied from new work item",t[q].CreateCopyCopiedWithAllAttachmentsFrom="Copied with all attachments from {0}",t[q].CreateCopyCopiedWithAllLinksAndAttachmentsFrom="Copied with all attachments and links from {0}",t[q].CreateCopyCopiedWithAllLinksFrom="Copied with all links from {0}",t[q].CreateCopyErrorCopyingChild="Error copying child item {0}: {1}",t[q].CreateCopyTooManyChildren="Cannot copy a work item with more than {0} children.",t[q].LinkedFromMentionCommentFormat="{0} mentioned work item #{1} in #{2}",t[q].WorkItemChangedReproDescriptionMessage="Copied from {0} when changed from {1} to {2}",t[q].DeletedAreaPath="(removed area path)",t[q].DeletedIterationPath="(removed iteration path)",t[q].WorkItemCaptionNew="New {0} {1}",t[q].Cancel="Cancel",t[q].DirtyNavDialogOptions="You can save your changes, discard your changes, or cancel to continue editing.",t[q].DirtyNavDialogSavingFailure="Error! Failed to save work item(s):",t[q].DirtyNavDialogTitle="Are you sure you want to leave the page?",t[q].DirtyNavDialogUnsavedChanges="You have unsaved changes:",t[q].DiscardChanges="Discard Changes",t[q].SaveChanges="Save Changes",t[q].SavingWorkItems="Saving Work Items",function(e){C=t[e]={},function(e){e.LayoutUserSettingsProvider="ms.vss-work-web.work-item-layout-user-settings-data-provider",e.UnfollowsDataProvider="ms.vss-work-web.work-item-unfollows-data-provider"}(t[e].ExtensionConstants||(t[e].ExtensionConstants={})),function(e){e[e.None=0]="None",e[e.ServerDateTime=1]="ServerDateTime",e[e.CallerIdentity=2]="CallerIdentity",e[e.RandomGuid=3]="RandomGuid"}(t[e].ServerDefaultValueType||(t[e].ServerDefaultValueType={})),t[e].RegisteredLinkTypeNames={Related:"Related Workitem",Hyperlink:"Workitem Hyperlink",Changeset:"Fixed in Changeset",VersionedItem:"Source Code File",Commit:"Fixed in Commit",Branch:"Branch",Tag:"Tag",PullRequest:"Pull Request",ResultAttachment:"Result Attachment",TestResult:"Test Result",Test:"Test",Storyboard:"Storyboard",Build:"Build",FoundInBuild:"Found in build",IntegratedInBuild:"Integrated in build",WikiPage:"Wiki Page",WorkItemLink:"WorkItemLink",RemoteWorkItemLink:"RemoteWorkItemLink",GitHubPullRequestLinkType:"GitHub Pull Request",GitHubCommitLinkType:"GitHub Commit",GitHubIssueLinkType:"GitHub Issue",ReleaseEnvironment:"Integrated in release environment"},t[e].RegisteredWorkItemLinkTypeNames={Parent:"Parent"},function(e){e.OperationCanceledException="VSS.WorkItemTracking.OperationCanceledException",e.WorkItemBulkSaveException="VSS.WorkItemTracking.WorkItemBulkSaveException",e.ProjectDoesNotExistException="VSS.WorkItemTracking.ProjectDoesNotExistException",e.FieldDoesNotExistException="VSS.WorkItemTracking.FieldDoesNotExistException",e.LinkTypeEndDoesNotExistException="VSS.WorkItemTracking.LinkTypeEndDoesNotExistException",e.LinkTypeDoesNotExistException="VSS.WorkItemTracking.LinkTypeDoesNotExistException",e.WorkItemSaveFailedDueToInvalidStatusException="VSS.WorkItemTracking.WorkItemSaveFailedDueToInvalidStatusException",e.InvalidQuerySyntaxException="VSS.WorkItemTracking.InvalidQuerySyntaxException",e.InvalidQueryFilterRowException="VSS.WorkItemTracking.InvalidQueryFilterRowException",e.QueryItemAlreadyExistException="VSS.WorkItemTracking.QueryItemAlreadyExistException",e.QueryFolderDoesNotExistException="VSS.WorkItemTracking.QueryFolderDoesNotExistException",e.InvalidOperationException="System.InvalidOperationException"}(t[e].Exceptions||(t[e].Exceptions={})),function(e){e[e.Valid=0]="Valid",e[e.InvalidEmpty=1]="InvalidEmpty",e[e.InvalidNotEmpty=2]="InvalidNotEmpty",e[e.InvalidFormat=3]="InvalidFormat",e[e.InvalidListValue=4]="InvalidListValue",e[e.InvalidOldValue=5]="InvalidOldValue",e[e.InvalidNotOldValue=6]="InvalidNotOldValue",e[e.InvalidEmptyOrOldValue=7]="InvalidEmptyOrOldValue",e[e.InvalidNotEmptyOrOldValue=8]="InvalidNotEmptyOrOldValue",e[e.InvalidValueInOtherField=9]="InvalidValueInOtherField",e[e.InvalidValueNotInOtherField=10]="InvalidValueNotInOtherField",e[e.InvalidDate=11]="InvalidDate",e[e.InvalidTooLong=12]="InvalidTooLong",e[e.InvalidType=13]="InvalidType",e[e.InvalidComputedField=14]="InvalidComputedField",e[e.InvalidPath=15]="InvalidPath",e[e.InvalidCharacters=16]="InvalidCharacters",e[e.InvalidIdentity=17]="InvalidIdentity",e[e.InvalidUnknown=18]="InvalidUnknown"}(t[e].FieldStatus||(t[e].FieldStatus={})),function(e){e[e.DefaultRules=1]="DefaultRules",e[e.CopyRules=2]="CopyRules",e[e.OtherRules=3]="OtherRules"}(t[e].RuleEvaluatorExecutionPhase||(t[e].RuleEvaluatorExecutionPhase={})),function(e){e.HIDDEN="Microsoft.HiddenCategory",e.TEST_CASE="Microsoft.TestCaseCategory",e.TEST_PLAN="Microsoft.TestPlanCategory",e.TEST_SUITE="Microsoft.TestSuiteCategory",e.TEST_SHAREDSTEP="Microsoft.SharedStepCategory",e.TEST_SHAREDPARAMETER="Microsoft.SharedParameterCategory"}(t[e].WorkItemCategoryConstants||(t[e].WorkItemCategoryConstants={})),function(e){e.NEW_PROJECT_DATA="new-project-data",e.DISCUSSION_ADDED="discussion-added",e.DISCUSSION_DELETED="discussion-deleted",e.DISCUSSION_UPDATED="discussion-updated",e.RESET_DISCUSSION="reset-discussion",e.RESET_HISTORY="reset-history",e.DISCUSSION_EDIT_DIRTY_CHANGED="discussion-dirty-changed",e.DISCUSSION_COMMENT_UPDATED="discussion-comment-updated",e.WORKITEM_DELETED="workitem-deleted",e.WORKITEM_RESTORED="workitem-restored",e.WORKITEM_DESTROYED="workitem-destroyed",e.WORKITEM_DISCARDED="workitem-discarded",e.WORKITEM_ID_UPDATED="workitem-id-updated",e.WORKITEM_COPIED="workitem-copied"}(t[e].Actions||(t[e].Actions={})),t[e].WorkItemWatermarkAllAction="all-fields",function(e){e.HISTORY_OUTDATED="history-outdated",e.WORKITEM_MANAGER_KEY="workitem-manager"}(t[e].RelatedDataKeys||(t[e].RelatedDataKeys={})),function(e){e.NoResult="NoResult",e.Error="Error",e.Success="Success"}(t[e].WorkItemUpdateResultState||(t[e].WorkItemUpdateResultState={})),function(e){e.ReproSteps="Microsoft.VSTS.TCM.ReproSteps"}(t[e].BugWITFieldReferenceNames||(t[e].BugWITFieldReferenceNames={})),function(e){e.QUERY=200,e.SAVE=200}(t[e].PageSizes||(t[e].PageSizes={})),function(e){e.Off="off",e.Right="right",e.Bottom="bottom"}(t[e].WorkItemPaneMode||(t[e].WorkItemPaneMode={})),function(e){e.Child_Link_Name="System.LinkTypes.Hierarchy-Forward",e.Parent_Link_Name="System.LinkTypes.Hierarchy-Reverse",e.Related_Link_Name="System.LinkTypes.Related-Forward"}(t[e].LinkTypeName||(t[e].LinkTypeName={})),function(e){e.DisableWorkItemStoreDataProviders="WorkItemTracking.Server.DisableWorkItemStoreDataProviders",e.DisableSendMailDataProvider="WorkItemTracking.Server.DisableSendMailDataProvider",e.DisableWorkItemColorDataProvider="WorkItemTracking.Server.DisableWorkItemColorDataProvider"}(t[e].WitFeatureAvailabilityFlags||(t[e].WitFeatureAvailabilityFlags={})),function(e){e[e.Related=1]="Related",e[e.Parent=-2]="Parent",e[e.Child=2]="Child",e[e.Predecessor=-3]="Predecessor",e[e.Successor=3]="Successor"}(t[e].CoreLinkTypes||(t[e].CoreLinkTypes={})),function(e){e[e.WorkItemMissingOrUpdated=600122]="WorkItemMissingOrUpdated",e[e.ResourceLinkNotFoundException=600180]="ResourceLinkNotFoundException"}(t[e].ErrorCodes||(t[e].ErrorCodes={})),function(e){e.WorkItemFormArea="NewWorkItemFormArea",e.EditWorkItemView="EditWorkItemView",e.CreateWorkItemView="CreateWorkItemView",e.TakeUpdateResult="WorkItemTracking.TakeUpdateResult",e.EvaluateLinkUpdates="WorkItemTracking.EvaluateLinkUpdates",e.ResetAfterSave="WorkItemTracking.ResetAfterSave"}(t[e].WorkItemFormPerfConstants||(t[e].WorkItemFormPerfConstants={}));class i{}t[e].WITCustomerIntelligenceArea=i,i.WORK_ITEM_TRACKING="WIT",i.WORK_ITEM_TRACKING_MOBILE="WIT_MOBILE",i.NEW_QUERIES_EXPERIENCE="NEW_QUERIES",i.WORK_ITEM_TRACKING_NEWNAV="WIT_NEWNAV";class s{}t[e].WITCustomerIntelligenceFeature=s,s.CLIENTSIDEOPERATION_SEND_EMAIL="SendEmail",s.CLIENTSIDEOPERATION_OPEN_WORK_ITEM_IN_NEW_TAB="OpenWorkItemInNewTab",s.CLIENTSIDEOPERATION_PREFETCH_NEXT_WORKITEM="PrefetchNextWorkitemInTriageView",s.CLIENTSIDEOPERATION_BACK_TO_QUERY_RESULTS="BackToQueryResults",s.CLIENTSIDEOPERATION_MAXIMIZE_RICH_EDITOR="MaximizeRichEditor",s.CLIENTSIDEOPERATION_QUERY_SOFTCAP_LINK="QuerySoftCapLink",s.CLIENTSIDEOPERATION_COPY_SELECTION_AS_HTML="CopySelectionAsHtml",s.CLIENTSIDEOPERATION_WORK_ITEM_FINDER="WorkItemFinder",s.CLIENTSIDEOPERATION_QUERYACROSSPROJECTS="QueryAcrossProjects",s.CLIENTSIDEOPERATION_QUERY_WORK_ITEM="QueryWorkItem",s.CLIENTSIDEOPERATION_CREATE_QUERY="CreateQuery",s.CLIENTSIDEOPERATION_CHANGE_QUERY_COLUMNS="ChangeQueryColumns",s.CLIENTSIDEOPERATION_WIT_CLONE="CloneWorkItem",s.CLIENTSIDEOPERATION_QUERY_RESULTS_PROVIDER="QueryResultsProvider",s.CLIENTSIDEOPERATION_COPY_WORKITEM_LINK="WorkItem.CopyWorkItemLink",s.CLIENTSIDEOPERATION_INCLUDE_WORKITEM_LINKS_ATTACHMENTS="WorkItem.IncludeWorkItemLinksAndAttachments",s.CLIENTSIDEOPERATION_COPY_WITH_CHILDREN="WorkItem.CopyWithChildren",s.CLIENTSIDEOPERATION_TOOLBAR_CLICK="WorkItem.ToolbarButtonClicks",s.CLIENTSIDEOPERATION_WIT_TABSELECTION="WorkItem.TabSelection",s.CLIENTSIDEOPERATION_WIT_GROUPCOLLAPSED="WorkItem.GroupCollapsed",s.CLIENTSIDEOPERATION_WIT_SAVING="WorkItem.Saving",s.CLIENTSIDEOPERATION_WIT_CSSNODECACHEINVALIDATED="CSSNodes.CacheInvalidated",s.CLIENTSIDEOPERATION_WIT_MOBILEDISCUSSIONOPENED="WorkItem.DiscussionOpened",s.CLIENTSIDEOPERATION_WIT_MOBILEDISCUSSIONMESSAGESLOADED="WorkItem.DiscussionMessagesLoaded",s.CLIENTSIDEOPERATION_WIT_MOBILEDISCUSSIONCOMMENTSUBMITTED="WorkItem.DiscussionCommentSubmitted",s.CLIENTSIDEOPERATION_WIT_MOBILEDISCUSSIONUNSAVEDPREVIEW="WorkItem.DiscussionUnsavedPreview",s.CLIENTSIDEOPERATION_WIT_MOBILEDISCUSSIONRETURNTOUNSAVEDCOMMENT="WorkItem.DiscussionReturnToUnsavedComment",s.CLIENTSIDEOPERATION_WIT_MOBILEDISCUSSIONPREVIEWCLICKED="WorkItem.DiscussionPreviewClicked",s.RESULT_FILTER="ResultFilter",s.CLIENTSIDEOPERATION_VS_WORKITEM_NOT_IN_QUERY_RESULTS="VSOpenInWeb.WorkItemNotInQueryResult",s.WORKITEMPANECHANGED="WorkItemPaneChanged",s.WI_FORM_CONTRIBUTION="FormContribution",s.IMPORTCSV_IMPORT="ImportCsv.Import",s.IMPORTCSV_IMPORT_ERROR="ImportCsv.Import.Error",s.CLIENTSIDEOPERATION_WIT_MOVE_CANCEL="WorkItemMove.CancelMove",s.CLIENTSIDEOPERATION_WIT_MOVE_CANCEL_AFTER_HIDDEN_TYPE_FAILED="WorkItemMove.CancelAfterHiddenTypeFailed",s.CLIENTSIDEOPERATION_WIT_MOVE_CANCEL_AFTER_TYPE_FAILED="WorkItemMove.CancelAfterTypeFailed",s.CLIENTSIDEOPERATION_WIT_MOVE_SUCCEED_AFTER_TYPE_FAILED="WorkItemMove.PassAfterTypeFailed",s.CLIENTSIDEOPERATION_WIT_MOVE_PERMISSIONS_ERROR="WorkItemMove.PermissionsError",s.CLIENTSIDEOPERATION_WIT_MOVE_REVERT="WorkItemMove.Revert",s.CLIENTSIDEOPERATION_WIT_MOVE_SUCCESS="WorkItemMove.Success",s.CLIENTSIDEOPERATION_WIT_TYPE_CHANGE_REVERT="WorkItemChangeType.Revert",s.CLIENTSIDEOPERATION_WIT_TYPE_CHANGE_CANCEL_AFTER_FAIL="WorkItemChangeType.CancelAfterFailed",s.CLIENTSIDEOPERATION_WIT_TYPE_CHANGE_CANCEL_AFTER_OPEN="WorkItemChangeType.CancelAfterOpen",s.CLIENTSIDEOPERATION_WIT_TYPE_CHANGE_SUCCESS="WorkItemChangeType.Success",s.BULK_EDIT_TAGS="BulkEditTags",s.TELEMETRY_ASSIGNTO_POPULATEMENU="AssignTo.PopulateMenu",s.TELEMETRY_OPENWORKITEM_CONTEXTMENU="OpenWorkItemConextMenu",s.WORKITEM_DISCUSSIONCONTROL="WorkItemDiscussion",s.WORKITEM_VIEWFOLLOWS="ViewWorkItemFollows",s.WORKITEM_BULKUNFOLLOWS="BulkUnfollows",s.CLIENTSIDEOPERATION_RELATEDWORKITEMS_CONTROL_OPENWORKITEM="RelatedWorkItemsControlOpenWorkItem",s.NEWQUERYEXPERIENCE_NAVIGATE_PIVOT="NewQueries.NavigatePivot",s.NEWQUERYEXPERIENCE_WORKITEMNAVIGATOR="NewQueries.WorkItemNavigator",s.NEWQUERYEXPERIENCE_TRIAGEVIEWHUB_PIVOTCOMMAND="NewQueries.TriageViewHub.PivotCommand",s.NEWQUERYEXPERIENCE_QUERY_ACTION="NewQueries.QueryAction",s.NEWQUERYEXPERIENCE_MOVE_QUERY="NewQueries.MoveQuery",s.NEWQUERYEXPERIENCE_LEAVE_DIRTY="NewQueries.LeaveDirty",s.NEWQUERYEXPERIENCE_ADHOCQUERY_REDIRECTION="NewQueries.AdhocQuery.Redirection",s.NEWQUERYEXPERIENCE_LASTVISITED_REDIRECTION="NewQueries.LastVisited.Redirection",s.NEWQUERYEXPERIENCE_NAVIGATE_QUERIESPIVOT="NewQueries.Navigate.QueriesPivot",s.NEWQUERYEXPERIENCE_BREADCRUMB_CLICKED="NewQueries.Breadcrumb.Clicked",s.CUSTOMIZE_WORKITEM="WorkItemToolbar.Customize",s.QUERYCHARTS_NAVIGATE="QueryCharts.Navigate",s.QUERY_SEARCH="Query.Search",s.CLIENTSIDEOPERATION_WIT_FIELDKEYBOARDSHORTCUT="WorkItemForm.FieldKeyboardShortcut",s.CLASSIFICATION_MRU_VALUE_CHANGED="ClassificationFieldsMruValueChanged",s.WIT_CACHE_PROVIDER_INIT="WorkItemTracking.CacheProvider.Initialize",s.WIT_CACHE_PROVIDER_OPEN="WorkItemTracking.CacheProvider.OpenCache",s.WIT_WATCHDOG_OPEN_FORM="WorkItemTracking.WatchDog.OpenForm",s.LINKSCONTROL_SAMECATEGORY_WARNING="LinksControl.SameCategory.Warning",s.FILTER_METHOD_USAGE="WorkItemTracking.ExtensionFilterMethodUsage";class a{}t[e].WITPerformanceScenario=a,a.WORKITEM_OPEN_NEWFORMDIALOG="WorkItem.Open.NewFormDialog",a.WORKITEM_RELATED_LINKING="WorkItem.Related.Linking",a.WORKITEMFORM_FOLLOWS_ACTION_FOLLOW="WorkItemForm.Follows.Action.Follow",a.WORKITEMFORM_FOLLOWS_ACTION_UNFOLLOW="WorkItemForm.Follows.Action.Unfollow",a.WORKITEM_OPENFORM="WorkItem.OpenForm",a.WORKITEM_OPENFORM_NEWLAYOUT="WorkItem.OpenForm.NewLayout",a.WORKITEM_OPENFORM_CREATE_NEWLAYOUT="WorkItem.OpenForm.Create.NewLayout",a.WORKITEM_OPENDIALOG_NEWLAYOUT="WorkItem.OpenDialog.NewLayout",a.WORKITEM_OPENIDE_NEWLAYOUT="WorkItem.IDE.OpenForm.NewLayout",a.WORKITEM_SAVE="WorkItem.Save",a.WORKITEM_BULKSAVE="WorkItem.BulkSave",a.WORKITEM_CLOSED="WorkItem.Closed",a.WORKITEM_FIELDCHANGED="WorkItem.FieldChanged",a.QUERY_OPENRESULTS="Query.OpenResults",a.QUERY_SAVE="Query.Save",a.QUERY_SAVEAS="Query.SaveAs",a.QUERYHIERARCHY_LOAD="QueryHierarchy.Load",a.HISTORYVIEW_EXTENSION_LOAD="HistoryView.Extension.Load",a.WORKITEM_SIGNALR_REFRESHCOMPLETE="WorkItem.SignalR.RefreshComplete",a.WORKITEM_SIGNALR_REFRESHERROR="WorkItem.SignalR.RefreshError",a.WORKITEM_SIGNALR_ERROR="WorkItem.SignalR.Error",a.QUERIESHUB_TRIAGEVIEW_OPENQUERYRESULTS="QueriesHub.TriageView.OpenQueryResults",a.QUERIESHUB_TRIAGEVIEW_OPENBREADCRUMBQUERYRESULTS="QueriesHub.TriageView.OpenBreadcrumbQueryResults",a.QUERIESHUB_TRIAGEVIEW_OPENWORKITEM="QueriesHub.TriageView.OpenWorkItem",a.QUERIESHUB_TRIAGEVIEW_SAVEEXISTINGQUERY="QueriesHub.TriageView.SaveExistingQuery",a.QUERIESHUB_QUERIESVIEW_OPENFAVORITESPIVOT="QueriesHub.QueriesView.OpenFavoritesPivot",a.QUERIESHUB_QUERIESVIEW_OPENALLQUERIESPIVOT="QueriesHub.QueriesView.OpenAllQueriesPivot"}("OMWorkItemConstants"),function(e){D=t[e]={},__exportStar(C,t[e])}("OMindex"),function(e){T=t[e]={};class i{constructor(e,t){this.filterByAncestorEntityIds=e||[],this.filterByEntityIds=t||[]}static GetHashCode(e){let t=s._hashSeed;if(null==e)return t;const a=e.filterByAncestorEntityIds.sort().concat([i._hashSeparator],e.filterByEntityIds.sort());for(const e of a)t=t*s._stringListHashPrime+s.GetStringHashCode(e),t&=t;return t}static isFilterByScopeEmpty(e){return e&&0==e.filterByAncestorEntityIds.length&&0==e.filterByEntityIds.length}}t[e].FilterByScope=i,i._hashSeparator="@";class s{static GetStringHashCode(e){let t=s._hashSeed;if(e){e=e.trim().toLowerCase();for(let i=0;i<e.length;i++)t=t*s._stringHashPrime+e.charCodeAt(i),t&=t}return t}static GetStringListHashCode(e){let t=s._hashSeed;if(e)for(let i in e)t=t*s._stringListHashPrime+s.GetStringHashCode(i),t&=t;return t}}t[e].CommonHelpers=s,s._hashSeed=0,s._stringListHashPrime=31,s._stringHashPrime=37}("RuleEngineFilterByScope"),function(e){S=t[e]={};t[e].FieldValidationKey=class{constructor(e,t,i){this.fieldId=e,this.fieldValue=t,this.scope=i}toString(){return JSON.stringify({fieldId:this.fieldId,fieldValue:this.fieldValue,scope:{filterByScope:T.FilterByScope.GetHashCode(this.scope),nonIdentities:this.scope&&this.scope.nonIdentities,excludeGroups:this.scope&&this.scope.excludeGroups}})}equals(e){return e.toString()===this.toString()}}}("RuleEngineFieldValidationKey"),function(e){_=t[e]={};t[e].ServerDefaultValue=class{constructor(e,t){this.type=D.ServerDefaultValueType.None,this.type=e,this.value=t}toString(){return""+this.value}valueOf(){return this.value}}}("RuleEngineServerDefaultValue"),function(e){R=t[e]={};const a=/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F-\u009F]/,r=/(^[\uD800-\uDFFF]$)|[^\uD800-\uDBFF](?=[\uDC00-\uDFFF])|[\uD800-\uDBFF](?![\uDC00-\uDFFF])/;t[e].workItemLinkBeginningSign="#",t[e].getErrorMessage=function e(t){return t?"string"==typeof t?t:"function"==typeof t?e(t()):t.message?t.message:t.description?t.description:t.toString():F.UnknownError},t[e].parseNumber=function(e,t){if((e=e.trim()).match(/^((0x[a-f0-9]+)|([0-9]+))$/i))return parseInt(e);const i=t?/^(([+-]?\d*(\.\d*)?(e[+-]?\d+)?)|([+-]?infinity))$/i:/^(([+-]?\d*\.\d*(e[+-]?\d+)?)|([+-]?infinity))$/i;return e.match(i)?parseFloat(e):Number.NaN},t[e].isRemoved=function(e){return!!e&&e<i.FutureDate},t[e].parseBool=function(e){if(e){if("true"===e.trim().toLowerCase())return!0}return!1},t[e].containsControlChars=function(e){return a.test(e)},t[e].containsMismatchedSurrogateChars=function(e){return r.test(e)},t[e].isHtmlVisuallyBlank=function(e){var t;const i=Range.prototype.createContextualFragment.bind(document.createRange())(e),s=["EMBED","IMG","INPUT","PICTURE","VIDEO"],a=i.children;if(a.length>0)for(let e=0;e<a.length;e++)if(s.includes(a[e].tagName))return!1;return""===(null!==(t=i.textContent)&&void 0!==t?t:"").trim()},t[e].getWorkItemUrl=async function(e,t,i){const s=e.getService("IVssLocationService");return`${await s.getServiceLocationAsync(void 0,4)}${t}/_apis/wit/workItems/${i}`},t[e].htmlSanitizerPreserveMentionOptions=Object.assign(Object.assign({},s.superAllowList),{onTag:function(e,t,i){if(e.match(/[0-9A-Fa-f]{8}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{4}-[0-9A-Fa-f]{12}/g))return t}}),t[e].getEndingNumberFromUrl=function(e){if(e){const t=(e=e.trim()).match(/\/(\d+)\/$/);if(t){const e=null==t?void 0:t[1],i=parseInt(e);if(!isNaN(i))return i}}}}("Utils"),function(e){function i(e,t){const i=e;i.sorted=!0,i.comparer=t}function s(e,t){const i=e;return i.sorted&&i.comparer===t}W=t[e]={},t[e].copySortFlag=function(e,t){const i=e,s=t;i.sorted=s.sorted,i.comparer=s.comparer},t[e].flagSorted=i,t[e].sortIfNotSorted=function(e,t){return!s(e,t)&&(e.sort(t),i(e,t),!0)},t[e].isSorted=s}("WorkItemSorting"),function(e){function i(e){return s(e,a.FieldFlags.Computed)}function s(e,t){return(e.flags&+t)!==a.FieldFlags.None}w=t[e]={},t[e].isEditable=function(e){switch(e.id){case a.CoreField.AreaPath:case a.CoreField.IterationPath:return!0;case a.CoreField.Id:case a.CoreField.Rev:case a.CoreField.WorkItemType:case a.CoreField.CreatedBy:case a.CoreField.IsDeleted:return!1}return!i(e)},t[e].isCloneable=function(e){return s(e,a.FieldFlags.Cloneable)},t[e].isComputed=i,t[e].checkFlag=s}("WorkItemFieldDefinitionUtils"),function(e){L=t[e]={};const i=[0,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864,134217728,268435456,8192,65536,4096,536870912,32768,131072,1073741824],s=2147483648,l=256,d=/^\{?([\dA-F]{8})-?([\dA-F]{4})-?([\dA-F]{4})-?([\dA-F]{4})-?([\dA-F]{12})\}?$/i;function u(e,t,i){let r,o,u,c=0;if(null==e)r=null;else if("string"==typeof e&&0===e.length)r=null;else if(e instanceof _.ServerDefaultValue)r=e;else try{switch(t){case a.FieldType.Boolean:if("boolean"==typeof e)r=e?1:0;else if("number"==typeof e)r=0!==e?1:0;else{if("string"!=typeof e)throw new Error("Invalid Boolean field value.");r=/^\d+$/.test(e)?0!==(0,R.parseNumber)(e,i)?1:0:(0,R.parseBool)(e)?1:0}break;case a.FieldType.Integer:if("number"==typeof e?r=Math.round(e):"boolean"==typeof e?r=e?0:1:"string"==typeof e&&/^[\-+]?\d+$/.test(e.trim())&&(r=Number.parseInt(e)),void 0===r||isNaN(r)||!isFinite(r)||r>s-1||r<-s)throw new Error(`Invalid Integer field value,  ${e}`);break;case a.FieldType.Double:if("number"==typeof e?r=e:"boolean"==typeof e?r=e?0:1:"string"==typeof e&&(r=(0,R.parseNumber)(e.replace(",","."),i)),void 0===r||isNaN(r)||!isFinite(r))throw new Error(`Invalid Double field value,  ${e}`);break;case a.FieldType.DateTime:if(r=e instanceof Date?e:"string"==typeof e?new Date(e):null,null===r||isNaN(r))throw new Error("Invalid DateTime field value.");o=r.getFullYear(),(o<1753||o>9999)&&(c=8192);break;case a.FieldType.Guid:if("string"!=typeof e)throw new Error("Invalid GUID field value.");if(u=d.exec(e),!u)throw new Error("Invalid GUID field value.");r=u[1]+"-"+u[2]+"-"+u[3]+"-"+u[4]+"-"+u[5];break;default:if("string"==typeof e)r=e;else if("number"==typeof e)r=e.toLocaleString();else if("boolean"==typeof e)r=e?"True":"False";else{if(!(e instanceof Date))throw new Error("Invalid String field type.");r=(0,n.dateToString)(e,!0)}void 0===r&&(r=null),null!==r&&(t!==a.FieldType.PlainText&&t!==a.FieldType.Html||(r=r.trim()),0===r.length&&(r=null)),null!==r&&(t===a.FieldType.String&&r.length>l&&(c=65536),h(r,g(t))||(c=131072))}}catch(t){return{value:e,error:t,status:4096}}return{value:r,status:c}}function h(e,t){return!(!t&&(0,R.containsControlChars)(e))&&!(0,R.containsMismatchedSurrogateChars)(e)}function c(e){switch(e){case a.FieldType.PlainText:case a.FieldType.Html:case a.FieldType.History:case a.FieldType.String:return!0;default:return!1}}function I(e,t){if(t){return m(e,!0)[t.toLocaleUpperCase()]||t}return t}function m(e,t){const i=e,s={};if(t){if(i.__hashSetCaseInsensitive)return i.__hashSetCaseInsensitive;for(const t of e)s[t.toLocaleUpperCase()]=t;i.__hashSetCaseInsensitive=s}else{if(i.__hashSet)return i.__hashSet;for(const t of e)s[t]=t;i.__hashSet=s}return s}function f(e){if(0!=(2147479552&e)){for(let t=1,s=i.length;t<s;t++)if(0!=(e&i[t]))return t;return D.FieldStatus.InvalidUnknown}return D.FieldStatus.Valid}function g(e){switch(e){case a.FieldType.PlainText:case a.FieldType.Html:case a.FieldType.History:return!0;default:return!1}}function p(e){return 0!=(4&e.status)}function k(e){return e===a.FieldType.Integer||e===a.FieldType.Double}function v(e){return null==e||"string"==typeof e&&0===e.trim().length}function E(e,t,i){let s,a;if(!t)return e;if(0===t.length)return[];if(e.length<t.length?s=m(e,i):(s=m(t,i),t=e),a=[],i)for(const e of t)s.hasOwnProperty(e.toLocaleUpperCase())&&(a[a.length]=e);else for(const e of t)s.hasOwnProperty(e)&&(a[a.length]=e);return a}function y(e,t,i){let s,a;if(i){t?(s=t.slice(0),(0,W.copySortFlag)(s,t)):(s=[],(0,W.flagSorted)(s,n.localeIgnoreCaseComparer));for(const t of i){if(a=e.getConstantSet(t),!a)throw new Error((0,n.format)("Constant set {0} is not ready. Operation cannot continue.",t));s=N(s,a,!0)}return s}return t}function C(e,t,i){if(i){return m(e,!0).hasOwnProperty(t.toLocaleUpperCase())}return e.includes(t)}function T(e,t,i){let s,a;if(!t||0===t.length)return e;if(a=[],s=m(t,i),i)for(const t of e)s.hasOwnProperty(t.toLocaleUpperCase())||(a[a.length]=t);else for(const t of e)s.hasOwnProperty(t)||(a[a.length]=t);return a}function N(e,t,i){const s=i?n.localeIgnoreCaseComparer:n.localeComparer;if(!t||0===t.length)return e;if(!e||0===e.length)return t;(0,W.sortIfNotSorted)(e,s),(0,W.sortIfNotSorted)(t,s);const a=[];(0,W.flagSorted)(a,s);let r=0;const o=e.length;let l=0;const d=t.length;let u,h,c;for(;r<o&&l<d;)u=e[r],h=t[l],c=s(u,h),0===c?(a[a.length]=u,r++,l++):c>0?(a[a.length]=h,l++):(a[a.length]=u,r++);for(;r<o;)a[a.length]=e[r],r++;for(;l<d;)a[a.length]=t[l],l++;return a}function O(e){return e.workItem.isReadOnly()}function V(e){if(e.workItem.isReadOnly()||O(e)||!w.isEditable(e.fieldDefinition))return!1;let t=e.fieldDefinition.id;switch(t){case a.CoreField.Rev:case a.CoreField.WorkItemType:case a.CoreField.CreatedBy:case a.CoreField.IsDeleted:return!1;case a.CoreField.AreaPath:t=a.CoreField.AreaId;break;case a.CoreField.IterationPath:t=a.CoreField.IterationId;break;default:return 0==(2&e.status)}const i=e.workItem.getFieldById(t);return!!i&&V(i)}function P(e,t){return u(e,a.FieldType.String,t).value}function A(e,t,i){if(!e.allowedValues){const s=b(e,t,i);e.allowedValues=new r.ObservableArray(s)}return e.allowedValues}function b(e,t,i){let s=[];const r=t.store;if(p(e)){const a=e.lists;if(a.allowedValues&&a.allowedValues.length>0){s=y(r,a.allowedValues[0].items,a.allowedValues[0].globals);for(const e of a.allowedValues)s=E(s,y(r,e.items,e.globals),!0)}if(a.suggestedValues&&a.suggestedValues.length>0){let e=[];for(const t of a.suggestedValues)e=N(e,y(r,t.items,t.globals),!0);s=s.length?E(s,e):e}if(a.allowExistingValue){const a=t.getFieldValueById(e.fieldDefinition.id,!0);v(a)||(s=s.length?N(s,[P(a,i)],!0):[P(a,i)])}if(s.length&&a.prohibitedValues&&a.prohibitedValues.length>0)for(const e of a.prohibitedValues)s=T(s,y(r,e.items,e.globals),!0)}return k(e.fieldDefinition.type)?(0,W.sortIfNotSorted)(s,((e,t)=>e-t)):e.fieldDefinition.id===a.CoreField.State&&e.fieldDefinition.workItemType&&e.fieldDefinition.workItemType.orderedStates&&e.fieldDefinition.workItemType.orderedStates.length>0?s=e.fieldDefinition.workItemType.orderedStates.filter((e=>-1!==s.indexOf(e))):(0,W.sortIfNotSorted)(s,n.localeComparer),s}function B(e){return e&&e.fieldDefinition&&e.fieldDefinition.isIdentity}function M(e){return 0==(2147479552&e.status)}t[e].resetField=function(e){e.status=0,e.allowedValues=void 0,e.lists=void 0},t[e].compareFieldValues=function e(t,i,s,a){if(t instanceof _.ServerDefaultValue)return i instanceof _.ServerDefaultValue&&t.type===i.type&&e(t.value,i.value,s);if(i instanceof _.ServerDefaultValue)return!1;null==(t=(0,o.convertPotentialIdentityRefFromFieldValueNotAsIdentityRef)(t))&&(t=""),null==(i=(0,o.convertPotentialIdentityRefFromFieldValueNotAsIdentityRef)(i))&&(i="");const r=""+t,l=""+i;let d=!1;if(d=s?0===(0,n.localeIgnoreCaseComparer)(r,l):0===(0,n.localeComparer)(r,l),!d&&a){const e=(0,o.parseUniquefiedIdentityName)(r),t=(0,o.parseUniquefiedIdentityName)(l);e&&t&&e.uniqueName&&t.uniqueName&&(d=0===(0,n.localeIgnoreCaseComparer)(e.uniqueName,t.uniqueName))}return d},t[e].convertFieldValueToExternal=function(e,t){return void 0===e&&(e=null),null===e&&c(t)?e="":t===a.FieldType.Boolean&&(e=!!e),e},t[e].convertFieldValueToInternal=u,t[e].tryNormalizeFieldValue=function(e,t,i){if(e&&"string"==typeof e&&p(t)){e=I(A(t,t.workItem,i).value,e)}return e},t[e].isValidStringFieldValue=h,t[e].isStringField=c,t[e].normalizeFieldValue=I,t[e].fieldHashset=m,t[e].getFieldErrorText=function(e,t){const i=f(e.status),s=e.error;switch(i){case D.FieldStatus.InvalidEmpty:return(0,n.format)(F.FieldStatusInvalidEmptyError,e.fieldDefinition.name);case D.FieldStatus.InvalidNotEmpty:return(0,n.format)(F.FieldStatusInvalidNotEmptyError,e.fieldDefinition.name);case D.FieldStatus.InvalidFormat:return(0,n.format)(F.FieldStatusInvalidFormatError,e.fieldDefinition.name);case D.FieldStatus.InvalidListValue:return(0,n.format)(F.FieldStatusInvalidListValueError,e.fieldDefinition.name,t);case D.FieldStatus.InvalidOldValue:return(0,n.format)(F.FieldStatusInvalidOldValueError,e.fieldDefinition.name);case D.FieldStatus.InvalidNotOldValue:return(0,n.format)(F.FieldStatusInvalidNotOldValueError,e.fieldDefinition.name);case D.FieldStatus.InvalidEmptyOrOldValue:return(0,n.format)(F.FieldStatusInvalidEmptyOrOldValueError,e.fieldDefinition.name);case D.FieldStatus.InvalidNotEmptyOrOldValue:return(0,n.format)(F.FieldStatusInvalidNotEmptyOrOldValueError,e.fieldDefinition.name);case D.FieldStatus.InvalidValueInOtherField:return(0,n.format)(F.FieldStatusInvalidValueInOtherFieldError,e.fieldDefinition.name);case D.FieldStatus.InvalidValueNotInOtherField:return(0,n.format)(F.FieldStatusInvalidValueNotInOtherFieldError,e.fieldDefinition.name);case D.FieldStatus.InvalidDate:return(0,n.format)(F.FieldStatusInvalidDateErrorError,e.fieldDefinition.name);case D.FieldStatus.InvalidTooLong:return(0,n.format)(F.FieldStatusInvalidTooLongError,e.fieldDefinition.name);case D.FieldStatus.InvalidType:return(0,n.format)(F.FieldStatusInvalidTypeError,e.fieldDefinition.name);case D.FieldStatus.InvalidComputedField:return(0,n.format)(F.FieldStatusInvalidComputedFieldError,e.fieldDefinition.name);case D.FieldStatus.InvalidPath:return(0,n.format)(F.FieldStatusInvalidPathError,e.fieldDefinition.name);case D.FieldStatus.InvalidCharacters:return(0,n.format)(F.FieldStatusInvalidCharactersError,e.fieldDefinition.name);case D.FieldStatus.InvalidIdentity:return s||(0,n.format)(F.FieldStatusInvalidListValueError,e.fieldDefinition.name,t);default:return(0,n.format)(F.FieldStatusInvalidUnknownError,e.fieldDefinition.name)}},t[e].getFieldStatus=f,t[e].isLongTextField=g,t[e].isUserChange=function(e,t){return!!t&&(!t.setByRule||0!=(512&e.status))},t[e].fieldHasList=p,t[e].isNumericField=k,t[e].isEmpty=v,t[e].inList=function(e,t,i,s,a){let r;if(i&&C(i,t,a))return!0;if(s)for(const i of s){if(r=e.getConstantSet(i),!r)throw new Error((0,n.format)("Constant set {0} is not ready. Operation cannot continue.",i));if(C(r,t,a))return!0}return!1},t[e].intersect=E,t[e].unionLists=y,t[e].contains=C,t[e].subtract=T,t[e].union=N,t[e].isMatch=function(e,t){return!e||(e="^"+(e=(e=e.replace(/[.*+?|()\[\]\^\${}\\]/g,"\\$&")).replace(/n/gi,"\\d").replace(/a/gi,"[a-zA-Z]").replace(/x/gi,"[a-zA-Z0-9]"))+"$",new RegExp(e,"i").test(t))},t[e].isHistoricalRevision=O,t[e].isEditable=V,t[e].isReadOnly=function(e){return!V(e)},t[e].isRequired=function e(t){let i=t.fieldDefinition.id;switch(i){case a.CoreField.IterationPath:i=a.CoreField.IterationId;break;case a.CoreField.AreaPath:i=a.CoreField.AreaId;break;default:return 0!=(1&t.status)}return e(t.workItem.getFieldById(i))},t[e].canSortBy=function(e){return 0!=(e.status&a.FieldFlags.Sortable)},t[e].isQueryable=function(e){return 0!=(e.status&a.FieldFlags.Queryable)},t[e].convertFieldValueToDisplayString=P,t[e].getAllowedFieldValues=A,t[e].computeAllowedFieldValues=b,t[e].setAllowedFieldValues=function(e,t){p(e)&&!B(e)&&(e.allowedValues?e.allowedValues.value=t:e.allowedValues=new r.ObservableArray(t))},t[e].isIdentityPickerSupportedForField=B,t[e].isFieldValid=M,t[e].validateIdentityFieldValue=function(e,t){const i=t.getFieldValueById(e.fieldDefinition.id),s=new S.FieldValidationKey(e.fieldDefinition.id,i,e.filterByScope);!B(e)||!M(e)||i instanceof _.ServerDefaultValue||t.beginValidate(e.fieldDefinition.id,s,(()=>{new S.FieldValidationKey(e.fieldDefinition.id,t.getFieldValueById(e.fieldDefinition.id),e.filterByScope).equals(s)&&(e.error="")}),((i,a)=>{let r=e;a&&(r=t.getFieldValueByName(a)),M(r)&&new S.FieldValidationKey(e.fieldDefinition.id,t.getFieldValueById(e.fieldDefinition.id),e.filterByScope).equals(s)&&(r.error=i.message,r.status=1073741824)}))},t[e].htmlDecode=function(e){var t;return null!==(t=(new DOMParser).parseFromString(e,"text/html").documentElement.innerText)&&void 0!==t?t:e}}("WorkItemFieldUtils"),function(e){N=t[e]={},function(e){e[e.Value=1]="Value",e[e.CurrentValue=2]="CurrentValue",e[e.OriginalValue=4]="OriginalValue",e[e.OtherFieldCurrentValue=8]="OtherFieldCurrentValue",e[e.OtherFieldOriginalValue=16]="OtherFieldOriginalValue",e[e.CurrentUser=32]="CurrentUser",e[e.Clock=64]="Clock"}(t[e].RuleValueFrom||(t[e].RuleValueFrom={}))}("RuleEngineRuleValueFrom"),function(e){O=t[e]={};class i extends T.FilterByScope{constructor(e,t,i,s,a){super(e,t),this.nonIdentities=i||[],this.displayNames=s||[],this.excludeGroups=a||!1}static equals(e,t){if(null==e&&null==t)return!0;if(T.FilterByScope.GetHashCode(e)!==T.FilterByScope.GetHashCode(t))return!1;if((null==e.nonIdentities?0:e.nonIdentities.length)!=(null==t.nonIdentities?0:t.nonIdentities.length))return!1;const i=null==e.nonIdentities?"":e.nonIdentities.sort().join(","),s=null==t.nonIdentities?"":t.nonIdentities.sort().join(",");return 0===(0,n.localeIgnoreCaseComparer)(i,s)}}t[e].WorkItemIdentityScope=i}("RuleEngineWorkItemIdentityScope"),function(e){V=t[e]={},t[e].stateFieldID=2;class i{constructor(e,t,i,s,a,r,n,o){this.executionPhase=D.RuleEvaluatorExecutionPhase.DefaultRules,this.userChange=!1,this.valueLocked=!1,this.setByRule=!1,this.valueChanged=!1,this.setByDefaultRule=!1,this.setByComputedRule=!1,this.readOnly=!1,this.empty=!1,this.required=!1,this.frozen=!1,this.cannotLoseValue=!1,this.otherFields={},this.allowExistingValue=!1,this.validUser=!1,this.serverDefault=!1,this.isIdentityField=!1,this.whenCount=0,this.fieldId=e,this.workItem=t,this.field=i,this.value=s,this.originalValue=a,this.valueLocked=r,this.userChange=r,this.evalState=n,this.isIdentityField=i.fieldDefinition.isIdentity,this.useOptionalDotRegex=o}static compareLists(e,t){let i,s;if(e!==t){if(!e||!t)return!1;if(i=e.length,i!==t.length)return!1;for(s=0;s<i;s++){if(e[s].items!==t[s].items)return!1;if(e[s].globals!==t[s].globals)return!1}}return!0}static compareFieldLists(e,t){if(e!==t){if(!e||!t)return!1;if(e.allowExistingValue!==t.allowExistingValue)return!1;if(!i.compareLists(e.allowedValues,t.allowedValues))return!1;if(!i.compareLists(e.suggestedValues,t.suggestedValues))return!1;if(!i.compareLists(e.prohibitedValues,t.prohibitedValues))return!1}return!0}evaluate(e){try{e&&(this.setExecutionPhase(D.RuleEvaluatorExecutionPhase.CopyRules),this.Block(e),this.setExecutionPhase(D.RuleEvaluatorExecutionPhase.DefaultRules),this.Block(e),this.setExecutionPhase(D.RuleEvaluatorExecutionPhase.OtherRules),this.Block(e)),this.validate()}catch(t){const i=`Error occured in Rule Engine Evaluate. Name: ${t.Name} Message: ${t.message} Rules.length: ${e.length} Rules.Information: ${e.toString()} Stack: ${t.stack}`,s=new Error(i);console.error(s)}}setExecutionPhase(e){this.executionPhase=e}Block(e){var t;let i=0;const s=e.length;for(;i<s;){const s=e[i++],a=e[i++]||[];null===(t=this[s])||void 0===t||t.apply(this,a)}}ScopedIdentity(e,t,i,s,a){this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules&&(this.whenCount>0||!this.filterByScope)&&(this.filterByScope=new O.WorkItemIdentityScope(i,t,e,s,a))}BlockWhenChangedProhibitedValuesOnly(e,t){let i=0;const s=t.length;for(;i<s;){const s=t[i++],a=t[i++]||[];if("ProhibitedValues"===s&&a[0]&&a[0]instanceof Array){const t=a[0].filter((t=>t!==e));this.ProhibitedValues(t,a[1])}}}When(e,t,i,s,a){i=this._getValueFrom(s,i);const r=this._isIdentityField(t),n=s==N.RuleValueFrom.Value&&r;(this._areValuesEqual(t,this._getFieldValue(t,!1),i,!0,n)?!e:e)&&(this.whenCount++,this.Block(a),this.whenCount--)}WhenWas(e,t,i,s,a){i=this._getValueFrom(s,i);const r=this._isIdentityField(t),n=s==N.RuleValueFrom.Value&&r;(this._areValuesEqual(t,this._getFieldValue(t,!0),i,!0,n)?!e:e)&&(this.whenCount++,this.Block(a),this.whenCount--)}WhenChanged(i,s,a){const r=this._areValuesEqual(s,this._getFieldValue(s,!1),this._getFieldValue(s,!0),!0);(r?i:!i)?(this.whenCount++,this.Block(a),this.whenCount--):s==t[e].stateFieldID&&r&&!i&&(this.whenCount++,this.BlockWhenChangedProhibitedValuesOnly(this._getFieldValue(s,!0),a),this.whenCount--)}WhenBecameNonEmpty(e,t,i){(this._areValuesEqual(t,this._getFieldValue(t,!0),null,!0)&&!this._areValuesEqual(t,this._getFieldValue(t,!1),null,!0)?!e:e)&&(this.whenCount++,this.Block(i),this.whenCount--)}WhenRemainedNonEmpty(e,t,i){(this._areValuesEqual(t,this._getFieldValue(t,!0),null,!0)||this._areValuesEqual(t,this._getFieldValue(t,!1),null,!0)?e:!e)&&(this.whenCount++,this.Block(i),this.whenCount--)}OtherField(e,t,i){if(this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules){const s=this._getFieldValue(e,i);this.otherFields[e]=s,this.otherFieldCheck=t,"same-as"===t&&!this.userChange&&i&&(this.value=s,this.setByRule=!0,this.valueChanged=!0)}}Map(e,t,i,s){if(this.executionPhase===D.RuleEvaluatorExecutionPhase.CopyRules){const a=this._getFieldValue(e,!1);let r;if(t){const t=this.evalState[e+""],s=t&&void 0!==t.prevValue?t.prevValue:this._getFieldValue(e,!1);if(!this._areValuesEqual(e,this._getFieldValue(e,!1),s,!0)&&!this.userChange){let t;if(null!=i)for(const s of i){if(s.values)for(const i of s.values)if(this._areValuesEqual(e,a,i,!0)){t=s.case;break}if(t)break}void 0===t||this._areValuesEqual(e,t,this.value,!0)||(this.value=t,this.valueLocked=!0,this.setByRule=!0,this.valueChanged=!0)}}else{if(!this.userChange){if(null!=i)for(const t of i)if(this._areValuesEqual(e,a,t.case,!0)){r=t;break}if(r||(r=s),r){let t=!1;if(r.values)for(const i of r.values)if(this._areValuesEqual(e,i,this.value,!0)){t=!0;break}t||(r.default?r.values instanceof Array&&r.values.includes(this.originalValue)?(this.value=this.originalValue,this.valueLocked=!0,this.setByRule=!0,this.valueChanged=!0):this._areValuesEqual(e,r.default,this.value,!0)||(this.value=r.default,this.valueLocked=!0,this.setByRule=!0,this.valueChanged=!0):(this.value=r.values&&r.values[0],this.valueLocked=!0,this.setByRule=!0,this.valueChanged=!0))}}this.allowedValues||(this.allowedValues=[]);let t=[];if(null!=i)for(const s of this._getAllowedValues(e)){let a;for(const t of i)if(this._areValuesEqual(e,s,t.case,!0)){a=t;break}a&&(t=(0,L.union)(t,a.values,!0))}s&&(t=(0,L.union)(t,s.values,!0)),this.allowedValues.push({items:t})}}}AllowExistingValue(){this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules&&(this.allowExistingValue=!0)}ReadOnly(){this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules&&(this.readOnly=!0,this.userChange||(this.value=this.originalValue,this.setByRule=!0,this.valueChanged=!0))}Empty(){this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules&&(this.empty=!0,this.userChange||(this.value=void 0,this.setByRule=!0,this.valueChanged=!0))}Required(){this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules&&(this.required=!0)}Frozen(){this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules&&(this.frozen=!0,!this.userChange&&this.originalValue&&(this.value=this.originalValue,this.setByRule=!0,this.valueChanged=!0))}CannotLoseValue(){this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules&&(this.cannotLoseValue=!0)}ValidUser(){this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules&&(this.validUser=!0)}Copy(e,t){this.executionPhase===D.RuleEvaluatorExecutionPhase.CopyRules&&(this.valueLocked||(this.value=this._getValueFrom(e,t),this.valueLocked=!0,this.setByRule=!0,this.valueChanged=!0))}Default(e,t){this.executionPhase===D.RuleEvaluatorExecutionPhase.DefaultRules&&(this.valueLocked||(0,L.isEmpty)(this.value)&&(this.value=this._getValueFrom(e,t),this.valueLocked=!0,this.setByRule=!0,this.setByDefaultRule=!0,this.valueChanged=!0))}AllowedValues(e,t){this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules&&(this.allowedValues||(this.allowedValues=[]),e&&(0,W.flagSorted)(e,n.localeIgnoreCaseComparer),this.allowedValues.push({items:e,globals:t}))}SuggestedValues(e,t){this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules&&(this.suggestedValues||(this.suggestedValues=[]),e&&(0,W.flagSorted)(e,n.localeIgnoreCaseComparer),this.suggestedValues.push({items:e,globals:t}))}ProhibitedValues(e,t){this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules&&(this.prohibitedValues||(this.prohibitedValues=[]),e&&(0,W.flagSorted)(e,n.localeIgnoreCaseComparer),this.prohibitedValues.push({items:e,globals:t}))}Match(e,t){this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules&&(this.patterns||(this.patterns=[]),e&&(0,W.flagSorted)(e,n.localeIgnoreCaseComparer),this.patterns.push({items:e,globals:t}))}ServerDefault(e){this.executionPhase===D.RuleEvaluatorExecutionPhase.CopyRules&&(this.value=new _.ServerDefaultValue(e,this.originalValue),this.serverDefault=!0,this.valueLocked=!0,this.setByRule=!0,this.setByDefaultRule=!0,this.valueChanged=!0)}Computed(e){if(this.executionPhase===D.RuleEvaluatorExecutionPhase.DefaultRules&&!this.valueLocked){const t=this.workItem.computeFieldValue(this.field.fieldDefinition.id,e);t&&t.success&&(this.value=t.value,this.valueLocked=!0,this.setByRule=!0,this.setByComputedRule=!0,this.valueChanged=!0)}}Trigger(e){this.executionPhase===D.RuleEvaluatorExecutionPhase.OtherRules&&e&&(this.triggerFields||(this.triggerFieldMap={},this.triggerFields=[]),e.forEach(((e,t)=>{const i=e+"";this.triggerFieldMap.hasOwnProperty(i)||(this.triggerFieldMap[i]=!0,this.triggerFields.push(e))})))}validate(){let e;const t=this.field;this.originalFieldStatus=t.status,t.status=0;const s=t.workItem.store,r=(0,L.convertFieldValueToInternal)(this.originalValue,t.fieldDefinition.type,this.useOptionalDotRegex),n=(0,L.convertFieldValueToInternal)(this.value,t.fieldDefinition.type,this.useOptionalDotRegex);e=n.value,t.status|=n.status,this.setByRule&&(this.workItem.setFieldValueById(t.fieldDefinition.id,e,{setByRule:!0}),t.status|=128),this.setByDefaultRule&&(t.status|=256),this.setByComputedRule&&(t.status|=512),(this.readOnly||this.serverDefault||this.empty)&&(t.status|=2),this.cannotLoseValue&&((0,L.isEmpty)(this.originalValue)||(this.required=!0)),this.required&&(t.status|=1);const o={};o.allowedValues=this.allowedValues,this.allowedValues&&this.allowedValues.length>0&&(t.status|=4,t.status|=8),o.suggestedValues=this.suggestedValues,this.suggestedValues&&this.suggestedValues.length>0&&(t.status|=4,t.status&=-9),o.prohibitedValues=this.prohibitedValues,o.allowExistingValue=this.allowExistingValue,i.compareFieldLists(t.lists,o)||(t.lists=o,t.allowedValues=void 0),this.allowExistingValue&&(t.status|=64);let l=[];if(this.patterns&&this.patterns.length>0){l=(0,L.unionLists)(s,this.patterns[0].items,this.patterns[0].globals);for(const e of this.patterns)l=(0,L.intersect)(l,(0,L.unionLists)(s,e.items,e.globals),!0)}if(t.fieldDefinition.isIdentity&&(t.filterByScope=this.filterByScope),t.patterns=l,l.length>0&&(t.status|=16),(0,L.isEmpty)(e)){if(!this.empty){if((0,L.isRequired)(t))return t.status|=1,void(t.status|=524288);if(void 0!==this.otherFieldCheck)for(const e in this.otherFields)if((0,L.isEmpty)(this.otherFields[e])){if("not-same-as"===this.otherFieldCheck)return t.status|=1,void(t.status|=268435456)}else if("same-as"===this.otherFieldCheck)return t.status|=1,void(t.status|=134217728)}}else{if(this.empty)return t.status&=-3,void(t.status|=1048576);if(!this.readOnly||this.serverDefault||this.setByDefaultRule||this._areValuesEqual(t.fieldDefinition.id,e,r.value)){if(void 0!==this.otherFieldCheck)for(const i in this.otherFields)if(this._areValuesEqual(t.fieldDefinition.id,e,this.otherFields[i])){if("not-same-as"===this.otherFieldCheck)return void(t.status|=134217728)}else if("same-as"===this.otherFieldCheck)return void(t.status|=268435456);if(!this.frozen||(0,L.isEmpty)(r.value)||this._areValuesEqual(t.fieldDefinition.id,e,r.value)){if(t.fieldDefinition.type===a.FieldType.TreePath&&!this.workItem.isChangeProjectInProgress()){if(!this.workItem.project.getNode(e,t.fieldDefinition.id===a.CoreField.AreaPath?0:1))throw new Error("Node not found:"+e)}if(!(this.serverDefault||e instanceof _.ServerDefaultValue)){const i=null==e?"":""+e;if(t.patterns.length>0){let e=!1;for(const s of t.patterns)if((0,L.isMatch)(s,i)){e=!0;break}if(!e)return void(t.status|=2097152)}if(o.prohibitedValues)for(const e of o.prohibitedValues)if((0,L.inList)(s,i,e.items,e.globals,!0))return void(t.status|=4194304);if(this.allowExistingValue&&!(0,L.isEmpty)(r.value)&&this._areValuesEqual(t.fieldDefinition.id,e,r.value))return;if(o.allowedValues)for(const e of o.allowedValues)if(!(0,L.inList)(s,i,e.items,e.globals,!0))return void(t.status|=4194304)}}else t.status|=67108864}else t.status|=16777216}}_isIdentityField(e){const t=this.workItem.getFieldById(e);return t&&t.fieldDefinition.isIdentity}_getFieldValue(e,t){return e===this.fieldId?t?this.originalValue:this.value:this.workItem.getFieldValueById(e,t)}_getValueFrom(e,t){switch(e){case N.RuleValueFrom.Clock:return new Date;case N.RuleValueFrom.CurrentUser:return this.workItem.store.getCurrentUserName();case N.RuleValueFrom.OtherFieldOriginalValue:return this._getFieldValue(t,!0);case N.RuleValueFrom.OtherFieldCurrentValue:return this._getFieldValue(t,!1);case N.RuleValueFrom.Value:return t;case N.RuleValueFrom.CurrentValue:return this.value;case N.RuleValueFrom.OriginalValue:return this.originalValue;default:return t}}_areValuesEqual(e,t,i,s,r){return this.workItem.fieldMapById[e]&&this.workItem.fieldMapById[e].fieldDefinition.type==a.FieldType.Boolean&&(t=this._translateToBoolData(t),i=this._translateToBoolData(i)),(0,L.compareFieldValues)(t,i,s,r)}_translateToBoolData(e){return!e||1!=e&&"true"!==String(e).toLowerCase()?0:1}_getAllowedValues(e){const t=this.workItem.getFieldById(e);return t?(0,L.getAllowedFieldValues)(t,this.workItem,this.useOptionalDotRegex).value:[]}}t[e].RuleEvaluator=i}("RuleEngineRuleEvaluator"),function(e){P=t[e]={};t[e].RuleEngine=class{constructor(e,t,i){var s;if(this.workItem=e,this.fieldRules={},this.useOptionalDotRegex=i,t)for(const e of t){this.fieldRules[e.fieldId]=null!==(s=this.fieldRules[e.fieldId])&&void 0!==s?s:[];const t=this.fieldRules[e.fieldId];t.push("Block"),t.push([e.rules])}}evaluateFields(e){const t={};for(const i of e)this._evaluateFieldRule(i,t,!1);return this._evalStateToChangedFields(t)}evaluateField(e,t,i){const s={};return this._evaluateFieldRule(e,s,t,i),this._evalStateToChangedFields(s)}_evalStateToChangedFields(e){const t=[];for(const[i,s]of Object.entries(e))s.requiresControlUpdate&&t.push(parseInt(i));return t}_evaluateFieldRule(e,t,i,s){const a=this.workItem.getFieldById(e);if(!a)return;const r=this.workItem.getFieldValueById(e),n=a.lists,o=a.status;let l=!1;t[e]&&t[e].requiresControlUpdate&&(l=!0),t[e]={state:!0,prevValue:void 0===s?r:s,requiresControlUpdate:l};const d=new V.RuleEvaluator(e,this.workItem,a,r,this.workItem.getFieldValueById(e,!0),i||!1,t,this.useOptionalDotRegex);let u;d.evaluate(this.fieldRules[e]),u=!!i||(!(0,L.compareFieldValues)(r,this.workItem.getFieldValueById(e))||!V.RuleEvaluator.compareFieldLists(n,a.lists)||0!=(o^a.status)),u&&(t[e].requiresControlUpdate=!0),u&&d.triggerFields&&d.triggerFields.forEach(((e,i)=>{const s=t[e];s&&s.state||this._evaluateFieldRule(e,t,!1)})),t[e].state=!1}}}("RuleEngineRuleEngine"),function(e){A=t[e]={};t[e].WorkItemStore=class{constructor(e,t){this._pageContext=e,this.constantSets=t}getCurrentUserName(){return this.getCurrentUser().distinctDisplayName}getCurrentUser(){const e=this._pageContext.getService("IVssPageService").getData().user,t=e.displayName,i=e.uniqueName;return{distinctDisplayName:(0,o.getDistinctDisplayName)(t,i),identityRef:{id:e.id,displayName:t,uniqueName:i}}}getConstantSet(e){return e in this.constantSets?this.constantSets[e]:(console.error("Could not find set ID:"+e),[])}}}("RuleEngineWorkItemStore"),function(e){b=t[e]={},function(e){e.WorkItemErrorUpdated="WorkItemErrorUpdated",e.WorkItemReset="WorkItemReset",e.WorkItemSaved="WorkItemSaved",e.WorkItemUpdated="WorkItemUpdated",e.WorkItemCommentsUpdated="WorkItemCommentsUpdated"}(t[e].IWorkItemEventType||(t[e].IWorkItemEventType={}));class i extends l.VssObservableService{fireEvent(e,t){this._notify(e,t)}}l.Services.add("IWorkItemEventService",{serviceFactory:i})}("ServicesIWorkItemEventService"),function(e){B=t[e]={},function(e){e.WorkItemFieldsUpdated="WorkItemFieldsUpdated"}(t[e].IWorkItemFieldEventType||(t[e].IWorkItemFieldEventType={}));class i extends l.VssObservableService{fireEvent(e,t){this._notify(e,t)}}l.Services.add("IWorkItemFieldEventService",{serviceFactory:i})}("ServicesIWorkItemFieldEventService"),t.ServicesIWorkItemModelService={},function(e){M=t[e]={};class s{constructor(e){this.linkData=e,this.pendingUpdate=!1,this.pendingDeletion=!1,this.baseLinkType="Link",this.remoteHostId=this.linkData.RemoteHostId}static createFromLinkData(e){(e=e||{}).FldID||(e.FldID=a.DalFields.RelatedLinks);switch(e.FldID){case a.DalFields.AttachedFiles:return new d(e);case a.DalFields.LinkedFiles:return new l(e);case a.DalFields.BISURI:return new o(e);case a.DalFields.RelatedLinks:return new r(e);default:return new s(e)}}static getCountFieldId(e){let t;switch(e){case a.DalFields.AttachedFiles:t=a.CoreField.AttachedFileCount;break;case a.DalFields.RelatedLinks:t=a.CoreField.RelatedLinkCount;break;case a.DalFields.LinkedFiles:t=a.CoreField.HyperLinkCount;break;case a.DalFields.BISURI:t=a.CoreField.ExternalLinkCount;break;default:t=0}return t}setState(e){e?(this.comment=this.getComment(),this.isLocked=this.getIsLocked(),this.pendingUpdate=!1,this.linkData.CommentChanged=!1,this.linkData.LockChanged=!1):this.pendingUpdate=this.linkData.CommentChanged||this.linkData.LockChanged||!1}equals(e){return!!e&&this.baseLinkType===e.baseLinkType}isDuplicate(e){return this.equals(e)}isNew(){const e=this.getAddedDate();return!e||e.getTime()===i.FutureDate.getTime()}isRemoved(){const e=this.getRemovedDate();return(0,R.isRemoved)(e)}isRemote(){return!1}getAddedDate(){return this.linkData.AddedDate}getRemovedDate(){return this.linkData.RemovedDate}getFieldId(){return this.linkData.FldID||-1}getComment(){return this.linkData.Comment}setComment(e,t){this.linkData.Comment=e,this.linkData.CommentChanged=!0,this.setState()}getIsLocked(){return this.linkData.Lock||!1}remove(e){e&&e.preventEvent;this.pendingDeletion=!0}async getRelationType(e){switch(this.linkData.FldID){case a.DalFields.BISURI:return a.WorkItemLinkConstants.ARTIFACTLINKTYPE;case a.DalFields.AttachedFiles:return a.WorkItemLinkConstants.ATTACHEDLINKTYPE;case a.DalFields.LinkedFiles:return a.WorkItemLinkConstants.HYPERLINKLINKTYPE;default:return this instanceof r?(await this.getWitLinkTypeEnd(e)).immutableName:D.RegisteredLinkTypeNames.Related}}getLinkType(){var e;return null!==(e=this.linkData.OriginalName)&&void 0!==e?e:D.RegisteredLinkTypeNames.Related}getWitLinkTypeEndId(){var e;return null!==(e=this.linkData.LinkType)&&void 0!==e?e:void 0}async clone(e,t){}getAttributes(){const e={isDeleted:this.pendingDeletion,isNew:this.isNew()};return this._isResourceLinkType(this.linkData.FldID||0)?(e[a.WorkItemLinkConstants.ATTRIBUTES_AUTHORIZEDDATE]=this.linkData.AddedDate,e[a.WorkItemLinkConstants.ATTRIBUTES_ID]=this.linkData.ExtID,e[a.WorkItemLinkConstants.ATTRIBUTES_RESOURCECREATEDDATE]=this.linkData.CreationDate,e[a.WorkItemLinkConstants.ATTRIBUTES_RESOURCEMODIFIEDDATE]=this.linkData.LastWriteDate,e[a.WorkItemLinkConstants.ATTRIBUTES_REVISEDDATE]=this.linkData.RemovedDate,this.linkData.Length&&this.linkData.Length>0&&(e[a.WorkItemLinkConstants.ATTRIBUTES_RESOURCESIZE]=this.linkData.Length),this.linkData.Comment&&(e[a.WorkItemLinkConstants.ATTRIBUTES_COMMENT]=this.linkData.Comment),this.linkData.OriginalName&&(e[a.WorkItemLinkConstants.ATTRIBUTES_NAME]=this.linkData.OriginalName),e):this.linkData.FldID===a.DalFields.RelatedLinks?(e[a.WorkItemLinkConstants.ATTRIBUTES_ISLOCKED]=this.linkData.Lock,this.linkData.Comment&&(e[a.WorkItemLinkConstants.ATTRIBUTES_COMMENT]=this.linkData.Comment),e):{}}async getLinkUrl(e,t){return this._isResourceLinkType(this.linkData.FldID||0)?this.linkData.FilePath||"":this.remoteHostId?this._getRemoteWorkItemRestUrl(this.remoteHostUrl||"",this.remoteProjectId||"",this.linkData.ID||0):await(0,R.getWorkItemUrl)(e,t,this.linkData.ID||0)}_isResourceLinkType(e){switch(e){case a.DalFields.BISURI:case a.DalFields.AttachedFiles:case a.DalFields.LinkedFiles:return!0;default:return!1}}_getRemoteWorkItemRestUrl(e,t,i){return`${e}/${t}/_apis/wit/workItems/${i}`}}t[e].Link=s;class r extends s{constructor(e){super(e),this.baseLinkType="WorkItemLink"}static async create(e,t,i,s,a,n){let o;if("object"==typeof t)o=t.id;else{o=(await r.findLinkTypeEnd(e,t)).id}return r.createSync(o,i,s,a,n)}static createSync(e,t,i,s,n){return new r({ID:t,LinkType:e,Comment:i||"",FldID:a.DalFields.RelatedLinks,isAddedBySystem:s,RemoteHostUrl:n&&n.remoteHostUrl,RemoteProjectId:n&&n.remoteProjectId,RemoteHostId:n&&n.remoteHostId,RemoteHostName:n&&n.remoteHostName})}static async findLinkTypeEnd(e,t){const i=(""+t).toUpperCase(),s=await this.getLinkTypeEnds(e);for(const e of s){if(e.id===t)return e;if(e.name.toUpperCase()===i)return e;if(e.immutableName.toUpperCase()===i)return e}throw Error((0,n.format)(F.WorkItemLinkTypeEndDoesNotExist,t))}static async getLinkTypes(e){const t=e.getService("IWorkItemDataManager"),i=await t.beginGetLinkTypes();if(!i)throw Error();return this._bindLinkTypeEnds(i.witLinkTypes),i.witLinkTypes}static async getLinkTypeEnds(e){let t=this.linkTypeEnds;if(t)return t;const i=await r.getLinkTypes(e);t=[];for(const e of i)t.push(e.forwardEnd),e.isDirectional&&t.push(e.reverseEnd);return this.linkTypeEnds=t,t}static _bindLinkTypeEnds(e){let t;for(const i of e)t=i.forwardEnd,t&&(t.linkType=i,t.oppositeEnd=i.reverseEnd),t=i.reverseEnd,t&&(t.linkType=i,t.oppositeEnd=i.forwardEnd)}equals(e){return super.equals(e)&&e instanceof r&&e.linkData.ID===this.linkData.ID&&e.linkData.LinkType===this.linkData.LinkType}isRemote(){return!!this.remoteHostId}getAddedDate(){return this.linkData["Changed Date"]}getRemovedDate(){return this.linkData["Revised Date"]}getTargetId(){return this.linkData.ID||-1}getLinkType(){return D.RegisteredLinkTypeNames.Related}async getWitLinkTypeEnd(e){return this._linkTypeEnd||(this._linkTypeEnd=await r.findLinkTypeEnd(e,this.linkData.LinkType)),this._linkTypeEnd}async clone(e,t){const i=await this.getWitLinkTypeEnd(e),s=i.linkType;if(s&&s.isActive&&"Unknown"!==s.topology&&(!s.isOneToMany||!i.isForwardLink)){const t={remoteHostId:this.remoteHostId,remoteHostName:this.remoteHostName,remoteHostUrl:this.remoteHostUrl,remoteProjectId:this.remoteProjectId};return r.create(e,i,this.getTargetId(),this.getComment(),!1,t)}}}t[e].WorkItemLink=r;class o extends s{static create(e,t,s){return new o({OriginalName:e,FilePath:t,Comment:s||"",FldID:a.DalFields.BISURI,AddedDate:i.FutureDate,RemovedDate:i.FutureDate})}constructor(e){super(e),this.baseLinkType="ExternalLink"}equals(e){return super.equals(e)&&e instanceof o&&e.linkData.OriginalName===this.linkData.OriginalName&&e.linkData.FilePath===this.linkData.FilePath}getArtifactLinkType(){return this.linkData.OriginalName}getLinkedArtifactUri(){return this.linkData.FilePath}async clone(e,t){return o.create(this.getArtifactLinkType(),this.getLinkedArtifactUri(),this.getComment())}}t[e].ExternalLink=o;class l extends s{static create(e,t){return new l({OriginalName:"",FilePath:e,Comment:t||"",FldID:a.DalFields.LinkedFiles,AddedDate:i.FutureDate,RemovedDate:i.FutureDate})}equals(e){return super.equals(e)&&e instanceof l&&e.linkData.FilePath===this.linkData.FilePath}async clone(e,t){const s=new Date;return new l(Object.assign(Object.assign({},this.linkData),{CreationDate:s,LastWriteDate:s,AddedDate:i.FutureDate,RemovedDate:i.FutureDate}))}getLinkType(){return this.linkData.OriginalName||D.RegisteredLinkTypeNames.Hyperlink}}t[e].Hyperlink=l;class d extends s{static create(e,t,s,r){const n=new Date;return new d({OriginalName:e,FilePath:t,Comment:r||"",ExtID:0,FldID:a.DalFields.AttachedFiles,Length:s,CreationDate:n,LastWriteDate:n,AddedDate:i.FutureDate,RemovedDate:i.FutureDate})}constructor(e){super(e),this.baseLinkType="Attachment"}equals(e){return super.equals(e)&&e instanceof d&&e.linkData.FilePath===this.linkData.FilePath}async clone(e,t){return d.create(this.linkData.OriginalName,this.linkData.FilePath,this.linkData.Length,this.linkData.Comment)}}t[e].Attachment=d}("WorkItemLinks"),function(e){t.ServicesWorkItemSavingService={};class i extends l.VssService{_serviceStart(e){this.witDataManager=e.getService("IWorkItemDataManager"),this.pageContext=e}saveWorkItemsBatchAsync(e,t,i){return new Promise(((s,a)=>{this.beginSaveWorkItemsBatch(e,(e=>s(e)),(e=>a(e)),t,i)}))}beginSaveWorkItemsBatch(e,t,i,s,a){const r=this,n=[],o=[],l={},d=[];let u=!1;const h={},c={};e.forEach((e=>{e.isValid()?n.push(e):(u=!0,d.push({workItem:e,error:{name:D.Exceptions.WorkItemSaveFailedDueToInvalidStatusException,message:e.infoText.value.text,workItem:e}}))})),n.length>0&&o.push(n);const I=()=>{if(o.length>0){let t=o.pop()||[];if(t.length>D.PageSizes.SAVE&&(o.push(t.slice(D.PageSizes.SAVE)),t=t.slice(0,D.PageSizes.SAVE)),t.length>D.PageSizes.SAVE)throw new Error("Too many work items for batch save.");r._beginSaveWorkItemsInternal(t,c,l,(()=>{t.forEach((e=>{d.push({workItem:e})})),window.setTimeout((()=>{I()}),0)}),(s=>{let a=0,n=!1,c=!1;const m=e=>{if(0===a){if(1===t.length&&e)o.push(t);else if(t.length>1){const e=t.length/2;o.push(t.slice(e)),o.push(t.slice(0,e))}else s.results&&d.push(s.results[0]);window.setTimeout((()=>{I()}),0)}},f=(e,t)=>{a-=1,t=Object.assign(Object.assign({},t),l[e.id]),m(!0)},g=()=>{a-=1,u=!0,m(!1)};if(s&&s.name===D.Exceptions.WorkItemBulkSaveException){const e=s.results;if(e)for(const t of e){const e=t.workItem;!t.error||t.error.errorCode!==D.ErrorCodes.WorkItemMissingOrUpdated&&t.error.errorCode!==D.ErrorCodes.ResourceLinkNotFoundException||h.hasOwnProperty(e.id.toString())?c=!0:(n=!0,h[e.id]=!0,a+=1,r._beginTryMergeWorkItem(e,f,g))}!n&&c&&(u=!0),m(!1)}else e.forEach((e=>{e.setError(s)})),null==i||i.call(r,s)}),!1,s,a)}else if(u)d.forEach((e=>{e.error&&e.workItem.setError(e.error)})),null==i||i.call(this,this._createWorkItemBulkSaveFailedException(d));else if("function"==typeof t){const i={workItems:e};t.call(r,i)}};I()}beginGetWorkItemData(e,t,i,s,a,r){let n;if(0===e.length&&(n=new Error("Resources.BeginGetWorkItemArgumentNull")),e)for(let t=0,i=e.length;t<i;++t){if(e[t]=+e[t],void 0===e[t]){n=new Error("Resources.WorkItemIdUndefined");break}if(isNaN(e[t])){n=new Error("Resources.WorkItemIdNaN");break}if(e[t]<=0){n=new Error("Resources.WorkItemIdOutOfRange");break}}if(n)return void(n.name="ArgumentException");this.witDataManager.beginGetWorkItemData(e,s,!r,a).then((e=>{e&&1===e.length?t.call(this,e[0]):t.call(this,e)}),i)}async saveWorkItemLinksAsync(e,t,i){const s=[];let a;const r=[],n=[];let o=[];const l=[],u={},h={},c={addedLinks:[]};for(const i of t)s.push({command:"add",sourceId:e.id,targetId:i.getTargetId(),linkData:i.linkData}),c.addedLinks.push(i.linkData);const I=()=>{if(o&&o.length===l.length){for(const e of o)for(const t of e.getLinks())t.setState(!0);m()}},m=()=>{try{return a&&(a=this._createWorkItemBulkSaveFailedException(l),console.warn(this,a)),l}catch(e){throw e}},f=e.getEmptyUpdateData();f.payload&&(f.payload.links=c);const g={changedWorkItemLinks:s};if(f&&f.payload){n.push(f),r.push(f.payload);h[e.id>0?e.id:e.tempId]=g,o.push(e)}try{const e={controller:"wit",action:"updateWorkItems"},t={updatePackage:JSON.stringify(r)};try{const s=(await new d.WorkItemStoreLevelWITDataSource(this.pageContext).getDataWithoutCache(e,t)).data;if(s.length===o.length){let e=!1;for(const t of s)if(t.state!==D.WorkItemUpdateResultState.Success){e=!0;break}for(let t=0;t<o.length;t++){const a=o[t],r=s[t];r.state!==D.WorkItemUpdateResultState.Success||e?r.state!==D.WorkItemUpdateResultState.Success?r.error&&a.setError(r.error):l.push({workItem:a}):(await a.takeUpdateResult(this.pageContext,r,n[t],{ignoreFieldUpdates:!0,fieldsToClear:i}),l.push({workItem:a}),u[a.tempId]=a.id),I()}}else o.forEach((e=>{e.setError({name:"SyncError",message:"Server data does not match with what client sent."})})),m()}catch(a){o.forEach((e=>{e.setError(a)})),m()}}catch(e){throw e}return l}async _beginSaveWorkItemsInternal(e,t,i,s,r,n=!0,o,l){let u,h;const c=[],I={},m=(e,t)=>{for(const s of e){const e=I[s.id]?I[s.id]:I[s.tempId];e&&i[s.id]&&Object.assign(e.changedFields,i[s.id]),s.saving.value=t}},f=()=>{try{if(h)h=this._createWorkItemBulkSaveFailedException(c),null==r||r.call(this,h);else{const t={workItems:e};s.call(this,t)}}finally{m(u,!1)}},g=(e,t)=>{let i;"string"==typeof t?i=t:t&&"object"==typeof t&&"message"in t&&"string"==typeof t.message&&(i=t.message),h=new Error(i),n&&e.setError(h),c.push({workItem:e,error:t})},p=()=>{if(u&&u.length===c.length){for(const e of u)for(const t of e.getLinks())t.setState(!0);f()}},k=(e,t)=>{const i={};for(const s in t)if(t.hasOwnProperty(s)){const t=Number(s),r=e.fieldMapById[t];r&&(i[r.fieldDefinition.referenceName]=r,t===a.CoreField.IterationId?i[a.CoreFieldRefNames.IterationPath]=e.fieldMapById[a.CoreField.IterationPath]:t===a.CoreField.AreaId&&(i[a.CoreFieldRefNames.AreaPath]=e.fieldMapById[a.CoreField.AreaPath]))}return i},v=(e,i)=>{var s,r;const n=[];if(i.deletedLinks)for(const t of i.deletedLinks)t instanceof M.WorkItemLink&&n.push({command:"remove",sourceId:e.id,targetId:t.getTargetId(),linkData:t.linkData});if(i.addedLinks)for(const s of i.addedLinks)s instanceof M.WorkItemLink&&(t.hasOwnProperty(s.getTargetId())&&(s.linkData.ID=t[s.getTargetId()]),n.push({command:"add",sourceId:e.id,targetId:s.getTargetId(),linkData:s.linkData}));let o=!1;(null===(s=i.payload)||void 0===s?void 0:s.fields)&&(o=!!i.payload.fields[a.DalFields.AreaPathId]);return{typeChanged:null!==(r=e.hasWorkItemTypeChanged())&&void 0!==r?r:o,projectChanged:e.hasTeamProjectChanged(),changedFields:i.payload&&i.payload.fields?k(e,i.payload.fields):{},changedWorkItemLinks:n,firstSave:0==e.id}};if(e&&e.length>0){const i=[],s=[];u=[];let a=!1;for(let t=0;t<e.length;t++){const r=e[t];try{await r.waitForPromisesResolving()}catch(e){g(r,e),a=!0}if(r.dirty.value){const e=r.getUpdateData();if(e&&e.payload){s.push(e),i.push(e.payload);const t=r.id>0?r.id:r.tempId;I[t]=v(r,e),u.push(r)}}}if(u.length>0&&!a){m(u,!0);try{const e={controller:"wit",action:"updateWorkItems"},a={updatePackage:JSON.stringify(i)};try{const i=(await new d.WorkItemStoreLevelWITDataSource(this.pageContext).getDataWithoutCache(e,a)).data;if(i.length===u.length){let e=!1;for(const t of i)if(t.state!==D.WorkItemUpdateResultState.Success){e=!0;break}for(let a=0;a<u.length;a++){const r=u[a],n=i[a];n.state!==D.WorkItemUpdateResultState.Success||e?n.state!==D.WorkItemUpdateResultState.Success?(n.error&&g(r,n.error),p()):(c.push({workItem:r}),p()):(await r.takeUpdateResult(this.pageContext,n,s[a],{keepDeletedLinks:o,ignoreTelemetry:l}),c.push({workItem:r}),t[r.tempId]=r.id,p())}}else u.forEach((e=>{g(e,{message:"Server data does not match with what client sent."})})),f()}catch(h){u.forEach((e=>{g(e,h)})),f()}}catch(e){throw m(u,!1),e}}else f()}else f()}_beginTryMergeWorkItem(e,t,i){const s={};this.beginGetWorkItemData([e.id],(a=>{if(this._hasConflicts(e,a,s)&&i)return void i(e);const r=this._getChangedFieldsForMerge(e,a);this._mergeWorkItem(e,a,s),e.evaluate();for(const t in s)s.hasOwnProperty(t)&&e.setFieldValueById(Number.parseInt(t),s[t]);e.isValid()?t(e,r):i&&i(e)}),(()=>{i&&i(e)}),!1,!0)}_mergeWorkItem(e,t,i){let s;s=e.getLinkUpdates(),e.load(t,!0);for(const t in i)i.hasOwnProperty(t)&&e.setFieldValueById(Number(t),i[t],{preventFire:!0});e.restoreLinkUpdates(s)}_getChangedFieldsForMerge(e,t){const i={},s=t.fields;for(const a in s)if(s.hasOwnProperty(a)){const s=e.getFieldById(Number.parseInt(a));if(s){const r=e.getFieldValueById(+a,!0),n=(0,L.convertFieldValueToExternal)(t.fields[a],s.fieldDefinition.type);(0,L.compareFieldValues)(r,n,!1)||(i[s.fieldDefinition.referenceName]=s)}}return i}_hasConflicts(e,t,i){let s,r,n,o;const l=e.getFieldUpdates();for(const d in l)if(l.hasOwnProperty(d)){const u=Number(d);if(n=e.getFieldById(u),n&&(s=e.getFieldValueById(u,!0),r=(0,L.convertFieldValueToExternal)(t.fields[u],n.fieldDefinition.type),(0,L.isUserChange)(n,l[d]))){const t=u===a.CoreField.History;if(o=e.getFieldValueById(u,!t),u==a.CoreField.History||(0,L.compareFieldValues)(s,r,!1))i[u]=o,u===a.CoreField.IterationId?i[a.CoreField.IterationPath]=e.getFieldById(a.CoreField.IterationPath):u===a.CoreField.AreaId&&(i[a.CoreField.AreaPath]=e.getFieldById(a.CoreField.AreaPath));else if(!(0,L.compareFieldValues)(o,r,!1))return!0}}return!1}_createWorkItemBulkSaveFailedException(e){const t=new Error(F.WorkItemBulkSaveFailed);return t.name=D.Exceptions.WorkItemBulkSaveException,t.results=e,t}}l.Services.add("IWorkItemSavingService",{serviceFactory:i})}(),function(e){U=t[e]={};t[e].WorkItemType=class{constructor(e,t,i,s){this.project=i,this.name=t.name,this.referenceName=t.referenceName,this.dependentFieldsMap={},this._httpClient=(0,u.getWorkItemTrackingClient)(e);const a=t.fields;this.triggerList=t.rules.triggerList,this.fieldMap={},this.fieldMapById={},this.fields=[];for(const e of a){const t=s[e];t&&(this.fieldMapById[t.id]=t,this.fieldMap[t.name.toUpperCase()]=t,this.fieldMap[t.referenceName.toUpperCase()]=t,this.fields.push(t))}}beginGetDependentFields(e,t,i,s){const a=this.fieldMapById[e];a?this.dependentFieldsMap.hasOwnProperty(e)?i(this.dependentFieldsMap[e]):this._httpClient.getWorkItemTypeFieldWithReferences(this.project.guid,this.name,a.referenceName,2).then((s=>{const a=(s.dependentFields||[]).map((e=>t.fieldMap[e.referenceName.toUpperCase()].fieldDefinition));this.dependentFieldsMap[e]=a,i(a)}),(e=>{s(""+e)})):s((0,n.format)("Field {0} doesn't exist in work item type {1}",e,this.name))}getTriggerList(){const e=[];return this.triggerList&&this.triggerList.forEach((t=>{e.push(t)})),e}},t[e].getTriggerList=function(e,t){const i=[];return e.rules&&e.rules.triggerList&&e.rules.triggerList.forEach((e=>{t(e)&&i.push(e)})),i}}("WorkItemWorkItemType"),function(e){x=t[e]={};t[e].Project=class{constructor(e,t){this.nodesById={},this.areaNodesByPath={},this.iterationNodesByPath={},this.store=e,this.id=t.id,this.name=t.name,this.guid=t.guid,this.workItemTypeNames=t.workItemTypes,this.fieldIds=t.fieldIds,this.extras=t.extras||{},this.process=t.process,this.relatedData={};const i={children:[t.areaNodes,t.iterationNodes],hasChildren:!0,id:t.id,name:t.name,attributes:{},path:t.name,url:"",structureType:0,identifier:t.guid,_links:{}};this.addNodeTreeToCache(i,0,""),Array.isArray(this.workItemTypeNames)&&this.workItemTypeNames.sort(n.localeIgnoreCaseComparer),this.workItemTypes={}}getNodeById(e){return e in this.nodesById?this.nodesById[e]:void 0}getNode(e,t){let i;return i=0===t?this.areaNodesByPath:this.iterationNodesByPath,e in i?i[e]:void 0}addNodeTreeToCache(e,t,i){let s;s=t>1?i+"\\"+e.name:1===t?i:e.name,this.addSingleNodeToCache(e,t,s),e.children&&e.children.forEach((e=>{this.addNodeTreeToCache(e,t+1,s)}))}addSingleNodeToCache(e,t,i){const s=Object.assign({},e);s.path=i,this.nodesById[e.id]=s,1!==t&&(0!==e.structureType&&0!==t||(this.areaNodesByPath[i]=s),1!==e.structureType&&0!==t||(this.iterationNodesByPath[i]=s))}}}("WorkItemProject"),function(e){H=t[e]={};class i{constructor(e,t,i,s,a,o,l){let d,u;this.id=0,this.tempId=0,this.revision=new r.ObservableValue(0),this.manualDirty=new r.ObservableValue(!1),this.dirty=new r.ObservableValue(!1),this.saving=new r.ObservableValue(!1),this.infoText=new r.ObservableValue({invalid:!1,text:""}),this.promisesToWait=new Map,this.promiseToWaitId=0,this.manuallySetFields=new Map,this._fieldWatermark=new r.ObservableValue(0),this._isChangeProjectInProgress=!1,this._workItemFormSavingService=e.getService("IWorkItemSavingService"),this._workItemEventService=e.getService("IWorkItemEventService"),this._workItemFieldEventService=e.getService("IWorkItemFieldEventService"),this._perfService=e.getService("IVssPerformanceService"),this.extensions=l||[],this._originalExtensions=this.extensions,this._contributionErrorMap={},this._typeData=t,this._originalTypeData=this._typeData,this._projectData=Object.assign(Object.assign({},i.projects[0]),{areaNodes:s.areaPathNodes,iterationNodes:s.iterationPathNodes}),this._originalProjectData=this._projectData,this._fieldLookup={},i.fields.forEach((e=>{this._fieldLookup[e.id]=e,this._fieldLookup[e.referenceName]=e})),this._pageContext=e,this._eventsEnabled=!1,this._initializeFields(t),this._defineExtensionFields(),this._isMarkdownDiscussionEnabled=(0,c.isFeatureFlagEnabled)(this._pageContext,f.FeatureFlags.IsMarkdownDiscussionEnabled,!1),this._useOptionalDotRegex=!(0,c.isFeatureFlagEnabled)(this._pageContext,f.FeatureFlags.UseStrictDoubleParsing,!1),this._eventsEnabled=!0,this.relatedData={},this.sessionId=(0,n.newGuid)(),this.saving=new r.ObservableValue(!1),this.store=new A.WorkItemStore(e,a),this.project=new x.Project(this.store,this._projectData),this.workItemType=new U.WorkItemType(e,this._typeData,this.project,this._fieldLookup),s.areaPathMru&&this.project.getNodeById(s.areaPathMru)&&(d=s.areaPathMru),s.iterationPathMru&&this.project.getNodeById(s.iterationPathMru)&&(u=s.iterationPathMru),this.load(o,!1,!1,d,u)}static getTempId(){return--i.tempIdSeed}static reserveTempId(e){i.tempIdSeed>e&&(i.tempIdSeed=e)}hasStateChanged(){return!(!this._previousStateName||this._previousStateName===this.getFieldValueById(a.CoreField.State))}fireWorkItemErrorChanged(){const e=[];if(this._error){const t=this.fieldMap[this._error.fieldReferenceName].fieldDefinition.id;e.push(t)}this._onWorkItemChanged(e,{workItemChangeType:"error-changed"}),this._workItemEventService.fireEvent({workItem:this},b.IWorkItemEventType.WorkItemErrorUpdated)}setContributionErrorStatus(e,t,i){if(t&&this._contributionErrorMap.hasOwnProperty(e))delete this._contributionErrorMap[e],this.fireWorkItemErrorChanged();else if(!t){const t=this._contributionErrorMap[e];this._contributionErrorMap[e]=i||"",t!==this._contributionErrorMap[e]&&this.fireWorkItemErrorChanged()}}beginValidate(e,t,i,s){if(this.dirty.value&&!this.isValidating(t)&&!this.saving.value){const a=this.getUpdateData();if(a&&a.payload){this._setValidatingStatus(!0,t);const a=this.getFieldById(e);this.workItemType.beginGetDependentFields(e,this,(async e=>{const r=e.concat(a.fieldDefinition),n={},o={};r.forEach((e=>{n[e.referenceName]=this.getFieldValueById(e.id,!0,void 0,void 0,!0),this.fieldUpdates.has(e.id)&&(o[e.referenceName]=this.getFieldValueById(e.id,!1,void 0,void 0,!0))}));try{const e=await this._pageContext.getService("IVssContributionService").getDataAsync("ms.vss-work-web.work-item-rule-engine-data-provider",{fieldsToEvaluate:{projectId:this.project.guid,workItemType:this.workItemType.name,fields:[a.fieldDefinition.referenceName],fieldValues:n,fieldUpdates:o}});if(e&&e.exception){if(s){const t=e.exception.customProperties?e.exception.customProperties.FieldReferenceName||e.exception.customProperties.ReferenceName:void 0;s(e.exception,t)}}else this.isValidating(t)&&!this.saving.value&&i()}catch(e){s(e)}finally{this._setValidatingStatus(!1,t)}}),(e=>{console.error(e)}))}}}isValidating(e){if(e)return this._fieldValidationMap[e.toString()]||!1;for(const e in this._fieldValidationMap)if(this._fieldValidationMap[e])return!0;return!1}validateIdentityFieldValue(e){const t=this.getFieldValueById(e),i=this.fieldMapById[e],s=new S.FieldValidationKey(e,t,i.filterByScope);!(0,L.isIdentityPickerSupportedForField)(i)||!(0,L.isFieldValid)(i)||t instanceof _.ServerDefaultValue||this.beginValidate(e,s,(()=>{new S.FieldValidationKey(e,this.getFieldValueById(e),i.filterByScope).equals(s)&&(i.error="",this._onWorkItemChanged([e],{workItemChangeType:"validation-completed"}))}),((t,a)=>{let r=i;a&&(r=this.getFieldByName(a)),(0,L.isFieldValid)(r)&&new S.FieldValidationKey(e,this.getFieldValueById(e),i.filterByScope).equals(s)&&(r.error=t.message,r.status=1073741824,this._onWorkItemChanged([e],{workItemChangeType:"validating"}))}))}_setValidatingStatus(e,t){let i=!1;if(t)this._fieldValidationMap[t.toString()]!==e&&(this._fieldValidationMap[t.toString()]=e,i=!0);else for(const t in this._fieldValidationMap)this._fieldValidationMap[t]!==e&&(this._fieldValidationMap[t]=e,i=!0)}_initializeFields(e){this.fields=[],this.fieldMap={},this.fieldMapById={},this._fieldValidationMap={},e.fields.forEach((e=>{this._defineFieldById(e)}))}save(e,t){var i;if(this.isReadOnly())throw new Error(F.WorkItemIsReadOnlyError);let s;const r=this._splitTagNames(this.getFieldValueById(a.DalFields.Tags)),n=this._splitTagNames(this.getFieldValueById(a.DalFields.Tags,!0));if(n!==r){s=r.length-n.length;const e=(0,L.subtract)(r,n);this._pageContext.getService("IWorkItemModelService").addTagsMru(e)}const o=this._perfService.startScenario("WorkItem.Save",!1);if(null==e&&(e=window.location.pathname),o.addProperties({workItemType:"[NonEmail: "+this._typeData.referenceName+"]",numberOfTags:undefined,numberOfTagsDelta:s,PathName:e}),this.isNew()&&this.saveLastAreaAndIteration(),this._isMarkdownDiscussionEnabled&&this.fieldUpdates.has(a.CoreField.History)){const e=null===(i=this.fieldUpdates)||void 0===i?void 0:i.get(a.CoreField.History);e&&(e.value=(0,p.filterXSS)((0,h.translateDisplayNamesToStorageKeys)(this._pageContext,e.value),R.htmlSanitizerPreserveMentionOptions),this.addLinksForNewMentionsInComment(e.value,!0))}return new Promise(((e,i)=>this._workItemFormSavingService.beginSaveWorkItemsBatch([this],(t=>{this._perfService.addSplitTiming("WorkItem.Save.Complete",o.scenarioName),e(t),this._perfService.endScenario(a.WITCommonConstants.WorkItemTrackingArea,o.scenarioName,!1)}),(e=>{this._perfService.endScenario(a.WITCommonConstants.WorkItemTrackingArea,o.scenarioName,!1),e&&e.name===D.Exceptions.WorkItemBulkSaveException&&(e=e.results[0].error),i(e)}),t)))}saveLastAreaAndIteration(){const e=this.getFieldValueByName(a.CoreFieldRefNames.AreaId),t=this.getFieldValueByName(a.CoreFieldRefNames.IterationId),i=this._pageContext.getService("IWorkItemNodeService");i.updateMruAreaPaths(this.project.guid,[e]),i.updateMruIterations(this.project.guid,[t])}saveLinks(e,t){return this._workItemFormSavingService.saveWorkItemLinksAsync(this,e,t)}isReadOnly(){return this._isReadOnly||this.isDeleted()}isCommentingAvailable(){return!this.isDeleted()&&this._isCommentingAvailable}isDeleted(){return this.getFieldValueByName(a.CoreFieldRefNames.IsDeleted)}isValid(){const e=this.getInvalidFields(!0);return(!e||0===e.length)&&0===Object.keys(this._contributionErrorMap).length}isNew(){return void 0===this.id||this.id<1}hasWorkItemTypeChanged(){return this._originalTypeData!==this._typeData}hasTeamProjectChanged(){return this._originalProjectData!==this._projectData}getError(){return this._error}setError(e){this._error=e,this.updateInfoText(),this._workItemEventService.fireEvent({workItem:this},b.IWorkItemEventType.WorkItemErrorUpdated)}clearError(){this._error&&(this._error=void 0)}getInvalidFields(e){const t=[],i=this.fields;for(const s of i)if(!(0,L.isFieldValid)(s)&&(t.push(s),e))break;return t}getDirtyFields(e){var t,i;const s=[];for(const a of this.fields){const r=a.fieldDefinition.id;(e&&(null===(t=this.manuallySetFields)||void 0===t?void 0:t.has(r))||!e&&(null===(i=this.fieldUpdates)||void 0===i?void 0:i.has(r)))&&s.push(a)}return s}isFieldDirty(e){let t;return"string"==typeof e?t=this.getFieldByName(e):"number"==typeof e&&(t=this.getFieldById(e)),!!t&&this.fieldUpdates.has(t.fieldDefinition.id)}updateInfoText(){const e={text:"",invalid:!1},t=this.getInvalidFields(!0);t&&t.length>0?(e.text=(0,L.getFieldErrorText)(t[0],this.getFieldValueById(t[0].fieldDefinition.id)),e.invalid=!0):this._error?(this._error.fieldReferenceName&&!this.getFieldByName(this._error.fieldReferenceName.toUpperCase())?e.text=F.BrowserRefreshRequired:e.text=(0,R.getErrorMessage)(this.getError()),e.invalid=!0):this._contributionErrorMap&&Object.keys(this._contributionErrorMap).length>0?(e.invalid=!0,e.text=this._contributionErrorMap[Object.keys(this._contributionErrorMap)[0]]||""):e.text="",this.infoText.value.text===e.text&&this.infoText.value.invalid===e.invalid||(this.infoText.value=e)}getTitle(){return this.getFieldValueById(a.CoreField.Title)||""}getCaption(e){let t;if(this.isNew()){const i=(null==e?void 0:e.excludeTempId)?"":-this.tempId;t=(0,n.format)(F.WorkItemCaptionNew,this._typeData.name,i)}else t=`${this._typeData.name} ${this.id}`;return(null==e?void 0:e.includeDirtyModifier)&&this.dirty.value&&(t=`${t}*`),t}getUniqueId(){return this.id||this.tempId}getTypeData(){return this._typeData}_getCommentCount(e){let t=this._fieldData[a.CoreField.CommentCount]||0;return!e&&this.fieldUpdates.has(a.CoreField.History)&&(t+=1),t}getFieldLookup(){return this._fieldLookup}getFieldByName(e){return this.fieldMap[e.toUpperCase()]}getFieldById(e){return this.fieldMapById[e]}getFieldValueById(e,t,i,s,a){const r=this.getFieldById(e);if(r)return this._getFieldValue(r.fieldDefinition,t,i,s,a)}getFieldValueByName(e,t,i,s,a){const r=this.getFieldByName(e);if(r)return this._getFieldValue(r.fieldDefinition,t,i,s,a)}_getFieldValue(e,t,i,s,r){const n=this.fieldUpdates,l=e.id;switch(l){case a.CoreField.AttachedFileCount:return this._getLinkCount(M.Attachment,!!t);case a.CoreField.ExternalLinkCount:return this._getLinkCount(M.ExternalLink,!!t);case a.CoreField.HyperLinkCount:return this._getLinkCount(M.Hyperlink,!!t);case a.CoreField.RelatedLinkCount:return this._getLinkCount(M.WorkItemLink,!!t);case a.CoreField.Parent:return this._getParentLinkId(!!t);case a.CoreField.CommentCount:return this._getCommentCount(t);case a.CoreField.TeamProject:if(this.isNew()&&this._projectData)return this._projectData.name}if(!t&&n.has(l)){const t=n.get(l);if(!t.setByRule||!i)return this.convertFieldValue(t.value,e,s)}const d=this._fieldData[l],u=r?(0,L.convertFieldValueToExternal)(d,e.type):d;return(0,o.convertPotentialIdentityRefFromFieldValue)(this._pageContext,u,s)}convertFieldValue(e,t,i){return(0,o.convertPotentialIdentityRefFromFieldValue)(this._pageContext,(0,L.convertFieldValueToExternal)(e,t.type),i)}wrappedSetFieldValue(e,t,i){if(!(null==i?void 0:i.handleExceptions))return this._setFieldValue(e,t,i);try{return this._setFieldValue(e,t,i)}catch(i){let s="An error occurred while bulk-editing a work item";return i instanceof Error&&(s+=`: ${i.message} Field Name: ${null==e?void 0:e.fieldDefinition.name}, Value: ${t}`),console.error(s),!1}}setFieldValueByName(e,t,i){const s=this.getFieldByName(e);return this.wrappedSetFieldValue(s,t,i)}setFieldValueById(e,t,i){const s=this.getFieldById(e);return this.wrappedSetFieldValue(s,t,i)}_setFieldValue(e,t,i){var s,r;let n=this.isReadOnly();if(null==i?void 0:i.checkIsCommentingAvailable){n=!((null===(s=null==e?void 0:e.fieldDefinition)||void 0===s?void 0:s.id)==a.CoreField.History&&this.isCommentingAvailable())&&this._isReadOnly}if(n)return!1;if(e){i=Object.assign({preventFire:!1,fireIdentityEagerValidation:!1,setByRule:!1},i),(0,o.isWorkItemIdentityRef)(t)&&(t=t.distinctDisplayName);const s=e.fieldDefinition.id,n=this.getFieldValueById(s),l=(0,L.convertFieldValueToInternal)((0,L.tryNormalizeFieldValue)(t,e,this._useOptionalDotRegex),e.fieldDefinition.type,this._useOptionalDotRegex),d=this._fieldData[s];switch(s){case a.CoreField.AttachedFileCount:case a.CoreField.ExternalLinkCount:case a.CoreField.HyperLinkCount:case a.CoreField.RelatedLinkCount:case a.CoreField.Parent:case a.CoreField.CommentCount:return!1;case a.CoreField.AreaId:case a.CoreField.IterationId:if(!this.project.getNodeById(t))throw new Error("Invalid node id.");break;case a.CoreField.Rev:this.revision.value=l.value;break;case a.CoreField.State:n!==l.value&&(this._previousStateName=n)}const u=e.fieldDefinition.isIdentity,h=s===a.CoreField.History,c=h&&!(0,L.compareFieldValues)("",l.value),I=!h&&!(0,L.compareFieldValues)(d,l.value,void 0,u);if(c||I){const e=this.fieldUpdates.get(s);if(e&&e.value===l.value?this.fieldUpdates.set(s,{value:l.value,setByRule:e.setByRule&&i.setByRule}):this.fieldUpdates.set(s,{value:l.value,setByRule:i.setByRule}),i.setByRule||this.manuallySetFields.set(s,l.value),c){const e=this.getFieldValueById(a.CoreField.CommentCount);this.evaluateField(a.CoreField.CommentCount,!0,e)}}else this.fieldUpdates.delete(s),this.manuallySetFields&&this.manuallySetFields.delete(s);if(this.evaluateDirty(),null!==(r=i.evaluate)&&void 0!==r?r:!(0,L.compareFieldValues)(n,l.value)){const t=this.evaluateField(e.fieldDefinition.id,!0,n);e.status|=l.status,i.fireIdentityEagerValidation&&this.validateIdentityFieldValue(e.fieldDefinition.id),i.preventFire||this._onWorkItemChanged(t,{setByRules:i.setByRule,workItemChangeType:"field-change"})}return!0}return!1}evaluateField(e,t,i){return this._getRuleEngine().evaluateField(e,t,i)}_defineFieldById(e){!this.fieldMapById.hasOwnProperty(e)&&this._fieldLookup[e]&&this._defineField(this._fieldLookup[e])}_defineField(e){var t;const i=Object.assign(Object.assign({},e),{rules:this._typeData.rules.fieldRules?this._typeData.rules.fieldRules[e.id]:[],workItemType:Object.assign(Object.assign({},this._typeData),{orderedStates:null!==(t=this._typeData.orderedStates)&&void 0!==t?t:[]})}),s={fieldDefinition:i,status:0,workItem:this,patterns:[]};this.fieldMap[i.referenceName.toUpperCase()]=s,this.fieldMapById[i.id]=s,this.fields.push(s)}getFieldUpdates(){const e={};return this.fieldUpdates.forEach(((t,i)=>{const s=this.getFieldById(i);if(s&&s.fieldDefinition&&s.fieldDefinition.flags&a.FieldFlags.Computed)return;let r=t.value;void 0===r&&(r=null),e[i]=r})),e}getFieldData(){return this._fieldData}evaluateDirty(){const e=this.isDirty();this.dirty.value!==e&&(this.dirty.value=e);const t=this.isDirty(!0);this.manualDirty.value!==t&&(this.manualDirty.value=t)}isDirty(e,t,i){let s=this.isReadOnly();return i&&(s=!this._isCommentingAvailable&&this.isReadOnly()),!s&&!this.isDeleted()&&(!!this._fieldsDirty(e,t)||!!this._linksDirty())}_linksDirty(){for(const e of this._allLinks)if(!(e.isRemoved()||e.isNew()&&e instanceof M.WorkItemLink&&e.linkData.isAddedBySystem)){if(e.pendingDeletion!==e.isNew())return!0;if(e.pendingUpdate)return!0}return!1}_fieldsDirty(e,t){var i;if(e){if(this.manuallySetFields){const e=new Map(this.manuallySetFields);if(t&&t.length>0)for(const i of t)e.delete(i);return e.size>0}}else{if(this.isNew())return!0;{const e=new Map(this.fieldUpdates);if(t&&t.length>0)for(const i of t)e.delete(i);for(const t of e.keys())if(!(null===(i=e.get(t))||void 0===i?void 0:i.setByRule))return!0}}return!1}_onWorkItemChanged(e,t){this.clearError(),this.updateInfoText();const s=new Map;if(this._eventsEnabled&&e){for(const t of e)if(!s.has(t)){const e=this.getFieldById(t);if(e){const t=e.fieldDefinition.id,a=i.FIELD_ID_TO_DEPENDENT_ID_MAP[t];s.set(t,e),a&&a.forEach((e=>{const t=this.getFieldById(e);t&&s.set(e,t)}))}else s.delete(t)}for(const[e,t]of s.entries())this.updateFieldWatermark(e.toString())}this._workItemFieldEventService.fireEvent({workItem:this,fieldDefinitionIds:Array.from(s.keys()),setByRules:null==t?void 0:t.setByRules,workItemChangeType:null==t?void 0:t.workItemChangeType},B.IWorkItemFieldEventType.WorkItemFieldsUpdated),this._workItemEventService.fireEvent({workItem:this},b.IWorkItemEventType.WorkItemUpdated)}getEmptyUpdateData(){const e=this.prepareWorkItemUpdateData();return e.payload=this.prepareWorkItemUpdatePackage(),e}getUpdateData(){let e=!1;const t=this.prepareWorkItemUpdateData(),i=this.prepareWorkItemUpdatePackage(),s=this.getFieldUpdates();s&&(this.addLinksForNewMentions(s),i.fields=s,this.hasTeamProjectChanged()&&i.fields&&(i.fields[a.CoreField.TeamProject]=this._projectData.name),e=!0);const r=this.getLinkUpdates(t);return r&&(i.links=r,e=!0),e&&(t.payload=i),t}prepareWorkItemUpdateData(){return{uniqueId:this.getUniqueId(),id:this.id,tempId:this.tempId,rev:this.revision.value,projectId:this._projectData.guid,addedLinks:[],deletedLinks:[],updatedLinks:[]}}prepareWorkItemUpdatePackage(){return{id:this.id,rev:this.revision.value,projectId:this._projectData.guid,isDirty:this.isDirty(),tempId:this.isNew()?this.tempId:void 0}}addLinksForNewMentions(e){var t,i,s;const r=null===(i=null===(t=this._pageContext.getService("IVssPageService").getData())||void 0===t?void 0:t.user)||void 0===i?void 0:i.displayName;if(!r)return;const n=new Set;for(const[t,i]of Object.entries(e)){const e=null===(s=this._fieldLookup[t])||void 0===s?void 0:s.type;e!==a.FieldType.Html&&e!==a.FieldType.History||"string"==typeof i&&this.findMentionsInHTMLFieldValue(i,n)}this.prepareAndAddRelatedlinks(n,r)}prepareAndAddRelatedlinks(e,t){const i=[...e].map((e=>M.WorkItemLink.createSync(D.CoreLinkTypes.Related,e,(0,n.format)(F.LinkedFromMentionCommentFormat,t,e,this.id))));return this.addLinks(i),i}findMentionsInHTMLFieldValue(e,t){const i=document.createElement("div");i.innerHTML=e;i.querySelectorAll("a[data-vss-mention]").forEach((e=>{if(!e.outerText.startsWith(R.workItemLinkBeginningSign))return;const i=(0,R.getEndingNumberFromUrl)(e.href);!i||i&&(!Number.isFinite(i)||i<=0)||t.add(Number(i))}))}async findMentionsInMarkdownFieldValue(e){const t=new Set,i=[],s=async e=>{const t=parseInt(e);(Number.isFinite(t)||t>0)&&i.push(t)},r=e.split(/(?<=\s|^)(#[0-9]+[^#\n]*)/g).filter((e=>Boolean(e)));for(const e of r){if(!e.startsWith(R.workItemLinkBeginningSign))continue;const t=e.match(/#([0-9]+)/g);if(t)for(const e of t){s(e.slice(1))}}return await(async()=>{const e=this._pageContext.getRestClient("IWorkItemTrackingRestClient"),s=await e.getWorkItems(i,void 0,[a.CoreFieldRefNames.Id],void 0,void 0,2);s&&s.map((e=>t.add(e.id)))})(),t}async addLinksForNewMentionsInComment(e,t){var i,s;const r=null===(s=null===(i=this._pageContext.getService("IVssPageService").getData())||void 0===i?void 0:i.user)||void 0===s?void 0:s.displayName;if(!r)return;let n=new Set;if(t?n=await this.findMentionsInMarkdownFieldValue(e):this.findMentionsInHTMLFieldValue(e,n),n.has(this.id)&&n.delete(this.id),n.size>0){const e=this.prepareAndAddRelatedlinks(n,r);this.saveLinks(e,[a.CoreField.History,a.CoreField.Rev])}}evaluate(e,t){const i=[],s={};(0,U.getTriggerList)(this._typeData,(e=>!!this.getFieldById(e))).forEach((e=>{s.hasOwnProperty(e)||(i.push(e),s[e]=!0)})),t?(t.forEach((e=>{s.hasOwnProperty(e)||(i.push(e),s[e]=!0)})),s.hasOwnProperty(a.DalFields.HistoryId)||(i.push(a.DalFields.HistoryId),s[a.DalFields.HistoryId]=!0)):this.fields.forEach((e=>{const t=e.fieldDefinition.id;s.hasOwnProperty(t)||(i.push(t),s[t]=!0)})),this.evaluateFields(i,e)}evaluateFields(e,t){const i=new Set;t&&t.forEach((e=>{i.add(e)}));const s=this._getRuleEngine().evaluateFields(e);s&&s.forEach((e=>{i.add(e)})),this._onWorkItemChanged([...i.values()],{workItemChangeType:"field-evaluate"})}resetManualFieldChanges(){this.manuallySetFields.clear()}getFieldWatermark(){return this._fieldWatermark}updateFieldWatermark(e){this._fieldWatermark.notify(this._fieldWatermark.value+1,e)}_getRuleEngine(){if(!this._ruleEngine){const e=[];this.fields.forEach((t=>{t.fieldDefinition.rules&&e.push({fieldId:t.fieldDefinition.id,rules:t.fieldDefinition.rules})})),this.extensions&&this.extensions.forEach((t=>{if(t.fieldRules)for(const[i,s]of Object.entries(t.fieldRules))e.push({fieldId:Number(i),rules:s})})),this._ruleEngine=new P.RuleEngine(this,e,this._useOptionalDotRegex)}return this._ruleEngine}_splitTagNames(e){return e?e.trim().split(/;\s*/):[]}reset(){this.resetContributionErrorStatuses(),this.resetChanges(),this.relatedData={};const e=[a.DalFields.RelatedLinks,a.DalFields.BISURI,a.DalFields.LinkedFiles,a.DalFields.AttachedFiles,a.DalFields.Tags];this.fieldMap[a.CoreFieldRefNames.Parent]&&e.push(a.CoreField.Parent),this._onWorkItemChanged(e,{workItemChangeType:"reset"}),this.updateFieldWatermark(D.WorkItemWatermarkAllAction),this._workItemFieldEventService.fireEvent({workItem:this},B.IWorkItemFieldEventType.WorkItemFieldsUpdated),this._workItemEventService.fireEvent({workItem:this},b.IWorkItemEventType.WorkItemReset)}resetChanges(){let e;this._currentLinks=void 0;const t=this._allLinks;for(let i=0,s=t.length;i<s;i++)e=t[i],e.isNew()?(t.splice(i--,1),s--):(e.pendingDeletion=!1,e.linkData.CommentChanged&&(e.linkData.Comment=e.comment,e.linkData.CommentChanged=!1),e.linkData.LockChanged&&(e.linkData.Lock=e.isLocked,e.linkData.LockChanged=!1),e.setState());this.cleanPromisesToWait(),this.fieldUpdates.clear(),this.evaluate(),this.resetManualFieldChanges(),this._resetWorkItemTypeChanges(),this.evaluateDirty()}async refresh(e){if(this.isNew())this.reset();else{const t=this._pageContext.getService("IWorkItemDataManager"),i=await t.beginGetWorkItemData([this.id],null==e?void 0:e.isDeleted,void 0,null==e?void 0:e.includeHistory);if(!i||0===i.length)return Promise.reject((0,n.format)(F.InvalidWorkItemId,this.id));if((null==e?void 0:e.doNotResetIfManuallyDirty)&&this.isDirty(!0,[a.CoreField.History]))return;this.updateWorkItemPayload(i[0],null==e?void 0:e.doNotResetComment,null==e?void 0:e.doNotResetFields)}}async refreshNewLinks(e){var t,i,s;const a=this._pageContext.getService("IWorkItemDataManager"),r=await a.beginGetWorkItemData([this.id],!1,!1,null==e?void 0:e.includeHistory);if(!r||0===r.length)throw new Error((0,n.format)(F.InvalidWorkItemId,this.id));const o=r[0],l=[...null!==(t=o.files)&&void 0!==t?t:[],...null!==(i=o.relations)&&void 0!==i?i:[],...null!==(s=o.relationRevisions)&&void 0!==s?s:[]].map((e=>M.Link.createFromLinkData(e)));this.addLinks(l,null==e?void 0:e.keepDeleted)}async updateWorkItemPayload(e,t,i){const s=e.fields[a.CoreField.TeamProject],r=e.fields[a.CoreField.WorkItemType];await this._evaluateWorkItemTypeChange(s,r),this.load(e,!i,t),i||(this.updateFieldWatermark(D.WorkItemWatermarkAllAction),this._workItemFieldEventService.fireEvent({workItem:this},B.IWorkItemFieldEventType.WorkItemFieldsUpdated)),this.evaluateDirty()}async takeUpdateResult(e,t,i,s){const{keepDeletedLinks:r,ignoreTelemetry:n}=null!=s?s:{},o=n?()=>{}:e=>{this._perfService.addSplitTiming(e)};o(`${D.WorkItemFormPerfConstants.TakeUpdateResult}.Start`);const l=[],d=this.id;let u,h;try{this._loadTime=t.loadTime,this._ruleEngine=void 0;const e=t.rev!==this.revision.value,i=t.fields&&this._fieldData&&t.fields[a.CoreField.Watermark]!==this._fieldData[a.CoreField.Watermark];if(e||i){let i;this.setFieldValueById(a.CoreField.Id,t.id,{preventFire:!0}),this.id=t.id,void 0!==t.isCommentingAvailable&&null!==t.isCommentingAvailable&&(this._isCommentingAvailable=t.isCommentingAvailable),this.setFieldValueById(a.CoreField.Rev,t.rev,{preventFire:!0}),u=t.rev;const r=t.fields;if(r)for(i in r)r.hasOwnProperty(i)&&(this.setFieldValueById(+i,r[i],{evaluate:!1}),l.push(+i));const n=this.fieldUpdates,o=this._fieldData;let d;1===t.rev?(n.forEach(((e,t)=>{o[t]=e.value})),o[a.CoreField.History]&&this._addDiscussionForRevision(o[a.CoreField.History],o)):e?(d={},o.hasOwnProperty(a.CoreField.ChangedBy)&&(d[a.CoreField.ChangedBy]=o[a.CoreField.ChangedBy]),n.forEach(((e,t)=>{d[t]=o[t],o[t]=e.value})),o.hasOwnProperty(a.CoreField.History)&&(d.hasOwnProperty(a.CoreField.History)||(d[a.CoreField.History]=o[a.CoreField.History],delete o[a.CoreField.History])),this._revisionsPopulated&&this._revisions.push(d),o[a.CoreField.History]&&this._addDiscussionForRevision(o[a.CoreField.History],o)):n.forEach(((e,t)=>{n.hasOwnProperty(t)&&(o[t]=e.value)})),(null==s?void 0:s.fieldsToClear)&&(null==s||s.fieldsToClear.forEach((e=>this.fieldUpdates.delete(e)))),(null==s?void 0:s.ignoreFieldUpdates)&&n.forEach(((e,i)=>{t.fields[i]&&this.fieldUpdates.delete(i)})),(null==s?void 0:s.ignoreFieldUpdates)||(null==s?void 0:s.fieldsToClear)||this.fieldUpdates.clear()}}finally{o(`${D.WorkItemFormPerfConstants.TakeUpdateResult}.Complete`)}o(`${D.WorkItemFormPerfConstants.EvaluateLinkUpdates}.Start`);try{h=await this._takeLinkUpdateResult(e,t,i,r),this.evaluate(h.changedFields,l),this._onWorkItemChanged(l,{workItemChangeType:"field-evaluate"}),this.resetManualFieldChanges(),this.evaluateDirty(),this.updateInfoText()}finally{o(`${D.WorkItemFormPerfConstants.EvaluateLinkUpdates}.Complete`)}o(`${D.WorkItemFormPerfConstants.ResetAfterSave}.Start`);try{const e=this.hasWorkItemTypeChanged(),t=this.hasTeamProjectChanged();this._originalTypeData=this._typeData,this._originalProjectData=this._projectData,this._workItemEventService.fireEvent({workItem:this,changedWorkItemLinks:h.changedWorkItemLinks,externalLinkChanged:h.externalLinkChanged,firstSave:d!==this.id,typeChanged:e,projectChanged:t},b.IWorkItemEventType.WorkItemSaved),void 0!==u&&(this.revision.value=u)}finally{o(`${D.WorkItemFormPerfConstants.ResetAfterSave}.Complete`)}}_addDiscussionForRevision(e,t){this._fieldData[a.CoreField.CommentCount]=this._getCommentCount()}async _takeLinkUpdateResult(e,t,i,s){const r={},n=[];let o=!1;const l=async t=>t.SourceID===this.id?{targetId:t.TargetID,linkType:t.LinkType,remoteHostId:t.RemoteHostId}:{targetId:t.SourceID,linkType:(await M.WorkItemLink.findLinkTypeEnd(e,t.LinkType)).oppositeEnd.id,remoteHostId:t.RemoteHostId},d=(e,t,i)=>{let s;return this._allLinks.forEach((a=>{if(a instanceof M.WorkItemLink&&!a.isRemoved()){const r=a;if(r.getTargetId()===e&&(!a.remoteHostId||a.remoteHostId===i)&&r.getWitLinkTypeEndId()===t)return s=r,!1}})),s},u={};i.deletedLinks&&i.deletedLinks.forEach((e=>{e instanceof M.WorkItemLink||(r[e.getFieldId()]=!0,e.linkData.RemovedDate=this.getFieldValueById(a.DalFields.LastChangedDateId),e.linkData.FilePath&&(u[e.linkData.FilePath]=e))}));for(const e of t.deletedLinks)if(e.ExtID){if(!o&&e.FilePath){u[e.FilePath]instanceof M.ExternalLink&&(o=!0)}}else{const t=await l(e),i=d(t.targetId,t.linkType,t.remoteHostId);i&&(r[i.getFieldId()]=!0,i.linkData["Revised Date"]=e.ChangedDate,i.linkData["Revised By"]=e.ChangedBy,n.push({command:"remove",sourceId:this.id,targetId:i.getTargetId(),linkData:i.linkData}))}const h={};i.addedLinks&&i.addedLinks.forEach((e=>{e instanceof M.WorkItemLink||!e.linkData.FilePath||(h[e.linkData.FilePath]=e)}));for(const i of t.addedLinks){let t;if(i.ExtID&&i.FilePath)t=h[i.FilePath],t&&(r[t.getFieldId()]=!0,t.linkData.ExtID=i.ExtID,t.linkData.AddedDate=this.getFieldValueById(a.DalFields.LastChangedDateId),t instanceof M.ExternalLink&&(o=!0));else{const t=await l(i);let s=d(t.targetId,t.linkType,t.remoteHostId);s||(s=await M.WorkItemLink.create(e,t.linkType,t.targetId),this._allLinks.push(s)),r[s.getFieldId()]=!0,s.linkData["Changed Date"]=i.ChangedDate,s.linkData["Changed By"]=i.ChangedBy,n.push({command:"add",sourceId:this.id,targetId:s.getTargetId(),linkData:s.linkData})}}this.resetLinks(void 0,s);const c=[];for(const e in r)r.hasOwnProperty(e)&&c.push(+e);return{changedFields:c,changedWorkItemLinks:n,externalLinkChanged:o}}load(e,t,s,r,n){var l;let d;this.dirty,this.manualDirty,e=e||{},this._isReadOnly=e.isReadOnly||!1,this._loadTime=e.loadTime||new Date,this._fieldData=e.fields||{};for(const e in this._fieldData)if(this._fieldData.hasOwnProperty(e)){const t=this._fieldData[e].fieldDefinition;if(t)if((0,L.isLongTextField)(t.type)){const t=this._fieldData[e];t&&(this._fieldData[e]=t.trim())}else if(t.isIdentity){const t=this._fieldData[e];t&&(0,o.setResolvedByDescriptorIfWorkItemIdentityRef)(t)}}if(this._revisions=e.revisions||[],!t&&this.fieldUpdates?this.dirty.value=this.fieldUpdates.size>0:s&&this.fieldUpdates.has(a.CoreField.History)?(this.fieldUpdates=new Map([[a.CoreField.History,this.fieldUpdates.get(a.CoreField.History)]]),this.dirty.value=!0):this.fieldUpdates=new Map,Object.keys(this._fieldData).forEach((e=>{this._defineFieldById(+e)})),t&&(this.fields.forEach((e=>{(0,L.resetField)(e)})),this.resetContributionErrorStatuses()),d=[],e.files&&d.push(...e.files),e.relations&&d.push(...e.relations),e.relationRevisions&&d.push(...e.relationRevisions),this._allLinks=[],this._currentLinks=void 0,this._allLinks.push(...d.map((e=>M.Link.createFromLinkData(e)))),this.relatedData={},this.referencedPersons=e.referencedPersons||{},this.id=this.getFieldValueById(a.CoreField.Id)||0,0===this.id&&(e.tempId?(this.tempId=e.tempId,i.reserveTempId(this.tempId)):this.tempId=i.getTempId()),this.revision.value=this.getFieldValueById(a.CoreField.Rev)||0,this._isCommentingAvailable=null!==(l=e.isCommentingAvailable)&&void 0!==l&&l,this.isNew()){const e=this._projectData.id;this.setFieldValueById(a.CoreField.AreaId,null!=r?r:e,{setByRule:!0}),this.setFieldValueById(a.CoreField.IterationId,null!=n?n:e,{setByRule:!0}),this.setFieldValueById(a.CoreField.WorkItemType,this._typeData.name,{setByRule:!0}),this.setFieldValueById(a.CoreField.Id,0,{setByRule:!0}),this._revisionsPopulated=!0}else this._revisionsPopulated=null!=e.revisions&&null!=e.revisions&&e.revisions.length>0||null!=e.relationRevisions&&null!=e.relationRevisions&&e.relationRevisions.length>0;const u=[a.DalFields.RelatedLinks,a.DalFields.AttachedFiles,a.DalFields.BISURI,a.DalFields.LinkedFiles];this.fieldMap[a.CoreFieldRefNames.Parent]&&u.push(a.CoreField.Parent),this.evaluate(u),this.isNew()&&(this.initialValues=new Map(this.fieldUpdates),this.dirty.value=!0),!t&&this.manuallySetFields.size>0?(this.dirty.value=!0,this.manualDirty.value=!0):s&&this.manuallySetFields.has(a.CoreField.History)?(this.manuallySetFields=new Map([[a.CoreField.History,this.manuallySetFields.get(a.CoreField.History)]]),this.dirty.value=!0,this.manualDirty.value=!0):this.manuallySetFields=new Map}resetContributionErrorStatuses(){this._contributionErrorMap&&Object.keys(this._contributionErrorMap).length>0&&(this._contributionErrorMap={})}restoreLinkUpdates(e){if(e){if(e.addedLinks){const t=e.addedLinks;for(const e of t){const t=M.Link.createFromLinkData(e);this.addLinks([t])}}if(e.deletedLinks){const t=e.deletedLinks;for(const e of t){const t=this.findLink(M.Link.createFromLinkData(e));t&&this.removeLinks([t])}}}}addLinks(e,t){var i,s;if(this.isReadOnly())return;const a={};for(const t of e){let e=!1,r=!1;for(const a of this._allLinks)if(!a.isRemoved()&&t.isDuplicate(a)){if(a.pendingDeletion){(0,n.localeComparer)(null!==(i=a.getComment())&&void 0!==i?i:"",null!==(s=t.getComment())&&void 0!==s?s:"")||a.setComment(t.getComment()),e=!0,a.pendingDeletion=!1;break}r=!0}if(r)continue;const o=t.getFieldId();e?a[o]=0:(a[o]=(a[o]||0)+1,this._allLinks.push(t))}if(e.length){this.resetLinks(void 0,t);const e=[];let i;for(const t in a)if(a.hasOwnProperty(t)){const s=+t;e.push(s),i=M.Link.getCountFieldId(s),this.evaluateField(i,!0,this.getFieldValueById(i)-a[s])}this.evaluateDirty(),this.evaluateFields(e,e),this.evaluateDirty()}}removeLinks(e,t){if(this.isReadOnly())return;let i=0;const s={};let a;for(const t of e)t.getIsLocked()||(a=t.getFieldId(),t.remove({preventEvent:!0}),s[t.getFieldId()]=(s[a]||0)+1,i++);if(i){this.resetLinks(!0,t);const e=[];let i;for(const t in s)if(s.hasOwnProperty(t)){const a=+t;e.push(+a),i=M.Link.getCountFieldId(a),this.evaluateField(i,!0,this.getFieldValueById(i)+s[a])}this.evaluateDirty(),this.evaluateFields(e,e),this.evaluateDirty()}}findLink(e){const t=this._allLinks;for(const i of t)if(i.equals(e))return i}getLinkUpdates(e){const t=[],i=[],s=[];for(const a of this._allLinks)a.isRemoved()||(a.pendingDeletion?(t.push(a.linkData),e&&e.deletedLinks&&e.deletedLinks.push(a)):a.isNew()?(s.push(a.linkData),e&&e.addedLinks&&e.addedLinks.push(a)):a.pendingUpdate&&(i.push(a.linkData),e&&e.updatedLinks&&e.updatedLinks.push(a)));const a={};return t.length>0&&(a.deletedLinks=t),i.length>0&&(a.updatedLinks=i),s.length>0&&(a.addedLinks=s),a}resetLinks(e,t){let i;if(this._currentLinks=void 0,this._allLinks=this._allLinks.filter((i=>!(e&&i.pendingDeletion&&i.isNew())&&(!(!t||i.getLinkType()==a.WorkItemLinkConstants.ATTACHEDLINKTYPE)||!i.isRemoved()))),e){const e=this._allLinks;for(let t=0,s=e.length;t<s;t++)i=e[t],i.pendingDeletion&&i.isNew()&&(e.splice(t--,1),s--)}for(const e of this._allLinks)e.setState(!0)}getLinks(e){return e?this._allLinks:(this._currentLinks||(this._currentLinks=this._allLinks.filter((e=>!e.pendingDeletion&&!e.isRemoved()))),this._currentLinks)}_getLinkCount(e,t){let i=0;return this.getLinks().forEach((s=>{t&&s.isNew()||(e?s instanceof e&&i++:i++)})),i}_getParentLinkId(e){const t=this.getLinks();for(const i of t)if((!e||!i.isNew())&&i instanceof M.WorkItemLink){const e=i;if(e.getWitLinkTypeEndId()===D.CoreLinkTypes.Parent)return e.getTargetId()}}computeFieldValue(e,t,i){let s;const r={success:!1};s=void 0!==i&&i>=0?this.getFieldValueByRevision(t,i):this.getFieldValueById(t);const n=e=>{if(s){const t=this.project.getNodeById(s);if(t){let i;i=t.path?(0,g.getReferencedNodeSegmenets)(t.path):(0,g.getNodeSegments)(t),r.value=i[e],r.success=!0}}};switch(e){case a.CoreField.AreaId:case a.CoreField.IterationId:if(s){const t=this.project.getNode(s,e===a.CoreField.AreaId?0:1);t&&(r.value=t.id,r.success=!0)}break;case a.DalFields.AreaLevel1:case a.DalFields.IterationLevel1:n(0);break;case a.DalFields.AreaLevel2:case a.DalFields.IterationLevel2:n(2);break;case a.DalFields.AreaLevel3:case a.DalFields.IterationLevel3:n(3);break;case a.DalFields.AreaLevel4:case a.DalFields.IterationLevel4:n(4);break;case a.DalFields.AreaLevel5:case a.DalFields.IterationLevel5:n(5);break;case a.DalFields.AreaLevel6:case a.DalFields.IterationLevel6:n(6);break;case a.DalFields.AreaLevel7:case a.DalFields.IterationLevel7:n(7);break;case a.CoreField.AreaPath:case a.CoreField.IterationPath:if(s){const t=this.project.getNodeById(s);t?(r.value=t.path||(0,g.getPath)(t,1),r.success=!0):(r.value=e===a.CoreField.AreaPath?F.DeletedAreaPath:F.DeletedIterationPath,r.success=!0)}break;case a.CoreField.NodeName:if(s){const e=this.project.getNodeById(s);e&&(r.value=e.name,r.success=!0)}}return r}getFieldValueByRevision(e,t){const i=this._revisions,s=e+"";if(t<0)return null;if(e===a.CoreField.History)return t<i.length?i[t][e]:this._fieldData[e];{const a=this.getComputedFieldValue(e,t);if(a&&a.success)return a.value;let r,n=!1;for(let e=t;e<i.length;e++)if(i[e].hasOwnProperty(s)){r=(0,o.convertPotentialIdentityRefFromFieldValue)(this._pageContext,i[e][s]),n=!0;break}return n||(r=this.getFieldValueById(e,!0)),r}}getComputedFieldValue(e,t){const i=e+"";if(void 0!==t&&t>=0&&(e===a.CoreField.TeamProject||e===a.CoreField.IterationPath||e===a.CoreField.AreaPath)){const e=this._revisions[t];if(e&&e.hasOwnProperty(i)){const t=e[i];if(t)return{success:!0,value:t}}}switch(e){case a.CoreField.TeamProject:return this.getFieldValueById(e,!0);case a.CoreField.NodeName:return this.computeFieldValue(a.CoreField.NodeName,a.CoreField.AreaId,t);case a.CoreField.IterationPath:return this.computeFieldValue(a.CoreField.IterationPath,a.CoreField.IterationId,t);case a.CoreField.AreaPath:return this.computeFieldValue(a.CoreField.AreaPath,a.CoreField.AreaId,t);default:return null}}isChangeProjectInProgress(){return this._isChangeProjectInProgress}_copyField(e,t,i){if(t&&(0,w.isCloneable)(t)){if(this.getFieldById(t.id)){const s=this.getFieldValueById(t.id);if(!(0,L.isEmpty)(s)){if(!(t.id!==a.CoreField.AreaId&&t.id!==a.CoreField.IterationId||"number"==typeof s&&this.project.id===i.project.id))return;e.setFieldValueById(t.id,s)}}}}async copy(e,t,i,s=!0,r=!0,o=!0,l=[],d=!0,u){var h,c,I;const m=[],f=[],g={},p=e.getService("IVssTelemetryService"),k=this._pageContext.getService("IWorkItemModelService"),v=this._pageContext.getService("IWorkItemNodeService"),[E,y,C]=await Promise.all([k.getFieldLookup(t),v.getAreaPathNodes(t),v.getIterationNodes(t)]);if(!E||!y||!C)throw Error();let T;if(t===this.project.guid)T=this.project;else{const e=this._pageContext.getService("IWorkItemDataManager"),i=await e.beginGetFieldProjectData(t);if(!i)throw Error();const s=Object.assign(Object.assign({},i.projects[0]),{areaNodes:y,iterationNodes:C});T=new x.Project(this.store,s)}const S=new U.WorkItemType(this._pageContext,i,T,E);d="boolean"!=typeof d||d,p.publishEvent("WIT","WorkItem.IncludeWorkItemLinksAndAttachments",{action:"Telemetry for Copy links and attachments checkbox",copyLinks:s,copyAttachments:r});const _=[a.OobFieldRefNames.ResolvedBy,a.OobFieldRefNames.ResolvedDate,a.OobFieldRefNames.ClosedBy,a.OobFieldRefNames.ClosedDate,"Microsoft.Sync.ProjSrv.RequestedAssnGuid","Microsoft.Sync.ProjSrv.RequestedProjGuid","Microsoft.Sync.ProjSrv.ProjGuid","Microsoft.Sync.ProjSrv.TaskGuid"];l=l||[];for(const e of _){const t=this.getFieldByName(e);t&&l.push(t.fieldDefinition.id)}for(const e of l)g[e]=!0;const R=await k.createWorkItem(i,t);for(const e of S.triggerList)if(!g[e]){const t=null===(h=this.getFieldById(e))||void 0===h?void 0:h.fieldDefinition;t&&this._copyField(R,t,S),g[e]=!0}for(const e of S.fields){const t=null===(c=this.getFieldById(e.id))||void 0===c?void 0:c.fieldDefinition;t&&!g[t.id]&&this._copyField(R,t,S)}if(o){let e;if(this.isNew())e=F.CreateCopyCopiedFromNewWorkItem;else{const t=this._isMarkdownDiscussionEnabled?`#${this.id}`:`<a href='x-mvwit:workitem/${this.id}'>${this._typeData.name} ${this.id}</a>`;let i=F.CreateCopyCopiedFrom;s&&r?i=F.CreateCopyCopiedWithAllLinksAndAttachmentsFrom:s?i=F.CreateCopyCopiedWithAllLinksFrom:r&&(i=F.CreateCopyCopiedWithAllAttachmentsFrom),e=(0,n.format)(i,t)}R.setFieldValueById(a.CoreField.History,e)}if(s||r){const t=this.getLinks();for(const i of t){const t=await i.clone(e,R);t instanceof M.Attachment?r&&m.push(t):!s||!t||u&&-1!==u.indexOf(null!==(I=i.linkData.LinkType)&&void 0!==I?I:Number.NaN)||f.push(t)}}!this.isNew()&&d&&f.push(await M.WorkItemLink.create(e,await M.WorkItemLink.findLinkTypeEnd(e,D.LinkTypeName.Related_Link_Name),this.id,"")),m.length>0&&f.push(...m),f.length>0&&R.addLinks(f);const W=[a.DalFields.RelatedLinks,a.DalFields.AttachedFiles,a.DalFields.BISURI,a.DalFields.LinkedFiles];return this.fieldMap[a.CoreFieldRefNames.Parent]&&W.push(a.CoreField.Parent),R.evaluate(W),R}async copyWithChildren(e,t,i,s,a,r,o,l){const d=await this.copy(e,t,i,s,a,r,o,l,[D.CoreLinkTypes.Child]);if(!d.isValid()){const e=d.getInvalidFields()[0].error;throw Error(e)}const u=this.getLinks().filter((e=>e.linkData.LinkType===D.CoreLinkTypes.Child)).map((e=>e.linkData.ID));if(u.length>100)throw Error((0,n.format)(F.CreateCopyTooManyChildren,100));if(u.length>0){const i=this._pageContext.getService("IWorkItemModelService"),h=(await i.getWorkItems(u)).filter((e=>e.project.guid===d.project.guid)),c=await(0,m.mapAsyncSerial)(h,(async i=>{const d=await i.copy(e,t,i.getTypeData(),s,a,r,o,l,[D.CoreLinkTypes.Parent]);if(!d.isValid()){const e=d.getInvalidFields()[0].error;throw Error((0,n.format)(F.CreateCopyErrorCopyingChild,i.id,e))}return d})),I=e.getService("IWorkItemSavingService");await I.saveWorkItemsBatchAsync(c);const f=await(0,m.mapAsyncSerial)(c,(t=>M.WorkItemLink.create(e,D.LinkTypeName.Child_Link_Name,t.id)));d.addLinks(f)}return e.getService("IVssTelemetryService").publishEvent("WIT","WorkItem.CopyWithChildren",{action:"Copy work item with children",copyLinks:s,copyAttachments:a,children:u.length}),d}changeWorkItemType(e,t,i,s){this._isChangeProjectInProgress=!!t&&this.project.id!==t.id;const r=this._typeData.referenceName,n=this._getFieldChangeOnBugTypeChanged(this._typeData,e);this._typeData=e,this._ruleEngine=void 0,this._initializeFields(e);for(const e of Object.keys(this._fieldData))this._defineFieldById(Number(e));if(null==s||s.forEach((e=>{this.fieldMapById[e.id]||this._defineField(e)})),this.extensions=i||[],this._defineExtensionFields(),t&&this._isChangeProjectInProgress&&this._setProject(t),r!==e.referenceName){this.setFieldValueById(a.CoreField.WorkItemType,e.name);for(const e in n)this.setFieldValueByName(e,n[e])}this.evaluate(),this._isChangeProjectInProgress=!1}_setProject(e){this._projectData=e,this.project=new x.Project(this.store,e),this.setFieldValueById(a.CoreField.TeamProject,e.name,{preventFire:!0})}_getFieldChangeOnBugTypeChanged(e,t){var i;const s={},r=this._isBugTypeChange(e),o=this._isBugTypeChange(t);if(!r&&!o)return s;const l=`<b><u><br/><br/>${(0,n.format)(F.WorkItemChangedReproDescriptionMessage,null===(i=this.getFieldByName(r?D.BugWITFieldReferenceNames.ReproSteps:a.CoreFieldRefNames.Description))||void 0===i?void 0:i.fieldDefinition.name,e.name,t.name)}</u></b><br/>`,d=this.getFieldValueByName(D.BugWITFieldReferenceNames.ReproSteps),u=this.getFieldValueByName(a.CoreFieldRefNames.Description);return r?d&&!(0,R.isHtmlVisuallyBlank)(d)&&(s[a.CoreFieldRefNames.Description]=u?u+l+d:l+d):o&&u&&!(0,R.isHtmlVisuallyBlank)(d)&&(s[D.BugWITFieldReferenceNames.ReproSteps]=d?d+l+u:l+u),s}_isBugTypeChange(e){return!!e.fields&&e.fields.some((e=>{var t,i;return(0,n.equals)(null!==(i=null===(t=this._fieldLookup[e])||void 0===t?void 0:t.referenceName)&&void 0!==i?i:"",D.BugWITFieldReferenceNames.ReproSteps,!0)}))}async _evaluateWorkItemTypeChange(e,t){if((0,n.equals)(e,this._projectData.name,!0)&&(0,n.equals)(t,this._originalTypeData.name,!0)&&this._resetWorkItemTypeChanges(),!(0,n.equals)(t,this._typeData.name,!0)){let i=this._projectData;const s=this._pageContext.getService("IWorkItemDataManager");if(!(0,n.equals)(e,this._projectData.name,!0)){const t=this._pageContext.getService("IWorkItemNodeService"),a=await s.beginGetFieldProjectData(e),r=await t.getAreaPathNodes(e),n=await t.getIterationNodes(e),o=null==a?void 0:a.projects.find((t=>t.name===e));if(!o||!r||!n)return void console.warn(`Failed to find project data for project ${e}, aborting update of work item type for work item ${this.getUniqueId()}`);i=Object.assign(Object.assign({},o),{areaNodes:r,iterationNodes:n})}const a=await s.beginGetWorkItemTypeData(i.guid,[t]);a&&a[0]&&(this.changeWorkItemType(a[0],i),this._typeData=a[0])}}_resetWorkItemTypeChanges(){if(this.hasWorkItemTypeChanged()){const e={SourceType:this._originalTypeData.name,DestinationType:this.workItemType.name};(0,n.equals)(this.project.guid,this._originalTypeData.projectGuid)?(0,I.publishEvent)(this._pageContext,D.WITCustomerIntelligenceArea.WORK_ITEM_TRACKING,D.WITCustomerIntelligenceFeature.CLIENTSIDEOPERATION_WIT_MOVE_REVERT,e):(0,I.publishEvent)(this._pageContext,D.WITCustomerIntelligenceArea.WORK_ITEM_TRACKING,D.WITCustomerIntelligenceFeature.CLIENTSIDEOPERATION_WIT_TYPE_CHANGE_REVERT,e),this.changeWorkItemType(this._originalTypeData,this._originalProjectData,this._originalExtensions)}}setExtensions(e){this.extensions=e||[],this._originalExtensions=this.extensions,this._defineExtensionFields(),this._ruleEngine=void 0}_defineExtensionFields(){this.extensions&&this.extensions.forEach((e=>{e.markerField&&this._defineField(e.markerField.field),e.fields&&e.fields.forEach((e=>{this._defineField(e.field)}))}))}addPromiseToWait(e){const t=this.promiseToWaitId++;this.promisesToWait.set(t,e),e.then(void 0,(e=>{this.setError(e),this.promisesToWait.delete(t)}))}cleanPromisesToWait(){this.promisesToWait.clear(),this.promiseToWaitId=0}async waitForPromisesResolving(){try{this.saving.value=!0,await Promise.all(Array.from(this.promisesToWait.values()))}finally{this.saving.value=!1,this.cleanPromisesToWait()}}}t[e].WorkItem=i,i.tempIdSeed=0,i.FIELD_ID_TO_DEPENDENT_ID_MAP={[a.DalFields.AttachedFiles]:[a.CoreField.AttachedFileCount],[a.DalFields.RelatedLinks]:[a.CoreField.RelatedLinkCount,a.CoreField.Parent],[a.DalFields.LinkedFiles]:[a.CoreField.HyperLinkCount],[a.DalFields.BISURI]:[a.CoreField.ExternalLinkCount],[a.DalFields.HistoryId]:[a.CoreField.CommentCount]}}("WorkItemWorkItem"),function(e){t.ServicesWorkItemModelService={};const i="TagsMru",s="Tags";class r extends l.VssService{constructor(){super(...arguments),this.workItemTypeExtensions={},this.workItemPromiseCache=new Map}_serviceStart(e){super._serviceStart(e),this.workItemDataManager=e.getService("IWorkItemDataManager"),this.workItemMap={}}addWorkItemToMap(e,t){this.workItemMap[e]=t}clearWorkItems(){this.workItemPromiseCache.clear(),this.workItemMap={},this.workItemTypeExtensions={}}clearWorkItem(e){this.workItemPromiseCache.delete(e),delete this.workItemMap[e]}async createWorkItem(e,t,i){var s,a,r,n,o,l,d;const u=await this.getFieldProjectData(t);let h={};e.rules.globals.length>0&&(h=await this.getConstantSets(e.rules.globals));const c=this.pageContext.getService("IWorkItemNodeService"),I=await c.getAreaPathNodes(t),m=await c.getIterationNodes(t);if(void 0===I||void 0===m)throw new Error("Unable to find area or iteration nodes for project: "+t);let f=(await c.getMruAreaPaths(t))[0],g=(await c.getMruIterations(t))[0];if(this.checkPage()){const e=this.pageContext.getService("ITeamSettingsService"),t=await e.getTeamSettings();(null===(s=null==t?void 0:t.referencedNodes)||void 0===s?void 0:s.areaNodes)&&(f=null!==(r=null===(a=null==t?void 0:t.referencedNodes)||void 0===a?void 0:a.areaNodes[0].id)&&void 0!==r?r:f),t&&(g=null!==(d=null!==(o=null===(n=t.defaultIteration)||void 0===n?void 0:n.nodeId)&&void 0!==o?o:null===(l=t.currentIteration)||void 0===l?void 0:l.nodeId)&&void 0!==d?d:g)}f||(f=I.id);const p={areaPathMru:f,areaPathNodes:I,iterationPathMru:g,iterationPathNodes:m};if(u)return await this.createWorkItemModel(e,u,p,h,i);throw new Error(F.FailedToRetrieveProjectDataForId)}checkPage(){const e=this.pageContext.getService("IVssNavigationService").getRouteValues().pivot;return"backlog"===e||"board"===e||"taskboard"===e}async getWorkItems(e,t,i,s,r,o){if(!e||!e.length)return[];const l=[],d=[];if(e.forEach((e=>{const t=this.workItemMap[e];t&&!r?l.push(t):d.includes(e)||d.push(e)})),d.length){const e=void 0===o||1===o,r=await this.workItemDataManager.beginGetWorkItemData(d,t,i,s,o);if(!r||e&&r.length!==d.length){const e=d.filter((e=>!(null==r?void 0:r.some((e=>{e.fields[a.DalFields.IDId]})))));console.error((0,n.format)(F.FailedToRetrieveWorkItemDataForIds,e.join(", ")))}else{const e=new Map,t=new Map;for(const i of r){let s;const r=`${i.projectId}-${i.fields[a.DalFields.WorkItemTypeId]}`;let n;if(e.has(r)?s=e.get(r):(s=await this.workItemDataManager.beginGetWorkItemTypeData(i.projectId,[i.fields[a.DalFields.WorkItemTypeId]]),e.set(r,s)),t.has(i.projectId)?n=t.get(i.projectId):(n=await this.workItemDataManager.beginGetFieldProjectData(i.projectId),t.set(i.projectId,n)),s&&n){let e={};s[0].rules.globals.length>0&&(e=await this.getConstantSets(s[0].rules.globals));const t=this.pageContext.getService("IWorkItemNodeService"),a=await t.getAreaPathNodes(i.projectId),r=await t.getIterationNodes(i.projectId);if(void 0===a||void 0===r)throw new Error("Unable to find area or iteration nodes for project: "+i.projectId);const o=await this.createWorkItemModel(s[0],n,{areaPathNodes:a,iterationPathNodes:r},e,i);l.push(o)}}}}return l}async refreshWorkItemLinks(e){const t=e.getLinks().filter((e=>0===(0,n.localeIgnoreCaseComparer)(e.baseLinkType,"WorkItemLink")));for(const e of t){if(!e.linkData.ID)continue;this.clearWorkItem(e.linkData.ID);(await this.getWorkItem(e.linkData.ID)).refresh().catch((e=>alert(e)))}}async getWorkItem(e,t){let i=this.workItemPromiseCache.get(e);i||(i=this.getWorkItems([e],null==t?void 0:t.isDeleted,null==t?void 0:t.includeRecentActivity,null==t?void 0:t.includeHistory),this.workItemPromiseCache.set(e,i));const s=await i;if(!s.length)throw Error((0,n.format)(F.InvalidWorkItemId,e));return s[0]}getWorkItemTypeData(e,t){return this.workItemDataManager.beginGetWorkItemTypeData(e,t)}async getConstantSets(e){const t=await this.workItemDataManager.beginGetConstantSets(e);return null!==t?t:{}}getFieldProjectData(e){return this.workItemDataManager.beginGetFieldProjectData(e)}async getFieldLookup(e){const t=await this.getFieldProjectData(e),i={};return t&&t.fields.forEach((e=>{i[e.id]=e,i[e.referenceName]=e})),i}async addTagsMru(e){const t=await this.getTagsMRU(),a=(0,L.subtract)(t,e),r=e.concat(a);r.splice(5),this.workItemTagsMruCache=r;const n={};n[`${i}/${s}`]=r;return this.pageContext.getService("ISettingsService").setEntries(n,0)}async getTagsMRU(){this.workItemTagsMruCache&&this.workItemTagsMruCache.slice();const e=this.pageContext.getService("ISettingsService"),t=await e.getEntriesAsync(i,0),a=t&&t[s]||[];return this.workItemTagsMruCache=(0,L.subtract)(a,[";;;;;",";SUGGESTIONS;"]),this.workItemTagsMruCache.slice()}async createWorkItemModel(e,t,i,s,a){var r;if(!(a=a||{}).isCommentingAvailable){const e=this.pageContext.getService("IVssContributionService"),t={areaId:i.areaPathMru},s=await e.getDataAsync("ms.vss-work-web.work-item-permissions-data-provider",t),n=!!(null===(r=null==s?void 0:s.saveWorkItemCommentPermission)||void 0===r?void 0:r.hasPermission);a.isCommentingAvailable=n}const n=new H.WorkItem(this.pageContext,e,t,i,s,a);return this.workItemMap[n.id]=n,n}getWorkItemTypeExtensions(e){return new Promise(((t,i)=>this.beginGetWorkItemTypeExtensions(e,t,i)))}beginGetWorkItemTypeExtensions(e,t,i){const s=[];let a=null,r=0,n=0,o=[];const l=()=>{0===n&&t.call(this,o)},u=e=>{const t={controller:"wit",action:"workItemTypeExtensions"},s=this.pageContext.getService("IVssPageService").getData();new d.WorkItemStoreLevelWITDataSource(this.pageContext).getDataFromCacheAsync(t,{extensionIds:e},s.hostId,t.action,"_").then((e=>{const t=e.data;t.forEach((e=>{e.fields.map((e=>e.field))}));let i=[];t.forEach((e=>{this.workItemTypeExtensions[e.id]=e,e.globals&&(i=i.concat(e.globals))})),o=o.concat(t),n--,l()}),i)};if(e&&e.length>0)if(e.forEach((e=>{if(this.workItemTypeExtensions[e])o.push(this.workItemTypeExtensions[e]);else{const t=e.length+15;r+t>1024&&(r=0,a=null),a?a.push(e):(a=[e],s.push(a),n++),r+=t}})),0===s.length)l();else for(;s.length>0;)u(s.pop());else t.call(this,o)}isWorkItemCached(e){return!!this.workItemMap[e]}}l.Services.add("IWorkItemModelService",{serviceFactory:r})}(),function(e){j=t[e]={};t[e].LegacyField=class{constructor(e,t){this._value=t,this._field=e,this.fieldDefinition=e.fieldDefinition}getValue(){return this._value}getDisplayText(e){var t;return null!==(t=(0,L.convertFieldValueToDisplayString)(this._value,e))&&void 0!==t?t:""}setValue(e,t){const i=this._field.workItem.setFieldValueById(this.fieldDefinition.id,e,t);return this._value=e,i}getAllowedValues(){var e;return null===(e=this._field.lists)||void 0===e?void 0:e.allowedValues[0].items}}}("WorkItemLegacyField"),function(e){G=t[e]={};t[e].LegacyTfsClient=class{constructor(e){this._pageContext=e,this._restClient=(0,u.getWorkItemTrackingClient)(e)}async beginAttachmentUpload(e,t,i,s,a,r){return this._restClient.createAttachment(t,e,r,void 0,i)}}}("WorkItemLegacyTfsClient"),function(e){Q=t[e]={};t[e].LegacyTfsConnection=class{constructor(e){this._client=new G.LegacyTfsClient(e)}getHttpClient(e){return this._client}}}("WorkItemLegacyTfsConnection"),function(e){K=t[e]={};t[e].LegacyWorkItemStore=class{constructor(e,t){this.tfsConnection=new Q.LegacyTfsConnection(e),this._linkTypeEnds=t}findLinkTypeEnd(e){const t=(""+e).toUpperCase();for(const i of this._linkTypeEnds){if(i.id===e)return i;if(i.name.toUpperCase()===t)return i;if(i.immutableName.toUpperCase()===t)return i}throw Error()}}}("WorkItemLegacyStore"),function(e){t[e]={};t[e].LegacyWorkItem=class{constructor(e,t,i){this.sessionId="NewWorkItemFormLegacyContainer",this._pageContext=e,this._workItem=t,this._linkTypeEnds=i,this.rev=t.revision.value,this.id=t.id,this.workItemType={name:this._workItem.getFieldValueById(a.CoreField.WorkItemType)},this.project={guid:this._workItem.project.guid,name:this._workItem.project.name,extras:this._workItem.project.extras},this.store=new K.LegacyWorkItemStore(e,i)}getField(e){if("number"==typeof e){const t=this._workItem.getFieldById(e);if(void 0===t)return;return new j.LegacyField(t,this._workItem.getFieldValueById(e))}{const t=this._workItem.getFieldByName(e);if(void 0===t)return;return new j.LegacyField(t,this._workItem.getFieldValueByName(e))}}getState(){return this.getFieldValue(a.CoreField.State)||""}getTitle(){return this.getFieldValue(a.CoreField.Title)||""}isReadOnly(){return this._workItem.isReadOnly()}isCommentingAvailable(){return this._workItem.isCommentingAvailable()}isNew(){return this._workItem.isNew()}isSaving(){return this._workItem.saving.value}getFieldValue(e,t,i){return"number"==typeof e?this._workItem.getFieldValueById(e):this._workItem.getFieldValueByName(e)}setFieldValue(e,t){this._workItem.setFieldValueByName(e,t)}attachFieldChange(e,t){}detachFieldChange(e,t){}attachWorkItemChanged(e){}detachWorkItemChanged(e){}getComputedFieldValue(e,t){return this._workItem.getComputedFieldValue(e)}getWorkItemContract(){if(this.isNew())return null;const e={};return this._workItem.fields.forEach((t=>{e[t.fieldDefinition.referenceName]=this.getFieldValue(t.fieldDefinition.referenceName)})),{id:this.id,rev:this._workItem.revision.value,relations:null,fields:e,_links:null,url:this.getResourceUrl()}}getResourceUrl(){const e=this._pageContext.getRestClient("IWorkItemTrackingRestClient")._options.rootPath;return`${window.location.origin}${e}_apis/wit/workItems/${this.id}`}getLinks(){return this._workItem.getLinks().map((e=>{const t={linkData:e.linkData,workItem:{id:this._workItem.id},getAddedDate:()=>e.getAddedDate(),getComment:()=>e.getComment(),getFilePath:()=>e.linkData.FilePath,getFieldId:()=>e.getFieldId(),getLength:()=>e.linkData.Length,getName:()=>e.linkData.OriginalName,getUri:e=>"",remove:()=>{this._workItem.removeLinks([e])},getTargetId:()=>e.linkData.ID,getLinkTypeEnd:()=>{var t;for(let i=0;i<this._linkTypeEnds.length;i++){const s=this._linkTypeEnds[i];if(e.linkData.LinkType===s.linkType.reverseEnd.id)return{immutableName:null===(t=s.linkType)||void 0===t?void 0:t.reverseEnd.immutableName}}},open:()=>{var t;null===(t=this.getAttachmentUri)||void 0===t||t.call(this,e.linkData).then((t=>{const i=e.linkData.OriginalName,s=t.concat(i?`?fileName=${i}`:"");window.open(s,"_blank")}))}};return Object.defineProperty(t,"comment",{get:function(){return e.comment},set:function(t){e.setComment(t)}}),t}))}addLink(e){this._workItem.addLinks([this.getReplatLink(e)])}removeLinks(e){const t=e.map((e=>this.getReplatLink(e)));this._workItem.removeLinks(t)}getReplatLink(e){const t={ID:e.linkData.ID,Comment:e.comment,FilePath:e.linkData.FilePath,FldID:e.linkData.FldID,OriginalName:e.linkData.OriginalName,Length:e.linkData.Length,LastWriteDate:e.linkData.LastWriteDate,ExtID:e.linkData.ExtID,CreationDate:e.linkData.CreationDate,RemovedDate:e.linkData.RemovedDate,AddedDate:e.linkData.AddedDate,LinkType:e.linkData.LinkType};return M.Link.createFromLinkData(t)}}}("WorkItemLegacyWorkItem"),function(e){t.ServicesWorkItemFormUnsavedChangesService={};class i extends l.VssService{constructor(){super(...arguments),this.workItems=[],this.saving=new r.ObservableValue(!1),this.unsavedChangesDialogShown=!1,this.errorUnsavedWorkItems=new r.ObservableArray([]),this.filters=new Set,this.resolveDialog=(e,t,i)=>{this.unsavedChangesDialogShown=!1,t(),i(e)},this.onBeforeUnload=e=>{this.isDirty()&&(e.returnValue="dirtyState",e.preventDefault())},this.onFpsStarting=e=>{[...this.filters.values()].some((t=>!t(e)))||!this.isDirty()||e.detail.data&&e.detail.data.userConfirmed||(e.preventDefault(),e.detail.cancellationReason="dirtyState",this.showMessage().then((t=>{t&&(0,v.FastPageSwitch)(e.detail.pageContext,e.detail.href,e.detail.recordHistoryEntry,Object.assign(Object.assign({},e.detail.data),{userConfirmed:!0}))})))},this.isDirty=()=>{for(const e of this.workItems)if(e.dirty.value)return!0;return!1},this.saveWorkItems=(e,t)=>{const i=this.pageContext.getService("IWorkItemSavingService");this.saving.value=!0,i.saveWorkItemsBatchAsync(this.workItems.filter((e=>e.dirty.value))).then(e,t)},this.saveWorkItem=(e,t,i)=>{this.saving.value=!0,i().then(e).catch(t)},this.resetWorkItems=()=>{for(const e of this.workItems)e.resetChanges()},this.resetWorkItem=e=>{e.resetChanges()},this.getWorkItemTitles=e=>e.map((e=>e.getCaption({excludeTempId:!0}))).join(", "),this.getWorkItemTitle=e=>e.getCaption({excludeTempId:!0})}isUnsavedChangesDialogActive(){return this.unsavedChangesDialogShown}_serviceStart(e){super._serviceStart(e),document.body.addEventListener("fpsStarting",this.onFpsStarting),window.addEventListener("beforeunload",this.onBeforeUnload)}_serviceEnd(e){super._serviceEnd(e),document.body.removeEventListener("fpsStarting",this.onFpsStarting),window.removeEventListener("beforeunload",this.onBeforeUnload),this.filters.clear()}register(e){this.workItems.includes(e)||this.workItems.push(e)}unregister(e){this.workItems=this.workItems.filter((t=>t!==e))}registerFPSFilter(e){this.filters.add(e)}async showMessage(e,t){const i=this.pageContext.getService("IVssLayoutManager");return this.unsavedChangesDialogShown?Promise.resolve(!1):(this.unsavedChangesDialogShown=!0,new Promise((s=>i.renderCallout((i=>k.createElement(y.Observer,{errorUnsavedWorkItems:this.errorUnsavedWorkItems,saving:this.saving},(a=>k.createElement(E.Dialog,{footerButtonProps:[{text:F.Cancel,onClick:()=>{this.resolveDialog(!1,i,s)}},{text:F.DiscardChanges,onClick:()=>{e?this.resetWorkItem(e):this.resetWorkItems(),this.resolveDialog(!0,i,s)}},{onClick:()=>{const a=()=>{this.saving.value=!1,this.resolveDialog(!0,i,s)},r=e=>{this.saving.value=!1,this.errorUnsavedWorkItems.value=e.results?e.results.filter((e=>!!e.error)).map((e=>e.workItem)):[]};e&&t?this.saveWorkItem(a,r,t):this.saveWorkItems(a,r)},primary:!0,text:F.SaveChanges}],modal:!0,onDismiss:()=>{this.resolveDialog(!1,i,s)},overlay:a.saving?{spinnerLabel:F.SavingWorkItems}:void 0,titleProps:{text:F.DirtyNavDialogTitle}},k.createElement("div",{className:"padding-vertical-4"},k.createElement("div",null,F.DirtyNavDialogUnsavedChanges),k.createElement("div",null,e?this.getWorkItemTitle(e):this.getWorkItemTitles(this.workItems.filter((e=>e.dirty.value))))),k.createElement("div",{className:"padding-vertical-4"},F.DirtyNavDialogOptions),0!==this.errorUnsavedWorkItems.length&&k.createElement("div",{className:"error-text padding-vertical-4"},k.createElement("div",null,F.DirtyNavDialogSavingFailure," "),k.createElement("div",null,this.getWorkItemTitles(a.errorUnsavedWorkItems)))))))))))}}l.Services.add("IWorkItemFormUnsavedChangesService",{serviceFactory:i})}()}),["Resources","OM/WorkItemConstants","OM/index","RuleEngine/FilterByScope","RuleEngine/FieldValidationKey","RuleEngine/ServerDefaultValue","Utils","WorkItem/Sorting","WorkItem/FieldDefinitionUtils","WorkItem/FieldUtils","RuleEngine/RuleValueFrom","RuleEngine/WorkItemIdentityScope","RuleEngine/RuleEvaluator","RuleEngine/RuleEngine","RuleEngine/WorkItemStore","Services/IWorkItemEventService","Services/IWorkItemFieldEventService","Services/IWorkItemModelService","WorkItem/Links","Services/WorkItemSavingService","WorkItem/WorkItemType","WorkItem/Project","WorkItem/WorkItem","Services/WorkItemModelService","WorkItem/LegacyField","WorkItem/LegacyTfsClient","WorkItem/LegacyTfsConnection","WorkItem/LegacyStore","WorkItem/LegacyWorkItem","Services/WorkItemFormUnsavedChangesService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-model"}}));