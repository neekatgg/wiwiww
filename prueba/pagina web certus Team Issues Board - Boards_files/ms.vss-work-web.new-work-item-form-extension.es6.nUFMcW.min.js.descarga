"use strict";define("Wit/WorkItemFormExtension",["require","exports","Tfs/Platform/Page","VSS/Core/Util/String","VSS/Features/PlatformUI/MessageDialog","VSS/Platform/Context","VSS/Platform/Telemetry","VSS/Platform/Trace","Wit/Common/Generated/Constants","Wit/Identity/Utilities/WorkItemIdentityHelper","Wit/WorkItemModel/OM/index","Wit/WorkItemModel/Utils","Wit/WorkItemModel/WorkItem/FieldUtils","Wit/WorkItemModel/WorkItem/Links","VSS/Platform/Feature","Wit/Common/Constants/FeatureFlags"],(function(e,t,r,i,o,n,s,a,l,m,c,I,k,d,u,g){var h,W;h=t[W="Resources"]={},t[W].AttachmentsNotSupported="Invalid link type, Attachments not supported",t[W].ConfirmWorkItemRefresh="You have unsaved changes to this work item which will be lost. Are you sure you want to refresh this work item?",t[W].ConfirmWorkItemRevert="You have unsaved changes to this work item which will be lost. Are you sure you want to revert your changes to the work item?",t[W].ContributionBlockingWITSave="Saving the work item is blocked by the extension {0}.",t[W].ErrorExtensionService_CannotRefreshWorkItem="You cannot refresh a work item that is new",t[W].ErrorExtensionService_CannotRevertWorkItem="You cannot revert a work item that is new or not dirty",t[W].InvalidArgumentExpectingArray="Invalid argument, expecting array of WorkItemRelations",t[W].InvalidWorkItemUrl="WorkItem url not valid: {0}",t[W].LinkFormWorkItemNotFound="Work item not found or no permission to access it.",t[W].LinksControlDuplicateRemoteLink="A remote work item link already exist.",t[W].NoActiveWorkItem="Active work item document does not exist in the current context",t[W].Revert="Revert",t[W].WorkItemFormIsReadonly="Work item form is readonly",t[W].WorkItemNotSaveable="Work item can not be saved in its current state. Its either not changed or has errors.",t.IWorkItemFormExtensionService={},t.IWorkItemFormNavigationService={},function(e){async function W(e,t){if(function(e){return!(!e||void 0===e.displayName)}(t)){const r=await(0,m.convertPotentialIdentityRefFromFieldValue)(e,t);return r&&r.identityRef}return t}t[e]={};class p{constructor(e,t,r){this._contributionId=e,this._contributionInstanceId=t,this.pageContext=r,this._useOptionalDotRegex=!(0,u.isFeatureFlagEnabled)(r,g.FeatureFlags.UseStrictDoubleParsing,!1)}getId(){return Promise.resolve(this._getWorkItem().id)}getRevision(){return Promise.resolve(this._getWorkItem().revision.value)}getFields(){return Promise.resolve(this._getWorkItem().fields.map((e=>this._mapWorkItemFieldToFieldContract(e))))}async getFieldValue(e,t){const{returnOriginalValue:r}=this._getFieldOptions(t);return this._getWorkItem().getFieldValueByName(e,r)}async getIdentityFieldValue(e,t){const{returnOriginalValue:r}=this._getFieldOptions(t),i=this._getWorkItem().getFieldValueByName(e);return async function(e,t,r){if(t&&t.fieldDefinition.isIdentity){const r=t.workItem.getFieldValueById(t.fieldDefinition.id),i=await(0,m.convertPotentialIdentityRefFromFieldValue)(e,r);return i&&i.identityRef}if(r)return t.workItem.getFieldValueById(t.fieldDefinition.id)}(this.pageContext,i,r)}async getFieldValues(e,t){const{returnOriginalValue:r}=this._getFieldOptions(t),i=this._getWorkItem(),o={};return e instanceof Array&&e.forEach((e=>{o[e]=i.getFieldValueByName(e,r)})),o}async setFieldValue(e,t){const r=this._getWorkItem();if(r.isReadOnly())return!1;const i=await W(this.pageContext,t);return r.setFieldValueByName(e,i)}async setFieldValues(e){const t=this._getWorkItem(),r={},i=this._getWorkItem().isReadOnly();if(e)for(const o in e)if(i)r[o]=!1;else{const i=await W(this.pageContext,e[o]);r[o]=t.setFieldValueByName(o,i)}return r}async getAllowedFieldValues(e){const t=this._getWorkItem(),r=t.getFieldByName(e);return r?(0,k.computeAllowedFieldValues)(r,t,this._useOptionalDotRegex):[]}async filterAllowedFieldValues(e,t){try{(0,s.publishEvent)(this.pageContext,c.WITCustomerIntelligenceArea.WORK_ITEM_TRACKING,c.WITCustomerIntelligenceFeature.FILTER_METHOD_USAGE,{})}catch(e){}const r=this._getWorkItem(),i=r.getFieldByName(e);if(!i)return;const o=(0,k.computeAllowedFieldValues)(i,r,this._useOptionalDotRegex).map((e=>(0,k.convertFieldValueToDisplayString)(e,this._useOptionalDotRegex)));if((0,k.fieldHasList)(i)&&!i.fieldDefinition.isIdentity){const e=new Set;o.forEach((t=>{e.add(t)})),t=t.filter((t=>e.has(t))),(0,k.setAllowedFieldValues)(i,t)}}async getFilteredAllowedFieldValues(e){const t=this._getWorkItem().getFieldByName(e);return t?(0,k.getAllowedFieldValues)(t,t.workItem,this._useOptionalDotRegex).value:[]}isDirty(){return Promise.resolve(this._getWorkItem().dirty.value)}isNew(){return Promise.resolve(this._getWorkItem().isNew())}isValid(){return Promise.resolve(this._getWorkItem().isValid())}setError(e){if(this._getWorkItem().isReadOnly())return Promise.reject(h.WorkItemFormIsReadonly);const t=e||(0,i.format)(h.ContributionBlockingWITSave,this._contributionId);return this._getWorkItem().setContributionErrorStatus(this._contributionInstanceId,!1,t),Promise.resolve()}clearError(){return this._getWorkItem().setContributionErrorStatus(this._contributionInstanceId,!0),Promise.resolve()}save(){return this._getWorkItem().isReadOnly()?Promise.reject(h.WorkItemFormIsReadonly):new Promise(((e,t)=>{this.beginSaveWorkItem(e,t)}))}async refresh(){return new Promise(((e,t)=>{const r=this._getWorkItem();if(r.isNew())return void t(h.ErrorExtensionService_CannotRefreshWorkItem);const i=()=>{r.refresh().catch((e=>t(e))),e()};r.dirty.value?(0,o.showMessageDialog)(this.pageContext,{message:h.ConfirmWorkItemRefresh,onClose:e=>e&&i()}):i()}))}async reset(){return this._getWorkItem().isReadOnly()?Promise.reject(h.WorkItemFormIsReadonly):new Promise(((e,t)=>{const r=this._getWorkItem();!r.dirty.value||r.isNew()||r.saving.value?t(h.ErrorExtensionService_CannotRevertWorkItem):(0,o.showMessageDialog)(this.pageContext,{message:h.ConfirmWorkItemRevert,okButtonProps:{text:h.Revert},onClose:r=>{r&&(this._getWorkItem().reset(),e()),t(r)}})}))}getInvalidFields(){return Promise.resolve(this._getWorkItem().getInvalidFields().map((e=>this._mapWorkItemFieldToFieldContract(e))))}getDirtyFields(e){return Promise.resolve(this._getWorkItem().getDirtyFields(!e).map((e=>this._mapWorkItemFieldToFieldContract(e))))}async addWorkItemRelations(e){if(this._getWorkItem().isReadOnly())return Promise.resolve();if(e instanceof Array){const t=this._getWorkItem();for(const r of e){const e=r.attributes?r.attributes.comment:null;if(this._isResourceLinkTypeFromRelation(r)){const i=r.attributes?r.attributes.name:null;let o;switch(r.rel){case l.WorkItemLinkConstants.HYPERLINKLINKTYPE:o=d.Hyperlink.create(r.url,e);break;case l.WorkItemLinkConstants.ARTIFACTLINKTYPE:o=d.ExternalLink.create(i,r.url,e)}if(!o)throw new Error(h.AttachmentsNotSupported);t.addLinks([o])}else if(await this._isRemoteLinkType(r))try{await this._addRemoteWorkItemRelation(r)}catch(e){throw e}else{const i=this._getWorkItemIdFromUrl(r.url);t.addLinks([await d.WorkItemLink.create(this.pageContext,r.rel,i,e)])}}}return Promise.resolve()}async removeWorkItemRelations(e){var t,r;if(this._getWorkItem().isReadOnly())return Promise.resolve();if(!(e instanceof Array))throw new Error(h.InvalidArgumentExpectingArray);const i=this._getWorkItem(),o=[],n=i.getLinks();for(const i of e){const e=this._getRelationLinkTypeFromRelation(i);let s=-1;if(e===l.DalFields.AttachedFiles)throw new Error(h.AttachmentsNotSupported);e===l.DalFields.RelatedLinks&&(s=this._getWorkItemIdFromUrl(i.url));for(const a of n)if(!a.isRemoved()&&e===a.linkData.FldID)if(a.linkData.FldID===l.DalFields.RelatedLinks){const e=a.getWitLinkTypeEndId();if(e){const t=await d.WorkItemLink.findLinkTypeEnd(this.pageContext,e);if(i.rel.toUpperCase()===t.immutableName.toUpperCase()&&s===a.linkData.ID){o.push(a);break}}}else{const e=null===(r=null===(t=a.linkData)||void 0===t?void 0:t.FilePath)||void 0===r?void 0:r.toUpperCase();if(i.url.toUpperCase()===e){o.push(a);break}}}return i.removeLinks(o),Promise.resolve()}async getWorkItemRelations(){const e=this._getWorkItem().getLinks().filter((e=>!e.isRemoved()&&e.linkData.FldID!==l.DalFields.AttachedFiles));return Promise.all(e.map((async e=>({attributes:e.getAttributes(),rel:await e.getRelationType(this.pageContext),url:await e.getLinkUrl(this.pageContext,(0,r.getTFSPageData)(this.pageContext).project.id)}))))}async getWorkItemResourceUrl(e){return Promise.resolve((0,I.getWorkItemUrl)(this.pageContext,(0,r.getTFSPageData)(this.pageContext).project.id,e))}async getWorkItemRelationTypes(){const e=[],t=await d.WorkItemLink.getLinkTypes(this.pageContext);for(const r of t)e.push({attributes:{[l.WorkItemLinkConstants.ATTRIBUTES_USAGE]:l.WorkItemLinkConstants.WORKITEMLINKUSAGE,[l.WorkItemLinkConstants.ATTRIBUTES_EDITABLE]:r.canEdit,[l.WorkItemLinkConstants.ATTRIBUTES_ENABLED]:r.isActive,[l.WorkItemLinkConstants.ATTRIBUTES_ACYCLIC]:r.isNonCircular,[l.WorkItemLinkConstants.ATTRIBUTES_DIRECTIONAL]:r.isDirectional,[l.WorkItemLinkConstants.ATTRIBUTES_SINGLETARGET]:r.isOneToMany,[l.WorkItemLinkConstants.ATTRIBUTES_TOPOLOGY]:r.topology},referenceName:r.forwardEnd.immutableName,name:r.forwardEnd.name,url:"",_links:null}),r.forwardEnd.isForwardLink!==r.reverseEnd.isForwardLink&&e.push({attributes:{[l.WorkItemLinkConstants.ATTRIBUTES_USAGE]:l.WorkItemLinkConstants.WORKITEMLINKUSAGE,[l.WorkItemLinkConstants.ATTRIBUTES_EDITABLE]:r.canEdit,[l.WorkItemLinkConstants.ATTRIBUTES_ENABLED]:r.isActive,[l.WorkItemLinkConstants.ATTRIBUTES_ACYCLIC]:r.isNonCircular,[l.WorkItemLinkConstants.ATTRIBUTES_DIRECTIONAL]:r.isDirectional,[l.WorkItemLinkConstants.ATTRIBUTES_SINGLETARGET]:r.isOneToMany,[l.WorkItemLinkConstants.ATTRIBUTES_TOPOLOGY]:r.topology},referenceName:r.reverseEnd.immutableName,name:r.reverseEnd.name,url:"",_links:null});for(const t of l.WorkItemLinkConstants.RESOURCELINKTYPES)e.push({attributes:{[l.WorkItemLinkConstants.ATTRIBUTES_USAGE]:l.WorkItemLinkConstants.RESOURCELINKUSAGE,[l.WorkItemLinkConstants.ATTRIBUTES_EDITABLE]:!1,[l.WorkItemLinkConstants.ATTRIBUTES_ENABLED]:!0},referenceName:t,name:"",url:"",_links:null});return Promise.resolve(e)}hasActiveWorkItem(){return Promise.resolve(this._hasActiveWorkItem())}async beginSaveWorkItem(e,t){if(await this.isDirty()&&await this.isValid()){this._getWorkItem().isReadOnly()&&t(new Error(h.WorkItemFormIsReadonly));try{await this._getWorkItem().save(),e(),(0,s.publishEvent)(this.pageContext,"WIT","SaveWorkItemFromExtension",{}),(0,a.trace)(this.pageContext,{area:"WIT",feature:"WorkItem",level:3,component:"WorkItemFormExtensionService",exceptionType:"",message:"WorkItemExtension.saveComplete",method:"",properties:{action:"WorkItemExtension.saveComplete"}})}catch(e){t(e)}}else t(new Error(h.WorkItemNotSaveable))}async _addRemoteWorkItemRelation(e){}_hasActiveWorkItem(){return!!this.pageContext.getService("ms.vss-work-web.active-work-item-service").activeWorkItem}_getWorkItem(){if(!this._hasActiveWorkItem())throw new Error(h.NoActiveWorkItem);return this.pageContext.getService("ms.vss-work-web.active-work-item-service").activeWorkItem}_getWorkItemIdFromUrl(e){if(e){const t=(e=e.trim()).lastIndexOf("/");if(-1!==t&&t<e.length-1){const r=e.substring(t+1),i=parseInt(r);if(!isNaN(i))return i}}throw new Error((0,i.format)(h.InvalidWorkItemUrl,e))}_isResourceLinkTypeFromRelation(e){const t=this._getRelationLinkTypeFromRelation(e);return this._isResourceLinkType(t)}_isResourceLinkType(e){switch(e){case l.DalFields.BISURI:case l.DalFields.AttachedFiles:case l.DalFields.LinkedFiles:return!0;default:return!1}}async _isRemoteLinkType(e){const t=e.rel.toUpperCase(),r=await d.WorkItemLink.findLinkTypeEnd(this.pageContext,t);return!!r.linkType&&r.linkType.isRemote}_getRelationLinkTypeFromRelation(e){switch(e.rel.toUpperCase()){case l.WorkItemLinkConstants.ATTACHEDLINKTYPE.toUpperCase():return l.DalFields.AttachedFiles;case l.WorkItemLinkConstants.HYPERLINKLINKTYPE.toUpperCase():return l.DalFields.LinkedFiles;case l.WorkItemLinkConstants.ARTIFACTLINKTYPE.toUpperCase():return l.DalFields.BISURI;default:return l.DalFields.RelatedLinks}}_getUsage(e){switch(e.fieldDefinition.usages){case l.FieldUsages.Tree:return 3;case l.FieldUsages.WorkItem:return 1;case l.FieldUsages.WorkItemLink:return 2;case l.FieldUsages.WorkItemTypeExtension:return 4;default:return 0}}_mapWorkItemFieldToFieldContract(e){const t=this._mapWorkItemFieldType(e.fieldDefinition.type);return{name:e.fieldDefinition.name,referenceName:e.fieldDefinition.referenceName,readOnly:(0,k.isReadOnly)(e),canSortBy:(0,k.canSortBy)(e),isQueryable:(0,k.isQueryable)(e),supportedOperations:[],description:"",type:t,_links:null,isIdentity:e.fieldDefinition.isIdentity,isPicklist:!1,isPicklistSuggested:!1,picklistId:"",usage:this._getUsage(e),isDeleted:!1,url:""}}_mapWorkItemFieldType(e){switch(e){case l.FieldType.Boolean:return 9;case l.FieldType.DateTime:return 2;case l.FieldType.Double:return 7;case l.FieldType.Guid:return 8;case l.FieldType.History:return 6;case l.FieldType.Html:return 4;case l.FieldType.Integer:return 1;case l.FieldType.Internal:return null;case l.FieldType.PlainText:return 3;case l.FieldType.String:return 0;case l.FieldType.TreePath:return 5;default:return null}}_isWorkItemOptions(e){if(e){return void 0!==e.returnOriginalValue}return!1}_getFieldOptions(e){let t=!1;return this._isWorkItemOptions(e)?({returnOriginalValue:t}=Object.assign({},e)):e&&(t=e),{returnOriginalValue:t}}}t[e].WorkItemFormExtensionService=p;class v extends n.VssService{_serviceStart(e){this._serviceInstances={},this.pageContext=e}getInstance(e,t){const r=`${e}-${t}`;let i=this._serviceInstances[r];return i||(i=new p(e,t,this.pageContext),i[n.RemoteSerializationSettingsKey]={proxyFunctions:!0,ignoredProperties:{pageContext:!0}},this._serviceInstances[r]=i),i}}t[e].WorkItemFormExtensionServiceFactory=v;n.Services.add("ms.vss-work-web.work-item-form-extension-service-factory",{serviceFactory:v,options:1});class y extends n.VssService{setActiveWorkItem(e){this.activeWorkItem=e}}t[e].ActiveWorkItemService=y;n.Services.add("ms.vss-work-web.active-work-item-service",{serviceFactory:y,options:1})}("WorkItemFormExtensionService"),function(e){t.WorkItemFormNavigationService={};class r extends n.VssService{_serviceStart(e){this.pageContext=e}async openWorkItem(e,t=!1){}async openNewWorkItem(e,t){}}n.Services.add("ms.vss-work-web.work-item-form-navigation-service",{serviceFactory:r})}()}),["Resources","IWorkItemFormExtensionService","IWorkItemFormNavigationService","WorkItemFormExtensionService","WorkItemFormNavigationService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.new-work-item-form-extension"}}));