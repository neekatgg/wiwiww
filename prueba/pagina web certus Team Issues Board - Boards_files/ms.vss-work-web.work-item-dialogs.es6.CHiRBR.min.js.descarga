"use strict";define("Wit/Common/WorkItemDialogs",["require","exports","VSS/Platform/Context","VSS/Platform/RestClientBase","Tfs/Platform/Page","VSS/Core/Observable","VSS/Core/Util/String","Wit/Clients/Work/RestClient/Work","Wit/Common/Generated/Constants","react","VSS/Platform/Layout","VSSUI/Button","VSSUI/EditableDropdown","VSSUI/FormItem","VSSUI/Observer","VSSUI/Status","VSSUI/Table","Wit/Common/BulkUpdateUtils/TagUtils","Wit/Common/WorkItemControls/WorkItemFieldControl","Tfs/Platform/TfsComponent","VSSUI/Dialog","Wit/Common/BulkUpdateUtils/BulkUpdateInterfaces","Wit/Common/BulkUpdateUtils/BulkUpdateUtils","Wit/HtmlEditor/Components/HtmlEditor","VSSUI/Components/Panel/Panel","VSSUI/Dropdown","VSSUI/MessageCard","VSSUI/Panel","VSSUI/Spinner","Wit/DirectoryView/Components/DirectoryDropdown","Wit/UI/Data","Wit/UI/WorkItemTypeIcon","VSS/Platform/Feature","VSSUI/Icon","VSSUI/Link","Wit/Common/Constants/FeatureFlags","VSS/Platform/Trace","VSSUI/Checkbox","VSSUI/Utilities/DropdownSelection","Wit/Common/WorkItemTypesService/IWorkItemTypesService","VSS/Platform/Location","VSSUI/TextField","VSSUI/Utils/ClipboardUtils","Wit/Common/DateUtils","Wit/Common/WiqlOperators","Wit/Identity/Utilities/WorkItemIdentityHelper","VSS/Features/Identities/IdentityPickerProvider","VSSUI/IdentityPicker","VSSUI/Util","Wit/Common/QueryUtils/QueryUtils","VSSUI/List","Wit/Clients/Wit/RestClient/WorkItemTracking","Wit/Common/WorkItemControls/AreaPathDropdown","Wit/UI/Services/WorkItemTypeIconMetadataService","VSSUI/Components/MessageCard/MessageCard","Wit/Common/WorkItemControls/IterationDropdown","Wit/Common/WorkItemControls/NodeUtils"],(function(e,t,s,o,i,a,r,l,n,m,c,d,u,p,h,v,g,I,C,f,k,y,S,b,w,T,N,W,E,D,x,F,P,R,V,A,j,L,M,O,B,_,U,H,z,q,Q,K,$,G,Y,J,X,Z,ee,te,se){var oe,ie,ae,re,le,ne,me;oe=t[me="Resources"]={},t[me].AddAutocompleteComment="Add a comment.  Use # to link a work item, ! to link a pull request, or @ to mention a person.",t[me].AddField="Add new field",t[me].AddTagsFormat="{0} (Add)",t[me].AreaPathLabel="Area path",t[me].AreaPathSearchLabel="Area path to search under",t[me].Backlogs="backlogs",t[me].Cancel="Cancel",t[me].CaptureTemplateHeader="Capture Template",t[me].ChangeParentErrorLoadingParentWorkItemsMessage="Error loading parent work items: {0}",t[me].ChangeParentNoViableBacklogLevel="No parent backlog level found for selected work item(s)",t[me].ChangeParentMaxLevel="Cannot change parent of the selected work item(s) because they are already at the highest backlog level ({0})",t[me].ChangeParentNoAvailableParents="No potential parent work items found for selected work item(s)",t[me].ChangeParentOfWorkItems="Change Parent of Work Item(s)",t[me].ChangeParentOfSelectedWorkItems="Change parent of selected work item(s)",t[me].ChangeParentPanelDescription="This will replace any existing parent of the {0} selected item(s).",t[me].ChangeParentSelectNewParent="Select a new parent...",t[me].ChangeTypeLink="Learn more about changing the type",t[me].ChangeTypeReason="Add a reason for changing the type",t[me].ChangeWorkItemInvalidTypeMessage="Work item type(s) {0} cannot be moved because it is disabled, hidden or not supported.",t[me].ChangeWorkItemType="Change work item type",t[me].CharacterCount="{0}/{1} characters",t[me].CloneWorkItemError="Error cloning work item",t[me].CloningWorkItem="Cloning work item...",t[me].CloseLabel="Close",t[me].Copying="Copying work item...",t[me].Copy="Copy",t[me].CopyLink="Copy link",t[me].CopyTemplateLinkMessage="Copy the URL to add a work item using this template.",t[me].CopyWorkItemDialogTitle="Copy Work Item",t[me].CopyWorkItemDialogText="Creating a copy of {0} {1}: {2}",t[me].CreatingTemplateSpinnerAriaLabel="Creating template...",t[me].DeleteSelectedWorkItems="Delete",t[me].DeleteWorkItems="Delete work item(s)",t[me].DeleteWorkItemsConfirmation="Are you sure you want to delete the selected work item(s)?",t[me].DeleteWorkItemsRestore="You can restore deleted work items from the Recycle Bin.",t[me].DeletingWorkItems="Deleting work item(s)",t[me].DeletingFailedMessage="Failed to delete work item(s): {0}",t[me].DescriptionLabel="Description",t[me].DuplicateFieldsErrorMessage="You cannot edit the same field with multiple values.",t[me].EditWorkItems="Edit work items",t[me].EditWorkItemsNotes="Click to add Notes for History",t[me].EditWorkItemsNotesAriaLabel="Work item history notes",t[me].EmailWorkItemsLimit="* Only the first {0} work items are retrieved for the email.",t[me].ErrorSendingEmail="Error sending email",t[me].FalseString="False",t[me].FieldColumn="Field*",t[me].IterationPathLabel="Iteration path",t[me].KeepCurrentTypesOption="Keep current type(s)",t[me].Loading="Loading",t[me].IncludeAttachments="Include existing attachments",t[me].IncludeChildren="Include child work items",t[me].IncludeLinks="Include existing links",t[me].InsertNewField="Insert new field",t[me].InsertSharedSteps="Insert Shared Steps",t[me].MoveWorkItem="Move work item",t[me].MoveSourceWorkItemBlockedCase="Work item type {0} cannot be moved because it is disabled, hidden or not supported in the source project {1}.",t[me].MoveTargetWorkItemBlockedCase="Work item type {0} cannot be moved because it is disabled, hidden or not supported in the destination project {1}.",t[me].MoveToPositionTitle="Move to column position",t[me].MoveWorkItemBulkTypeError="Work item type(s) {0} may not exist in {1}.  Change the type of all selected work items below, or exit the dialog and move work items separately.",t[me].MoveToProjectReasonLabel="Add a reason for moving the work item",t[me].MovingWorkItems="Moving work items...",t[me].NameLabel="Name",t[me].Note="Note",t[me].NoWorkItems="The query you selected does not return any work items. Select a query that contains at least one work item, and try again.",t[me].OK="OK",t[me].Project="Project",t[me].SelectAWorkItemType="Select a work item type",t[me].ProjectDropdownLabel="Destination project",t[me].ProjectDropdownPlaceholder="Select a project",t[me].RemoveField="Remove this field",t[me].RemoveFieldsButtonLabel="Remove unmodified fields",t[me].RemoveTagsFormat="{0} (Remove)",t[me].RequiredLabel="Required",t[me].InvalidPosition="Invalid position. Choose a value between 1 and {0}",t[me].SaveLabel="Save",t[me].SaveTemplateMessage="Save the template in order to enable Copy link.",t[me].Search="Search",t[me].SelectAPositionPrompt="Select a position between 1 and {0}",t[me].SelectedWorkItems="Selected Work Items",t[me].Send="Send",t[me].Sending="Sending",t[me].SendMailNotEnabled="Sending email is not enabled. Please contact your administrator.",t[me].SendWorkItems="Send work items in email",t[me].Subject="Subject",t[me].TeamLabel="Team",t[me].TitleLabel="Title",t[me].TitleSearchTooltip="You can enter a partial title or exact match",t[me].To="To",t[me].TrueString="True",t[me].Type="Type",t[me].UnsavedChanges="Unsaved Changes",t[me].UnsavedChangesMessage="Leaving this page will discard the email.  Are you sure you want to discard these changes",t[me].UnsavedQueryMessage="You have unsaved changes made to the query. Save the modified query before proceeding.",t[me].UpdatingWorkItems="Updating work items...",t[me].ValueColumn="Value",t[me].WorkItemTemplate="Templates",t[me].WorkItemTemplateCapture="Capture...",t[me].WorkItemType="Work item type",t[me].UnsavedChangesDirtyDialog="You have unsaved changes that will be lost:",t[me].EditorDirtyDialog="Are you sure you want to leave the page?",t[me].EditorDirtyDialogMessage="You can save your changes, discard your changes, or cancel to continue editing.",t[me].DiscardChanges="Discard changes",t[me].SaveChanges="Save changes",t[me].RevertQuery="Query: {0}",t[me].UntitledQuery="Untitled query",t[me].NoProjectSpecifiedMessage="No project is available",function(e){ie=t[e]={};class i extends o.RestClientBase{constructor(e){super(e)}async sendMail(e,t){return this.beginRequest({apiVersion:"5.0-preview.1",method:"POST",routeTemplate:"{project}/_apis/wit/sendMail",routeValues:{project:t},body:e})}}t[e].WorkItemTrackingClientName="WorkItemDialogs-Wit.IWorkItemTrackingRestClient",t[e].getWorkItemTrackingClient=function(s,o){return s.getRestClient(t[e].WorkItemTrackingClientName,o)},s.RestClients.add(t[e].WorkItemTrackingClientName,{factory:i,options:{serviceInstanceType:"00025394-6065-48ca-87d9-7f5672854ef7"}})}("clientsWorkItemTracking"),function(e){ae=t[e]={};class o extends s.VssService{constructor(){super(...arguments),this.teamId=new a.ObservableValue(""),this.parentBacklogLevel=new a.ObservableValue(""),this.errorText=new a.ObservableValue(""),this.isBusy=new a.ObservableValue(!1),this.topLevelWorkItems=new a.ObservableValue([]),this.parentWorkItems=new a.ObservableValue([]),this.newParentId=new a.ObservableValue(void 0),this.backlogLevels={},this.workItems=[],this.busyCount=0,this.getErrorText=()=>this.errorText,this.getTeamId=()=>this.teamId,this.getIsBusy=()=>this.isBusy,this.setTeamId=e=>{this.teamId.value=e,this.updateObservables()},this.getParentBacklogLevelId=()=>this.parentBacklogLevel,this.getTopLevelWorkItems=()=>this.topLevelWorkItems,this.getParentWorkItems=()=>this.parentWorkItems,this.initialize=(e,t)=>{this.increaseBusyCount(),this.teamId.value=t,this.workItems=e,this.updateObservables(),this.decreaseBusyCount()},this.setWorkItems=e=>{this.workItems=e,this.updateObservables()},this.getNewParentId=()=>this.newParentId,this.setNewParentId=e=>{this.newParentId.value=e},this.updateObservables=()=>{this.getBacklogLevels().then((e=>{this.updateTopLevelWorkItems().then((()=>{this.updateParentWorkItems()}))}))},this.updateParentWorkItems=async()=>{var e,t;this.increaseBusyCount();const s=this.pageContext.getService("work-item-service"),o=null!==(t=null===(e=(0,i.getTFSProject)(this.pageContext))||void 0===e?void 0:e.id)&&void 0!==t?t:"",a={team:"",teamId:this.teamId.value,project:o,projectId:o},m=(0,l.getWorkClient)(this.pageContext);try{const e=await m.getBacklogLevelWorkItems(a,this.parentBacklogLevel.value);if(e&&e.workItems){const t=e.workItems.map((e=>e.target.id)),i=[n.CoreFieldRefNames.TeamProject,n.CoreFieldRefNames.Title,n.CoreFieldRefNames.WorkItemType],a=(await Promise.all(s.loadWorkItems(o,t,i))).flat();this.parentWorkItems.value=a,this.newParentId.value=void 0}}catch(e){this.parentWorkItems.value=[],this.newParentId.value=void 0,this.errorText.value=(0,r.format)(oe.ChangeParentErrorLoadingParentWorkItemsMessage,e)}this.decreaseBusyCount()},this.getBacklogLevels=()=>{if(this.teamId.value&&!this.backlogLevels[this.teamId.value]){this.increaseBusyCount();const e=(0,l.getWorkClient)(this.pageContext),t=(0,i.getTFSProject)(this.pageContext);this.backlogLevels[this.teamId.value]=e.getBacklogs({project:"",projectId:null==t?void 0:t.id,team:"",teamId:this.teamId.value}).then((e=>e.sort(((e,t)=>t.rank-e.rank)))),this.decreaseBusyCount()}return this.backlogLevels[this.teamId.value]},this.updateTopLevelWorkItems=async()=>{this.increaseBusyCount(),this.getBacklogLevels().then((e=>{let t=e.length,s=[];for(const o of this.workItems){const i=m(e,o[n.CoreFieldRefNames.WorkItemType]);i<t&&(s=[],t=i),i==t&&s.push(o)}this.topLevelWorkItems.value=s,t>0&&t<e.length?this.parentBacklogLevel.value=e[t-1].id:(this.parentBacklogLevel.value="",this.errorText.value=oe.ChangeParentNoViableBacklogLevel)}),(e=>{this.parentBacklogLevel.value="",this.topLevelWorkItems.value=[],this.errorText.value=(0,r.format)(oe.ChangeParentErrorLoadingParentWorkItemsMessage,e)})),this.decreaseBusyCount()},this.increaseBusyCount=()=>{this.busyCount++,this.busyCount>0&&(this.isBusy.value=!0)},this.decreaseBusyCount=()=>{this.busyCount--,this.busyCount<=0&&(this.isBusy.value=!1)}}}function m(e,t){for(let s=0;s<e.length;s++)for(let o=0;o<e[s].workItemTypes.length;o++)if(e[s].workItemTypes[o].name===t)return s;return e.length}s.Services.add("IChangeParentService",{serviceFactory:o}),t[e].getChangeParentService=function(e){return e.getService("IChangeParentService")}}("ServicesChangeParentService"),function(e){re=t[e]={};const s=new Set([n.CoreFieldRefNames.AreaId,n.CoreFieldRefNames.AttachedFileCount,n.CoreFieldRefNames.AuthorizedAs,n.CoreFieldRefNames.AuthorizedDate,n.CoreFieldRefNames.BoardColumn,n.CoreFieldRefNames.BoardColumnDone,n.CoreFieldRefNames.BoardLane,n.CoreFieldRefNames.ChangedBy,n.CoreFieldRefNames.CreatedBy,n.CoreFieldRefNames.ChangedDate,n.CoreFieldRefNames.CreatedDate,n.CoreFieldRefNames.ExternalLinkCount,n.CoreFieldRefNames.History,n.CoreFieldRefNames.HyperLinkCount,n.CoreFieldRefNames.Id,n.CoreFieldRefNames.IterationId,n.CoreFieldRefNames.LinkType,n.CoreFieldRefNames.NodeName,n.CoreFieldRefNames.RelatedLinkCount,n.CoreFieldRefNames.Rev,n.CoreFieldRefNames.RevisedDate,n.CoreFieldRefNames.TeamProject,n.CoreFieldRefNames.Watermark,n.CoreFieldRefNames.WorkItemType,n.CoreFieldRefNames.IsDeleted,n.OobFieldRefNames.BacklogPriority,n.OobFieldRefNames.StackRank,n.OobFieldRefNames.ActivatedBy,n.OobFieldRefNames.ActivatedDate,n.OobFieldRefNames.ClosedBy,n.OobFieldRefNames.ClosedDate,n.OobFieldRefNames.ResolvedBy,n.OobFieldRefNames.ResolvedDate,n.OobFieldRefNames.StateChangeDate,"System.PersonId"]);class o extends c.VssComponent{constructor(e,t){super(e,t),this.fields=new a.ObservableArray([]),this.fieldToAllowedValues=new Map,this.onClausesChanged=()=>{this.validate()},this.columns=[{id:"add-remove",readonly:!0,width:76,renderCell:(e,t,s,o)=>m.createElement(g.SimpleTableCell,{columnIndex:t,tableColumn:s,key:o.id+"-col-"+t},m.createElement(d.Button,{ariaLabel:oe.InsertNewField,className:"add-line-button",iconProps:{iconName:"Add"},tooltipProps:{text:oe.InsertNewField},onClick:()=>{this.props.clauses.splice(e,0,{allowedValues:new a.ObservableArray([]),field:new a.ObservableValue(void 0),id:(0,r.newGuid)(),value:new a.ObservableValue("")}),this.validate()}}),m.createElement(d.Button,{ariaLabel:oe.RemoveField,className:"remove-line-button",iconProps:{iconName:"Cancel"},tooltipProps:{text:oe.RemoveField},onClick:()=>{this.props.clauses.splice(e,1),this.validate()}}))},{id:"field",name:oe.FieldColumn,width:-40,renderCell:(e,t,s,o)=>{var i,a;return m.createElement(g.SimpleTableCell,{columnIndex:t,key:"field-"+o.id},m.createElement(p.FormItem,{className:"field-form-item"},m.createElement(u.EditableDropdown,{allowTextSelection:!0,className:"field-editable-dropdown",items:this.fields,onValueChange:e=>this.onFieldValueChange(o,e),selectedText:null!==(a=null===(i=o.field.value)||void 0===i?void 0:i.name)&&void 0!==a?a:""})))}},{id:"operator",width:34,renderCell:(e,t,s,o)=>m.createElement(g.SimpleTableCell,{columnIndex:t,key:"operator-"+o.id,contentClassName:"justify-center"},"=")},{id:"value",name:oe.ValueColumn,width:-60,renderCell:(e,t,s,o)=>m.createElement(g.SimpleTableCell,{columnIndex:t,key:"value-"+o.id},m.createElement(p.FormItem,{className:"flex-grow"},m.createElement(h.Observer,{allowedValues:o.allowedValues,selectedField:o.field},(e=>m.createElement(C.WorkItemFieldControl,{allowedValues:e.allowedValues,disabled:!e.selectedField,fieldEntry:e.selectedField,initialValue:o.value.value,key:o.id,onChange:e=>{e!==o.value.value&&(o.value.value=e,o.dirty=!0,this.validate())}})))))}],this.updateAvailableFields(),this.state={}}componentDidMount(){this.validate(),this.props.clauses.subscribe(this.onClausesChanged)}componentDidUpdate(e){this.props.fields!==e.fields&&this.updateAvailableFields()}componentWillUnmount(){this.props.clauses.unsubscribe(this.onClausesChanged)}render(){return m.createElement("div",{className:"flex-grow bulk-edit-table-container rhythm-vertical-16"},this.state.errorMessage&&m.createElement("div",{className:"flex-row flex-center rhythm-horizontal-8"},m.createElement(v.Status,Object.assign({},v.Statuses.Failed,{key:"error",size:"16"})),m.createElement("span",{className:"error-text"},this.state.errorMessage)),m.createElement(g.Table,{className:"bulk-edit-table",columns:this.columns,itemProvider:this.props.clauses,spacerWidth:0,scrollable:this.props.scrollable}),m.createElement("div",{className:"padding-bottom-16"},m.createElement(d.Button,{iconProps:{iconName:"Add"},onClick:()=>{this.props.clauses.push({allowedValues:new a.ObservableArray([]),id:(0,r.newGuid)(),field:new a.ObservableValue(void 0),value:new a.ObservableValue("")}),this.validate()},text:oe.AddField})))}updateAvailableFields(){const e=this.props.fields.filter((e=>!i(e))),t=this.addTagFields(e);t.sort(((e,t)=>(0,r.localeIgnoreCaseComparer)(e.name,t.name))),this.fields.value=t.map((e=>({id:e.id.toString(),text:e.name,data:e})))}async onFieldValueChange(e,t){const s=null==t?void 0:t.data;if(e.field.value=t?t.data:void 0,e.value.value="",e.dirty=!0,s){let t=this.fieldToAllowedValues.get(s.referenceName);!t&&this.props.getAllowedValues&&(t=this.props.getAllowedValues(s));const o=await t;if(o){const t=e.allowedValues;t.splice(0,t.length,...o)}}this.validate()}validate(){let e,t=!!this.props.clauses.length;const s=new Set;for(const o of this.props.clauses.value)if(o.field.value){if(s.has(o.field.value.referenceName)){t=!1,e=oe.DuplicateFieldsErrorMessage;break}s.add(o.field.value.referenceName)}else t=!1;return e!==this.state.errorMessage&&this.setState({errorMessage:e}),this.props.onValidate&&this.props.onValidate(t),t}addTagFields(e){const t=[];for(const s of e)s.referenceName===n.CoreFieldRefNames.Tags?(t.push(Object.assign(Object.assign({},s),{name:(0,r.format)(oe.AddTagsFormat,s.name),referenceName:I.AddTagsPseudoRefName})),t.push(Object.assign(Object.assign({},s),{name:(0,r.format)(oe.RemoveTagsFormat,s.name),referenceName:I.RemoveTagsPseudoRefName}))):t.push(s);return t}}function i(e){const t=e.referenceName,o=e.usages&n.FieldUsages.WorkItem;if(!function(e){if(e.referenceName===n.CoreFieldRefNames.AreaPath||e.referenceName===n.CoreFieldRefNames.IterationPath)return!0;return!function(e){return l(e,n.FieldFlags.Computed)}(e)}(e)||!o||l(e,n.FieldFlags.Ignored))return!0;if(s.has(t))return!0;if(["Microsoft.VSTS.Build.IntegrationBuild","Microsoft.VSTS.TCM.ReproSteps","Microsoft.VSTS.TCM.SystemInfo","Microsoft.VSTS.Common","Microsoft.VSTS.CMMI"].some((e=>(0,r.startsWith)(t,e,!0))))return!1;return!!["System.AreaLevel","System.IterationLevel","Microsoft.VSTS.TCM","Microsoft.VSTS.Build","Microsoft.VSTS.CodeReview","Microsoft.VSTS.Feedback"].some((e=>(0,r.startsWith)(t,e,!0)))||!!["ExtensionMarker"].some((e=>(0,r.endsWith)(t,e,!0)))}function l(e,t){return(e.flags&+t)!==n.FieldFlags.None}t[e].BulkEditFieldsTable=o,t[e].isExcludedFromBulkEdit=i}("ComponentsBulkEditFieldsTable"),function(e){t[e]={};class s extends f.TfsComponent{constructor(e,t){super(e,t),this.clauses=new a.ObservableArray([{allowedValues:new a.ObservableArray([]),id:(0,r.newGuid)(),field:new a.ObservableValue(void 0),value:new a.ObservableValue("")}]),this.historyNotes=new a.ObservableValue(""),this.projectToTypes=new Map,this.allowedValuesProjectId="",this.getAllowedValues=async e=>{if(e.referenceName===n.CoreFieldRefNames.AreaPath||e.referenceName===n.CoreFieldRefNames.IterationPath)return Promise.resolve([]);if(e.type===n.FieldType.Boolean)return Promise.resolve([oe.TrueString,oe.FalseString]);const t=[];for(const[s,o]of this.projectToTypes)t.push(this.getAllowedValuesForTypes(s,[...o],e.referenceName));const s=(await Promise.all(t)).reduce(((e,t)=>e.concat(t)));return[...new Set(s)].sort()},this.onSave=async()=>{if(!(this.state.isValid||this.state.hasComments))return;const e=new Map,t=[];if(this.state.isValid)for(const e of this.clauses.value)e.field.value&&t.push({fieldName:e.field.value.referenceName,value:e.value.value});""!==this.historyNotes.value&&t.push({fieldName:n.CoreFieldRefNames.History,value:this.historyNotes.value}),e.set(y.BulkUpdateConstants.AllTypes,t),this.setState({working:!0});const s=this.props.selectedItems.map((e=>Number(e[n.CoreFieldRefNames.Id]))).filter((e=>e)),o=this.props.getWorkItems&&this.props.getWorkItems(s),i=await(0,S.performBulkUpdate)(this.context.pageContext,null!=o?o:s,e);this.setState({working:!1}),this.props.onModifyItems&&this.props.onModifyItems(i),this.props.onDismiss()},this.onValidate=e=>{e!==this.state.isValid&&this.setState({isValid:e})},this.state={selectedTypeFields:[],isValid:!1,working:!0,hasComments:!1}}async componentDidMount(){var e;const t=this.context.pageContext.getService("ITfsProjectService"),s=await t.getAllProjectsLoadedPromise(),o=new Map;for(const e of s)o.set(e.name,e.id);for(const e of this.props.selectedItems){const t=e[n.CoreFieldRefNames.TeamProject],s=e[n.CoreFieldRefNames.WorkItemType],i=o.get(t);if(i){const e=this.projectToTypes.get(i);e?e.add(s):this.projectToTypes.set(i,new Set([s]))}}const i=null===(e=this.projectData)||void 0===e?void 0:e.id;i&&this.projectToTypes.has(i)?this.allowedValuesProjectId=i:this.projectToTypes.size>0?this.allowedValuesProjectId=this.projectToTypes.keys().next().value:this.allowedValuesProjectId="";const a=[],r=this.context.pageContext.getService("IWorkItemTypesService");for(const[e,t]of this.projectToTypes)a.push(r.getWorkItemTypeData(e,[...t]));const l=await Promise.all(a),m=new Set(l.reduce(((e,t)=>e.concat(t)),[]).map((e=>e.fields)).reduce(((e,t)=>e.concat(t)),[])),c=this.props.fields.filter((e=>m.has(e.id)));this.setState({selectedTypeFields:c,working:!1})}render(){const{onDismiss:e}=this.props,{selectedTypeFields:t,isValid:s,working:o,hasComments:i}=this.state,a=!o&&(s||i);return m.createElement(k.Dialog,{calloutContentClassName:"work-item-dialog",titleProps:{text:oe.EditWorkItems},onDismiss:e,footerButtonProps:[{text:oe.Cancel,onClick:e},{text:oe.OK,disabled:!a,onClick:this.onSave,primary:!0}],overlay:o?{spinnerAriaLabel:oe.UpdatingWorkItems}:void 0,resizable:!0,showCloseButton:!0},m.createElement(re.BulkEditFieldsTable,{clauses:this.clauses,fields:t,getAllowedValues:this.getAllowedValues,onValidate:this.onValidate,projectId:this.allowedValuesProjectId}),m.createElement(b.HtmlEditor,{className:"history-input",ariaLabel:oe.EditWorkItemsNotesAriaLabel,placeholder:oe.EditWorkItemsNotes,htmlContent:this.historyNotes.value,onChange:e=>{var t;this.historyNotes.value=e;const s=(null===(t=this.historyNotes.value)||void 0===t?void 0:t.length)>0;this.setState({hasComments:s})},telemetryContext:{controlName:"HtmlEditor"},showChromeBorder:!0}))}async getAllowedValuesForTypes(e,t,s){const o=this.context.pageContext.getService("IWorkItemFieldService"),i=[];for(const a of t){const t=o.getAllowedValues(s,e,a);i.push(t)}return(await Promise.all(i)).filter((e=>e)).reduce(((e,t)=>e.concat(t)))}}t[e].BulkEditDialog=s}("ComponentsBulkEditDialog"),function(e){function s(e){e&&e()}t[e]={},t[e].ChangeParentPanel=function(e){var t,o,a;const l=null!==(o=null===(t=(0,i.getTFSProject)(e.pageContext))||void 0===t?void 0:t.id)&&void 0!==o?o:"",c=(0,ae.getChangeParentService)(e.pageContext);return c.initialize(e.workItemsToChange||[],(null===(a=e.currentDirectory)||void 0===a?void 0:a.id)||""),m.createElement(h.Observer,{errorText:c.getErrorText(),topLevelWorkItems:c.getTopLevelWorkItems(),newParentId:c.getNewParentId(),isBusy:c.getIsBusy()},(t=>m.createElement(w.Panel,{titleProps:{text:oe.ChangeParentOfWorkItems},onDismiss:()=>s(e.onDismiss),description:(0,r.format)(oe.ChangeParentPanelDescription,t.topLevelWorkItems.length),footerButtonProps:[{text:oe.Cancel,onClick:()=>s(e.onDismiss)},{text:oe.ChangeParentOfSelectedWorkItems,onClick:()=>(async()=>{const t=c.getNewParentId().value;e.onChangeParent&&void 0!==t&&e.onChangeParent(c.getTopLevelWorkItems().value,t),s(e.onDismiss)})(),primary:!0,disabled:!!t.errorText||void 0===t.newParentId}]},t.isBusy&&m.createElement(W.PanelOverlay,{overlayContent:m.createElement(E.Spinner,null)}),m.createElement("div",{className:"flex-column flex-grow"},t.errorText&&m.createElement(N.MessageCard,{severity:"Error",className:"flex-noshrink margin-bottom-16"},m.createElement("div",{className:"flex-column font-size-ms"},t.errorText)),m.createElement(D.DirectoryDropdown,{selectedItem:e.currentDirectory,itemProvider:e.directoryDropdownProvider,onSelect:(e,t)=>{var s,o;c.setTeamId((null===(o=null===(s=t.data)||void 0===s?void 0:s.directory)||void 0===o?void 0:o.id)||"")}}),m.createElement(h.Observer,{teamId:c.getTeamId(),backlogLevelId:c.getParentBacklogLevelId(),parentWorkItems:c.getParentWorkItems()},(t=>m.createElement(m.Fragment,null,t.teamId&&t.backlogLevelId&&m.createElement(T.Dropdown,{items:t.parentWorkItems.map((t=>({id:t.id.toString(),text:t.fields[n.CoreFieldRefNames.Title],data:t,iconProps:{render:s=>((t,s)=>{const o=t.fields[n.CoreFieldRefNames.WorkItemType];return m.createElement("div",{className:s},m.createElement(x.WorkItemTypeIconProvider,{dataProvider:new x.WorkItemTrackingDataProvider(e.pageContext),dataSource:{projectIdOrName:l,workItemTypeName:o}},(e=>m.createElement(F.WorkItemTypeIcon,{data:e,className:"icon-margin font-size-m"}))))})(t,s)}}))),onSelect:(e,t)=>{t.data&&c.setNewParentId(t.data.id)},placeholder:oe.ChangeParentSelectNewParent,noItemsText:oe.ChangeParentNoAvailableParents}))))))))}}("ComponentsChangeParentPanel"),function(e){t[e]={};const s={id:"loading",text:oe.Loading,type:4};class o extends c.VssComponent{constructor(e,t){super(e,t),this.historyNotes=new a.ObservableValue(""),this.types=new a.ObservableArray([s]),this.selectedType="",this.validWorkItemTypes=[],this.changeWorkItemType=async()=>{this.validate();const e=(0,S.getWorkItemTypes)(this.props.selectedItems);if(!this.validatePayload(e,this.validWorkItemTypes))return;const t=new Map,s=[{fieldName:n.CoreFieldRefNames.WorkItemType,value:this.selectedType}];""!==this.historyNotes.value&&s.push({fieldName:n.CoreFieldRefNames.History,value:this.historyNotes.value}),t.set(y.BulkUpdateConstants.AllTypes,s);let o=this.props.selectedItems.map((e=>Number(e[n.CoreFieldRefNames.Id]))).filter((e=>e)),i=await(0,S.performBulkUpdate)(this.context.pageContext,o,t);if(this.isStateDropdownBlockingWhenWITChangedEnabled){e.some((e=>e===this.selectedType))&&(o=this.props.selectedItems.filter((e=>e[n.CoreFieldRefNames.WorkItemType]!==this.selectedType)).map((e=>Number(e[n.CoreFieldRefNames.Id]))).filter((e=>e)));const t=this.context.pageContext.getService("work-item-service");i=await t.setWorkItemInitialState(i,this.useOptionalDotRegex)}this.props.onModifyItems&&this.props.onModifyItems(i),this.props.onDismiss()},this.validate=()=>{const e=!!this.selectedType;e!==this.state.isValid&&this.setState({isValid:e})},this.validatePayload=(e,t)=>{const s=e.filter((e=>t.indexOf(e)<0));return!s.length||(this.setState({errorMessage:(0,r.format)(oe.ChangeWorkItemInvalidTypeMessage,s.join(", ")),isValid:!1}),!1)},this.state={errorMessage:void 0,isValid:!1},this.isStateDropdownBlockingWhenWITChangedEnabled=(0,P.isFeatureFlagEnabled)(t.pageContext,A.FeatureFlags.StateDropdownBlockingWhenWITChangedEnabled,!1),this.useOptionalDotRegex=(0,P.isFeatureFlagEnabled)(t.pageContext,A.FeatureFlags.UseStrictDoubleParsing,!1)}async componentDidMount(){var e,t,s,o;let a="";for(const e of this.props.selectedItems)if(a){if(a!==e[n.CoreFieldRefNames.WorkItemType]){a="";break}}else a=e[n.CoreFieldRefNames.WorkItemType];const r=null!==(s=null===(t=null===(e=(0,i.getTFSPageData)(this.context.pageContext))||void 0===e?void 0:e.project)||void 0===t?void 0:t.id)&&void 0!==s?s:null===(o=this.props)||void 0===o?void 0:o.workItemProjectId;if(!r)throw new Error(oe.NoProjectSpecifiedMessage);const l=this.context.pageContext.getService("IWorkItemTypesService");this.validWorkItemTypes=await l.getVisibleWorkItemTypes(r),this.types.value=this.validWorkItemTypes.filter((e=>e!==a)).map((e=>({id:e,text:e})))}render(){const{errorMessage:e,isValid:t}=this.state;return m.createElement(k.Dialog,{titleProps:{text:oe.ChangeWorkItemType},onDismiss:this.props.onDismiss,footerButtonProps:[{text:oe.Cancel,onClick:this.props.onDismiss},{disabled:!t,text:oe.OK,onClick:()=>this.changeWorkItemType(),primary:!0}],resizable:!0,showCloseButton:!0},m.createElement("div",{className:"rhythm-vertical-16"},e&&m.createElement(N.MessageCard,{severity:"Error"},e),m.createElement(p.FormItem,{label:oe.Type},m.createElement(T.Dropdown,{items:this.types,className:"change-type-dialog-dropdown",placeholder:oe.SelectAWorkItemType,onSelect:(e,t)=>{this.selectedType=t.text||"",this.validate()}})),m.createElement(p.FormItem,{label:oe.ChangeTypeReason},m.createElement(b.HtmlEditor,{className:"history-input",ariaLabel:oe.EditWorkItemsNotesAriaLabel,placeholder:oe.EditWorkItemsNotes,htmlContent:this.historyNotes.value,onChange:e=>{this.historyNotes.value=e},telemetryContext:{controlName:"HtmlEditor"},showChromeBorder:!0})),m.createElement(V.Link,{href:"https://go.microsoft.com/fwlink/p/?LinkID=746668",target:"_blank"},oe.ChangeTypeLink,m.createElement(R.Icon,{iconName:"NavigateExternalInline"}))))}}t[e].ChangeTypeDialog=o}("ComponentsChangeTypeDialog"),function(e){le=t[e]={};const s="WorkItemForm/WifDialog/FullScreen";class o extends f.TfsComponent{constructor(e,t){var o;super(e,t),this._setPreviousId=async()=>{this._activeWorkItemService=this.context.pageContext.getService("ms.vss-work-web.active-work-item-service"),this._activeWorkItemService.activeWorkItem&&(this._previousActiveId=await this._activeWorkItemService.activeWorkItem.id)},this._onRegisterTryShowSaveDialog=e=>{this.tryShowSaveDialog=e},this._onDismiss=async()=>{if(this.tryShowSaveDialog){if(!(await this.tryShowSaveDialog()).canDismiss)return}await this._onInternalDismiss()},this._onInternalDismiss=async()=>{if(this.props.onDismiss(),this._activeWorkItemService&&void 0!==this._previousActiveId){const e=this.context.pageContext.getService("IWorkItemModelService"),t=await e.getWorkItem(this._previousActiveId);this._activeWorkItemService.setActiveWorkItem(t)}},this.onToggleFullscreen=()=>{const e=this.state.fullscreen;this.setState({fullscreen:!e}),this._settingsService.setEntries({[s]:!e},0)},this._settingsService=this.context.pageContext.getService("ISettingsService"),this.state={fullscreen:null!==(o=this._settingsService.getEntry(s,0))&&void 0!==o&&o,defaultFocusableElementAriaLabel:""},this._setPreviousId(),this._setCurrentWorkItem()}componentDidMount(){this._setAriaLabelForDefaultFocusableElement()}render(){return m.createElement(k.CustomDialog,{calloutContentClassName:(0,c.css)("work-item-form-dialog",this.state.fullscreen&&"fullscreen"),contentSize:3,escDismiss:!0,lightDismiss:!1,resizable:!this.state.fullscreen,onDismiss:this._onDismiss,defaultFocusableElementAriaLabel:this.state.defaultFocusableElementAriaLabel,selectInputTextOnFocus:!0},m.createElement(i,Object.assign({},this.props,{onDismiss:this._onInternalDismiss,onRegisterTryShowSaveDialog:this._onRegisterTryShowSaveDialog,onToggleFullscreen:this.onToggleFullscreen})))}async _setAriaLabelForDefaultFocusableElement(){if(!this._currentWorkItem)return;const e=await this._currentWorkItem;e&&this.setState({defaultFocusableElementAriaLabel:`${e.getCaption()} ${e.getTitle()}`})}_setCurrentWorkItem(){const{workItem:e}=this.props,{workItemId:t}=this.props,s=this.context.pageContext.getService("IWorkItemModelService");e?this._currentWorkItem=e:t&&(this._currentWorkItem=s.getWorkItem(t))}}t[e].WorkItemFormDialog=o;const i=e=>m.createElement(c.WrappedComponent,Object.assign({},e,{dependencies:["ms.vss-work-web.work-item-form-dependencies"],loadingComponent:()=>m.createElement("div",{className:"work-item-form-loading-placeholder flex-column justify-center"},m.createElement("div",{className:"full-width flex-row justify-end"},m.createElement(d.Button,{ariaLabel:oe.CloseLabel,iconProps:{iconName:"ChromeClose"},onClick:()=>e.onDismiss(),subtle:!0,tooltipProps:{text:oe.CloseLabel}})),m.createElement("div",{className:"flex-grow flex-row justify-center"},m.createElement(E.Spinner,null))),wrappedType:"work-item-form-view-component"}));c.Components.add("work-item-form-dialog",o)}("ComponentsWorkItemFormDialog"),function(e){t[e]={};class s extends c.VssComponent{constructor(e,t){super(e,t),this._observable=new a.ObservableValue(void 0),this._error=new a.ObservableValue(void 0),this._initialize()}async _initialize(){const e=this.props.selectedItem[n.CoreFieldRefNames.Id];try{const t=this.context.pageContext.getService("ITfsProjectService"),s=await t.getAllProjectsLoadedPromise(),o=this.context.pageContext.getService("IWorkItemModelService"),i=this.context.pageContext.getService("IWorkItemTypesService"),[a]=await o.getWorkItems([e]),r=s.find((e=>e.name===this.props.selectedItem[n.CoreFieldRefNames.TeamProject])),l=r&&await i.getWorkItemTypeData(r.id,[this.props.selectedItem[n.CoreFieldRefNames.WorkItemType]]);if(r&&l){const e=await a.copy(this.context.pageContext,r.id,l[0],!1,!1,!1,[n.DalFields.TitleId]);this._observable.value=e}}catch(t){console.error("%O",t),this._error.value=t.message||String(t),(0,j.traceException)(this.context.pageContext,"WIT","CloneWorkItem",t,{workItemId:e})}}render(){return m.createElement(h.Observer,{error:this._error,item:this._observable},(({error:e,item:t})=>t?m.createElement(le.WorkItemFormDialog,{workItem:t,onDismiss:this.props.onDismiss}):e?m.createElement(k.Dialog,{footerButtonProps:[{text:oe.OK,onClick:()=>this.props.onDismiss()}],lightDismiss:!1,titleProps:{text:oe.CloneWorkItemError},onDismiss:this.props.onDismiss},e):m.createElement(k.Dialog,{lightDismiss:!1,titleProps:{text:oe.CloningWorkItem},onDismiss:this.props.onDismiss},m.createElement(E.Spinner,{size:"large"}))))}}t[e].CloneWorkItemDialog=s}("ComponentsCloneWorkItemDialog"),function(e){t[e]={};const s="ok-button";function o({title:e,message:t,primaryButtonText:o,onConfirm:i,onDismiss:a}){return m.createElement(k.Dialog,{showCloseButton:!0,titleProps:{text:e},lightDismiss:!1,onDismiss:a,footerButtonProps:[{primary:!0,className:s,onClick:i,text:o}]},t)}t[e].ConfirmButtonDialog=o,t[e].showConfirmationDialog=function(e,t,s,i,a){e.getService("IVssLayoutManager").renderCallout((e=>o({title:i,message:t,primaryButtonText:s,onConfirm:()=>{a&&a(),e()},onDismiss:e})))}}("ComponentsConfirmationDialog"),function(e){t[e]={};class s extends c.VssComponent{constructor(e,t){super(e,t),this._projectSelection=new M.DropdownSelection,this._workItemTypeSelection=new M.DropdownSelection,this._includeLinks=new a.ObservableValue(!1),this._includeAttachments=new a.ObservableValue(!1),this._includeChildren=new a.ObservableValue(!1),this._projectWorkItemTypes={},this._isIncludeChildEnabled=new a.ObservableValue(!0),this.copyWorkItemExcludedCategories=[O.WorkItemCategoryConstants.hidden,O.WorkItemCategoryConstants.testPlan,O.WorkItemCategoryConstants.testSuite,O.WorkItemCategoryConstants.testSharedStep,O.WorkItemCategoryConstants.testSharedParameter],this._copyWorkItem=async()=>{const e=this.props.selectedItem[n.CoreFieldRefNames.Id],t=this._includeLinks.value,s=this._includeAttachments.value,i=this._includeChildren.value;this.setState({working:!0});try{const a=this.context.pageContext.getService("IWorkItemModelService"),r=this.context.pageContext.getService("IWorkItemTypesService"),[l]=await a.getWorkItems([e]),n=o(this._projectSelection),c=void 0!==n&&this._projects.value[n].id,d=o(this._workItemTypeSelection),u=void 0!==d&&this.state.workItemTypes&&this.state.workItemTypes[d].id,p=u&&c&&await r.getWorkItemTypeData(c,[u]);if(c&&p){let e;e=i?await l.copyWithChildren(this.context.pageContext,c,p[0],t,s):await l.copy(this.context.pageContext,c,p[0],t,s);this.context.pageContext.getService("IVssLayoutManager").renderCallout((t=>m.createElement(le.WorkItemFormDialog,{workItem:e,onDismiss:t}))),this.props.onDismiss()}}catch(o){console.error("%O",o),this.setState({error:o.message||String(o),working:!1}),(0,j.traceException)(this.context.pageContext,"WIT","CopyWorkItem",o,{workItemId:e,includeChildren:i,includeLinks:t,includeAttachments:s})}},this._initialize(),this.state={loadingTypes:!0,working:!1,workItemTypes:void 0}}async _initialize(){const e=this.context.pageContext.getService("ITfsProjectService");this._projects=e.getAllProjects(),await e.getAllProjectsLoadedPromise();const t=this._projects.value.findIndex((e=>e.name===this.props.selectedItem[n.CoreFieldRefNames.TeamProject]));this._projectSelection.select(t>=0?t:0),this._getWorkItemTypes(this._projects.value[t].id)}render(){return m.createElement(k.Dialog,{className:"copy-work-item-dialog",escDismiss:!0,footerButtonProps:[{disabled:this.state.working,text:oe.Cancel,onClick:this.props.onDismiss},{disabled:this.state.loadingTypes||this.state.working,primary:!0,text:oe.Copy,onClick:this._copyWorkItem}],lightDismiss:!1,overlay:this.state.working?{spinnerAriaLabel:oe.Copying}:void 0,resizable:!0,showCloseButton:!0,titleProps:{text:oe.CopyWorkItemDialogTitle},onDismiss:this.props.onDismiss},m.createElement(h.Observer,{ready:this._projects.ready,isIncludeChildEnabled:this._isIncludeChildEnabled},(({ready:e,isIncludeChildEnabled:t})=>e?m.createElement("div",{className:"rhythm-vertical-16"},this.state.error&&m.createElement(N.MessageCard,{severity:"Error"},this.state.error),m.createElement("div",null,(0,r.format)(oe.CopyWorkItemDialogText,this.props.selectedItem[n.CoreFieldRefNames.WorkItemType],this.props.selectedItem[n.CoreFieldRefNames.Id],this.props.selectedItem[n.CoreFieldRefNames.Title])),m.createElement(p.FormItem,{label:oe.Project},m.createElement(T.Dropdown,{ariaLabel:oe.Project,disabled:this.state.loadingTypes,items:this._projects.value.map((e=>({text:e.name,id:e.id}))),selection:this._projectSelection,onSelect:(e,t)=>{this._getWorkItemTypes(t.id).then((e=>this.updateIncludeChildCheckboxState()))}})),m.createElement(p.FormItem,{label:oe.WorkItemType},m.createElement(T.Dropdown,{ariaLabel:oe.WorkItemType,disabled:this.state.loadingTypes,items:this.state.workItemTypes||[],selection:this._workItemTypeSelection,onSelect:(e,t)=>{this._lastSelectedWorkItemType=t.id,this.updateIncludeChildCheckboxState()}})),m.createElement("div",null,m.createElement("div",null,m.createElement(L.Checkbox,{checked:this._includeLinks,label:oe.IncludeLinks,onChange:(e,t)=>this._includeLinks.value=t})),m.createElement("div",null,m.createElement(L.Checkbox,{checked:this._includeAttachments,label:oe.IncludeAttachments,onChange:(e,t)=>this._includeAttachments.value=t})),m.createElement("div",null,m.createElement(L.Checkbox,{disabled:!t,checked:this._includeChildren,label:oe.IncludeChildren,onChange:(e,t)=>this._includeChildren.value=t})))):m.createElement(E.Spinner,null))))}async _getWorkItemTypes(e){if(!this._projectWorkItemTypes[e]){this.state.loadingTypes||this.setState({loadingTypes:!0});const t=this.context.pageContext.getService("IWorkItemTypesService"),s=await t.getWorkItemTypes(e,this.copyWorkItemExcludedCategories);this._projectWorkItemTypes[e]=s}this._setWorkItemTypes()}_setWorkItemTypes(){const e=o(this._projectSelection);if(void 0!==e){const t=this._projects.value[e].id,s=this._projectWorkItemTypes[t];if(s){this.setState({loadingTypes:!1,workItemTypes:s.map((e=>({id:e,text:e})))});const e=this._lastSelectedWorkItemType||this.props.selectedItem[n.CoreFieldRefNames.WorkItemType],t=s.indexOf(e);this._workItemTypeSelection.select(t>=0?t:0)}}}updateIncludeChildCheckboxState(){const e=o(this._projectSelection),t=void 0!==e&&this.props.selectedItem[n.CoreFieldRefNames.TeamProject]===this._projects.value[e].name&&(void 0===this._lastSelectedWorkItemType||this.props.selectedItem[n.CoreFieldRefNames.WorkItemType]===this._lastSelectedWorkItemType);t!==this._isIncludeChildEnabled.value&&(this._isIncludeChildEnabled.value=t,this._includeChildren.value&&!this._isIncludeChildEnabled.value&&(this._includeChildren.value=!1))}}function o(e){return e.value&&e.value.length>0?e.value[0].beginIndex:void 0}t[e].CopyWorkItemDialog=s}("ComponentsCopyWorkItemDialog"),function(e){t[e]={},t[e].DeleteDialog=function({onDeleteItems:e,onDeleteFinished:t,onDeletionFailed:s,onDismiss:o,selectedItems:i}){const a=(0,c.usePageContext)(),[l,d]=(0,m.useState)(!1),u=(0,m.useRef)([]),[p,h]=(0,m.useState)(void 0),v=async()=>{d(!0);const l=function(e,t){const s=[];for(let o=0;o<e.length;o+=t)s.push(e.slice(o,o+t));return s}(i,200).map((async t=>{const{successes:o,failures:i}=await async function(e,t){const s=t.map((e=>e[n.CoreFieldRefNames.Id])).filter((e=>!!e)),o=e.getService("IVssContributionService"),i=await o.getDataAsync("ms.vss-work-web.delete-work-items-data-provider",{ids:s},!0);if(i){return{successes:i.successes.map((e=>t.find((t=>t[n.CoreFieldRefNames.Id]===e)))).filter((e=>!!e)),failures:i.failures.map((e=>t.find((t=>t[n.CoreFieldRefNames.Id]===e)))).filter((e=>!!e))}}return{successes:[],failures:t}}(a,t);null==e||e(o),i.length>0&&(s?s(i):u.current.push(...i.map((e=>e[n.CoreFieldRefNames.Id])).filter((e=>!!e))))}));await Promise.all(l),null==t||t(),d(!1),u.current.length>0?h((0,r.format)(oe.DeletingFailedMessage,u.current.join(", "))):null==o||o()};return m.createElement(k.Dialog,{titleProps:{text:oe.DeleteWorkItems},onDismiss:()=>null==o?void 0:o(),footerButtonProps:[{text:oe.Cancel,onClick:()=>null==o?void 0:o()},{text:oe.DeleteSelectedWorkItems,onClick:()=>v(),primary:!0,disabled:l||!!p}],escDismiss:!1,lightDismiss:!1,overlay:l?{spinnerLabel:oe.DeletingWorkItems}:void 0},p?m.createElement(N.MessageCard,{severity:"Warning"},p):null,m.createElement("div",{className:"scroll-auto flex-grow flex-row"},m.createElement(R.Icon,{className:"delete-dialog-warning-icon",iconName:"IncidentTriangle",size:"large"}),m.createElement("div",null,m.createElement("p",null,oe.DeleteWorkItemsConfirmation),m.createElement("p",null,oe.DeleteWorkItemsRestore))))}}("ComponentsDeleteDialog"),function(e){t[e]={};t[e].EditorDirtyDialog=({onDismiss:e,onLeave:t,onSave:s,query:o})=>{const[i,a]=m.useState(void 0);return m.createElement(k.Dialog,{footerButtonProps:[{text:oe.Cancel,onClick:e},{text:oe.DiscardChanges,onClick:t},{text:oe.SaveChanges,onClick:()=>{try{s()}catch(e){a(e.message)}},primary:!0}],onDismiss:e,resizable:!0,titleProps:{text:oe.EditorDirtyDialog}},m.createElement("div",{className:"flex-column rhythm-vertical-8"},i&&m.createElement(N.MessageCard,{severity:"Error"},i),m.createElement("span",null,oe.UnsavedChangesDirtyDialog),m.createElement("span",null,(0,r.format)(oe.RevertQuery,o?o.name:oe.UntitledQuery)),m.createElement("span",null,oe.EditorDirtyDialogMessage)))}}("ComponentsEditorDirtyDialog"),function(e){t[e]={};class s extends f.TfsComponent{constructor(e,t){var s,o,i,r;super(e,t),this.team=new a.ObservableValue(""),this.teams=new a.ObservableArray([]),this.clauses=new a.ObservableArray([]),this.historyNotes=new a.ObservableValue(""),this.isNewTemplate=!1,this.isTableValid=!0,this.getAllowedValues=async e=>{var t,s;if(!this.projectData||e.referenceName===n.CoreFieldRefNames.AreaPath||e.referenceName===n.CoreFieldRefNames.IterationPath)return;const o=null!==(s=null===(t=this.props.workItemTemplate)||void 0===t?void 0:t.workItemTypeName)&&void 0!==s?s:this.props.selectedItem[n.CoreFieldRefNames.WorkItemType],i=this.context.pageContext.getService("IWorkItemFieldService");return await i.getAllowedValues(e.referenceName,this.projectData.id,o)},this.removeUnmodifiedClauses=()=>{this.clauses.removeAll((e=>!e.dirty))},this.onSave=async()=>{var e,t,s,o,i,a,r;if(!this.state.isValid||!this.props.selectedItem&&!this.state.workItemTemplate)return;const l={};for(const t of this.clauses.value)if(t.field.value){const s=(0,q.isWorkItemIdentityRef)(t.value.value)?t.value.value.distinctDisplayName:null===(e=t.value.value)||void 0===e?void 0:e.toString();l[t.field.value.referenceName]=null!=s?s:""}""!==this.historyNotes.value&&(l[n.CoreFieldRefNames.History]=this.historyNotes.value);const m=null!==(s=null===(t=this.state.workItemTemplate)||void 0===t?void 0:t.workItemTypeName)&&void 0!==s?s:this.props.selectedItem[n.CoreFieldRefNames.WorkItemType],c={description:this.templateDescription.value,fields:l,id:null===(o=this.state.workItemTemplate)||void 0===o?void 0:o.id,name:this.templateName.value,workItemTypeName:m};this.setState({working:!0});const d=this.context.pageContext.getService("IWorkItemTemplateService");try{const e=null!==(a=null===(i=this.projectData)||void 0===i?void 0:i.id)&&void 0!==a?a:"",t=this.state.workItemTemplate?await d.replaceTemplate(e,null!==(r=this.props.teamId)&&void 0!==r?r:this.team.value,c):await d.createTemplate(e,this.team.value,c);this.setState({working:!1,workItemTemplate:Object.assign(Object.assign({},t),{fields:c.fields}),isValid:!1}),this.props.onSave&&this.props.onSave()}catch(e){this.setState({errorMessage:e.message,working:!1,isValid:!1})}},this.onValidateTable=e=>{this.isTableValid=e,this.validate()},this.isNewTemplate=!e.workItemTemplate,this.templateDescription=new a.ObservableValue(null!==(o=null===(s=e.workItemTemplate)||void 0===s?void 0:s.description)&&void 0!==o?o:""),this.templateName=new a.ObservableValue(null!==(r=null===(i=e.workItemTemplate)||void 0===i?void 0:i.name)&&void 0!==r?r:""),this.state={isValid:!0,selectedTypeFields:[],working:!0,workItemTemplate:e.workItemTemplate}}async componentDidMount(){var e;if(this.isNewTemplate&&this.projectData){const e=this.context.pageContext.getService("ITfsTeamService"),t=await e.getAllTeams(this.projectData.id);this.teams.value=t.sort(((e,t)=>(0,r.localeIgnoreCaseComparer)(e.name,t.name))).map((e=>({text:e.name,id:e.id})))}let t=null===(e=this.props.workItemTemplate)||void 0===e?void 0:e.fields,s=[];if(!t&&this.props.selectedItem&&this.props.selectedItem[n.CoreFieldRefNames.Id]){const e=Number(this.props.selectedItem[n.CoreFieldRefNames.Id]),o=this.context.pageContext.getService("IWorkItemModelService"),i=await o.getWorkItem(e),a=i.getFieldData();s=i.fields.map((e=>e.fieldDefinition));const r={};for(const e of Object.keys(a)){const t=Number(e),o=a[t],i=s.find((e=>e.id===Number(t)));i&&(i.id===n.CoreField.Tags?r[I.AddTagsPseudoRefName]=o:(0,re.isExcludedFromBulkEdit)(i)||(r[i.referenceName]=o))}t=r}t&&(this.clauses.value=await this.getClausesFromFieldValues(t,!this.isNewTemplate)),this.validate(),this.setState({selectedTypeFields:s,working:!1})}render(){var e,t;const{onDismiss:s}=this.props,{errorMessage:i,isValid:a,selectedTypeFields:r,working:l,workItemTemplate:n}=this.state;return m.createElement(k.Dialog,{calloutContentClassName:"work-item-dialog",titleProps:{text:oe.CaptureTemplateHeader},onDismiss:s,footerButtonProps:[{text:oe.CloseLabel,onClick:s},{text:oe.SaveLabel,disabled:!a||l,onClick:this.onSave,primary:!0}],overlay:l?{spinnerAriaLabel:oe.CreatingTemplateSpinnerAriaLabel}:void 0,resizable:!0,showCloseButton:!0},m.createElement("div",{className:"rhythm-vertical-16"},i&&m.createElement(N.MessageCard,{severity:"Error"},i),this.isNewTemplate&&m.createElement(p.FormItem,{label:m.createElement(o,{text:oe.TeamLabel,required:!0})},m.createElement(T.Dropdown,{disabled:!!n,items:this.teams,onSelect:(e,t)=>{this.team.value=t.id,this.validate()}})),m.createElement(p.FormItem,{label:m.createElement(o,{text:oe.NameLabel,required:!0})},m.createElement(_.TextField,{value:this.templateName,onChange:(e,t)=>{this.templateName.value=t,this.validate()}})),m.createElement(p.FormItem,{label:m.createElement(o,{text:oe.DescriptionLabel})},m.createElement(_.TextField,{value:this.templateDescription,onChange:(e,t)=>{this.templateDescription.value=t,this.validate()}})),m.createElement("div",{className:"margin-bottom-16"},m.createElement(re.BulkEditFieldsTable,{clauses:this.clauses,fields:r,getAllowedValues:this.getAllowedValues,onValidate:this.onValidateTable,projectId:null!==(t=null===(e=this.projectData)||void 0===e?void 0:e.id)&&void 0!==t?t:"",scrollable:!0}),m.createElement(d.Button,{iconProps:{iconName:"Cancel"},onClick:this.removeUnmodifiedClauses,text:oe.RemoveFieldsButtonLabel}))),m.createElement(b.HtmlEditor,{className:"history-input",ariaLabel:oe.EditWorkItemsNotesAriaLabel,placeholder:oe.EditWorkItemsNotes,htmlContent:this.historyNotes.value,onChange:e=>{this.historyNotes.value=e},telemetryContext:{controlName:"HtmlEditor"},showChromeBorder:!0}),m.createElement("div",{className:"margin-top-16"},m.createElement(d.Button,{disabled:!n,iconProps:{iconName:"Copy"},onClick:e=>{n&&(0,U.copyToClipboard)(this.getCreateWorkItemWithTemplateRoute(n))},text:oe.CopyLink,tooltipProps:{text:n?oe.CopyTemplateLinkMessage:oe.SaveTemplateMessage}})))}validate(){const e=!!this.team.value&&!!this.templateName.value&&!!this.clauses.length&&this.isTableValid;e!==this.state.isValid&&this.setState({isValid:e})}async getClausesFromFieldValues(e,t=!1){const s=[];for(const o of this.sortNamespacesByName(Object.keys(e))){const i=e[o];let a=this.props.fields.find((e=>e.referenceName===o));o===I.AddTagsPseudoRefName&&(a=this.props.fields.find((e=>e.referenceName===n.CoreFieldRefNames.Tags))),a&&(t||i)&&(a.id===n.CoreField.Tags&&(a=Object.assign(Object.assign({},a),{name:(0,r.format)(oe.AddTagsFormat,a.name),referenceName:I.AddTagsPseudoRefName})),s.push(this.createClauseWithAllowedValues(a,i)))}return Promise.all(s)}async createClauseWithAllowedValues(e,t){const s=await this.getAllowedValues(e);return{allowedValues:new a.ObservableArray(null!=s?s:[]),field:new a.ObservableValue(e),id:(0,r.newGuid)(),value:new a.ObservableValue(t)}}getCreateWorkItemWithTemplateRoute(e){var t,s;const o=this.props.teamId||this.team.value,{id:i,workItemTypeName:a}=e,r={project:null!==(s=null===(t=this.projectData)||void 0===t?void 0:t.id)&&void 0!==s?s:"",workItemTypeName:a,templateId:i,ownerId:o};return`${window.location.origin}${(0,B.routeUrl)(this.context.pageContext,"ms.vss-work-web.new-work-item-form-route",r)}`}sortNamespacesByName(e){return e.sort(((e,t)=>{const s=e.split(".").pop()||"",o=t.split(".").pop()||"";return s<o?-1:s>o?1:0}))}}function o({text:e,required:t}){return m.createElement("div",{className:"flex-row"},m.createElement("div",{className:"flex-grow"},e),t&&m.createElement("div",{className:"secondary-text"},oe.RequiredLabel))}async function i(e,t,o,l,c,d,u,p){if(!u){const e=t.getService("IWorkItemFieldService"),s=await e.getFieldsAsync();u=new a.ObservableArray(s||[])}const v=o[0][n.CoreFieldRefNames.WorkItemType],g=[{groupKey:"capture-template",id:"capture-work-item",onActivate:()=>{l((a=>m.createElement(h.Observer,{fields:u},(r=>m.createElement(s,{fields:r.fields,onDismiss:a,onSave:()=>i(e,t,o,l,c,d,u),selectedItem:o[0]})))))},text:oe.WorkItemTemplateCapture,iconProps:{iconName:"Camera"},disabled:o.length>1}];if(d&&v){const e=t.getService("IWorkItemTemplateService"),s=await e.getMyTemplateReferences(c,d.id,v);g.push(...s.map((e=>({id:e.id,onActivate:()=>{!async function(e,t,s,o,i,a,l){if(!a)return;const m=s.map((e=>Number(e[n.CoreFieldRefNames.Id]))),c=t.getService("IWorkItemTemplateService"),d=await c.getTemplate(o,a.id,e),u=[];for(const e in d.fields){let s=d.fields[e];const o=i.value.find((t=>t.referenceName===e));if(o)switch(o.type){case n.FieldType.DateTime:const e="string"==typeof s&&(0,r.startsWith)(s,H.MacroToday,!0)?(0,H.buildDate)(s):new Date(s);isNaN(e.getTime())||(s=e);break;case n.FieldType.Integer:case n.FieldType.Boolean:s=Number(s);break;default:if(o.isIdentity&&s){if((0,z.isMeMacro)(s,!1)){const e=t.getService("IVssPageService").getData().user;s=(0,q.getDistinctDisplayName)(e.displayName,e.uniqueName)}s=(0,q.convertWorkItemIdentityRefFromFieldValue)(t,s)}}u.push({fieldName:e,value:s})}const p=new Map([[y.BulkUpdateConstants.AllTypes,u]]),h=await(0,S.performBulkUpdate)(t,m,p);l&&l(h)}(e.id,t,o,c,u,d,p)},text:e.name}))).sort(((e,t)=>e.text.localeCompare(t.text))))}e.value=g}t[e].EditTemplateDialog=s,t[e].getTemplateMenuItem=function(e,t,s,o,r,l,n){const m=new a.ObservableArray;return i(m,e,t,s,o,r,l,n),{rank:70,id:"work-item-templates",text:oe.WorkItemTemplate,iconProps:{iconName:"AutoFillTemplate"},groupKey:"modify",subMenuProps:{id:"work-item-templates-sub-menu",items:m}}}}("ComponentsEditTemplateDialog"),function(e){t[e]={};const s=1024;class o extends c.VssComponent{constructor(e,t){var s,o,r,l;super(e,t),this.selectedIdentities=new a.ObservableArray([]),this.note=new a.ObservableValue(""),this.subject=new a.ObservableValue(""),this.sending=new a.ObservableValue(!1),this.errorMessage=new a.ObservableValue(""),this.showConfirmationDialog=new a.ObservableValue(!1),this.renderTable=()=>m.createElement("table",{style:{fontFamily:"Calibri, sans-serif",borderCollapse:"collapse",border:0,maxHeight:"180px",width:"100%"},"aria-label":oe.SelectedWorkItems},m.createElement("tbody",null,m.createElement("tr",{style:{background:"#106EBE",color:"white",verticalAlign:"top"}},this.props.columnFieldNames.map((e=>m.createElement("th",{style:{border:"none",borderRight:"solid white 1.0pt",padding:"1.45pt .05in 1.45pt .05in",fontFamily:"Segoe UI, Helvetica Neue, Helvetica, Arial, Verdana",fontSize:"12px"},key:e},e)))),this.props.selectedItems.filter((e=>e[n.CoreFieldRefNames.WorkItemType])).map(((e,t)=>m.createElement("tr",{key:t,style:{background:t%2==0?"rgba(124, 124, 124, 0.5)":"inherit",verticalAlign:"top"}},this.props.referenceFieldNames.map((t=>m.createElement("td",{key:t,style:{border:"none",borderRight:"solid white 1.0pt",padding:"1.45pt .05in 1.45pt .05in",fontFamily:"Segoe UI, Helvetica Neue, Helvetica, Arial, Verdana",fontSize:"12px",maxWidth:"50px"}},t===n.CoreFieldRefNames.Id?m.createElement("a",{href:this.workItemService.getWorkItemUrl(e[n.CoreFieldRefNames.Id],this.projectId),target:"_blank",tabIndex:0},e[t]):(0,G.convertValueToDisplayString)(e[t]))))))))),this.onSend=async()=>{var e;this.sending.value=!0;const t=this.context.pageContext.getService("IVssPageService").getData(),s=(null==t?void 0:t.user.id)||"",o=(0,ie.getWorkItemTrackingClient)(this.context.pageContext),i=this.selectedIdentities.value.map((e=>e.localId)),a=this.projectId;let r=[];this.props.wiql||(r=this.props.selectedItems.map((e=>e[n.CoreFieldRefNames.Id])));let l=this.props.tempQueryId;!l&&this.props.getTempQueryId&&(l=await this.props.getTempQueryId());try{await o.sendMail({message:{body:this.note.value,to:{tfIds:i,emailAddresses:[],unresolvedEntityIds:[]},subject:this.subject.value,cc:{tfIds:[s],emailAddresses:[],unresolvedEntityIds:[]},replyTo:{tfIds:[s],emailAddresses:[],unresolvedEntityIds:[]},inReplyTo:"",messageId:""},fields:this.props.referenceFieldNames,wiql:this.props.wiql||"",persistenceId:this.props.queryId||"",ids:r,projectId:a,sortFields:this.props.sortFields||[],tempQueryId:l||""},a),this.props.onDismiss()}catch(t){this.errorMessage.value=null!==(e=t.message)&&void 0!==e?e:t}finally{this.sending.value=!1}},this.onIdentityAdded=e=>{this.selectedIdentities.push(e)},this.onIdentityRemoved=e=>{this.selectedIdentities.value=this.selectedIdentities.value.filter((t=>t.entityId!==e.entityId))},this.onIdentitiesRemoved=e=>{this.selectedIdentities.value=this.selectedIdentities.value.filter((t=>0===e.filter((e=>e.entityId===t.entityId)).length))},this.onDismiss=()=>{this.subject.value&&this.subject.value!==this.props.defaultSubject||this.note.value?this.showConfirmationDialog.value=!0:this.props.onDismiss()},this.onConfirmationDismiss=()=>{this.showConfirmationDialog.value=!1},this.workItemService=t.pageContext.getService("work-item-service"),this.pickerProvider=new Q.PeoplePickerProvider(this.context.pageContext,{identityTypes:["user"]}),this.props.defaultSubject&&(this.subject.value=this.props.defaultSubject);const c=null!==(r=null===(o=null===(s=(0,i.getTFSPageData)(this.context.pageContext))||void 0===s?void 0:s.project)||void 0===o?void 0:o.id)&&void 0!==r?r:null===(l=this.props)||void 0===l?void 0:l.workItemProjectId;if(!c)throw new Error(oe.NoProjectSpecifiedMessage);this.projectId=c;const d=this.context.pageContext.getService("IMailConfigurationService");this.isMailEnabled=d.isEnabled()}render(){return this.props.isQueryDirty||!this.isMailEnabled?m.createElement(k.Dialog,{titleProps:{text:oe.ErrorSendingEmail},footerButtonProps:[{text:oe.OK,primary:!0,onClick:this.props.onDismiss}],onDismiss:this.onDismiss},this.isMailEnabled?oe.UnsavedQueryMessage:oe.SendMailNotEnabled):m.createElement(m.Fragment,null,m.createElement(h.Observer,{subject:this.subject,selectedIdentities:this.selectedIdentities,note:this.note,errorMessage:this.errorMessage},(({errorMessage:e,subject:t,selectedIdentities:o})=>m.createElement(k.Dialog,{contentSize:4,titleProps:{text:oe.SendWorkItems},onDismiss:this.onDismiss,footerButtonProps:[{text:oe.Cancel,onClick:this.onDismiss},{text:oe.Send,onClick:this.onSend,primary:!0,disabled:!t||0===o.length||this.note.value.length>s}],showCloseButton:!0},m.createElement("div",{className:"flex-grow flex-column rhythm-vertical-16"},this.props.loading?m.createElement(E.Spinner,{label:oe.Loading}):0===this.props.selectedItems.length?m.createElement(N.MessageCard,{severity:"Error"},oe.NoWorkItems):m.createElement(m.Fragment,null,e&&m.createElement(N.MessageCard,{onDismiss:()=>this.errorMessage.value="",severity:"Error"},e),m.createElement(p.FormItem,{label:oe.To},m.createElement(K.IdentityPicker,{className:"email-dialog-item",onIdentityAdded:this.onIdentityAdded,onIdentitiesRemoved:this.onIdentitiesRemoved,onIdentityRemoved:this.onIdentityRemoved,pickerProvider:this.pickerProvider,selectedIdentities:this.selectedIdentities})),m.createElement(p.FormItem,{label:oe.Subject},m.createElement(_.TextField,{containerClassName:"email-dialog-item",value:this.subject,onChange:(e,t)=>{this.subject.value=t}})),m.createElement(p.FormItem,{label:m.createElement("div",{className:"flex-row"},m.createElement("span",{className:"flex-grow email-dialog-label"},oe.Note),m.createElement("span",{className:(0,$.css)(this.note.value.length>s&&"character-count-error")},(0,r.format)(oe.CharacterCount,this.note.value.length,s)))},m.createElement(_.TextField,{containerClassName:"email-dialog-item",multiline:!0,value:this.note,onChange:(e,t)=>{this.note.value=t}})),m.createElement("div",{className:"flex-column email-read-only-body"},m.createElement("span",{className:"margin-bottom-16"},oe.SelectedWorkItems),this.renderTable()),m.createElement("div",{className:"flex-column"},this.props.selectedItems.length>200&&m.createElement("span",null,(0,r.format)(oe.EmailWorkItemsLimit,200))),m.createElement(h.Observer,{sending:this.sending},(({sending:e})=>e&&m.createElement(E.Spinner,{label:oe.Sending})))))))),m.createElement(h.Observer,{showConfirmationDialog:this.showConfirmationDialog},(({showConfirmationDialog:e})=>e&&m.createElement(k.Dialog,{titleProps:{text:oe.UnsavedChanges},onDismiss:this.props.onDismiss,lightDismiss:!1,modal:!0,footerButtonProps:[{text:oe.Cancel,onClick:this.onConfirmationDismiss},{text:oe.OK,onClick:this.props.onDismiss,primary:!0}]},oe.UnsavedChangesMessage))))}}t[e].EmailWorkItemsDialog=o}("ComponentsEmailWorkItemsDialog"),function(e){ne=t[e]={};const s=[n.CoreFieldRefNames.Id,n.CoreFieldRefNames.WorkItemType,n.CoreFieldRefNames.Title,n.CoreFieldRefNames.AreaPath,n.CoreFieldRefNames.IterationPath],o="SELECT [System.Id], [System.WorkItemType], [System.Title], [System.AreaPath], [System.IterationPath] FROM WorkItems WHERE ([System.TeamProject] = @project AND [System.WorkItemType] IN GROUP '{0}' AND [System.AreaPath] UNDER '{1}')",l="SELECT [System.Id], [System.WorkItemType], [System.Title], [System.AreaPath], [System.IterationPath] FROM WorkItems WHERE ([System.TeamProject] = @project AND [System.WorkItemType] IN GROUP '{0}' AND [System.AreaPath] UNDER '{1}' AND [System.Title] CONTAINS '{2}')";t[e].SelectTestItemForm=({testItemType:e,multipleSelect:t,onSelectionChanged:u,onMultiSelectionChanged:h})=>{var v,I;const C=(0,c.usePageContext)(),f=null!==(I=null===(v=(0,i.getTFSProject)(C))||void 0===v?void 0:v.id)&&void 0!==I?I:"",[k]=(0,a.useObservable)(""),[y]=(0,a.useObservable)(""),[S]=(0,a.useObservableArray)([]),[b,w]=m.useState({loading:!1}),T=m.useRef(new Y.ListSelection({multiSelect:t})),N=(e,t,s,o)=>{const i=o.fields[n.CoreFieldRefNames.WorkItemType],a=o.fields[n.CoreFieldRefNames.Title],r=(0,Z.getIconDataObservable)(f,i,C);return m.createElement(g.SimpleTableCell,{className:s.className,columnIndex:t,key:`results-${s.id}-${e}`,tableColumn:s},m.createElement(F.WorkItemTypeIcon,{className:"icon-margin",data:r}),m.createElement(V.Link,{className:"text-ellipsis",tooltipProps:{overflowOnly:!0},onClick:e=>{C.getService("work-item-service").openWorkItem(Number(o.fields[n.CoreFieldRefNames.Id]))}},a))},W=(e,t,s,o)=>({id:e,name:t.get(s),renderCell:(e,t,o,i)=>function(e,t,s,o,i){return m.createElement(g.SimpleTableCell,{className:s.className,columnIndex:t,key:`results-${s.id}-${e}`,tableColumn:s},(0,Y.renderListCell)(i))}(e,t,o,0,i.fields[s]),width:o});return m.createElement("div",{className:"flex-column flex-grow rhythm-vertical-8"},m.createElement(p.FormItem,{label:m.createElement("span",{className:"flex-row"},oe.TitleLabel,m.createElement(R.Icon,{className:"margin-left-4",iconName:"Info",size:"small",tooltipProps:{text:oe.TitleSearchTooltip}}))},m.createElement(_.TextField,{onChange:(e,t)=>k.value=t,value:k})),m.createElement(p.FormItem,{label:oe.AreaPathSearchLabel},m.createElement(X.AreaPathDropdown,{onSetPath:e=>y.value=e,selectDefaultValue:!0,selectedText:y})),m.createElement("span",{className:"flex-row"},m.createElement(d.Button,{iconProps:{iconName:"Search"},onClick:async()=>{w({loading:!0});const{columns:t,workItems:i}=await async function(e,t,i,a,n){const m=(0,J.getWorkItemTrackingClient)(e),c={query:n?(0,r.format)(l,i,a,n):(0,r.format)(o,i,a)},{workItems:d,columns:u}=await m.queryByWiql(c,t,void 0,void 0,1e3),p=d.map((e=>e.id)),h=e.getService("work-item-service"),v=(await Promise.all(h.loadWorkItems(t,p,s))).flat();return{columns:u,workItems:v}}(C,f,e,y.value,k.value),a=new Map;for(const e of t)a.set(e.referenceName,e.name);w({columns:a,loading:!1}),S.value=i},primary:!0,text:oe.Search}),b.loading&&m.createElement(E.Spinner,{className:"margin-left-8"})),b.columns&&m.createElement(g.Table,{columns:(D=b.columns,[W("id-column",D,n.CoreFieldRefNames.Id,-15),W("type-column",D,n.CoreFieldRefNames.WorkItemType,-20),{id:"title-column",name:D.get(n.CoreFieldRefNames.Title),renderCell:N,width:-25},W("area-path-column",D,n.CoreFieldRefNames.AreaPath,-20),W("iteration-column",D,n.CoreFieldRefNames.IterationPath,-20)]),itemProvider:S,onSelect:(e,s)=>{if(t){const e=function(e,t){const s=new Set;for(const o of e){const e=o.beginIndex,i=o.endIndex;for(let o=e;o<=i;o++)s.add(t[o].id)}return Array.from(s)}(T.current.value,S.value);h&&h(e)}else u&&u(s.data)},selection:T.current}));var D}}("ComponentsSelectTestItemForm"),function(e){t[e]={};t[e].InsertSharedStepsDialog=({onDismiss:e,onInsertSharedSteps:t})=>{const[s,o]=m.useState(void 0);return m.createElement(k.Dialog,{className:"insert-shared-steps-dialog",footerButtonProps:[{onClick:e,text:oe.Cancel},{disabled:!s,onClick:()=>{s&&t(s),e()},primary:!0,text:oe.InsertSharedSteps}],onDismiss:e,titleProps:{text:oe.InsertSharedSteps},contentSize:2},m.createElement(ne.SelectTestItemForm,{testItemType:"Microsoft.SharedStepCategory",onMultiSelectionChanged:e=>{o(e)},multipleSelect:!0}))},c.Components.add("insert-shared-steps-dialog",t[e].InsertSharedStepsDialog)}("ComponentsInsertSharedStepsDialog"),function(e){t[e]={},t[e].MoveToPositionDialog=function({items:e,onDismiss:t,onMoveToPosition:s}){const[o,i]=m.useState(void 0),[a,l]=m.useState(void 0),[n,c]=m.useState("");return m.createElement(k.Dialog,{defaultActiveElement:".position-textbox",footerButtonProps:[{onClick:t,text:oe.Cancel},{disabled:!!o||!n,onClick:()=>{try{null==s||s(Number(n)-1),t()}catch(e){l(e.message)}},primary:!0,text:oe.SaveChanges}],onDismiss:t,resizable:!0,titleProps:{text:oe.MoveToPositionTitle},showCloseButton:!0},m.createElement("div",{className:"flex-column rhythm-vertical-8"},a&&m.createElement(ee.MessageCard,{severity:"Error"},a),m.createElement(p.FormItem,{label:(0,r.format)(oe.SelectAPositionPrompt,e.length),error:!!o,message:o},m.createElement(_.TextField,{inputClassName:"position-textbox",inputType:"number",onChange:(t,s)=>{c(s);const a=Number(s);a<1||a>e.length?i((0,r.format)(oe.InvalidPosition,e.length)):o&&i(void 0)},value:n}))))}}("ComponentsMoveToPositionDialog"),function(e){t[e]={};t[e].MoveToProjectDialog=({onModifyItems:e,onDismiss:t,selectedItems:r})=>{const{pageContext:u}=(0,c.useComponentContext)(),h=u.getService("IWorkItemTypesService"),v=u.getService("ITfsProjectService"),[g,I]=m.useState(!1),[C,f]=m.useState(!1),[y,w]=m.useState(void 0),W=m.useRef([]),[E]=(0,a.useObservable)(""),[D,x]=m.useState(),F=m.useRef(),P=m.useRef(new M.DropdownSelection),R=m.useRef(new M.DropdownSelection),[V]=(0,a.useObservable)(""),[A]=(0,a.useObservable)(""),[j]=(0,a.useObservableArray)([d]),[L]=(0,a.useObservableArray)([]),[O]=(0,a.useObservableArray)([]),[B]=(0,a.useObservableArray)([]),_=async e=>{L.value=[d];const t=await h.getVisibleWorkItemTypes(e);L.value=[o,...t.map((e=>({id:e,text:e})))],R.current.select(0),F.current=s;const i=u.getService("IWorkItemNodeService");O.value=[d];const a=await i.getAreaPathNodes(e);a&&(O.value=(0,se.convertNodesToListBoxItems)(a),V.value=(0,se.normalizePath)(a.path)),B.value=[d];const r=await i.getIterationNodes(e);r&&(B.value=(0,se.convertNodesToListBoxItems)(r),A.value=(0,se.normalizePath)(r.path)),U()},U=()=>{const e=!!(D&&V.value&&A.value&&F.current);e!==g&&I(e)};return m.useEffect((()=>{D&&_(D)}),[D]),m.useEffect((()=>{(async()=>{const e=await v.getAllProjectsLoadedPromise();j.value=e.map((e=>({id:e.id,text:e.name}))),W.current=e})()}),[]),m.createElement(k.Dialog,{calloutContentClassName:"work-item-dialog",defaultActiveElement:".bolt-dialog-focus-element-cancel-button",footerButtonProps:[{className:"bolt-dialog-focus-element-cancel-button",text:oe.Cancel,onClick:t},{text:oe.OK,disabled:!g||C,onClick:async()=>{var o;const a=null===(o=W.current.find((e=>e.id===D)))||void 0===o?void 0:o.name;if(D&&V.value&&A.value&&F.current&&a)try{f(!0);const o=await async function(e,t,s){const{sourceProjects:o,targetProjectId:a,targetProjectName:r,targetType:m}=s,c=e.getService("IWorkItemTypesService"),d=function(e,t){const s=new Map;for(const o of e){const e=o[n.CoreFieldRefNames.WorkItemType],i=o[n.CoreFieldRefNames.TeamProject],a=t.find((e=>e.name===i));if(!a)continue;let r=s.get(a.id);r||(r=new Set,s.set(a.id,r)),r.add(e)}return s}(t,o),u=await async function(e,t,s,o){var i;const a=e.getService("IWorkItemTypesService");for(const e of[...t.keys()]){const r=await a.getVisibleWorkItemTypes(e),n=(await a.getWorkItemTypes(e)).filter((e=>r.indexOf(e)<0)),m=t.get(e),c=null===(i=s.find((t=>t.id===e)))||void 0===i?void 0:i.name;if(!m)continue;const d=l([...m.keys()],r,n,null!=c?c:e,o,!0);if(!d.success)return d}return{success:!0}}(e,d,o,!m);if(!u.success)return u;const p=t.map((e=>Number(e[n.CoreFieldRefNames.Id]))),h=(0,S.getWorkItemTypes)(t),v=await c.getVisibleWorkItemTypes(a),g=(await c.getWorkItemTypes(a)).filter((e=>v.indexOf(e)<0)),I=l(m?[m]:h,v,g,r,!m);if(!I.success)return I;const C=m?await async function(e,t,s){const o=e.getService("IWorkItemTypesService"),i=await o.getWorkItemTypeData(t,[s]);if(1===i.length&&i[0].orderedStates&&i[0].orderedStates.length>0){return i[0].orderedStates[0]}}(e,a,m):void 0,f=new Map;for(const e of h)f.set(e,i(e,s,C));const k=await(0,S.performBulkUpdate)(e,p,f);return{success:!0,workItems:k}}(u,r,{areaPath:V.value,historyValue:E.value,iterationPath:A.value,sourceProjects:W.current,targetProjectId:D,targetProjectName:a,targetType:F.current!==s?F.current:void 0});o.workItems&&o.success?(e&&e(o.workItems),t()):(w(o.errorMessage),f(!1))}catch(e){w(e.message),f(!1)}},primary:!0}],onDismiss:t,overlay:C?{spinnerAriaLabel:oe.MovingWorkItems}:void 0,resizable:!0,showCloseButton:!0,titleProps:{text:oe.MoveWorkItem}},m.createElement("div",{className:"rhythm-vertical-16"},y&&m.createElement(N.MessageCard,{severity:"Error"},y),m.createElement(p.FormItem,{label:oe.ProjectDropdownLabel},m.createElement(T.Dropdown,{items:j,placeholder:oe.ProjectDropdownPlaceholder,selection:P.current,onSelect:(e,t)=>{x(t.id)}})),m.createElement(p.FormItem,{label:oe.AreaPathLabel},m.createElement(X.AreaPathDropdown,{items:O,onSetPath:e=>{V.value=e,U()},projectId:D,selectedText:V})),m.createElement(p.FormItem,{label:oe.IterationPathLabel},m.createElement(te.IterationDropdown,{items:B,onSetPath:e=>{A.value=e,U()},projectId:D,selectedText:A})),m.createElement(p.FormItem,{label:oe.WorkItemType},m.createElement(T.Dropdown,{items:L,selection:R.current,onSelect:(e,t)=>{F.current=t.id===s?t.id:t.text,U()}})),m.createElement(p.FormItem,{label:oe.MoveToProjectReasonLabel},m.createElement(b.HtmlEditor,{className:"history-input",ariaLabel:oe.EditWorkItemsNotesAriaLabel,placeholder:oe.EditWorkItemsNotes,htmlContent:E.value,onChange:e=>{E.value=e},telemetryContext:{controlName:"HtmlEditor"},showChromeBorder:!0}))))};const s="keepCurrentType",o={id:s,text:oe.KeepCurrentTypesOption};function i(e,t,s=void 0){const{areaPath:o,historyValue:i,iterationPath:a,targetProjectId:r,targetType:l}=t,m=[{fieldName:n.CoreFieldRefNames.WorkItemType,value:null!=l?l:e},{fieldName:n.CoreFieldRefNames.TeamProject,value:r},{fieldName:n.CoreFieldRefNames.AreaPath,value:o},{fieldName:n.CoreFieldRefNames.IterationPath,value:a}];return s&&m.push({fieldName:n.CoreFieldRefNames.State,value:s}),i&&i.trim().length>0&&m.push({fieldName:n.CoreFieldRefNames.History,value:i}),m}function l(e,t,s,o,i,a=!1){const l=[];let n;for(const i of e){const e=s.indexOf(i)>=0,m=t.indexOf(i)>=0;e?n=(0,r.format)(a?oe.MoveSourceWorkItemBlockedCase:oe.MoveTargetWorkItemBlockedCase,i,o):m||l.push(i)}return l.length>0&&i&&(n=(0,r.format)(oe.MoveWorkItemBulkTypeError,l.join(", "),o)),{errorMessage:n,success:!n}}const d={id:"loading",type:4}}("ComponentsMoveToProjectDialog"),function(e){t.ServicesIWorkItemFormDialogService={};class o extends s.VssService{constructor(){super(...arguments),this.historyServiceListener=e=>{var t,s;const o=Number(null===(t=e.newState)||void 0===t?void 0:t.state.workitem);o!==this.currentWorkItemFormItemId&&(this.currentWorkItemFormItemId&&(null===(s=this.dismissWorkItemForm)||void 0===s||s.call(this,!1)),isNaN(o)||this.showWorkItemFormDialog(o,this.saveCompleteListener,{updateHistory:!1}))}}_serviceStart(e){super._serviceStart(e),this.historyService=this.pageContext.getService("IVssHistoryService")}_serviceEnd(e){super._serviceEnd(e),this.historyService.unsubscribe(this.historyServiceListener)}subscribeToHistoryService(e){this.historyService.unsubscribe(this.historyServiceListener),this.saveCompleteListener=e;const t=this.pageContext.getService("IVssHistoryService").getState();if(t.workitem){const e=Number(t.workitem);isNaN(e)||this.showWorkItemFormDialog(e,this.saveCompleteListener,{updateHistory:!1})}this.historyService.subscribe(this.historyServiceListener)}showWorkItemFormDialog(e,t,s){let o,i;"number"==typeof e?i=e:(o=e,i=o.id);const a=this.pageContext.getService("IVssLayoutManager");if(null==s?void 0:s.updateHistory){const e=this.historyService.getState();e.workitem!==""+i&&this.historyService.pushState(Object.assign(Object.assign({},e),{workitem:""+i}))}this.currentWorkItemFormItemId=i,a.renderCallout((e=>{const a=(t=!0)=>{var o;if(this.currentWorkItemFormItemId=void 0,this.dismissWorkItemForm=void 0,t){const e=this.historyService.getState();delete e.workitem,this.historyService.pushState(e)}null===(o=null==s?void 0:s.onDismiss)||void 0===o||o.call(s),e()};this.dismissWorkItemForm=a;const r={onDelete:null==s?void 0:s.onDelete,onDismiss:a,shouldRefresh:null==s?void 0:s.shouldRefresh,onSaveComplete:(e,s)=>null==t?void 0:t(this.pageContext,e,s)};return o?m.createElement(le.WorkItemFormDialog,Object.assign({},r,{workItem:o})):m.createElement(le.WorkItemFormDialog,Object.assign({},r,{workItemId:i}))}))}}s.Services.add("IWorkItemFormDialogService",{serviceFactory:o})}()}),["Resources","clients/WorkItemTracking","Services/ChangeParentService","Components/BulkEditFieldsTable","Components/BulkEditDialog","Components/ChangeParentPanel","Components/ChangeTypeDialog","Components/WorkItemFormDialog","Components/CloneWorkItemDialog","Components/ConfirmationDialog","Components/CopyWorkItemDialog","Components/DeleteDialog","Components/EditorDirtyDialog","Components/EditTemplateDialog","Components/EmailWorkItemsDialog","Components/SelectTestItemForm","Components/InsertSharedStepsDialog","Components/MoveToPositionDialog","Components/MoveToProjectDialog","Services/IWorkItemFormDialogService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-dialogs"}}));